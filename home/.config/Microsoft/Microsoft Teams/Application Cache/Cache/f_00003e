!function(e){"object"==typeof module&&module.exports?module.exports=e():window.vdiPeerConnection=e()}(function(e,t){"use strict";var n={NATIVE:0,CEF:1},i={createInstance:30,createInstanceResult:31,newVideoElement:32,removeVideoElement:33,updateVideoElement:34,newFrame:36,removeFrame:37,version:40,enumDevices:41,enumVideoDevice:42,createPeerConnection:43,createOffer:44,createAnswer:45,setLocalDescription:46,setRemoteDescription:47,addIceCandidate:48,addStream:49,getLocalStreams:50,getStats:51,removeStream:52,close:53,getUserMediaShim:54,mediaTrkStop:55,trackEnabled:56,newAudioElement:57,setSinkId:58,updateSrcObject:59,notifyAudio:60,mediaStreamClone:61,mediaTrackClone:62,getDisplayMediaShim:63,setDefaultSinkId:64,shimLogToWebSocket:65,insertDTMF:66,getReceivers:67,customClipRect:69,applyConstraints:70,getScreens:71,setScreenId:72,connectedStateChanged:78,updateObjectFit:79},o={ERROR:0,WARN:1,INFO:2,DEBUG:3},r={DISCONNECTED:0,PENDING:1,CONNECTED:2},s={DURATION:100,INTERTONEGAP:70},a={SSRC:0,CSRC:1},c={ADD:0,REMOVE:1,UPDATE:2},d={POWEREVENT_SUSPEND:0,POWEREVENT_RESUME:1},l="1.0.";l+="@"==="17520895"[0]?"00000":"17520895";var u=-1,h=0,f=0,v={},g={},m={},p={},b={},S=window.navigator.mediaDevices.enumerateDevices,y=n.CEF,C=null,E=null,k={},w={},_={},O={},D={},I=null,M=null,R=[],T=[],P={},N={},j={logLevel:o.DEBUG,websocketlogLevel:o.INFO,logToConsole:!1,updateLogLevel:function(e,t){j.logLevel=e,j.websocketlogLevel=t},error:function(e){j.log("ERROR",e),M&&"function"==typeof M.error&&M.error(e)},warn:function(e){j.log("WARN",e),M&&"function"==typeof M.warn&&M.warn(e)},info:function(e){j.log("INFO",e),M&&"function"==typeof M.info&&M.info(e)},debug:function(e){j.log("DEBUG",e)},log:function(e,t){try{o[e]<=j.logLevel&&(j.logToConsole&&console&&("object"==typeof t?console.log(t):console.log(e+": "+t)),"string"==typeof t&&o[e]<=j.websocketlogLevel&&I.sendLogToWebSocket(t,e))}catch(e){}}},V=function(e){setTimeout(e,0)},A=function(e){return e},W=function(e){if(P.multiwindow&&I){var t=A(e);t?N[t]?j.info("ensureFrame skipped due to frame already registered."):(I.send({cmd:"newFrame",frame:t,browser:"electron",customClipRect:1},-1),N[t]=e):j.error("ensureFrame skipped due to no frameWnd")}else j.error("ensureFrame skipped due to feature not enabled or no connection.")},F=function(e){if(P.multiwindow&&I){var t=A(e);t?N[t]?(I.send({cmd:"removeFrame",frame:t},-1),delete N[t]):j.info("removeFrame skipped due to frame is not registered."):j.error("removeFrame skipped due to no frameWnd")}else j.error("removeFrame skipped due to feature not enabled or no connection.")},x=function(){var e=this,t={};this.id=++u,this._localStreams=[],this._remoteStreams=[],this._iceConnectionState="new",Object.defineProperty(this,"iceConnectionState",{get:function(){return j.debug("get iceConnectionState:"+this._iceConnectionState),this._iceConnectionState},configurable:!0}),this._iceGatheringState="new",Object.defineProperty(this,"iceGatheringState",{get:function(){return j.debug("get iceGatheringState:"+this._iceGatheringState),this._iceGatheringState},configurable:!0}),this._signalingState="stable",Object.defineProperty(this,"signalingState",{get:function(){return j.debug("get signalingState:"+this._signalingState),this._signalingState},configurable:!0}),this._connectionState="new",Object.defineProperty(this,"connectionState",{get:function(){return j.debug("get connectionState:"+this._connectionState),this._connectionState},configurable:!0}),this._localDescription=null,Object.defineProperty(this,"localDescription",{get:function(){return j.debug("get localDescription:"+this._localDescription),this._localDescription},configurable:!0}),this._remoteDescription=null,Object.defineProperty(this,"remoteDescription",{get:function(){return j.debug("get remoteDescription:"+this._remoteDescription),this._remoteDescription},configurable:!0}),this.cleanUp=function(){if("complete"!==this._iceGatheringState){t={type:"icecandidate",candidate:null,target:this};this.onicecandidate&&this.onicecandidate(t),this._iceGatheringState="complete";var e={type:"icegatheringstatechange",target:this};this.onicegatheringstatechange&&this.onicegatheringstatechange(e)}if("disconnected"!=this._iceConnectionState){this._iceConnectionState="disconnected";var t={type:"iceconnectionstatechange",target:this};this.oniceconnectionstatechange&&this.oniceconnectionstatechange(t)}this._localStreams=[],this._remoteStreams=[]},this.createOffer=function(t,n,i){return new Promise(function(o,r){var s=new DOMException("createOffer cancelled","OperationError"),a=new DOMException("The RTCPeerConnection is closed","InvalidStateError");I.send({cmd:"createOffer",options:i},e.id,function(i){g[e.id]?void 0===i.error?(j.debug(i.desc),t(i.desc)):n(s):n(a)})})},this.createAnswer=function(t,n,i){return new Promise(function(o,r){var s=new DOMException("createAnswer cancelled","OperationError"),a=new DOMException("The RTCPeerConnection is closed","InvalidStateError");I.send({cmd:"createAnswer",options:i},e.id,function(i){g[e.id]?void 0===i.error?(j.debug(i.desc),t(i.desc)):n(s):n(a)})})},this.setRemoteDescription=function(t,n,i){return this._remoteDescription=t,new Promise(function(o,r){var s=new DOMException("setRemoteDescription cancelled","OperationError"),a=new DOMException("The RTCPeerConnection is closed","InvalidStateError");I.send({cmd:"setRemoteDescription",desc:t},e.id,function(t){g[e.id]?void 0===t.error?n():i(s):i(a)})})},this.setLocalDescription=function(t,n,i){return this._localDescription=t,new Promise(function(o,r){var s=new DOMException("setLocalDescription cancelled","OperationError"),a=new DOMException("The RTCPeerConnection is closed","InvalidStateError");I.send({cmd:"setLocalDescription",desc:t},e.id,function(t){g[e.id]?void 0===t.error?n():i(s):i(a)})})},this.addIceCandidate=function(t,n,i){return new Promise(function(o,r){var s=new DOMException("addIceCandidate cancelled","OperationError"),a=new DOMException("The RTCPeerConnection is closed","InvalidStateError");I.send({cmd:"addIceCandidate",candidate:t},e.id,function(t){g[e.id]?void 0===t.error?n():i(s):i(a)})})},this.createDTMFSender=function(t){if("audio"!==t.kind)return j.error("DTMF only could be associated with audio track."),null;var n=new G(e.id,t);return b[t.id]=n,n},this.getStats=function(t){return new Promise(function(n,i){new DOMException("getStats cancelled","InvalidAccessError");I.send({cmd:"getStats"},e.id,function(n){if("function"==typeof t)if(void 0===n.error&&void 0!==n.stats&&void 0!==g[e.id]){var i=new U;i._create(n.stats),t(i)}else t({})})})},this.getLocalStreams=function(){return j.debug("getLocalStreams():"+this._localStreams.length),this._localStreams},this.getRemoteStreams=function(){return j.debug("getRemoteStreams():"+this._remoteStreams.length),this._remoteStreams},this.addStream=function(t){this._localStreams.push(t),I.send({cmd:"addStream",sid:t.id},e.id)},this.removeStream=function(t){j.debug("RTCPeerConnection.removeStream(): "+t.id);var n=this._localStreams.indexOf(t);-1!=n?this._localStreams.splice(n,1):j.error("RTCPeerConnection.removeStream(): Failed to find stream: "+t.id),I.send({cmd:"removeStream",sid:t.id},e.id)},this.close=function(){n=null,I.send({cmd:"close"},e.id,function(t){delete g[e.id]},!0)};var n=null,i=function(e){e&&e.forEach(function(e){if(e.id){var t=e.id;if("-"===e.op)delete n[t];else{"+"===e.op&&delete n[t];var i=n[t];i||(i=new z,n[t]=i),i.update(e)}}})};this.getReceivers=function(){n||(n={},I.send({cmd:"getReceivers"},e.id,function(e){},!0));var t=[];for(var i in n)n[i]&&t.push(n[i]);return t},this.getSenders=function(){j.debug("RTCPeerConnection.getSenders(): Not Implemented")},this.addEventListener=function(e,n){j.debug("RTCPeerConnection.addEventListener(): "+e),"function"==typeof n?"string"==typeof e?(void 0===t[e]&&(t[event]={listeners:[]}),t[e].listeners.push(n)):j.error("RTCPeerConnection.addEventListener(): The event name is invalid."):j.error("RTCPeerConnection.addEventListener(): The listener handler is invalid.")},this.removeEventListener=function(e,n){j.debug("RTCPeerConnection.removeEventListener(): "+e),void 0!==t[e]?t[e].listeners=t[e].listeners.filter(function(e){return e.toString()!==n.toString()}):j.error("RTCPeerConnection.removeEventListener(): Event does not exist = "+e)},this._onReceiveEvent=function(e){if(void 0!==e&&void 0!==e.evt){var t={type:e.evt,target:this};switch(e.details&&this._updateVars(e.details),e.evt){case"connectionstatechange":this.onconnectionstatechange&&this.onconnectionstatechange(t);break;case"negotiationneeded":this.onnegotiationneeded&&this.onnegotiationneeded(t);break;case"icecandidate":t.candidate=e.candidate,this.onicecandidate&&this.onicecandidate(t);break;case"icegatheringstatechange":this.onicegatheringstatechange&&this.onicegatheringstatechange(t);break;case"iceconnectionstatechange":this.oniceconnectionstatechange&&this.oniceconnectionstatechange(t);break;case"signalingstatechange":this.onsignalingstatechange&&this.onsignalingstatechange(t);break;case"datachannel":t.channel=JSON.parse(JSON.stringify(evt.channel)),this.ondatachannel&&this.ondatachannel(t);break;case"addStream":if(void 0===e.stream){j.debug("_onReceiveEvent(): stream property is invalid.");break}t.stream=new L,t.stream._create(e.stream),this._remoteStreams.push(t.stream),this.onaddstream&&this.onaddstream(t);break;case"removeStream":if(void 0===e.stream){j.debug("_onReceiveEvent(): stream property is invalid.");break}if(t.stream=p[e.stream],void 0===t.stream){j.debug("_onReceiveEvent(): no stream found.");break}var n=this._remoteStreams.indexOf(t.stream);-1!=n&&this._remoteStreams.splice(n,1),this.onremovestream&&this.onremovestream(t);break;case"ontrack":if(t.streams=[],void 0===e.sid||void 0===p[e.sid]){j.debug("_onReceiveEvent(): ontrack, sid is invalid  or not found.");break}t.streams.push(p[e.sid]),this.ontrack&&this.ontrack(t);break;case"tonechange":var o=b[e.tid];if(void 0===o){j.debug("_onReceiveEvent(): tonechange, dtmfId is invalid  or not found.");break}o.ontonechange&&o.ontonechange(e);break;case"onreceivers":i(e.receivers)}}else j.error("_onReceiveEvent(): evt property is invalid.")},this._updateVars=function(e){e.iceConnectionState&&(this._iceConnectionState=e.iceConnectionState),e.iceGatheringState&&(this._iceGatheringState=e.iceGatheringState),e.signalingState&&(this._signalingState=e.signalingState),e.connectionState&&(this._connectionState=e.connectionState),e.localDescription&&(this._localDescription=e.localDescription),e.remoteDescription&&(this._remoteDescription=e.remoteDescription)}},L=function(){var e=0,t={};this.id="",this.active=!1,this.ended=!1,this.cloned=null,this.track=[],this._create=function(e){var t=this;this.id=e.id,this.active=e.active,this.track=[],e.track.forEach(function(e){var n=new H;n._create(e),t.track.push(n)}),p[this.id]=this},this.dispatchEvent=function(e){j.debug("MediaStream.dispatchEvent(): "+e.type),void 0!==t[event.type]&&t[event.type].listeners.forEach(function(t){t(e)}),"active"===e.type?this.onactive&&this.onactive(e):"addtrack"===e.type?this.onaddtrack&&this.onaddtrack(e):"inactive"===e.type?this.oninactive&&this.oninactive(e):"removetrack"===e.type?this.onremovetrack&&this.onremovetrack(e):j.debug("MediaStream.dispatchEvent(): Undefined event: ",e.type)},this.addEventListener=function(e,n){j.debug("MediaStream.addEventListener(): "+e),"function"==typeof n?"string"==typeof e?(void 0===t[e]&&(t[event]={listeners:[]}),t[e].listeners.push(n)):j.error("MediaStream.addEventListener(): The event name is invalid."):j.error("MediaStream.addEventListener(): The listener handler is invalid.")},this.removeEventListener=function(e,n){j.debug("MediaStream.removeEventListener(): "+e),void 0!==t[e]?t[e].listeners=t[e].listeners.filter(function(e){return e.toString()!==n.toString()}):j.error("MediaStream.removeEventListener(): Event does not exist = "+e)},this.addTrack=function(e){j.debug("MediaStream.addTrack(): "+e.id);var t=!1;this.track.forEach(function(n){n.id==e.id&&(t=!0)}),t||this.track.push(e)},this.removeTrack=function(e){j.debug("MediaStream.removeTrack(): "+e.id);for(var t=0;t<this.track.length;t++)if(this.track[t].id==e.id)return void this.track.splice(t,1)},this.getTracks=function(){return j.debug("MediaStream.getTracks(): "+this.track.length),j.debug(this.track),this.track},this.getAudioTracks=function(){var e=[];return this.track.forEach(function(t){"audio"==t.kind&&e.push(t)}),j.debug("MediaStream.getAudioTracks(): Audio tracks = "+e.length),e},this.getVideoTracks=function(){var e=[];return this.track.forEach(function(t){"video"==t.kind&&e.push(t)}),j.debug("MediaStream.getVideoTracks(): Video tracks = "+e.length),e},this.getTrackById=function(e){var t=null;return j.debug("MediaStream.getTrackById(): "+e),this.track.forEach(function(n){n.id==e&&(t=n)}),t},this.clone=function(){if(j.debug("MediaStream.clone(): Clone mediaStream = "+this.id),this.cloned)return j.debug("MediaStream.clone(): Use cached clone: "+this.cloned.id),this.cloned;var t=this.id+"StreamCln#"+ ++e,n=new L,i=[];n._create({id:t,active:this.active,track:[]});for(var o=0;o<this.track.length;o++){var r=this.track[o]._internalClone();n.track.push(r),i.push({tid:this.track[o].id,cid:r.id})}return I.send({cmd:"mediaStreamClone",sid:this.id,cid:n.id,trackClones:i},-1),j.debug("MediaStream.clone(): MediaStream cloned = "+n.id+" from = "+this.id),n}},H=function(){var e=0,t={};this.remote=!1,this.readonly=!1,this.contentHint="",this.id="",this.kind="",this.label="",this.muted=!1,this.readyState="",this._enabled=!1,Object.defineProperty(this,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e,void 0===e&&j.warn("Set MediaStreamTrack.enabled to undefined."),I.send({cmd:"trackEnabled",trackId:this.id,enabled:e},-1)},configurable:!0}),this._create=function(e){this._update(e),m[this.id]=this},this._update=function(e){e&&(this.contentHint=e.contentHint,this.id=e.id,this.kind=e.kind,this.label=e.label,this._enabled=e.enabled,this.muted=e.muted,this.readyState=e.readyState,this.remote=e.remote,this.readonly=e.readonly,this.settings=e.settings)},this.dispatchEvent=function(e){"started"==e.type?this.onstarted&&this.onstarted(e):"ended"==e.type?this.onended&&this.onended(e):"isolationchange"==e.type?this.onisolationchange&&this.onisolationchange(e):"mute"==e.type?this.onmute&&this.onmute(e):"unmute"==e.type?this.onunmute&&this.onunmute(e):"overconstrained"==e.type?this.onoverconstrained&&this.onoverconstrained(e):j.debug("Undefined media track evt: ",e.type)},this.addEventListener=function(e,n){j.debug("MediaStreamTrack.addEventListener(): "+e),"function"==typeof n?"string"==typeof e?(void 0===t[e]&&(t[event]={listeners:[]}),t[e].listeners.push(n)):j.error("MediaStreamTrack.addEventListener(): The event name is invalid."):j.error("MediaStreamTrack.addEventListener(): The listener handler is invalid.")},this.removeEventListener=function(e,n){j.debug("MediaStreamTrack.removeEventListener(): "+e),void 0!==t[e]?t[e].listeners=t[e].listeners.filter(function(e){return e.toString()!==n.toString()}):j.error("MediaStreamTrack.removeEventListener(): Event does not exist = "+e)},this.applyConstraints=function(e){var t=this.id,n=this.settings;return j.debug("MediaStreamTrack.applyConstraints()"),new Promise(function(i,o){var r=new DOMException("applyConstraints failed","OperationError");I.send({cmd:"applyConstraints",constraints:e,trkid:t},-1,function(e){void 0===e.error?(void 0!==e.settings.width&&void 0!==e.settings.height&&(n.width=e.settings.width,n.height=e.settings.height),i()):o(r)})})},this.getConstraints=function(){j.debug("MediaStreamTrack.getConstraints(): Not implemented")},this.getCapabilities=function(){j.debug("MediaStreamTrack.getCapabilities(): Not implemented")},this.getSettings=function(){return j.debug("MediaStreamTrack.getSettings(): "+JSON.stringify(this.settings)),this.settings},this.stop=function(){I.send({cmd:"mediaTrkStop",trkid:this.id})},this._internalClone=function(){var t=this.id+"TrackCln#"+ ++e,n=new H;return n._create({id:t,kind:this.kind,label:this.label,enabled:this.enabled,muted:this.muted,readyState:this.readyState,remoate:this.remote,readonly:this.readonly,settings:this.settings}),n},this.clone=function(){var e=this._internalClone();return I.send({cmd:"mediaTrackClone",tid:this.id,cid:e.id},-1),e}},U=function(){this.reports=[],this.result=function(){return this.reports},this._create=function(e){var t=this;e.forEach(function(e){var n=new J;n._create(e),t.reports.push(n)})}},J=function(){this.stats={},this._create=function(e){this.stats=e,this.type=e.type,this.id=e.id,this.timestamp=e.timestamp,delete this.stats.type,delete this.stats.id,delete this.stats.timestamp},this.names=function(){return Object.keys(this.stats)},this.stat=function(e){return this.stats[e]}},G=function(e,t){this.peerId=e,this.track=t,this._toneBuffer="",this.canInsertDTMF=!0,Object.defineProperty(this,"toneBuffer",{get:function(){return j.debug("get DTMF tone buffer"+this._toneBuffer),this._toneBuffer},set:function(e){void 0===e&&j.warn("Set RTCDTMFSender.toneBuffer to undefined."),j.debug("set DTMF tone buffer"+e),this._toneBuffer=e},configurable:!0}),this.insertDTMF=function(e,n,i){j.debug("insertDTMF audio tones: "+e),void 0===n&&(j.debug("Duration is not set, use default"),n=s.DURATION),void 0===i&&(j.debug("Gap is not set, use default"),i=s.INTERTONEGAP),I.send({cmd:"insertDTMF",tid:t.id,tones:e,duration:n,gap:i},this.peerId)}},z=function(){var e={},t={},n=function(n){n&&("+"===n.op&&(e=null,t={}),n.track&&(e?Object.keys(n.track).forEach(function(t){"enabled"!=t?e[t]=n.track[t]:e._enabled=n.track[t]}):(e=new H)._update(n.track)),n.sources&&n.sources.forEach(function(e){var n=e.source;if("-"===e.op)delete t[n];else{"+"===e.op&&(delete t[n],t[n]={});var i=t[n];Object.keys(e).forEach(function(t){i[t]=e[t]})}}))},i=function(e){var n=[];for(var i in t){var o=t[i];o.type&&o.type===e&&n.push(o)}return n};this.update=function(e){n(e)},Object.defineProperty(this,"track",{get:function(){return e},configurable:!0}),this.getContributingSources=function(){return i(a.CSRC)},this.getSynchronizationSources=function(){return i(a.SSRC)}},B=function(e,t){var n=this,i=t;this._srcObject=e.srcObject,this._id=f++,this._rawAudio=e,this.sendAudioElement=function(){var t={cmd:"newAudioElement",audioId:this._id};e.setAttribute("data-vdi_audioid",this._id),I.send(t,-1)},Object.defineProperty(e,"srcObject",{get:function(){return n._srcObject},set:function(e){void 0===e&&j.warn("Set audio.srcObject to undefined."),j.debug("Setting srcObject for audio element: "+n._id),j.debug(e),n._srcObject=void 0===e?null:e,n.sendSrcObject()},configurable:!0}),this.sendSrcObject=function(){var e=this._srcObject?this._srcObject.id:"null";I.send({cmd:"updateSrcObject",mediaStreamId:e,audioId:this._id,type:"audio"},-1)},Object.defineProperty(e,"sinkId",{get:function(){return n._sinkId},set:function(e){},configurable:!0}),e.setSinkId=function(e){return n._sinkId=e,j.debug("Audio.setSinkId for ID = "+n._id+" Value = "+e),0===(void 0!==P.setSinkId?P.setSinkId:0)?new Promise(function(t,i){I.send({cmd:"setSinkId",deviceId:e,audioId:n._id,context:"audioElement"},-1),t()}):new Promise(function(t,i){I.send({cmd:"setSinkId",deviceId:e,audioId:n._id,context:"audioElement"},-1,function(e){void 0===e.error?t():i(e.error)})})},e.play=function(){return Promise.resolve()},this.init=function(){W(i),this.sendAudioElement(),this._srcObject&&(j.debug("srcObject already set for audio: "+this._id),this.sendSrcObject()),j.debug(e)},this.init()},q=function(e,t){var n=this,i=t,o=A(t);this._srcObject=e.srcObject,this._videoWidth=e.videoWidth,this._videoHeight=e.videoHeight,this._cloaked=!1,this._id=h++,this._clientRect=null,this._bodyClientRect=null,this._colorKey=null,this._rawVideo=e,this._removeTimer=null,this._removed=!1,this._objectFit=e.style.objectFit,this._styleObserver=new MutationObserver(function(t){t.forEach(function(t){n.handleStyleChanges(t,e)})});var r=function(e){var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t},s=function(){for(var e="";""==e;){var t=Math.floor(16*Math.random())+1,n=Math.floor(16*Math.random())+1,i=Math.floor(16*Math.random())+1;e="#"+r(t)+r(n)+r(i);var o=Object.keys(k);for(var s in o){var a=k[o[s]];if(a&&a._colorKey==e){e="";break}}}return e};this.sendVideoElement=function(){this._colorKey=s();var t={cmd:"newVideoElement",videoId:this._id,colorKey:this._colorKey,body:{}};o&&(t.frame=o);for(var n in this._clientRect)t[n]=this._clientRect[n];for(var n in this._bodyClientRect)t.body[n]=this._bodyClientRect[n];""!==this._objectFit&&(t.objectFit=this._objectFit),e.setAttribute("data-vdi_videoid",this._id),I.send(t,-1)},this.updateVideoElement=function(){var t=this.getBoundingClientRect(e);this._cloaked||(t.right=t.left,t.bottom=t.top);var n=this.getBoundingClientRect(document.body);if(t.left==this._clientRect.left&&t.right==this._clientRect.right&&t.top==this._clientRect.top&&t.bottom==this._clientRect.bottom&&n.left==this._bodyClientRect.left&&n.right==this._bodyClientRect.right&&n.top==this._bodyClientRect.top&&n.bottom==this._bodyClientRect.bottom)return!1;this._clientRect=t,this._bodyClientRect=n;var i={cmd:"updateVideoElement",videoId:this._id,body:{}};o&&(i.frame=o);for(var r in t)i[r]=t[r];for(var r in n)i.body[r]=n[r];""!==this._objectFit&&(i.objectFit=this._objectFit),j.debug(i),I.send(i,-1)},this.removeVideoElement=function(){var e={cmd:"removeVideoElement",videoId:n._id};o&&(e.frame=o),j.debug("RemoveVideoElement: "+n._id),I.send(e,-1),delete k[n._id],n._removeTimer=null,n._removed=!0},this.cloak=function(){!0!==this._cloaked&&(this._colorKey?(e.style.backgroundColor=this._colorKey,this._styleObserver.observe(e,{attributes:!0,attributeFilter:["style"]}),this._cloaked=!0,this._poll=setInterval(function(){n.updateVideoElement()},500)):j.error("cloak(): Invalid color key."))},this.uncloak=function(){if(!1===this._cloaked)return!1;e.style.backgroundColor="",this._styleObserver.disconnect(),clearInterval(this._poll),this._cloaked=!1,this.updateVideoElement()},this.getBoundingClientRect=function(e,t){var n=e.getBoundingClientRect(),i=1;return"number"==typeof window.devicePixelRatio&&(i=window.devicePixelRatio),t&&t.left&&t.top?{left:n.left*i+t.left,top:n.top*i+t.top,bottom:n.bottom*i+t.top,right:n.right*i+t.left,width:n.width*i,height:n.height*i}:{left:n.left*i,top:n.top*i,bottom:n.bottom*i,right:n.right*i,width:n.width*i,height:n.height*i}},this.onReceiveEvent=function(e){if(void 0!==e&&void 0!==e.evt)if(this._rawVideo){if("loadedmetadata"===e.evt){void 0!==e.videoWidth&&(this._videoWidth=e.videoWidth),void 0!==e.videoHeight&&(this._videoHeight=e.videoWidth);var t=new Event(e.evt);this._rawVideo.dispatchEvent(t)}}else j.error("onReceiveEvent(): Invalid rawVideo object.");else j.error("onReceiveEvent(): evt property is invalid.")},this.sendSrcObject=function(){var e=this._srcObject?this._srcObject.id:"null";I.send({cmd:"updateSrcObject",mediaStreamId:e,videoId:this._id,type:"video"},-1),this._srcObject?this.cloak():this.uncloak()},this.sendObjectFit=function(){I.send({cmd:"updateObjectFit",videoId:this._id,objectFit:this._objectFit},-1)},Object.defineProperty(e,"srcObject",{get:function(){return n._srcObject},set:function(e){n._removed?j.warn("Setting srcObject of zombie video element: "+n._id):(n._removeTimer&&(clearTimeout(n._removeTimer),n._removeTimer=null),void 0===e&&j.warn("Set video.srcObject to undefined."),j.debug("Setting srcObject for video element: "+n._id),j.debug(e),n._srcObject=e,n.sendSrcObject(),n._srcObject||(j.debug("srcObject is null, setup removeTimer for "+n._id),n._removeTimer=setTimeout(n.removeVideoElement,5e3)))},configurable:!0}),Object.defineProperty(e,"videoWidth",{get:function(){return n._videoWidth},configurable:!0}),Object.defineProperty(e,"videoHeight",{get:function(){return n._videoHeight},configurable:!0}),Object.defineProperty(e.style,"objectFit",{get:function(){return console.log("keyword defineProperty get objectFit "+n._objectFit),n._objectFit},set:function(e){console.log("keyword defineProperty set objectFit "+e),n._objectFit=e,n.sendObjectFit()},configurable:!0}),q.prototype.handleStyleChanges=function(e,t){"attributes"===e.type&&"style"===e.attributeName&&(j.debug("video style change in id = "+this._id+", object-fit = "+t.style.objectFit),j.debug(t),this._objectFit!==t.style.objectFit&&(j.debug("change in object-fit. Old = "+this._objectFit+", new = "+t.style.objectFit),this._objectFit=t.style.objectFit,this.sendObjectFit()))},this.init=function(){this._clientRect=this.getBoundingClientRect(e),this._bodyClientRect=this.getBoundingClientRect(document.body),W(i),this.sendVideoElement(),this._srcObject&&(j.debug("srcObject already set for video: "+this._id),this.sendSrcObject()),j.debug(e)},this.init()},K=function(e){"function"==typeof C?(j.info("onVMEvent(): Fire event = "+JSON.stringify(e)),C(e)):j.warn("onVMEvent(): setVMEventCallback is not called yet.")},X=function(){var e=this,t=null,n=r.DISCONNECTED,s={},a=0,c=null,u=!1,h=!0;Object.defineProperty(this,"state",{get:function(){return n},configurable:!0}),Object.defineProperty(this,"shortPollingIntervalMs",{get:function(){return 1e3}}),Object.defineProperty(this,"shortPollingTimeout",{get:function(){return 1e4}}),Object.defineProperty(this,"longPollingIntervalMs",{get:function(){return 5e3}}),Object.defineProperty(this,"isHorizonRegistryPresent",{get:function(){return u},set:function(e){u=e},configurable:!0}),Object.defineProperty(this,"sendVdiClientEventsOnError",{get:function(){return h},set:function(e){h=e},configurable:!0}),this.sendLogToWebSocket=function(e,t){return"string"==typeof e&&0!==e.length&&(n===r.CONNECTED&&(C({cmd:"shimLogToWebSocket",message:e,level:t},-1),!0))},this.isSocketConnected=function(){return n===r.CONNECTED},this.isSocketOpen=function(){return!!t&&t.readyState===WebSocket.OPEN},this.init=function(){j.info("RequestManager.init(): Initializing Request Manager."),this.startPolling(1e3,1e4,this.sendEvents)},this.startPolling=function(t,i,o){if(c)j.info("RequestManager.startPolling(): Polling timer already initialized");else if(n===r.DISCONNECTED){var s=i;j.info("intervalMs "+t+" timeout "+i),c=setInterval(function(){e.connectToHorizon(),void 0!==s&&(s-=t,u||e.queryHorizonRegistry()),void 0!==s&&s<=0&&(e.stopPolling(),o&&!0===u&&o())},t)}else j.info("RequestManager.startPolling(): Socket state not disconnected, exiting")},this.stopPolling=function(){null!==c&&(clearInterval(c),c=null,j.info("Stopped polling websocket"))},this.sendEvents=function(){var e={};e.shimVersion=l;var t={event:"vdiClientConnected",version:e};try{K(t)}catch(e){j.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}try{K({event:"vdiClientDisconnected",reason:"endpointUnsupported"})}catch(e){j.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}I.startPolling(5e3)},this.queryHorizonRegistry=function(){window.getVMWareViewClientID().then(function(e){j.info("queryHorizonRegistry(): Horizon Client ID "+e),e&&I&&(I.isHorizonRegistryPresent=!0,j.info("queryHorizonRegistry(): isHorizonRegistryPresent true"))},function(){return j.error("queryHorizonRegistry(): Failed to query Horizon Client ID"),!1})},this.connectToHorizon=function(){n===r.DISCONNECTED&&window.getVMWareSecureWebPort().then(function(e){if("string"!=typeof e||0===e.length)return j.error("connectToHorizon(): Port is not valid"),void D("VMware HTML5 Server port not valid");j.info("connectToHorizon(): port is "+e),n=r.PENDING,(t=new WebSocket("wss://view-localhost:"+e+"/")).binaryType="arraybuffer",t.onopen=f,t.onclose=v,t.onerror=b,t.onmessage=S},function(){j.error("connectToHorizon(): Failed to receive port number"),D("Failed to receive port number")})};var f=function(){j.info("onWebSocketOpen(): Websocket opened"),I.stopPolling(),C({cmd:"createInstance",hwnd:O.hwnd,shimVersion:l,shimMinAgentVersion:1,customClipRect:1,allowFeatureChange:1,supportObjectFit:1},-1,function(t){if(n!=r.DISCONNECTED){t.uid&&j.info("onWebSocketOpen(): ["+t.uid+"] createInstanceDone"),"true"===t.traceEnabled&&j.updateLogLevel(o.DEBUG,o.DEBUG);var i=["agentOsVersion","clientOsVersion","haVersion","hcVersion","shimVersion","webrtcClientVer","webRTCRedirAgentVersion","webRTCRedirClientVersion"],s={};j.logToConsole=1===t.logToConsole,j.debug("VDI Shim: Log to console = "+j.logToConsole);for(d=0;d<i.length;d++)t[i[d]]?(s[i[d]]=t[i[d]],j.debug("onWebSocketOpen(): "+i[d]+" = "+t[i[d]])):j.warn("onWebSocketOpen(): Could not find property "+i[d]);t.clientOsVersion?t.clientOsVersion.startsWith("Win")?s.clientPlatform="Windows":t.clientOsVersion.startsWith("Mac")?s.clientPlatform="Mac":t.clientOsVersion.startsWith("Lin")?s.clientPlatform="Linux":(j.error("Unknown client os: "+t.clientOsVersion),s.clientPlatform="Unknown"):(j.error("Missing client os information."),s.clientPlatform="Unknown"),j.debug("onWebSocketOpen(): clientPlatform = "+s.clientPlatform);var a={event:"vdiClientConnected",version:s};if(t.hcId&&(a.endpointId=t.hcId,j.debug("onWebSocketOpen(): ClientId = "+t.hcId)),"true"===t.allow){n=r.CONNECTED,P=t["api-capabilities"]?t["api-capabilities"]:{},Array.isArray(t.featuresSupported)?(R=t.featuresSupported,j.info("onWebSocketOpen(): Supported features = "+JSON.stringify(R))):j.warn("onWebSocketOpen(): featureSupported property not valid");try{K(a)}catch(e){j.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}e.invokeDeviceChange()}else{try{K(a)}catch(e){j.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}for(var c="",i=["errorCode","errorMsg"],d=0;d<i.length;d++)void 0!==t[i[d]]?(j.debug("onWebSocketOpen(): "+i[d]+": "+t[i[d]]),c+=i[d]+" = "+t[i[d]],d!=i.length-1&&(c+="; ")):j.warn("onWebSocketOpen(): Could not find property "+i[d]);try{K({event:"vdiClientDisconnected",reason:"endpointUnsupported",msg:c})}catch(e){j.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}D("VMware HTML5 Server connection not allowed")}}})},v=function(){j.info("onWebSocketClose(): Websocket closed"),D("VMware HTML5 Server connection closed")},b=function(e){j.debug("onWebSocketError(): Websocket error");var t=r.DISCONNECTED;I&&(t=I.state),D("VMware HTML5 Server connection error: "+e.message),t==r.PENDING&&(j.debug("Error in connecting socket"),I&&I.sendVdiClientEventsOnError&&(j.error("Error in connecting to websocket"),I.stopPolling(),I.sendEvents(),I.sendVdiClientEventsOnError=!1))},S=function(e){if("object"==typeof e.data){var t=new Uint8Array(e.data),n=new DataView(e.data),i=n.getInt32(0),o=n.getInt32(36);if(1396920910!=i)return void j.WARN("Unsupport binary data: "+i.toString(16));for(var r=40,a=[];r+12<t.length;){var c=n.getInt32(r),d=(b=n.getInt32(r+4))*(S=n.getInt32(r+8))*4;if(b<0||S<0||r+12+d>t.length){j.warn("Invalid screen "+b+"X"+S+" offs:"+r+" size:"+d+" len:"+t.length);break}r+=12;var l=new Uint8ClampedArray(t.buffer,r,d),u=new ImageData(l,b,S),h=new Y(c,"Screen "+c,u);r+=d,a.push(h),j.debug("Screen:"+c+": "+b+"X"+S+" offs:"+r+" size:"+d+" len:"+t.length)}m=s[o];return delete s[o],void(void 0!==m&&"function"==typeof m.responseCb&&m.responseCb(a))}if("string"==typeof e.data){var f=e.data,v=JSON.parse(f);if(j.logToConsole&&console.log("onWebSocketMessage(): "+f),E&&E(v),"number"==typeof v.id&&v.id>0){var m=s[v.id];if(delete s[v.id],m&&"function"==typeof m.responseCb)if("getScreens"!==v.evt)m.responseCb(v);else if(v.error)m.responseCb(v);else{var a=[],p="number"==typeof v.screens?v.screens:1;for(c=1;c<=p;c++){for(var b=100,S=100,y=4*b*S,l=new Uint8ClampedArray(y),C=0;C<y;C+=4)l[C]=81,l[C+1]=144,l[C+2]=201,l[C+3]=255;var u=new ImageData(l,b,S),h=new Y(c,"Screen "+c,u);a.push(h)}m.responseCb(a)}}else if(void 0!==v.evt)switch(v.evt){case"version":if(void 0===v.ver){j.error("onWebSocketMessage(): ver property is invalid.");break}j.info("onWebSocketMessage(): version = "+v.ver);break;case"negotiationneeded":case"icecandidate":case"icegatheringstatechange":case"iceconnectionstatechange":case"signalingstatechange":case"addStream":case"tonechange":case"onreceivers":case"removeStream":void 0!==v.peer&&void 0!==g[v.peer]?g[v.peer]._onReceiveEvent(v):j.error("onWebSocketMessage(): peerConnection is invalid.");break;case"loadedmetadata":void 0!==v.videoId&&void 0!==k[v.videoId]?k[v.videoId].onReceiveEvent(v):j.error("onReceiveCommand(): Invalid context.");break;case"devicechange":var w=new Event("devicechange");navigator.mediaDevices.dispatchEvent(w);break;case"vdiScreenTopologyChanged":try{K({event:"vdiScreenTopologyChanged"})}catch(e){j.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}break;case"featuresSupportedChanged":for(var C in v.features){var O=v.features[C],D=R.indexOf(O.feature);"+"==O.op&&D<0?R.push(O.feature):"-"==O.op&&D>=0&&R.splice(D,1)}K({event:"vdiFeatureSupportedChanged",reason:v.reason?v.reason:"endpoint changes supported features"});break;case"powerevent":var I=v.eventData;_(I)}else j.error("onWebSocketMessage(): evt property is invalid")}else j.error("onWebSocketMessage(): invalid data type: "+typeof e.data)},C=function(e,o,c,d){if(o=void 0==o?-1:o,void 0!==e)if(-1===o||g[o])e.feature=3,e.commandId=i[e.cmd],e.id=++a,e.peer=o,e.browser="electron",e.player=y,"createInstance"===e.cmd&&(e.uid=Date.now(),j.info("sendHelper(): ["+e.uid+"] createInstance")),"createInstance"!==e.cmd&&n!==r.CONNECTED||(c&&(d?c():s[e.id]={id:e.id,webCommandId:e.commandId,responseCb:c}),t.send(JSON.stringify(e)));else{l=new DOMException("peer Id is not found, operation cancelled","OperationError");c?c({error:l}):j.error(l)}else{var l=new DOMException("Invalid command, operation cancelled","OperationError");c?c({error:l}):j.error(l)}};this.send=function(e,t,n,i){"getStats"!=e.cmd&&j.debug(JSON.stringify(e)),C(e,t,n,i)},this.invokeDeviceChange=function(){V(function(){j.info("invokeDeviceChange(): Fire devicechange event");var e=new Event("devicechange");navigator.mediaDevices.dispatchEvent(e)})},this.sendBinary=function(e){n===r.CONNECTED?t.send(e):j.warn("sendBinary(): WSS is not connected.")};var w=function(){var e="v=0\n",t=Math.random()*Number.MAX_SAFE_INTEGER;return t=Math.floor(t),e=e+"o=- "+String(t)+" 2 IP4 127.0.0.1\n",e+="s=-\n",e+="t= 0 0\n",e+="a=msid-semantic: WMS"},_=function(e){if(e==d.POWEREVENT_SUSPEND)try{j.info("onPowerEvent(): received suspend"),K({event:"vdiRequestEndCalls",reason:"vdiClientPowerEventSuspend"})}catch(e){j.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}else if(e==d.POWEREVENT_RESUME){j.info("onPowerEvent(): received resume");try{K({event:"vdiRequestEndCalls",reason:"vdiClientPowerEventResume"})}catch(e){j.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}}else j.error("powerevent: Invalid param.")},D=function(o,a){var c=n;if(n=a?r.PENDING:r.DISCONNECTED,Object.keys(s).forEach(function(e){var t=new DOMException(o,"OperationError");if(s[e].responseCb)if(s[e].webCommandId===i.createOffer||s[e].webCommandId===i.createAnswer){var n={desc:{sdp:w()}};j.debug("Resolving createoffer/createAnswer with desc "+n.desc),s[e].responseCb(n)}else s[e].responseCb({error:t});else j.error(t)}),s={},t&&t.readyState===WebSocket.OPEN&&n==r.DISCONNECTED&&t.close(),t=null,Object.keys(g).forEach(function(e){g[e].cleanUp()}),g={},m={},p={},R=[],T=[],N={},P={},c===r.CONNECTED){try{K({event:"vdiClientDisconnected",reason:"endpointDisconnected"})}catch(e){j.warn("Catch exception in onVMEvent()"+JSON.stringify(e))}e.invokeDeviceChange()}}},Q={Monitor:1,Window:2,Camera:3},Y=function(e,t,n){var i=this;this.id=e,this.name="",this.image=n,this.icon=void 0,this.getId=function(){return j.debug("getId "+this.id),this.id},this.getDeviceId=function(){return j.debug("getDeviceId "+this.id),"VDI_Mon-"+this.id},this.getType=function(){return Q.Monitor},this.getPreview=function(e,t,n){return j.debug("ScreensAsync getPreview "),new Promise(function(e,t){t()})},this.getPreviewAsync=function(e,t,n){return j.debug("ScreensAsync getPreviewAsync"),n?new Promise(function(e,t){var n=document.createElement("canvas");n.getContext("2d").putImageData(i.image,0,0);var o=n.toDataURL();e({data:o=o.replace("data:image/png;base64,","")})}):new Promise(function(e,t){e(i.image)})},this.getDescription=function(){return j.debug("ScreensAsync getDescription "),this.name},this.getIcon=function(e,t){return j.debug("ScreensAsync getIcon"),new Promise(function(e,t){e(i.image)})},this.getBounds=void 0},Z={createPeerConnection:function(e,t){if(I){if(I.isSocketConnected()){var n=new x(e,t);return g[n.id]=n,I.send({cmd:"createPeerConnection",arg1:e,arg2:t},n.id),j.debug("createPeerConnection(): Create peer: "+n.id),n}j.error("createPeerConnection: WebSocket is not in connected state")}else j.error("createPeerConnection: gRequestManager is not created yet.")},getDisplayMediaShim:function(e){if(I.isSocketConnected())return new Promise(function(t,n){j.debug("getDisplayMediaShim(): Constraints = "+JSON.stringify(e)),I.send({cmd:"getDisplayMediaShim",constraints:e},-1,function(e){if(void 0===e.error){var i=new L;i._create(e.stream),j.debug("getDisplayMediaShim(): Media ="+i.id),t(i)}else n(e.error)})});j.error("getDisplayMediaShim: WebSocket is not in connected state")},mediaDevicesGetUserMediaShim:function(e){if(I.isSocketConnected())return new Promise(function(t,n){Z.getUserMediaShim(e,t,n)});j.error("mediaDevicesGetUserMediaShim: WebSocket is not in connected state")},getUserMediaShim:function(e,t,n){if(j.debug("Constraints: "+JSON.stringify(e)),I.isSocketConnected()){if(void 0!==e.video&&void 0!==e.video.mandatory&&void 0!==e.video.mandatory.sourceId&&void 0!==D[e.video.mandatory.sourceId]){var i=0,o=0,r=0,s=!1,a=e.video.mandatory.sourceId,c=e.video.mandatory.minWidth,d=e.video.mandatory.maxWidth,l=e.video.mandatory.minHeight,u=e.video.mandatory.maxHeight,h=e.video.mandatory.maxFrameRate,f=c,v=l,g={width:0,height:0},m={width:0,height:0};D[a].forEach(function(e){(void 0===c||e.width>=c)&&(void 0===d||e.width<=d)&&(void 0===l||e.height>=l)&&(void 0===u||e.height<=u)&&(void 0===h||e.fps>=h)?(e.width*e.height>g.width*g.height&&(g=e),f&&v&&f*e.height==v*e.width&&e.width*e.height>m.width*m.height&&(m=e)):(void 0!==c&&e.width>=c||void 0!==d&&e.width>=d)&&(s=!0)});var p=m.width>0?m:g;if(p&&(i=p.width,o=p.height,r=p.fps),i>0&&o>0&&r>0)j.debug("Constraints: "+JSON.stringify(e)+" ==> "+i+"x"+o+" @"+r),e.video.mandatory.maxFrameRate=r,e.video.mandatory.maxWidth=e.video.mandatory.minWidth=i,e.video.mandatory.maxHeight=e.video.mandatory.minHeight=o;else{if(!s)return j.debug("getUserMediaShim(): constraints does not match."),void n({name:"OverconstrainedError",message:null});j.debug("getUserMediaShim(): low resolution video forward to client.")}}I.send({cmd:"getUserMediaShim",constraints:e},-1,function(e){if(void 0===e.error){var i=null;void 0!==e.clone&&((i=new L)._create(e.clone),j.debug("Media cloned:"+i.id));var o=new L;o._create(e.stream),o.cloned=i,j.debug("Media:"+o.id),t(o)}else{new DOMException("Abort","AbortError");n(e.error)}})}else j.error("getUserMediaShim: Websocket is not in connected state")},init:function(e){M=e,j.info("init(): VMware VDI shim version = "+l),window.getWindowHandleAsHex().then(function(e){j.info("init(): HWND: "+e),O.hwnd=e,(I=new X).init()},function(e){j.error("init(): Failed to retrieve window handle: "+e.message)})},connectedStateChanged:function(e){j.info("connectedStateChanged called "+e),I&&(I.state===r.CONNECTED&&I.send({cmd:"connectedStateChanged",connectionState:!0===e?1:0},-1),!0===e?(I.sendVdiClientEventsOnError=!0,I.startPolling(I.shortPollingIntervalMs,I.shortPollingTimeout,I.sendEvents)):(I.sendVdiClientEventsOnError=!1,I.isHorizonRegistryPresent=!1,j.info("connectedStateChanged(): isHorizonRegistryPresent false"),I.stopPolling()))},enumerateDevicesShim:function(){return I.isSocketConnected()?new Promise(function(e,t){I.send({cmd:"enumDevices"},-1,function(n){void 0===n.error?(e(n.devices),void 0!==n.caps&&Object.keys(n.caps).forEach(function(e){D[e]=n.caps[e]})):t("enumDevices cancelled.")})}):(j.info("enumerateDevicesShim(): Use fallback mode."),new Promise(function(e,t){S.call(navigator.mediaDevices).then(function(t){e(t),I.isSocketConnected()&&(j.info("enumerateDevicesShim(): [Resolve] Fallback cancelled. Invoke device change."),I.invokeDeviceChange())},function(n){I.isSocketConnected()?(j.info("enumerateDevicesShim(): [Reject] Fallback cancelled. Invoke device change."),e([]),I.invokeDeviceChange()):t(n)})}))},newVideoElement:function(e,t){if(I.isSocketConnected()){j.debug("newVideoElement: New video element from teams.");for(var n=Object.keys(k),i=0;i<n.length;i++){var o=n[i];if(k[o]._rawVideo===e)return void j.debug("newVideoElement(): Video already found")}var r=new q(e,t);k[r._id]=r,e._context=r}else j.error("newVideoElement: WebSocket is not in connected state")},newAudioElement:function(e,t){if(I.isSocketConnected()){j.debug("newAudioElement(): A new audio element created.");for(var n=Object.keys(w),i=0;i<n.length;i++){var o=n[i];if(w[o]._rawAudio===e)return void j.debug("newAudioElement(): Audio already found")}var r=new B(e,t);w[r._id]=r,e._context=r}else j.error("newAudioElement: WebSocket is not in connected state")},setVMEventCallback:function(e){return"function"!=typeof e?(j.error("setVMEventCallback(): The event callback function is not valid."),!1):(j.info("setVMEventCallback(): Set event callback"),C=e,!0)},setVMResultHandler:function(e){return"function"!=typeof e?(j.error("setVMResultHandler(): The event callback function is not valid."),!1):(j.info("setVMResultHandler(): Set result event callback"),E=e,!0)},playNotifyAudio:function(e,t){if(I.isSocketConnected())if(t){var n=!0===_[e];j.debug("playNotifyAudio(): id = "+e+" src = "+t+" loop = "+n),t.startsWith("file:")&&(t="https://teams.microsoft.com/assets/audio"+t.substring(t.lastIndexOf("/")),j.debug("playNotifyAudio(): src map to :"+t));var i=v[e];void 0===i&&(i=f++,v[e]=i),I.send({cmd:"notifyAudio",action:"play",src:t,audid:i,loop:n},-1);var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer",o.onreadystatechange=function(){if(o.readyState==XMLHttpRequest.DONE&&200==o.status){var e=16+o.response.byteLength,n=new Uint8Array(16);n[0]=65,n[1]=78,n[2]=84,n[3]=70,n[4]=e>>24&255,n[5]=e>>16&255,n[6]=e>>8&255,n[7]=255&e,n[8]=i>>24&255,n[9]=i>>16&255,n[10]=i>>8&255,n[11]=255&i;var r=new Uint8Array(e),s=new Uint8Array(o.response);r.set(n,0),r.set(s,16),I.sendBinary(r),j.debug("onreadystatechange(): Send "+e+"bytes")}else j.debug("onreadystatechange(): Download "+t+" status = "+o.status)},o.send()}else j.error("playNotifyAudio(): src cannot be null or undefined");else j.error("playNotifyAudio(): WebSocket is not in connected state")},setLoop:function(e,t){j.debug(e+".loop = "+t),_[e]=t},pauseNotifyAudio:function(e){if(I.isSocketConnected()){j.debug("pauseNotifyAudio(): id = "+e);var t=v[e];void 0===t?j.warn("pauseNotifyAudio(): id = "+e+" did not play yet."):I.send({cmd:"notifyAudio",action:"pause",audid:t},-1)}else j.error("playNotifyAudio: WebSocket is not in connected state")},addClipRect:function(e,t){if(j.debug("addClipRect: "+JSON.stringify(e)),I.isSocketConnected()){var n={cmd:"customClipRect",op:c.ADD,clip:e},i=A(t);i&&(W(t),n.frame=i),I.send(n,-1)}else j.error("addClipRect: WebSocket is not in connected state")},removeClipRect:function(e,t){if(j.debug("removeClipRect: "+JSON.stringify(e)),I.isSocketConnected()){var n={cmd:"customClipRect",op:c.REMOVE,clip:e},i=A(t);i&&(n.frame=i),I.send(n,-1)}else j.error("removeClipRect: WebSocket is not in connected state")},addClipCircle:function(e,t){var n=JSON.parse(JSON.stringify(e));n.colored=!0,j.debug("addClipCircle: "+JSON.stringify(n));var i={cmd:"customClipRect",op:c.ADD,clip:n},o=A(t);o&&(W(t),i.frame=o),I.send(i,-1)},removeClipCircle:function(e,t){var n=JSON.parse(JSON.stringify(e));n.colored=!0,j.debug("removeClipCircle: "+JSON.stringify(n));var i={cmd:"customClipRect",op:c.REMOVE,clip:n},o=A(t);o&&(i.frame=o),I.send(i,-1)},disposeVideoElement:function(e,t){var n=e&&e._context?e._context._id:void 0;j.debug("disposeElement video id="+n)},disposeAudioElement:function(e,t){e&&e._context&&e._context._id;j.debug("disposeElement audio id="+_id)},onWindowClose:function(e){F(e)},setSinkId:function(e,t){if(I.isSocketConnected()){var n=v[e];void 0===n&&(n=f++,v[e]=n),j.debug("setSinkId id = "+n+" srcId = "+e+" Value = "+t),I.send({cmd:"setSinkId",deviceId:t,audioId:n,srcId:e,context:"global"},-1,function(e){})}else j.error("setSinkId: WebSocket is not in connected state")},setDefaultSinkId:function(e){j.debug("setDefaultSinkId = "+e),I.isSocketConnected()?I.send({cmd:"setDefaultSinkId",deviceId:e},-1):j.error("setDefaultSinkId: WebSocket is not in connected state")},isFeatureSupported:function(e){if("string"!=typeof e)return j.error("isFeatureSupported(): Invalid feature parameter"),!1;if(!I||I.state!==r.CONNECTED)return!1;var t=!1;return Array.isArray(R)&&-1!=R.indexOf(e)&&(t=!0),t||j.error("isFeatureSupported(): Input feature string not supported = "+e),t},getScreensAsync:function(){j.debug("getScreensAsync get called.");{if(I.isSocketConnected())return new Promise(function(e,t){I.send({cmd:"getScreens"},-1,function(n){if(Array.isArray(n)){var i=n;T=i,e(i)}else{var o=n.error&&n.error.message?n.error.message:"Invalid getScreen response";t(new DOMException(o,"OperationError"))}})});j.error("getScreensAsync: WebSocket is not in connected state")}},setScreenSharePanelId:function(e){j.debug("setScreenSharePanelId = "+e+" for getDisplayMedia"),I.isSocketConnected()?I.send({cmd:"setScreenId",scrnId:e,numScreens:T.length},-1):j.error("setScreenSharePanelId: WebSocket is not in connected state")},startClientLogsCollection:function(){return null},queryState:function(e){return"requestmanager"===e?I.isSocketConnected():"websocket"===e?I.isSocketOpen():(j.error("queryState() Invalid item: "+e),!1)}};return Z});