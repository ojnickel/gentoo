var msRDCRTC;!function(e){window.vdiPeerConnection=e()}(function(e,t){"use strict";function i(e,t){t.forEach(function(t){Object.defineProperty(e,t,{enumerable:!0,get:function(){return this.readOnlyAttributes[t]},set:function(){throw new TypeError}})})}function n(e,t){t.forEach(function(t){var i=t[0],n=t[1],r=t[2];e.observableAttributes[i]=n,Object.defineProperty(e,i,{enumerable:!0,get:function(){return this.observableAttributes[i]},set:function(e){this.observableAttributes[i]=e,r()}})})}function r(e,t){t.forEach(function(t){var i=t[0],n=t[1],r=t[2];Object.defineProperty(e,i,{enumerable:!0,get:function(){return n(i)},set:function(e){return r(i,e)}})})}function o(e,t){t.forEach(function(t){var o=t[0],c=t[1];if(Object.defineProperty(e,o,{enumerable:!1,writable:!0,value:c}),"readOnlyAttributes"===o){var a=[];for(var o in c)a.push(o);i(e,a)}else"observableAttributes"===o?n(e,c):"customAttributes"===o&&r(e,c)})}function c(e,t){var i="on"+t,n=e.observableAttributes[i],r=e.eventListeners[i];e.eventListeners[i]=n,null!=r&&e.removeEventListener(t,r,!1),null!=n&&e.addEventListener(t,n,!1)}function a(){var e=this;o(this,[["customAttributes",[["size",function(){return e.getSize()},k]]]])}function s(e){return e<0&&(e+=4294967296),"0x"+e.toString(16)}function d(e){var t=[];e.forEach(function(e){t[e.name]={listeners:[],level:e.level}}),this.eventTarget=void 0,this.eventList=t}function u(e){return new Promise(function(t,i){var n=document.createElement("canvas");n.width=e.width,n.height=e.height;var r=n.getContext("2d"),o=new Image(e.width,e.height);o.addEventListener("load",function(){r.drawImage(o,0,0,n.width,n.height),t(r.getImageData(0,0,n.width,n.height))},!1),o.src=e.base64PNGData})}function l(e,t,i){o(this,[["readOnlyAttributes",{rpcObjectType:"ScreenCaptureSource"}]]),this.sourceId=e,this.sharingSourceType=t,this.description=i}function h(){var e=navigator.mediaDevices,t=new d([{name:"devicechange",level:"info"}]);t.setEventTarget(e);var i=this;o(this,[["readOnlyAttributes",{rpcObjectType:"MediaDevices",actualMediaDevicesAddEventListener:e.addEventListener,actualMediaDevicesRemoveEventListener:e.removeEventListener,actualMediaDevicesGetUserMedia:e.getUserMedia,actualMediaDevicesEnumerateDevices:e.enumerateDevices,actualMediaDevicesGetDisplayMedia:e.getDisplayMedia,actualMediaDevicesGetScreensAsync:e.getScreensAsync,actualMediaDevicesSetScreenSharePanelId:e.setScreenSharePanelId}],["observableAttributes",[["ondevicechange",void 0,function(){c(i,"devicechange")}]]],["redirecting",!1],["mediaDevices",null],["audioOutputDevice",null],["eventManager",t],["eventListeners",new a],["deviceList",""],["pending",new Array]]);e.addEventListener=function(){return i.addEventListener.apply(i,arguments)},e.removeEventListener=function(){return i.removeEventListener.apply(i,arguments)},e.getUserMedia=function(){return i.getUserMedia.apply(i,arguments)},e.enumerateDevices=function(){return i.enumerateDevices.apply(i,arguments)},e.getDisplayMedia=function(){return i.getDisplayMedia.apply(i,arguments)},e.getScreensAsync=function(){return i.getScreensAsync.apply(i,arguments)},e.setScreenSharePanelId=function(){return i.setScreenSharePanelId.apply(i,arguments)}}function p(e){var t=this;D.debug("RTCDTMFSenderRedirector("+e+")"),o(this,[["readOnlyAttributes",{rpcObjectType:"RTCDTMFSender",rpcObjectId:e,canInsertDTMF:!0,toneBuffer:""}],["eventManager",new d([{name:"tonechange",level:"info"}])],["eventListeners",new a],["observableAttributes",[["ontonechange",null,function(){c(t,"tonechange")}]]]])}function g(e){o(this,[["readOnlyAttributes",{id:e.id,type:e.type,timestamp:new Date(e.timestamp),rawTimestamp:e.timestamp}]]);var t=new a;for(var i in e.stats)e.stats.hasOwnProperty(i)&&(t[i]=e.stats[i]);this.stats=t}function f(e){var t=new Array;void 0!=e&&e.reports.forEach(function(e){var i=new g(e);t.push(i)}),this.statsReports=t}function v(e,t){var i=this,n=msRDCRTC.getNextRpcObjectId();D.debug("RTCPeerConnectionRedirector("+n+") - config: "+JSON.stringify(e)+", constraints: "+JSON.stringify(t));var r=new d([{name:"negotiationneeded",level:"info"},{name:"icecandidate",level:"info"},{name:"icecandidateerror",level:"error"},{name:"signalingstatechange",level:"info"},{name:"iceconnectionstatechange",level:"info"},{name:"icegatheringstatechange",level:"info"},{name:"connectionstatechange",level:"info"},{name:"track",level:"info"},{name:"addstream",level:"info"},{name:"removestream",level:"info"},{name:"statsended",level:"info"}]);o(this,[["readOnlyAttributes",{rpcObjectType:"RTCPeerConnection",rpcObjectId:n,currentLocalDescription:null,pendingLocalDescription:null,currentRemoteDescription:null,pendingRemoteDescription:null,signalingState:"stable",iceGatheringState:"new",iceConnectionState:"new",connectionState:"new",canTrickleIceCandidates:null}],["observableAttributes",[["onnegotiationneeded",void 0,function(){c(i,"negotiationneeded")}],["onicecandidate",void 0,function(){c(i,"icecandidate")}],["onicecandidateerror",void 0,function(){c(i,"icecandidateerror")}],["onsignalingstatechange",void 0,function(){c(i,"signalingstatechange")}],["oniceconnectionstatechange",void 0,function(){c(i,"iceconnectionstatechange")}],["onicegatheringstatechange",void 0,function(){c(i,"icegatheringstatechange")}],["onconnectionstatechange",void 0,function(){c(i,"connectionstatechange")}],["ontrack",void 0,function(){c(i,"track")}],["onaddstream",void 0,function(){c(i,"addstream")}],["onremovestream",void 0,function(){c(i,"removestream")}],["onstatsended",void 0,function(){c(i,"statsended")}]]],["customAttributes",[["localDescription",function(){return i.getLocalDescription()},k],["remoteDescription",function(){return i.getRemoteDescription()},k]]],["eventManager",r],["eventListeners",new a],["configuration",e],["closed",!1],["senders",[]],["receivers",[]],["transceivers",[]],["defaultIceServers",[]],["sendCapabilities",{}],["recvCapabilities",{}],["stats",void 0],["operations",[]],["opExecutionScheduled",!1],["pendingOp",null],["ready",!1],["eventMap",{signalingstatechange:"signalingState",iceconnectionstatechange:"iceConnectionState",icegatheringstatechange:"iceGatheringState",connectionstatechange:"connectionState"}]]),0!==msRDCRTC.debugLevel&&(this.debugPeriodicCallback=function(){var e=performance.now(),t=i.pendingOp;if(null!=t&&void 0==t.completed){var n=e-t.started;n>=5e3?void 0==t.hung&&(D.error('RTCPeerConnectionRedirector "rpcObjectId":'+i.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has not completed after "+n.toFixed(4)+" ms"),t.hung=!0):n>=1e3&&void 0==t.warned&&(D.warn('RTCPeerConnectionRedirector "rpcObjectId":'+i.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has not completed after "+n.toFixed(4)+" ms"),t.warned=!0)}i.operations.forEach(function(t){var n=e-t.queued;n>=5e3?void 0==t.hung&&(D.error('RTCPeerConnectionRedirector "rpcObjectId":'+i.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has been waiting in the queue for "+n.toFixed(4)+" ms"),t.hung=!0):n>=1e3&&void 0==t.warned&&(D.warn('RTCPeerConnectionRedirector "rpcObjectId":'+i.rpcObjectId+', "opName":'+t.name+', "opId":'+t.id+" has been waiting in the queue for "+n.toFixed(4)+" ms"),t.warned=!0)})}),this.queueOperation("createPeerConnection",function(){return i.makeRpcCall("createPeerConnection",[e,t]).then(function(e){D.debug("RTCPeerConnectionRedirector("+i.rpcObjectId+")::createPeerConnection - sendCapabilities: "+JSON.stringify(e.sendCapabilities)),D.debug("RTCPeerConnectionRedirector("+i.rpcObjectId+")::createPeerConnection - recvCapabilities: "+JSON.stringify(e.recvCapabilities)),i.sendCapabilities=e.sendCapabilities,i.recvCapabilities=e.recvCapabilities,i.senders.forEach(function(e){e.readOnlyAttributes.capabilities=i.sendCapabilities}),i.ready=!0})})}function m(e,t,i,n,r){var s=this,u=void 0==i?msRDCRTC.getNextRpcObjectId():i;if(void 0==n&&(n=msRDCRTC.generateUuid()),D.debug("MediaStreamRedirector("+u+") - id: "+n+", devices: "+JSON.stringify(t)),o(this,[["readOnlyAttributes",{rpcObjectType:"MediaStream",rpcObjectId:u,id:n,constraints:e}],["observableAttributes",[["onaddtrack",void 0,function(){c(s,"addtrack")}],["onremovetrack",void 0,function(){c(s,"removetrack")}]]],["eventManager",new d([{name:"addtrack",level:"info"},{name:"removetrack",level:"info"}])],["eventListeners",new a],["audioTracks",[]],["videoTracks",[]],["devices",t]]),void 0==i&&(this.makeRpcCall("createMediaStream",[{id:this.id,constraints:this.constraints}]),void 0==r))for(var l in t){var h=new b(this,t[l]);this.addTrack(h)}}function b(e,t,i,n,r){var s=this,u=void 0==i?msRDCRTC.getNextRpcObjectId():i;void 0==n&&(n=msRDCRTC.generateUuid());var l=null;if(void 0!=r)l=r;else if("audioinput"===t.kind||"audiooutput"===t.kind)l="audio";else if("videoinput"===t.kind)l="video";else{if("displayoutput"!==t.kind)throw new Error({name:"MSRDCRTC: E_NOTIMPL",message:"device not supported - kind="+t.kind});l="screenshare"}D.debug("MediaStreamTrackRedirector("+u+") - id: "+n+", kind: "+l+", stream rpcObjectId: "+e.rpcObjectId);var h=new d([{name:"mute",level:"info"},{name:"unmute",level:"info"},{name:"ended",level:"info"},{name:"overconstrained",level:"warn"}]),p=void 0;"audio"===l&&n.match(/.*-(\d+)$/)&&(p=n.replace(/.*-(\d+)$/,"$1")),o(this,[["readOnlyAttributes",{rpcObjectType:"MediaStreamTrack",rpcObjectId:u,mediaStreamRpcObjectId:e.rpcObjectId,deviceRpcObjectId:t.rpcObjectId,kind:l,id:n,label:t.label,muted:!1,readyState:"live"}],["observableAttributes",[["enabled",!0,function(){s.onEnabledAttributeChanged()}],["onmute",void 0,function(){c(s,"mute")}],["onunmute",void 0,function(){c(s,"unmute")}],["onended",void 0,function(){c(s,"ended")}],["onoverconstrained",void 0,function(){c(s,"overconstrained")}]]],["mediaStream",e],["device",t],["eventManager",h],["eventListeners",new a],["ssrc",p]]),void 0==i&&this.makeRpcCall("createMediaStreamTrack",[{mediaStreamRpcObjectId:e.rpcObjectId,id:this.id,kind:this.kind,label:this.label}])}function R(e,t,i,n){var r=msRDCRTC.getNextRpcObjectId();D.debug("RTCRtpSenderRedirector("+r+") - kind: "+t.kind+", pc rpcObjectId: "+e.rpcObjectId);var c=null;"audio"===t.kind&&(c=new p(r)),o(this,[["readOnlyAttributes",{rpcObjectType:"RTCRtpSender",rpcObjectId:r,track:t,kind:t.kind,transport:null,rtcpTransport:null,dtmf:c}],["ready",!1],["peerConnection",e],["streams",i],["sendEncodings",n],["parameters",null],["capabilities",e.sendCapabilities]])}function C(e,t,i,n){var r=void 0==i?msRDCRTC.getNextRpcObjectId():i;D.debug("RTCRtpReceiverRedirector("+r+") - kind: "+t+", pc rpcObjectId: "+e.rpcObjectId),o(this,[["readOnlyAttributes",{rpcObjectType:"RTCRtpReceiver",rpcObjectId:r,track:void 0==n?null:n,kind:t,transport:null,rtcpTransport:null}],["peerConnection",e],["parameters",null],["contributingSources",[]],["synchronizationSources",[]],["capabilities",e.recvCapabilities],["lastAudioReceived",void 0]])}function O(e,t){var i=this,n=msRDCRTC.getNextRpcObjectId();D.debug("MediaElementRedirector("+n+") - kind: "+e);var r=new d([{name:"loadstart",level:"info"},{name:"abort",level:"info"},{name:"emptied",level:"info"},{name:"stalled",level:"info"},{name:"play",level:"info"},{name:"pause",level:"info"},{name:"loadedmetadata",level:"info"},{name:"loadeddata",level:"info"},{name:"waiting",level:"info"},{name:"playing",level:"info"},{name:"canplay",level:"info"},{name:"canplaythrough",level:"info"},{name:"ended",level:"info"},{name:"durationchange",level:"info"},{name:"volumechange",level:"info"},{name:"timeupdate",level:"ignore"},{name:"progress",level:"ignore"},{name:"contextmenu",level:"info"},{name:"error",level:"error"}]);r.setEventTarget(t);var c=function(e){return i.getAttribute(e)},s=function(e,t){return i.setAttribute(e,t)};o(this,[["readOnlyAttributes",{rpcObjectType:"MediaElement",rpcObjectId:n,kind:e,duration:Number.NaN,readyState:this.HAVE_NOTHING,networkState:this.NETWORK_EMPTY,paused:t.paused,currentTime:0,ended:!1}],["redirecting",!1],["mediaElement",t],["eventManager",r],["eventListeners",new a],["actualGetAttribute",t.getAttribute],["actualSetAttribute",t.setAttribute],["actualRemoveAttribute",t.removeAttribute],["actualAddEventListener",t.addEventListener],["actualRemoveEventListener",t.removeEventListener],["actualPlay",t.play],["actualPause",t.pause],["actualLoad",t.load],["actualSetSinkId",t.setSinkId],["getAttributeFunctor",c],["setAttributeFunctor",s],["removeAttributeFunctor",function(e){return i.removeAttribute(e)}],["addEventListenerFunctor",function(e,t,n){return i.addEventListener(e,t,n)}],["removeEventListenerFunctor",function(e,t,n){return i.removeEventListener(e,t,n)}],["onResizeFunctor",function(){return i.onPositionChanged("onresize")}],["playFunctor",function(){return i.play()}],["pauseFunctor",function(){return i.pause()}],["loadFunctor",function(){return i.load()}],["setSinkIdFunctor",function(e){return i.setSinkId(e)}],["srcObject",null],["autoplay",t.autoplay],["muted",t.muted],["volume",t.volume],["videoWidth",0],["videoHeight",0],["lastPlayAt",0],["progressIntervalId",void 0],["boundingRect",void 0],["scaleFactor",void 0],["objectFit",t.style.objectFit]]),o(t,[["customAttributes",[["srcObject",c,s],["loop",c,s],["autoplay",c,s],["muted",c,s],["volume",c,s]]]]);var u=[e];if("video"===e){o(t,[["observableAttributes",[["data-vdi_videoid",t["data-vdi_videoid"],function(){i.onVdiVideoIdChanged()}],["data-toggle",t["data-toggle"],function(){i.onVdiDataToggleChanged()}]]]]);var l=t.getBoundingClientRect();D.debug("MediaElementRedirector("+n+") - bounding client rect: "+JSON.stringify(l)),this.boundingRect=l,u.push({top:l.top,right:l.right,bottom:l.bottom,left:l.left})}this.makeRpcCall("createMediaElement",u)}function S(e,t){var i=(e+t).replace(/-/g,"").match(/[0-9a-f]{2}/gi),n=new ArrayBuffer(i.length),r=new Uint8Array(n);for(var o in i)r[o]=parseInt(i[o],16);this.rawKey=n,this.key=void 0}function E(){this.vmEventCallback=void 0,this.connectionState=this.STATE_NOT_CONNECTED,this.endpointUnsupported=!1,this.webSocketUnavailable=!1,this.clientFeatures=void 0,this.debugLevel=0,this.socket=null,this.socketConnected=!1,this.socketClosed=!0,this.rtcSessionStarted=!1,this.enumerateDevicesOnConnect=!1,this.pendingMessages=[],this.outstandingRpcCalls=new a,this.actualRTCPeerConnection=RTCPeerConnection,this.mediaDevicesRedirector=new h,this.rtcObjects=[this.mediaDevicesRedirector],this.nextPeerConnectionId=1,this.nextVideoElementId=1,this.nextRpcObjectId=1,this.nextRpcCallId=1,this.nextOperationId=1,this.uniqueIds=new a,this.defaultSinkId=void 0,this.notifications=new a;var e=this;this.onWebSocketOpenFunctor=function(t){e.onWebSocketOpen(t)},this.onWebSocketClosedFunctor=function(t){e.onWebSocketClosed(t)},this.onWebSocketErrorFunctor=function(t){e.onWebSocketError(t)},this.onWebSocketMessageFunctor=function(t){e.onWebSocketMessage(t)}}var T,y={debug:function(){},info:function(e){T.info("MSRDCRTC: [I] "+e)},warn:function(e){T.warn("MSRDCRTC: [W] "+e)},error:function(e){T.error("MSRDCRTC: [E] "+e)}},I={debug:function(e){T.debug("MSRDCRTC: [D] "+e)},info:function(e){T.info("MSRDCRTC: [I] "+e)},warn:function(e){T.warn("MSRDCRTC: [W] "+e)},error:function(e){T.error("MSRDCRTC: [E] "+e)}},N={debug:function(e){console.debug("MSRDCRTC: [D] "+e)},info:function(e){console.info("MSRDCRTC: [I] "+e)},warn:function(e){console.warn("MSRDCRTC: [W] "+e)},error:function(e){console.error("MSRDCRTC: [E] "+e)}},D=y,A=function(){},k=function(){throw new TypeError},j=function(){throw new InvalidStateError};return a.prototype={forEach:function(e){for(var t in this)"size"!==t&&this.hasOwnProperty(t)&&e(t)},get:function(e){return this[e]},has:function(e){return void 0!=this[e]},keys:function(){var e=[];return this.forEach(function(t){e.push(t)}),e},values:function(){var e=[],t=this;return this.forEach(function(i){e.push(t.get(i))}),e},getSize:function(){return this.keys().length}},d.prototype={addEventListener:function(e,t,i){var n=this.eventList[e];void 0!=n?n.listeners.push(t):D.warn("EventManager::addEventListener called for unexpected event: "+e)},removeEventListener:function(e,t,i){var n=this.eventList[e];if(void 0!=n){var r=n.listeners;for(var o in r)if(r[o]===t){r.splice(o,1);break}}else D.warn("EventManager::removeEventListener called for unexpected event: "+e)},setEventTarget:function(e){this.eventTarget=e},fireEvent:function(e,t){var i=this.eventList[e];if(void 0==i)return D.warn("event not expected: "+e),!1;var n=i.level;"ignore"!==n&&("debug"===n?D.debug:"info"===n?D.info:"warn"===n?D.warn:D.error)("EventManager::fireEvent('"+e+"')");var r=document.createEvent("HTMLEvents");if(r.initEvent(e,!1,!0),void 0!=t)for(var o in t)r[o]=t[o];if(void 0!=this.eventTarget)this.eventTarget.dispatchEvent(r);else{i.listeners.forEach(function(e){e(r)})}return!0}},l.prototype={getId:function(){return D.debug("ScreenCaptureSource::getId() returning "+this.sourceId),this.sourceId},getDeviceId:function(){return D.debug("ScreenCaptureSource::getDeviceId() returning "+this.description),this.description},getType:function(){return D.debug("ScreenCaptureSource::getType() returning "+this.sharingSourceType),this.sharingSourceType},getPreview:function(e,t,i){return D.debug("ScreenCaptureSource::getPreview(width: "+e+" height: "+t+" asImage: "+i+")"),new Promise(function(e,t){t(null)})},getPreviewAsync:function(e,t){var i=this;return D.debug("ScreenCaptureSource::getPreviewAsync(width: "+e+" height: "+t+")"),new Promise(function(n,r){i.makeRpcCall("getPreviewAsync",[{width:e,height:t,sourceId:i.sourceId}],!0).then(function(e){D.debug("ScreenCaptureSource::getPreviewAsync returning"+JSON.stringify(e)+")"),u(e).then(function(e){D.debug("ScreenCaptureSource::getPreviewAsync imageData: "+e+")"),n(e)})}).catch(function(e){r(e)})})},getDescription:function(){return D.debug("ScreenCaptureSource::getDescription() returning "+this.description),this.description},getIcon:function(e,t){return D.debug("ScreenCaptureSource::getIcon(width: "+e+" height: "+t+")"),new Promise(function(e,t){t(null)})},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcName:e,rpcArgs:t},i)}},h.prototype={enableRedirection:function(){this.redirecting=!0},disableRedirection:function(){this.redirecting=!1,this.mediaDevices=null,this.deviceList="",this.pending=new Array},addEventListener:function(e,t,i){D.debug("MediaDevicesRedirector adding event listener for: "+e),this.eventManager.addEventListener(e,t,i),this.actualMediaDevicesAddEventListener.apply(navigator.mediaDevices,arguments)},removeEventListener:function(e,t,i){D.debug("MediaDevicesRedirector removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i),this.actualMediaDevicesRemoveEventListener.apply(navigator.mediaDevices,arguments)},enumerateDevices:function(){if(D.debug("MediaDevicesRedirector::enumerateDevices("+JSON.stringify(arguments)+")"),!this.redirecting)return D.info("returning empty array"),msRDCRTC.enumerateDevicesOnConnect=!0,new Promise(function(e,t){e([])});var e=this;if(null!=this.mediaDevices)return new Promise(function(t,i){D.debug("MediaDevicesRedirector::enumerateDevices returning: "+JSON.stringify(e.mediaDevices)),t(e.mediaDevices)});var t={},i=new Promise(function(e,i){t.resolve=function(t){D.debug("MediaDevicesRedirector::enumerateDevices returning: "+JSON.stringify(t)),e(t)},t.reject=function(e){i(e)}});return this.pending.push(t),1==this.pending.length&&e.makeRpcCall("enumerateDevices",arguments).then(function(t){e.onEnumerateDevices(t),e.pending.forEach(function(e){e.resolve(t)}),e.pending=new Array}).catch(function(t){e.pending.forEach(function(e){e.reject(t)}),e.pending=new Array}),i},onEnumerateDevices:function(e){var t=JSON.stringify(e);if(t!==this.deviceList){this.deviceList=t,this.mediaDevices=e,this.audioOutputDevice=null;for(var i in e){var n=e[i];if("audiooutput"===n.kind&&null==this.audioOutputDevice){this.audioOutputDevice=n;break}}this.eventManager.fireEvent("devicechange")}},getUserMedia:function(){if(D.debug("MediaDevicesRedirector::getUserMedia("+JSON.stringify(arguments)+")"),!msRDCRTC.redirectionSupported())return D.info("passing through call to actual MediaDevices.getUserMedia"),this.actualMediaDevicesGetUserMedia.apply(navigator.mediaDevices,arguments);var e,t,i;if(arguments.length<=1?e=arguments[0]:(e=arguments[0],t=arguments[1],i=arguments[2]),void 0==e||0===Object.keys(e).length)throw new TypeError("getUserMedia() constraints must not be the empty set.");var n=!1,r=!1;if(!0===e||e.audio&&e.video?(n=!0,r=!0):e.audio?n=!0:e.video&&(r=!0),!n&&!r)throw new TypeError("getUserMedia() constraints not supported.");var o=this;return null==this.mediaDevices?new Promise(function(c,a){o.enumerateDevices().then(function(s){o.completeGetUserMedia(e,n,r,t,i,c,a)}).catch(function(e){a(e)})}):new Promise(function(c,a){o.completeGetUserMedia(e,n,r,t,i,c,a)})},completeGetUserMedia:function(e,t,i,n,r,o,c){var a,s,d=new Array;t&&e.audio&&(a=e.audio.deviceId),i&&e.video&&(s=e.video.deviceId);for(var u=void 0===a,l=void 0===s,h=!1,p=!1,g=null==this.mediaDevices?0:this.mediaDevices.length,f=0;f<g;++f){var v=this.mediaDevices[f];if(t&&"audioinput"===v.kind&&!h?(u||v.deviceId===a)&&(d.push(v),h=!0):i&&"videoinput"===v.kind&&!p&&(l||v.deviceId===s)&&(d.push(v),p=!0),h&&p)break}if(d.length>0){var b=new m(e,d);D.debug("MediaDevicesRedirector::getUserMedia returning: "+JSON.stringify(b)),void 0!=n?(n(b),o()):o(b)}else{var R=t?i?"audio or video":"audio":"video",C=new Error({name:"MSRDCRTC Error",message:"No "+R+" input device found."});void 0!=r&&r(C),c(C)}},getDisplayMedia:function(){D.debug("MediaDevicesRedirector::getDisplayMedia("+JSON.stringify(arguments)+")");var e,t,i;if(arguments.length<=1?e=arguments[0]:(e=arguments[0],t=arguments[1],i=arguments[2]),void 0==e||0===Object.keys(e).length)throw new TypeError("getDisplayMedia() constraints must not be the empty set.");var n=!0===e||e.video,r=this;return new Promise(function(o,c){r.completeGetDisplayMedia(e,n,t,i,o,c)})},completeGetDisplayMedia:function(e,t,i,n,r,o){var c=new Array;if(c.push(JSON.parse('{"deviceId":"display","kind":"displayoutput","label":"Session Desktop"}')),t&&e.video){var a=new m(e,c);D.debug("MediaDevicesRedirector::getDisplayMedia returning: "+JSON.stringify(a)),void 0!=i?(i(a),r()):r(a)}},onDeviceChange:function(e){this.onEnumerateDevices(e.mediaDevices)},onRpcEventNotification:function(e){var t=!1;return e.rpcEventTarget.rpcObjectType===this.rpcObjectType&&"devicechange"===e.rpcEventName&&(this.onDeviceChange(e.rpcEventArgs),t=!0),t},getScreensAsync:function(){D.debug("MediaDevicesRedirector::getScreensAsync()");var e=this;return new Promise(function(t,i){e.makeRpcCall("getScreensAsync",[],!0).then(function(e){var i=new Array;for(var n in e){var r=new l(e[n].sourceId,e[n].sharingSourceType,e[n].description);i.push(r)}D.debug("MediaDevicesRedirector::getScreensAsync returning: "+JSON.stringify(i)),t(i)}).catch(function(e){i(e)})})},setScreenSharePanelId:function(){D.debug("MediaDevicesRedirector::setScreenSharePanelId("+JSON.stringify(arguments)+")");var e=arguments[0];this.makeRpcCall("setScreenSharePanelId",[{id:e}])},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcName:e,rpcArgs:t},i)}},p.prototype={addEventListener:function(e,t,i){D.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,i)},removeEventListener:function(e,t,i){D.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i)},insertDTMF:function(e,t,i){D.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+") - Inserting tones ["+e+"] with Duration:"+t+" and Gap:"+i),this.makeRpcCall("insertDTMF",[{tones:e,duration:t,gap:i}])},onToneChange:function(e,t){D.debug("RTCDTMFSenderRedirector("+this.rpcObjectId+")::onToneChange("+JSON.stringify(e)+", "+JSON.stringify(t)+")"),this.readOnlyAttributes.toneBuffer=t,this.eventManager.fireEvent("tonechange",{tone:e})},makeRpcCall:function(e,t){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t})}},g.prototype={names:function(){return this.stats.keys()},stat:function(e){return this.stats.get(e)}},f.prototype={namedItem:function(){return null},result:function(){return this.statsReports}},v.prototype={addEventListener:function(e,t,i){D.debug("adding event listener for: "+e),this.eventManager.addEventListener(e,t,i)},removeEventListener:function(e,t,i){D.debug("removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i)},createOffer:function(){D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::createOffer("+JSON.stringify(arguments)+")");var e,t,i;arguments.length<=1?e=arguments[0]:(t=arguments[0],i=arguments[1],e=arguments[2]);var n=this;return new Promise(function(r,o){n.queueOperation("createOffer",function(){return n.makeRpcCall("createOffer",[e]).then(function(e){void 0!=t?(D.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::createOffer - returning: "+JSON.stringify(e.desc)),t(e.desc),r()):r(e.desc)}).catch(function(e){void 0!=i&&i(e),o(e)})})})},createAnswer:function(){if(D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::createAnswer("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,i;arguments.length<=1?e=arguments[0]:(t=arguments[0],i=arguments[1]);var n=this;return new Promise(function(r,o){n.queueOperation("createAnswer",function(){return n.makeRpcCall("createAnswer",[e]).then(function(e){void 0!=t?(D.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::createAnswer - returning: "+JSON.stringify(e.desc)),t(e.desc),r()):r(e.desc)}).catch(function(e){void 0!=i&&i(e),o(e)})})})},setLocalDescription:function(){if(D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setLocalDescription("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,i=arguments[0];arguments.length>1&&(e=arguments[1],t=arguments[2]),this.readOnlyAttributes.pendingLocalDescription=i;var n=this;return new Promise(function(r,o){n.queueOperation("setLocalDescription",function(){return n.makeRpcCall("setLocalDescription",[i]).then(function(t){n.readOnlyAttributes.currentLocalDescription=i,n.readOnlyAttributes.pendingLocalDescription=null,void 0!=e&&(D.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::setLocalDescription - calling successCallback"),e()),r()}).catch(function(e){n.readOnlyAttributes.pendingLocalDescription=null,void 0!=t&&t(e),o(e)})})})},setRemoteDescription:function(){if(D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setRemoteDescription("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,i=arguments[0];arguments.length>1&&(e=arguments[1],t=arguments[2]),this.readOnlyAttributes.pendingRemoteDescription=i;var n=this;return new Promise(function(r,o){n.queueOperation("setRemoteDescription",function(){return n.makeRpcCall("setRemoteDescription",[i]).then(function(t){n.readOnlyAttributes.currentRemoteDescription=i,n.readOnlyAttributes.pendingRemoteDescription=null,void 0!=e&&(D.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::setRemoteDescription - calling successCallback"),e()),r()}).catch(function(e){n.readOnlyAttributes.pendingRemoteDescription=null,void 0!=t&&t(e),o(e)})})})},addIceCandidate:function(){if(D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addIceCandidate("+JSON.stringify(arguments)+")"),this.closed)return new Promise(function(e,t){t(new InvalidStateError)});var e,t,i=arguments[0];arguments.length>1&&(e=arguments[1],t=arguments[2]);var n=this;return new Promise(function(r,o){n.queueOperation("addIceCandidate",function(){return n.makeRpcCall("addIceCandidate",[i]).then(function(t){D.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::addIceCandidate - updating remoteDescription: "+JSON.stringify(t.result)),n.remoteDescription=t.result,void 0!=e&&(D.debug("RTCPeerConnectionRedirector("+n.rpcObjectId+")::addIceCandidate - calling successCallback"),e()),r()}).catch(function(e){void 0!=t&&t(e),o(e)})})})},getDefaultIceServers:function(){return D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getDefaultIceServers("+JSON.stringify(arguments)+")"),D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getDefaultIceServers returning: "+JSON.stringify(this.defaultIceServers)),this.defaultIceServers},getConfiguration:function(){return D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getConfiguration("+JSON.stringify(arguments)+")"),D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getConfiguration returning: "+JSON.stringify(this.configuration)),this.configuration},setConfiguration:function(e){D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setConfiguration("+JSON.stringify(arguments)+")"),this.configuration=e;var t=this;this.queueOperation("setConfiguration",function(){return t.makeRpcCall("setConfiguration",[e]).then(function(){t.configuration=e})})},close:function(){if(D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::close("+JSON.stringify(arguments)+")"),!this.closed){var e=this;this.queueOperation("close",function(){return e.makeRpcCall("close").finally(function(){e.closed=!0})})}},getSenders:function(){return D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getSenders("+JSON.stringify(arguments)+")"),D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getSenders returning: "+JSON.stringify(this.senders)),this.senders},getReceivers:function(){return D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getReceivers("+JSON.stringify(arguments)+")"),D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getReceivers returning: "+JSON.stringify(this.receivers)),this.receivers},addStream:function(e){D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addStream("+JSON.stringify(arguments)+")");var t=this;e.getTracks().forEach(function(i){t.internalAddTrack(i,e)})},removeStream:function(){D.error("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addStream("+JSON.stringify(arguments)+") - E_NOTIMPL")},addTrack:function(){return D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addTrack("+JSON.stringify(arguments)+")"),this.internalAddTrack.apply(this,arguments)},removeTrack:function(e){D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::removeTrack("+JSON.stringify(arguments)+")");var t=this;this.queueOperation("removeTrack",function(){return t.makeRpcCall("removeTrack",[{senderRpcObjectId:e.rpcObjectId}])})},addTransceiver:function(e,t){D.error("RTCPeerConnectionRedirector("+this.rpcObjectId+")::addTransceiver("+JSON.stringify(arguments)+") - E_NOTIMPL")},createDTMFSender:function(){D.error("RTCPeerConnectionRedirector("+this.rpcObjectId+")::createDTMFSender("+JSON.stringify(arguments)+") - E_NOTIMPL")},getLocalStreams:function(){D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getLocalStreams("+JSON.stringify(arguments)+")");var e=new Array;return this.senders.forEach(function(t){e=e.concat(t.streams)}),D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getLocalStreams - returning: "+JSON.stringify(e)),e},getRemoteStreams:function(){D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getRemoteStreams("+JSON.stringify(arguments)+")");var e=new Array;return this.receivers.forEach(function(t){e=e.concat(t.track.mediaStream)}),D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getRemoteStreams - returning: "+JSON.stringify(e)),e},getStats:function(){D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getStats("+JSON.stringify(arguments)+")");var e,t;arguments.length>0&&void 0!=arguments[0]&&"function"==typeof arguments[0]?e=arguments[0]:t=arguments[0];var i={};void 0!=t&&(i={selectorRpcObjectType:t.rpcObjectType,selectorRpcObjectId:t.rpcObjectid});var n=this;return this.closed?void 0!=e?void e(new f):new Promise(function(e,t){t(new InvalidStateError)}):this.ready?new Promise(function(t,r){n.makeRpcCall("getStats",[i]).then(function(i){if(n.updateContributingSources(i.receivers),void 0!=e){var r=new f(i);return n.stats=r,void e(r)}var o=new a;for(var c in i){var s=i[c];o[s.id]=s}t(o)}).catch(function(e){r(e)})}):void 0!=e?void e(new f):new Promise(function(e,t){e(new a)})},setState:function(e,t,i){var n=this.readOnlyAttributes[e];n!==t&&(this.readOnlyAttributes[e]=t,D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::setState - "+e+" changed from: "+n+" to: "+t),"iceGatheringState"===e&&"complete"===t&&this.eventManager.fireEvent("icecandidate"),this.eventManager.fireEvent(i))},setIceConnectionState:function(e){this.setState("iceConnectionState",e,"iceconnectionstatechange")},getLocalDescription:function(){var e=void 0!=this.readOnlyAttributes.pendingLocalDescription,t=this.readOnlyAttributes.pendingLocalDescription||this.readOnlyAttributes.currentLocalDescription;return D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getLocalDescription - pending="+e+": "+JSON.stringify(t)),t},getRemoteDescription:function(){var e=void 0!=this.readOnlyAttributes.pendingRemoteDescription,t=this.readOnlyAttributes.pendingRemoteDescription||this.readOnlyAttributes.currentRemoteDescription;return D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::getRemoteDescription - pending="+e+": "+JSON.stringify(t)),t},getReceiverByRpcObjectId:function(e){var t=null;return this.receivers.some(function(i){return i.rpcObjectId==e&&(t=i),null!=t}),t},internalAddTrack:function(e,t){D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+")::internalAddTrack("+JSON.stringify(arguments)+")"),void 0!=t&&(t=(new Array).concat(t));var i=new R(this,e,t,void 0),n=this,r=new Array;return void 0!=t&&t.forEach(function(e){r.push(e.rpcObjectId)}),this.queueOperation("addTrack",function(){return n.makeRpcCall("addTrack",[{trackRpcObjectId:e.rpcObjectId,streamRpcObjectIds:r,senderRpcObjectId:i.rpcObjectId}]).then(function(e){i.ready=!0})}),this.senders.push(i),i},onTrack:function(e){D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onTrack - "rpcObjectId":'+this.rpcObjectId+" - "+JSON.stringify(e));var t=e.receiver,i=e.stream,n=e.track,r=new Array,o=msRDCRTC.mediaDevicesRedirector.audioOutputDevice,c=new m(void 0,[o],i.rpcObjectId,i.id),a=new b(c,o,n.rpcObjectId,n.id,t.kind);c.addTrack(a);var s=new C(this,t.kind,t.rpcObjectId,a);this.receivers.push(s);var d={track:a,receiver:s,streams:r};return this.eventManager.fireEvent("addstream",{stream:c}),d},onRemoveTrack:function(e){D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onRemoveTrack - "rpcObjectId":'+this.rpcObjectId+" - "+JSON.stringify(e));var t=e.receiverRpcObjectId,i=void 0;for(var n in this.receivers){var r=this.receivers[n];if(r.rpcObjectId===t){i=r.track.mediaStream,this.receivers.splice(n,1);break}}this.eventManager.fireEvent("removestream",{stream:i})},onIceCandidate:function(e){return D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::onIceCandidate - "rpcObjectId":'+this.rpcObjectId+" - updating localDescription: "+JSON.stringify(e.desc)),this.readOnlyAttributes.currentLocalDescription=e.desc,e},updateContributingSources:function(e){if(e)for(var t in this.receivers){var i=this.receivers[t],n=e.find(function(e){return e.rpcObjectId===i.rpcObjectId});n?i.updateContributingSources(n.contributingSources):i.updateContributingSources([])}},queueOperation:function(e,t){var i=this.operations.length,n={id:msRDCRTC.getNextOperationId(),name:e,op:t,queued:performance.now(),started:void 0,completed:void 0};D.debug("RTCPeerConnectionRedirector("+this.rpcObjectId+')::queueOperation - "rpcObjectId":'+this.rpcObjectId+', "opName":'+n.name+', "opId":'+n.id+", "+i+" operation"+(1!==i?"s":"")+" ahead in queue"),this.operations.push(n),this.scheduleNextOperation()},scheduleNextOperation:function(e){if(!this.opExecutionScheduled&&null==this.pendingOp&&this.operations.length>0){this.opExecutionScheduled=!0;var t=this;window.setTimeout(function(){t.executeNextOperation()},0)}},executeNextOperation:function(){this.opExecutionScheduled=!1;var e=this.operations.shift();if(void 0!=e)if(null==this.pendingOp){this.pendingOp=e;var t=this;e.started=performance.now();var i=e.started-e.queued;(i>=5e3?D.error:i>=1e3?D.warn:D.debug)("RTCPeerConnectionRedirector("+this.rpcObjectId+')::executeNextOperation - "rpcObjectId":'+this.rpcObjectId+', "opName":'+e.name+', "opId":'+e.id+" is starting after waiting in queue for "+i.toFixed(4)+" ms"),e.op().then(function(){e.completed=performance.now();var i=e.started-e.queued,n=e.completed-e.started;(i>=5e3||n>=5e3?D.error:i>=1e3||n>=1e3?D.warn:D.debug)('RTCPeerConnectionRedirector "rpcObjectId":'+t.rpcObjectId+', "opName":'+e.name+', "opId":'+e.id+" took "+n.toFixed(4)+" ms, after sitting in the queue for "+i.toFixed(4)+" ms")}).finally(function(){t.pendingOp=null,t.scheduleNextOperation()})}else D.error("RTCPeerConnectionRedirector("+this.rpcObjectId+')::executeNextOperation "rpcObjectId":'+this.rpcObjectId+" was called while an operation was pending.");else void 0!=e&&D.debug('RTCPeerConnectionRedirector "rpcObjectId":'+this.rpcObjectId+" is closed - dropping operation")},disableRedirection:function(){this.closed||(this.pendingOp=null,this.operations=new Array,"new"!==this.iceConnectionState&&(D.info("RTCPeerConnectionRedirector("+this.rpcObjectId+")::disableRedirection - iceConnectionState changing from: "+this.iceConnectionState+" to: failed"),this.setIceConnectionState("failed")),this.closed=!0)},onRpcEventNotification:function(e){var t=!1,i=e.rpcEventTarget,n=e.rpcEventArgs;if(i.rpcObjectType===this.rpcObjectType&&i.rpcObjectId===this.rpcObjectId){var r=e.rpcEventName,o=n&&n.state;if(void 0!=o){var c=this.eventMap[r];void 0!=c&&(this.setState(c,o,r),t=!0)}t||("removetrack"===r?(this.onRemoveTrack(n),t=!0):("track"===r?n=this.onTrack(n):"icecandidate"===r&&(n=this.onIceCandidate(n)),t=this.eventManager.fireEvent(r,n)))}else"RTCRtpReceiver"===i.rpcObjectType?this.getReceivers().forEach(function(i){void 0!=i.onRpcEventNotification&&i.onRpcEventNotification(e)&&(t=!0)}):"RTCRtpSender"===i.rpcObjectType&&this.getSenders().forEach(function(i){void 0!=i.onRpcEventNotification&&i.onRpcEventNotification(e)&&(t=!0)});return t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},m.prototype={addEventListener:function(e,t,i){D.debug("MediaStreamRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,i)},removeEventListener:function(e,t,i){D.debug("MediaStreamRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i)},getAudioTracks:function(){return D.debug("MediaStreamRedirector("+this.rpcObjectId+")::getAudioTracks("+JSON.stringify(arguments)+")"),D.debug("MediaStreamRedirector("+this.rpcObjectId+")::getAudioTracks returning: "+JSON.stringify(this.audioTracks)),this.audioTracks},getVideoTracks:function(){return D.debug("MediaStreamRedirector("+this.rpcObjectId+")::getVideoTracks("+JSON.stringify(arguments)+")"),D.debug("MediaStreamRedirector("+this.rpcObjectId+")::getVideoTracks returning: "+JSON.stringify(this.videoTracks)),this.videoTracks},getTracks:function(){D.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTracks("+JSON.stringify(arguments)+")");var e=this.audioTracks.concat(this.videoTracks);return D.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTracks returning: "+JSON.stringify(e)),e},getTrackById:function(e){D.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTrackById("+JSON.stringify(arguments)+")");var t=null;for(var i in this.audioTracks)if(i.id===e){t=i;break}if(null==t)for(var i in this.videoTracks)if(i.id===e){t=i;break}return D.debug("MediaStreamRedirector("+this.rpcObjectId+")::getTrackById returning: "+JSON.stringify(t)),t},addTrack:function(e){if(D.debug("MediaStreamRedirector("+this.rpcObjectId+")::addTrack("+JSON.stringify(arguments)+")"),null==this.getTrackById(e.id)){if("audio"===e.kind)this.audioTracks.push(e);else{if("video"!==e.kind&&"screenshare"!==e.kind)throw new TypeError("addTrack - unsupported track kind: "+e.kind);this.videoTracks.push(e)}this.eventManager.fireEvent("addtrack")}},removeTrack:function(e){if(D.debug("MediaStreamRedirector("+this.rpcObjectId+")::removeTrack("+JSON.stringify(arguments)+")"),null!=this.getTrackById(e.id)){var t=null;if("audio"===e.kind)t=this.audioTracks;else{if("video"!==e.kind&&"screenshare"!==e.kind)throw new TypeError("removeTrack - unsupported track kind: "+e.kind);t=this.videoTracks}var i=e.id;for(var n in t)if(t[n].id===i){t.splice(n,1);break}this.eventManager.fireEvent("removetrack")}},clone:function(){D.debug("MediaStreamRedirector("+this.rpcObjectId+")::clone");var e=new m(this.constraints,this.devices,void 0,void 0,"cloning");return this.getTracks().forEach(function(t){var i=t.internalClone(e);e.addTrack(i)}),D.debug("MediaStreamRedirector("+this.rpcObjectId+")::clone - returning: "+JSON.stringify(e)),e},onRpcEventNotification:function(e){var t=!1,i=e.rpcEventTarget;return i.rpcObjectType===this.rpcObjectType&&i.rpcObjectId===this.rpcObjectId&&(t=this.eventManager.fireEvent(e.rpcEventName,e.rpcEventArgs)),t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},b.prototype={addEventListener:function(e,t,i){D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,i)},removeEventListener:function(e,t,i){D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i)},clone:function(){D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone");var e=this.internalClone(this.mediaStream);return D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone - returning: "+JSON.stringify(e)),e},internalClone:function(e){D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone");var t=new b(e,this.device);return t.readOnlyAttributes.readyState=this.readyState,t.observableAttributes.enabled=this.observableAttributes.enabled,D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::clone - returning: "+JSON.stringify(t)),t},stop:function(){D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::stop("+JSON.stringify(arguments)+")"),this.setReadyState("ended"),this.makeRpcCall("stop")},getCapabilities:function(){D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::getCapabilities("+JSON.stringify(arguments)+") - E_NOTIMPL")},getConstraints:function(){D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::getConstraints("+JSON.stringify(arguments)+") - E_NOTIMPL")},getSettings:function(){D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::getSettings("+JSON.stringify(arguments)+") - E_NOTIMPL")},applyConstraints:function(e){D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::applyConstraints("+JSON.stringify(arguments)+")");var t=this;return new Promise(function(i,n){t.makeRpcCall("applyConstraints",e).then(function(e){i()}).catch(function(e){n(e)})})},setReadyState:function(e){var t=this.readyState;t!==e&&(this.readOnlyAttributes.readyState=e,D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::setReadyState - old="+t+", new="+e),"ended"===e&&this.eventManager.fireEvent("ended"))},onEnabledAttributeChanged:function(){D.debug("MediaStreamTrackRedirector("+this.rpcObjectId+")::onEnabledAttributeChanged("+JSON.stringify(arguments)+")"),"ended"!==this.readyState&&this.makeRpcCall("onEnabledAttributeChanged",[this.enabled])},onRpcEventNotification:function(e){var t=!1,i=e.rpcEventTarget;return i.rpcObjectType===this.rpcObjectType&&i.rpcObjectId===this.rpcObjectId&&(t=this.eventManager.fireEvent(e.rpcEventName,e.rpcEventArgs)),t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},R.prototype={getCapabilities:function(e){D.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getCapabilities("+JSON.stringify(arguments)+")");var t="audio"===e?this.capabilities.audio:"video"===e?this.capabilities.video:{};D.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getCapabilities returning: "+JSON.stringify(t))},setParameters:function(e){return D.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::setParameters("+JSON.stringify(arguments)+")"),this.parameters=e,this.makeRpcCall("setParameters",[e])},getParameters:function(){return D.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getParameters("+JSON.stringify(arguments)+")"),D.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getParameters returning: "+JSON.stringify(this.parameters)),this.parameters},replaceTrack:function(e){D.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::replaceTrack("+JSON.stringify(arguments)+") - E_NOTIMPL")},setStreams:function(e){D.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::setStreams("+JSON.stringify(arguments)+") - E_NOTIMPL")},getStats:function(){if(D.debug("RTCRtpSenderRedirector("+this.rpcObjectId+")::getStats("+JSON.stringify(arguments)+")"),!this.ready)return new Promise(function(e,t){e(new a)});var e=this;return new Promise(function(t,i){e.makeRpcCall("getStats",arguments).then(function(e){var i=new a;for(var n in e){var r=e[n];i[r.id]=r}t(i)}).catch(function(e){i(e)})})},onRpcEventNotification:function(e){var t=!1;if(e.rpcEventTarget.rpcObjectType===this.rpcObjectType&&e.rpcEventTarget.rpcObjectId===this.rpcObjectId&&"tonechange"===e.rpcEventName){var i=e.rpcEventArgs,n=i.tone,r=i.toneBuffer;this.dtmf.onToneChange(n,r),t=!0}return t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},C.prototype={getCapabilities:function(e){D.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getCapabilities("+JSON.stringify(arguments)+")");var t="audio"===e?this.capabilities.audio:"video"===e?this.capabilities.video:{};D.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getCapabilities returning: "+JSON.stringify(t))},getParameters:function(){return D.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getParameters("+JSON.stringify(arguments)+")"),D.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getParameters returning: "+JSON.stringify(this.parameters)),this.parameters},getContributingSources:function(){return D.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getContributingSources("+JSON.stringify(arguments)+")"),D.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getContributingSources returning: "+JSON.stringify(this.contributingSources)),this.contributingSources},getSynchronizationSources:function(){return D.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getSynchronizationSources("+JSON.stringify(arguments)+")"),D.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getSynchronizationSources returning: "+JSON.stringify(this.synchronizationSources)),this.synchronizationSources},getStats:function(){D.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::getStats("+JSON.stringify(arguments)+")");var e=this;return new Promise(function(t,i){e.makeRpcCall("getStats",arguments).then(function(e){var i=new a;for(var n in e){var r=e[n];i[r.id]=r}t(i)}).catch(function(e){i(e)})})},onContributingSourcesChanged:function(e){D.debug("RTCRtpReceiverRedirector("+this.rpcObjectId+")::onContributingSourcesChanged("+JSON.stringify(e)+")"),this.contributingSources=e},updateContributingSources:function(e){void 0!=this.track&&(this.contributingSources=e,this.contributingSources||(this.contributingSources=[]))},onRpcEventNotification:function(e){var t=!1;return e.rpcEventTarget.rpcObjectType===this.rpcObjectType&&e.rpcEventTarget.rpcObjectId===this.rpcObjectId&&"contributingsourceschanged"===e.rpcEventName&&(this.onContributingSourcesChanged(e.rpcEventArgs.sources),t=!0),t},makeRpcCall:function(e,t,i){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i)}},O.prototype={MEDIA_ERR_ABORTED:1,MEDIA_ERR_NETWORK:2,MEDIA_ERR_DECODE:3,MEDIA_ERR_SRC_NOT_SUPPORTED:4,NETWORK_EMPTY:0,NETWORK_IDLE:1,NETWORK_LOADING:2,NETWORK_NO_SOURCE:3,HAVE_NOTHING:0,HAVE_METADATA:1,HAVE_CURRENT_DATA:2,HAVE_FUTURE_DATA:3,HAVE_ENOUGH_DATA:4,enableRedirection:function(){if(!this.redirecting){var e=this.mediaElement;"video"===this.kind&&e.addEventListener("onresize",this.onResizeFunctor,!1),e.getAttribute=this.getAttributeFunctor,e.setAttribute=this.setAttributeFunctor,e.removeAttribute=this.removeAttributeFunctor,e.addEventListener=this.addEventListenerFunctor,e.removeEventListener=this.removeEventListenerFunctor,e.play=this.playFunctor,e.pause=this.pauseFunctor,e.load=this.loadFunctor,e.setSinkId=this.setSinkIdFunctor,this.redirecting=!0}},disableRedirection:function(){if(this.redirecting){var e=this.mediaElement;e.getAttribute=this.actualGetAttribute,e.setAttribute=this.actualSetAttribute,e.removeAttribute=this.actualRemoveAttribute,e.addEventListener=this.actualAddEventListener,e.removeEventListener=this.actualRemoveEventListener,e.play=this.actualPlay,e.pause=this.actualPause,e.load=this.actualLoad,e.setSinkId=this.actualSetSinkId,"video"===this.kind&&e.removeEventListener("onresize",this.onResizeFunctor,!1),this.stopProgressTimer(),this.redirecting=!1}},getAttribute:function(e){return this.redirecting?"preload"===e?"none":"currentTime"===e?this.getCurrentTime():"duration"===e?this.duration:"defaultPlaybackRate"===e?1:"playbackRate"===e?1:"played"===e?this.getPlayedRanges():"loop"!==e&&("srcObject"===e?this.srcObject:"sinkId"===e?this.sinkId:"autoplay"===e?this.autoplay:"muted"===e?this.muted:"volume"===e?this.volume:"videoHeight"===e?this.videoHeight:"videoWidth"===e?this.videoWidth:"data-vdi_videoid"===e?this["data-vdi_videoid"]:"data-toggle"===e?this["data-toggle"]:void D.warn("MediaElementRedirector("+this.rpcObjectId+")::getAttribute called for unsupported attribute: name="+e)):(D.info("MediaElementRedirector("+this.rpcObjectId+")::getAttribute called while not redirecting for attribute: name="+e),this.actualGetAttribute.apply(this.mediaElement,arguments))},getReadOnlyAttribute:function(e){return this.redirecting?this.readOnlyAttributes[e]:(D.info("MediaElementRedirector("+this.rpcObjectId+")::getReadOnlyAttribute called while not redirecting for attribute: name="+e),this.actualGetAttribute.apply(this.mediaElement,arguments))},setAttribute:function(e,t){var i=null,n=!0,r=!0,o=null,c=this;if(!this.redirecting)return D.info("MediaElementRedirector("+this.rpcObjectId+")::setAttribute called while not redirecting for attribute: name="+e+", value="+t),this.actualSetAttribute.apply(this.mediaElement,arguments);if("id"===e&&t.startsWith(msRDCRTC.MEDIAELEMENT_PLAYBACK_ID))return D.info("MediaElementRedirector("+this.rpcObjectId+")::setAttribute id="+t+" playback attempt detected; disabling redirection"),this.disableRedirection(),this.actualSetAttribute.apply(this.mediaElement,arguments);if("srcObject"===e){if(r=!1,null!=t&&"MediaStream"!==t.rpcObjectType)return D.warn("MediaElementRedirector("+this.rpcObjectId+")::setAttribute srcObject is not a MediaStream redirector object; disabling redirection"),this.disableRedirection(),this.actualSetAttribute.apply(this.mediaElement,arguments);this.readOnlyAttributes.networkState=this.NETWORK_LOADING,o=function(e){c.setReadyState(c.HAVE_ENOUGH_DATA)},this.srcObject=t,null!=t&&(t={rpcObjectType:t.rpcObjectType,rpcObjectId:t.rpcObjectId})}else"autoplay"===e?(r=!0,i=this.autoplay,this.autoplay=t):"muted"===e?(r=!0,i=this.muted,this.muted=t,o=function(e){c.eventManager.fireEvent("volumechange")}):"volume"===e?(msRDCRTC.clientVersionGreaterThanOrEqual("0.11.10")||(n=!1),r=!0,i=this.volume,this.volume=t,o=function(e){c.eventManager.fireEvent("volumechange")}):"data-toggle"===e?(D.info("MediaElementRedirector("+this.rpcObjectId+")::setAttribute called for data-toggle value="+t),this["data-toggle"]=t,n=!1):"data-vdi_videoid"===e?(D.info("MediaElementRedirector("+this.rpcObjectId+")::setAttribute called for data-vdi_video value="+t),this["data-vdi_videoid"]=t,n=!1):(n=!1,D.warn("MediaElementRedirector("+this.rpcObjectId+")::setAttribute called for unsupported attribute: name="+e+", value="+t));r&&(D.info("MediaElementRedirector("+this.rpcObjectId+")::setAttribute setting on mediaElement name="+e+", value="+t),this.actualSetAttribute.apply(this.mediaElement,arguments)),i!==t&&n&&this.makeRpcCall("setAttribute",[e,t]).then(function(e){null!=o&&o(e)})},removeAttribute:function(e){if(!this.redirecting)return D.info("MediaElementRedirector("+this.rpcObjectId+")::removeAttribute called while not redirecting for attribute: name="+e),this.actualRemoveAttribute.apply(this.mediaElement,arguments);D.warn("MediaElementRedirector("+this.rpcObjectId+")::removeAttribute called for unsupported attribute: name="+e+", value="+value)},addEventListener:function(e,t,i){return this.redirecting?"webkitneedkey"===e||"msneedkey"===e||"encrypted"===e?(D.info("MediaElementRedirector("+this.rpcObjectId+")::addEventListener called for: "+e+"; disabling redirection"),this.disableRedirection(),this.actualAddEventListener.apply(this.mediaElement,arguments)):("loadedmetadata"!==e||void 0!=this.mediaElement.id&&this.mediaElement.id.startsWith(msRDCRTC.MEDIAELEMENT_PLAYBACK_ID)||this.enablePropertyRedirection(),D.debug("MediaElementRedirector("+this.rpcObjectId+") - adding event listener for: "+e),this.eventManager.addEventListener(e,t,i),void this.actualAddEventListener.apply(this.mediaElement,arguments)):(D.info("MediaElementRedirector("+this.rpcObjectId+")::addEventListener called while not redirecting for event: "+e),this.actualAddEventListener.apply(this.mediaElement,arguments))},removeEventListener:function(e,t,i){if(!this.redirecting)return D.info("MediaElementRedirector("+this.rpcObjectId+")::removeEventListener called while not redirecting for event: "+e),this.actualRemoveEventListener.apply(this.mediaElement,arguments);D.debug("MediaElementRedirector("+this.rpcObjectId+") - removing event listener for: "+e),this.eventManager.removeEventListener(e,t,i),this.actualRemoveEventListener.apply(this.mediaElement,arguments),"loadedmetadata"===e&&this.makeRpcCall("shutdown",void 0,!1)},setSinkId:function(e){return D.debug("MediaElementRedirector("+this.rpcObjectId+")::setSinkId: "+e),this.makeRpcCall("setSinkId",[e])},play:function(){if(!this.redirecting)return D.info("MediaElementRedirector("+this.rpcObjectId+")::play called while not redirecting"),this.actualPlay.apply(this.mediaElement,arguments);if(D.debug("MediaElementRedirector("+this.rpcObjectId+")::play"),this.paused){this.eventManager.fireEvent("play"),this.lastPlayAt=performance.now();var e=this;this.makeRpcCall("play").then(function(){e.readOnlyAttributes.paused=!1,e.eventManager.fireEvent("playing"),e.startProgressTimer()})}},pause:function(){if(!this.redirecting)return D.info("MediaElementRedirector("+this.rpcObjectId+")::pause called while not redirecting"),this.actualPause.apply(this.mediaElement,arguments);if(D.debug("MediaElementRedirector("+this.rpcObjectId+")::pause"),!this.paused){var e=this;this.makeRpcCall("pause").then(function(){e.stopProgressTimer(),e.readOnlyAttributes.paused=!0,e.updateCurrentTime(),e.eventManager.fireEvent("pause")})}},load:function(){if(!this.redirecting)return D.info("MediaElementRedirector("+this.rpcObjectId+")::load called while not redirecting"),this.actualLoad.apply(this.mediaElement,arguments);D.debug("MediaElementRedirector("+this.rpcObjectId+")::load")},getCurrentTime:function(){return this.currentTime},updateCurrentTime:function(){var e=performance.now(),t=this.currentTime,i=e-this.lastPlayAt;i!==t&&(this.readOnlyAttributes.currentTime=i,this.eventManager.fireEvent("timeupdate"))},getPlayedTimeRanges:function(){var e=this.getCurrentTime(),t=new TimeRanges;return 0!==e&&t.setTimeRange(0,e),t},setReadyState:function(e){var t=this.readyState;if(t!==e){var i=!1;t===this.HAVE_NOTHING&&e>=this.HAVE_METADATA&&(this.readOnlyAttributes.readyState=this.HAVE_METADATA,isNaN(this.duration)&&(this.readOnlyAttributes.duration=Number.POSITIVE_INFINITY,this.eventManager.fireEvent("durationchange")),"video"===this.kind&&(this.videoWidth=1280,this.videoHeight=768),this.eventManager.fireEvent("loadedmetadata")),t<=this.HAVE_METADATA&&e>=this.HAVE_CURRENT_DATA&&(this.readOnlyAttributes.readyState=this.HAVE_CURRENT_DATA,this.eventManager.fireEvent("loadeddata")),t<=this.HAVE_CURRENT_DATA&&e>=this.HAVE_FUTURE_DATA&&(this.readOnlyAttributes.readyState=this.HAVE_FUTURE_DATA,this.eventManager.fireEvent("canplay"),i=!0),t<=this.HAVE_FUTURE_DATA&&e>=this.HAVE_ENOUGH_DATA&&(this.readOnlyAttributes.readyState=this.HAVE_ENOUGH_DATA,this.eventManager.fireEvent("canplaythrough"),i=!0),i&&this.paused&&this.autoplay&&this.play()}},startProgressTimer:function(){if(void 0==this.progressIntervalId){D.debug("MediaElementRedirector("+this.rpcObjectId+")::startProgressTimer");var e=this;this.progressIntervalId=window.setInterval(function(){e.onProgressTimer()},250)}},stopProgressTimer:function(){void 0!=this.progressIntervalId&&(D.debug("MediaElementRedirector("+this.rpcObjectId+")::startProgressTimer"),window.clearInterval(this.progressIntervalId),this.progressIntervalId=void 0)},onProgressTimer:function(){this.paused||this.ended||(this.onStyleChanged("poll"),this.onPositionChanged("poll"),this.updateCurrentTime(),this.eventManager.fireEvent("progress"))},onVdiVideoIdChanged:function(){D.debug("MediaElementRedirector("+this.rpcObjectId+")::onVdiVideoIdChanged: "+this.mediaElement["data-vdi_video"])},onVdiDataToggleChanged:function(){D.debug("MediaElementRedirector("+this.rpcObjectId+")::onVdiDataToggleChanged: "+this.mediaElement["data-toggle"])},onStyleChanged:function(e){var t=void 0;void 0!=this.mediaElement&&void 0!=this.mediaElement.style&&(t=this.mediaElement.style.objectFit),void 0!=t&&this.objectFit!==t&&(D.info("MediaElementRedirector("+this.rpcObjectId+")::onStyleChanged - objectFit changed from: "+this.objectFit+" to: "+t),this.objectFit=t,msRDCRTC.clientVersionGreaterThanOrEqual("0.11.10")&&this.makeRpcCall("notifyObjectFitChanged",[t],!1,!0,!0)),"poll"!==e&&this.onPositionChanged("style")},onPositionChanged:function(e){"poll"!==e&&D.debug("MediaElementRedirector("+this.rpcObjectId+")::onPositionChanged due to "+e+": ["+this.mediaElement[e]+"]");var t={left:0,top:0,right:0,bottom:0},i=this.boundingRect,n=this.scaleFactor;this.mediaElement&&(t=this.mediaElement.getBoundingClientRect()),null!=i&&t.left===i.left&&t.top===i.top&&t.right===i.right&&t.bottom===i.bottom&&window.devicePixelRatio===n||(D.debug("MediaElementRedirector("+this.rpcObjectId+")::onPositionChanged - bounding client rect changed from: "+JSON.stringify(i)+" to: "+JSON.stringify(t)+", scale factor changed from: "+n+", to: "+window.devicePixelRatio),this.boundingRect=t,this.scaleFactor=window.devicePixelRatio,this.makeRpcCall("notifyPositionChanged",[{left:t.left,top:t.top,right:t.right,bottom:t.bottom},this.scaleFactor],!1,!0,!0))},enablePropertyRedirection:function(){var e=this;D.info("MediaElementRedirector("+this.rpcObjectId+")::enablePropertyRedirection");var t=function(t){return e.getAttribute(t)},i=function(t){return e.getReadOnlyAttribute(t)};o(this.mediaElement,[["customAttributes",[["currentSrc",i,k],["networkState",i,k],["buffered",i,k],["readyState",i,k],["seeking",i,k],["duration",i,k],["paused",i,k],["seekable",i,k],["ended",i,k],["error",i,k],["sinkId",i,k],["src",t,j],["preload",t,A],["currentTime",t,j],["defaultPlaybackRate",t,A],["playbackRate",t,A],["played",t,k]]],["observableAttributes",[["onloadstart",void 0,function(){c(e,"loadstart")}],["onsuspend",void 0,function(){c(e,"suspend")}],["onabort",void 0,function(){c(e,"abort")}],["onemptied",void 0,function(){c(e,"emptied")}],["onstalled",void 0,function(){c(e,"stalled")}],["onplay",void 0,function(){c(e,"play")}],["onpause",void 0,function(){c(e,"pause")}],["onloadedmetadata",void 0,function(){c(e,"loadedmetadata")}],["onwaiting",void 0,function(){c(e,"waiting")}],["onplaying",void 0,function(){c(e,"playing")}],["oncanplay",void 0,function(){c(e,"canplay")}],["oncanplaythrough",void 0,function(){c(e,"canplaythrough")}],["onended",void 0,function(){c(e,"ended")}],["ondurationchange",void 0,function(){c(e,"durationchange")}],["onvolumechange",void 0,function(){c(e,"volumechange")}],["ontimeupdate",void 0,function(){c(e,"timeupdate")}],["onprogress",void 0,function(){c(e,"progress")}],["oncontextmenu",void 0,function(){c(e,"contextmenu")}],["onerror",void 0,function(){c(e,"error")}]]]]),"video"===this.kind&&o(this.mediaElement,[["customAttributes",[["videoHeight",t,j],["videoWidth",t,j]]],["observableAttributes",[["clientHeight",this.mediaElement.clientHeight,function(){e.onPositionChanged("clientHeight")}],["clientLeft",this.mediaElement.clientLeft,function(){e.onPositionChanged("clientLeft")}],["clientTop",this.mediaElement.clientTop,function(){e.onPositionChanged("clientTop")}],["clientWidth",this.mediaElement.clientWidth,function(){e.onPositionChanged("clientWidth")}],["offsetHeight",this.mediaElement.offsetHeight,function(){e.onPositionChanged("offsetHeight")}],["offsetLeft",this.mediaElement.offsetLeft,function(){e.onPositionChanged("offsetLeft")}],["offsetParent",this.mediaElement.offsetParent,function(){e.onPositionChanged("offsetParent")}],["offsetTop",this.mediaElement.offsetTop,function(){e.onPositionChanged("offsetTop")}],["offsetWidth",this.mediaElement.offsetWidth,function(){e.onPositionChanged("offsetWidth")}],["parentElement",this.mediaElement.parentElement,function(){e.onPositionChanged("parentElement")}],["parentNode",this.mediaElement.parentNode,function(){e.onPositionChanged("parentNode")}],["style",this.mediaElement.style,function(){e.onStyleChanged("style")}]]]])},makeRpcCall:function(e,t,i,n,r){return msRDCRTC.makeRpcCall({rpcObjectType:this.rpcObjectType,rpcObjectId:this.rpcObjectId,rpcName:e,rpcArgs:t},i,n,r)}},S.prototype={sign:function(e){var t=this;return void 0==this.key?new Promise(function(i,n){t.importKey().then(function(){t.generateHash(e).then(function(e){i(e)}).catch(function(e){n(e)})}).catch(function(e){n(e)})}):this.generateHash(e)},importKey:function(){var e=this;return new Promise(function(t,i){window.crypto.subtle.importKey("raw",e.rawKey,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]).then(function(i){e.key=i,t()}).catch(function(e){i(e)})})},pad:function(e){for(;e.length<2;)e="0"+e;return e},generateHash:function(e){for(var t=this,i=e.length,n=new ArrayBuffer(i),r=new Uint8Array(n),o=0;o<i;++o)r[o]=e.charCodeAt(o);return new Promise(function(e,i){window.crypto.subtle.sign({name:"HMAC"},t.key,n).then(function(i){for(var n=new Uint8Array(i),r="",o=n.byteLength,c=0;c<o;++c)r+=t.pad(n[c].toString(16));e(r)}).catch(function(e){i(e)})})}},E.prototype={VERSION:"1.0.2006.04002",WEBSOCKET_DEFAULT_PORT:9500,WEBSOCKET_PORT:E.WEBSOCKET_DEFAULT_PORT,WEBSOCKET_URI_BASE:"ws://localhost",WEBSOCKET_URI:E.WEBSOCKET_URI_BASE+":"+E.WEBSOCKET_DEFAULT_PORT,WEBSOCKET_SERVICE_ID:"388FE4DA-5AAD-C078-FCD5-2DB6ADE9C174",WEBSOCKET_KEY:void 0,CLIENT_OS_VERSION:void 0,HOST_OS_VERSION:void 0,OOB_CLIENT_VERSION:void 0,WEBRTC_VERSION:void 0,WEBRTC_REDIRECTOR_VERSION:void 0,WEBSOCKET_SERVICE_VERSION:void 0,VDI_MODE:void 0,SESSION_ID:void 0,ENDPOINT_ID:void 0,APP_WINDOW_NAME:"Chrome Legacy Window",NOTIFICATION_ASSETS_BASEURI:"https://teams.microsoft.com/assets/audio",MEDIAELEMENT_PLAYBACK_ID:"teamsDefaultPlayer",STATE_NOT_CONNECTED:0,STATE_CONNECTING:1,STATE_CONNECTED:2,STATE_WS_CONNECTION_FAILED:3,STATE_ENDPOINT_UNSUPPORTED:4,STATE_CONNECTION_FAILED:5,init:function(e){var t=this;T=e,D.info("WVD VDI shim loaded - v"+this.VERSION),this.getConfiguration().then(function(){t.startRtcSession()})},setConnectionState:function(e,t){D.info("connectionState changed from: "+this.connectionState+" to: "+e);var i=this.connectionState;if(this.connectionState=e,e===this.STATE_NOT_CONNECTED)this.verifyConnectionState([this.STATE_CONNECTING,this.STATE_CONNECTED],i),this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"endpointDisconnected"});else if(e===this.STATE_CONNECTING){if(this.verifyConnectionState([this.STATE_NOT_CONNECTED],i),null==this.socket){D.debug("connecting to: "+this.WEBSOCKET_URI),this.webSocketUnavailable=!1,this.endpointUnsupported=!1;var n=new WebSocket(this.WEBSOCKET_URI);n.addEventListener("open",this.onWebSocketOpenFunctor,!1),n.addEventListener("closed",this.onWebSocketClosedFunctor,!1),n.addEventListener("error",this.onWebSocketErrorFunctor,!1),n.addEventListener("message",this.onWebSocketMessageFunctor,!1),this.socket=n}}else if(e===this.STATE_CONNECTED)this.verifyConnectionState([this.STATE_CONNECTING],i),this.rtcObjects.forEach(function(e){void 0!=e.enableRedirection&&e.enableRedirection()}),this.notifyVmEventCallback({event:"vdiClientConnected",version:{clientOS:this.CLIENT_OS_VERSION,hostOS:this.HOST_OS_VERSION,oobClient:this.OOB_CLIENT_VERSION,webRTC:this.WEBRTC_VERSION,webRTCRedirector:this.WEBRTC_REDIRECTOR_VERSION,websocketService:this.WEBSOCKET_SERVICE_VERSION,shim:this.VERSION,vdiMode:this.VDI_MODE},endpointId:this.ENDPOINT_ID}),this.enumerateDevicesOnConnect?this.enumerateDevices():this.enumerateDevicesOnConnect=!0;else if(e===this.STATE_WS_CONNECTION_FAILED)this.verifyConnectionState([this.STATE_CONNECTING],i),D.info("connectionState changed from: "+this.connectionState+" to: "+this.STATE_NOT_CONNECTED),this.connectionState=this.STATE_NOT_CONNECTED,this.webSocketUnavailable=!0,this.closeWebSocketConnection(),this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"failure",msg:t});else if(e===this.STATE_ENDPOINT_UNSUPPORTED)this.verifyConnectionState([this.STATE_CONNECTING],i),D.info("connectionState changed from: "+this.connectionState+" to: "+this.STATE_NOT_CONNECTED),this.connectionState=this.STATE_NOT_CONNECTED,this.endpointUnsupported=!0,this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"endpointUnsupported",msg:t});else{if(e!==this.STATE_CONNECTION_FAILED)throw D.error("invalid connectionState: "+e),new Error({name:"MSRDCRTC: Error",message:"Connection state not expected: "+e});this.verifyConnectionState([this.STATE_CONNECTING,this.STATE_CONNECTED],i),D.info("connectionState changed from: "+this.connectionState+" to: "+this.STATE_NOT_CONNECTED),this.connectionState=this.STATE_NOT_CONNECTED,this.notifyVmEventCallback({event:"vdiClientDisconnected",reason:"failure",msg:t})}},verifyConnectionState:function(e,t){var i=!1;void 0==t&&(t=this.connectionState);for(var n in e)if(e[n]===t){i=!0;break}if(!i)throw D.error("invalid connectionState: "+this.connectionState+", expecting: "+e.toString()),new Error({name:"MSRDCRTC: Error",message:"Connection state not expected: "+this.connectionState+", expecting: "+e.toString()})},closeWebSocketConnection:function(){if(null!=this.socket){var e=this.socket;D.debug("disconnected from: "+this.WEBSOCKET_URI),e.removeEventListener("open",this.onWebSocketOpenFunctor,!1),e.removeEventListener("closed",this.onWebSocketClosedFunctor,!1),e.removeEventListener("error",this.onWebSocketErrorFunctor,!1),e.removeEventListener("message",this.onWebSocketMessageFunctor,!1),this.socket=null,this.socketConnected=!1,this.socketClosed=!0}this.stopRtcSession(),this.SESSION_ID=void 0},setDebugLevel:function(e){if(e!==this.debugLevel){var t=this.debugLevel;if(this.debugLevel=e,D=0===e?y:1===e?I:N,0===e)window.clearInterval(this.periodicCallbackId),this.periodicCallbackId=null;else if(0===t){var i=this;this.periodicCallbackId=window.setInterval(function(){i.debugPeriodicCallback()},1e3)}}},redirectionSupported:function(){return!this.endpointUnsupported&&!this.webSocketUnavailable},startRtcSession:function(){var e=this;if(!this.endpointUnsupported&&(this.setConnectionState(this.STATE_CONNECTING),void 0==this.SESSION_ID)){var t=msRDCRTC.generateUuid(),i=Date.now().toString(),n=t+"|"+i;new S(this.WEBSOCKET_SERVICE_ID,this.WEBSOCKET_KEY).sign(n).then(function(n){e.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"rtcSession",rpcArgs:[t,i,n,e.VERSION]},!0,!0).then(function(n){var r=n[0],o=n[1],c=n[2];void 0!=c&&(e.HOST_OS_VERSION=c.hostOS,e.WEBSOCKET_SERVICE_VERSION=c.websocketService),e.verifyRtcSession(t,i,r,o)}),e.trySendPendingMessages()}),this.registerAppWindowHandle()}},stopRtcSession:function(){this.pendingMessages=[],this.outstandingRpcCalls=new a,this.rtcObjects.forEach(function(e){void 0!=e.disableRedirection&&e.disableRedirection()}),this.connectionState!==this.STATE_NOT_CONNECTED&&this.setConnectionState(this.STATE_NOT_CONNECTED)},verifyRtcSession:function(e,t,i,n){var r=this;this.verifyConnectionState([this.STATE_CONNECTING]);var o=e+"|"+t+"|"+i;new S(this.WEBSOCKET_SERVICE_ID,this.WEBSOCKET_KEY).sign(o).then(function(e){e===n?(r.rtcSessionStarted=!0,r.trySendPendingMessages()):r.setConnectionState(r.STATE_WS_CONNECTION_FAILED,"WebSocket connection failed due to hash mismatch")})},getConfiguration:function(){var e=this;return new Promise(function(t,i){window.getWVDConfig().then(function(n){D.debug("config="+n);var r=JSON.parse(n);void 0!=r.port&&void 0!=r.key||i(new Error("invalid WVD config")),e.WEBSOCKET_PORT=r.port,e.WEBSOCKET_URI=e.WEBSOCKET_URI_BASE+":"+e.WEBSOCKET_PORT,e.WEBSOCKET_KEY=r.key,t()}).catch(function(e){i(e)})})},registerAppWindowHandle:function(){var e=this;window.getWindowHandleAsHex().then(function(t){t=t.match(/[0-9a-f]{2}/gi).reverse().join(""),D.info("app hwnd="+t),e.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"setAppWindow",rpcArgs:[t,e.APP_WINDOW_NAME]})}).catch(function(e){D.error("failed to get the app window - "+e.toString())})},compareVersions:function(e,t){for(var i=e.match(/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:\.(\d+))?$/),n=t.match(/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:\.(\d+))?$/),r=1;r<=4;++r)void 0==i[r]&&(i[r]="0"),void 0==n[r]&&(n[r]="0");var o=1e13*Number.parseInt(i[1])+1e11*Number.parseInt(i[2])+1e5*Number.parseInt(i[3])+Number.parseInt(i[4]),c=1e13*Number.parseInt(n[1])+1e11*Number.parseInt(n[2])+1e5*Number.parseInt(n[3])+Number.parseInt(n[4]);return o==c?0:o<c?1:-1},compareVersionsLowerThan:function(e,t){var i=!0;return void 0!=t&&(i=this.compareVersions(e,t)<0),i},clientVersionLowerThan:function(e){return this.compareVersionsLowerThan(e,this.WEBRTC_REDIRECTOR_VERSION)},wssVersionLowerThan:function(e){return this.compareVersionsLowerThan(e,this.WEBSOCKET_SERVICE_VERSION)},compareVersionsGreaterThanOrEqual:function(e,t){var i=!1;return void 0!=t&&(i=this.compareVersions(e,t)>=0),i},clientVersionGreaterThanOrEqual:function(e){return this.compareVersionsGreaterThanOrEqual(e,this.WEBRTC_REDIRECTOR_VERSION)},wssVersionGreaterThanOrEqual:function(e){return this.compareVersionsGreaterThanOrEqual(e,this.WEBSOCKET_SERVICE_VERSION)},setVMEventCallback:function(e){this.vmEventCallback=e},newAudioElement:function(e){var t=new O("audio",e);this.rtcObjects.push(t);var i=!1;this.connectionState===this.STATE_CONNECTED&&(t.enableRedirection(),i=!0),D.info("newAudioElement returning "+(i?"":"un")+"shimmed object")},newVideoElement:function(e){var t=this.nextVideoElementId++;e.setAttribute("data-vdi_videoid",t);var i=new O("video",e);this.rtcObjects.push(i);var n=!1;this.connectionState===this.STATE_CONNECTED&&(i.enableRedirection(),n=!0),D.info("newVideoElement returning "+(n?"":"un")+"shimmed object, id="+t)},getNotifyAudio:function(e){var t=this.notifications[e];return void 0==t&&(t={id:e,sinkId:this.defaultSinkId,loop:!1,played:!1},this.notifications[e]=t),t},getNotificationAssetUri:function(e){var t=void 0;return e.match(/^http/i)?t=e:e.match(/[^\/]+$/)&&(t=e.replace(/.*?([^\/]+)$/,this.NOTIFICATION_ASSETS_BASEURI+"/$1")),t},playNotifyAudio:function(e,t){D.debug("playNotifyAudio("+JSON.stringify(arguments)+")");var i=this.getNotifyAudio(e);i.played=!0;var n=this.getNotificationAssetUri(t);this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"playNotifyAudio",rpcArgs:[{audioId:e,uri:n,sinkId:i.sinkId,loop:i.loop}]})},pauseNotifyAudio:function(e){D.debug("pauseNotifyAudio("+JSON.stringify(arguments)+")"),this.getNotifyAudio(e).played&&this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"pauseNotifyAudio",rpcArgs:[{audioId:e}]})},setLoop:function(e,t){D.debug("pauseNotifyAudio("+JSON.stringify(arguments)+")"),this.getNotifyAudio(e).loop=t},setSinkId:function(e,t){D.debug("setSinkId("+JSON.stringify(arguments)+")"),this.getNotifyAudio(e).sinkId=t},setDefaultSinkId:function(e){D.debug("setDefaultSinkId("+JSON.stringify(arguments)+")"),this.defaultSinkId=e},addClipRect:function(e){D.info("addClipRect("+JSON.stringify(arguments)+")"),this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"addClipRect",rpcArgs:[{left:e.left,top:e.top,right:e.right,bottom:e.bottom}]})},removeClipRect:function(e){D.info("removeClipRect("+JSON.stringify(arguments)+")"),this.makeRpcCall({rpcObjectType:"RDWebRTCRedirector",rpcName:"removeClipRect",rpcArgs:[{left:e.left,top:e.top,right:e.right,bottom:e.bottom}]})},createPeerConnection:function(e,t){var i;if(null!=e&&(e=JSON.parse(JSON.stringify(e))),null!=t&&(t=JSON.parse(JSON.stringify(t))),this.redirectionSupported())(i=new v(e,t)).teamsId=this.nextPeerConnectionId++,D.info("createPeerConnection returning shimmed object, id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),this.rtcObjects.push(i);else{(i=new this.actualRTCPeerConnection(e,t)).teamsId=this.nextPeerConnectionId++,D.info("createPeerConnection returning hooked object, id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments));var n=i.addIceCandidate;i.addIceCandidate=function(){return D.info("addIceCandidate id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),n.apply(i,arguments)};var r=i.createOffer;i.createOffer=function(){return D.info("createOffer id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),r.apply(i,arguments)};var o=i.createAnswer;i.createAnswer=function(){return D.info("createAnswer id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),o.apply(i,arguments)};var c=i.setRemoteDescription;i.setRemoteDescription=function(){return D.info("setRemoteDescription id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),c.apply(i,arguments)};var a=i.setLocalDescription;i.setLocalDescription=function(){return D.info("setLocalDescription id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),a.apply(i,arguments)};var s=i.createDTMFSender;i.createDTMFSender=function(){return D.info("createDTMFSender id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),s.apply(i,arguments)};var d=i.getLocalStreams;i.getLocalStreams=function(){D.info("getLocalStreams id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments));var e=d.apply(i,arguments);return D.info("VDI Local Streams",e),e};var u=i.getRemoteStreams;i.getRemoteStreams=function(){return D.info("getRemoteStreams id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),u.apply(i,arguments)};var l=i.getStats;i.getStats=function(){return D.info("getStats id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),l.apply(i,arguments)};var h=i.addStream;i.addStream=function(){return D.info("addStream id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),h.apply(i,arguments)};var p=i.addTrackStream;i.addTrack=function(){return D.info("addTrack id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),p.apply(i,arguments)};var g=i.removeStream;i.removeStream=function(){return D.info("removeStream id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),g.apply(i,arguments)};var f=i.getReceivers;i.getReceivers=function(){return D.info("getReceivers id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),f.apply(i,arguments)};var m=i.close;i.close=function(){return D.info("close id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),m.apply(i,arguments)},["onnegotiationneeded","onsignalingstatechange","onaddstream","onremovestream","onicecandidate","oniceconnectionstatechange","onicegatheringstatechange"].forEach(function(e){var t=i[e];i[e]=function(){if(D.info(e+" id="+i.teamsId+" num args="+arguments.length+" args="+JSON.stringify(arguments)),t)return t.apply(i,arguments)}})}return i},getUserMedia:function(){return this.mediaDevicesRedirector.getUserMedia.apply(this.mediaDevicesRedirector,arguments)},enumerateDevices:function(){return this.mediaDevicesRedirector.enumerateDevices.apply(this.mediaDevicesRedirector,arguments)},getDisplayMedia:function(){return this.mediaDevicesRedirector.getDisplayMedia.apply(this.mediaDevicesRedirector,arguments)},getScreensAsync:function(){return this.mediaDevicesRedirector.getScreensAsync.apply(this.mediaDevicesRedirector,arguments)},setScreenSharePanelId:function(){return this.mediaDevicesRedirector.setScreenSharePanelId.apply(this.mediaDevicesRedirector,arguments)},isFeatureSupported:function(e){var t=!1;return"video"===e?void 0!=this.clientFeatures&&"disabled"===this.clientFeatures.camera||(t=!0):"screenshare"===e?void 0!=this.clientFeatures&&"enabled"===this.clientFeatures.screenshare&&(t=!0):"multimonitorscreenshare"===e&&void 0!=this.clientFeatures&&"enabled"===this.clientFeatures.multimonitorscreenshare&&this.wssVersionGreaterThanOrEqual("1.0.2006.4001")&&(t=!0),D.debug("isFeatureSupported("+JSON.stringify(arguments)+") returning: "+t),t},onWebSocketOpen:function(e){D.debug("WebSocket opened"),this.socketConnected=!0,this.trySendPendingMessages()},onWebSocketClosed:function(e){D.debug("WebSocket closed"),this.setConnectionState(this.STATE_NOT_CONNECTED)},onWebSocketError:function(e){D.error("WebSocket error");var t=this.connectionState===this.STATE_CONNECTING?this.STATE_WS_CONNECTION_FAILED:this.STATE_CONNECTION_FAILED,i=this.connectionState===this.STATE_CONNECTING?"WebSocket connection failed":"WebSocket error";this.setConnectionState(t,i)},onWebSocketMessage:function(e){D.debug("onWebSocketMessage");var t=null;try{var i=new String(e.data),n=i.lastIndexOf("}");i=i.substring(0,n+1),t=JSON.parse(i)}catch(t){D.error("failed to parse the JSON string: ["+e.data+"] - "+t.toString())}if(null!=t)try{void 0!=t.rpcCallId?this.onRpcResponse(t):void 0!=t.rpcEventTarget?this.onRpcEventNotification(t):D.error("error: received RPC response with no rpcCallId or rpcEventTarget defined")}catch(t){D.error("failed to handle the WebSocket message: ["+e.data+"] - "+t.toString())}},onSessionInfo:function(e){D.debug("onSessionInfo: "+JSON.stringify(e));var t=e.version;void 0!=t&&(this.CLIENT_OS_VERSION=t.clientOS,this.OOB_CLIENT_VERSION=t.oobClient,this.WEBRTC_VERSION=t.webRTC,this.WEBRTC_REDIRECTOR_VERSION=t.webRTCRedirector);var i=e.session;void 0!=i?(this.ENDPOINT_ID=i.endpointId,this.VDI_MODE=i.vdiMode):this.ENDPOINT_ID=e.endpointId,this.SESSION_ID=e.sessionId,this.clientFeatures=e.features,void 0!=this.clientFeatures&&"disabled"===this.clientFeatures.microphone?(D.warn("endpoint microphone access is disabled"),this.setConnectionState(this.STATE_ENDPOINT_UNSUPPORTED,"endpoint microphone access is disabled")):this.setConnectionState(this.STATE_CONNECTED)},onSessionChange:function(e){var t=e.status;void 0!=t&&(D.debug("onSessionChange: received sessionChange event: "+e.status),"connected"===t?(this.endpointUnsupported=!1,this.connectionState===this.STATE_NOT_CONNECTED&&this.startRtcSession()):"disconnected"===t&&this.stopRtcSession())},onRpcResponse:function(e){0===e.hr?D.debug("onRpcResponse: "+JSON.stringify(e)):D.error("onRpcResponse - ERROR: "+JSON.stringify(e));var t=e.rpcCallId,i=this.outstandingRpcCalls[t];if(void 0!=i){i.stats.completed=performance.now();var n=i.stats.completed-i.stats.started;(n>=1e3?D.warn:D.debug)('"rpcCallId":'+t+" took "+n.toFixed(4)+" ms"),delete this.outstandingRpcCalls[t],i.onRpcResponse(e)}else D.error("error: received RPC response with unexpected rpcCallId: "+t)},onRpcEventNotification:function(e){if(0===e.hr?D.debug("onRpcEventNotification: "+JSON.stringify(e)):D.error("onRpcEventNotification - ERROR: "+JSON.stringify(e)),void 0!=e.rpcEventTarget)if(void 0!=e.rpcEventTarget.rpcObjectType)if(void 0!=e.rpcEventName){var t=!1;"RDWebRTCRedirector"===e.rpcEventTarget.rpcObjectType?t=this.handleRpcEventNotification(e):this.rtcObjects.forEach(function(i){void 0!=i.onRpcEventNotification&&i.onRpcEventNotification(e)&&(t=!0)}),t||D.warn("warning - received RPC event notification but no objects handled the event")}else D.error("error: received RPC event notification with no rpcEventName defined");else D.error("error: received RPC event notification with no rpcEventTarget.rpcObjectType defined");else D.error("error: received RPC event notification with no rpcEventTarget defined")},handleRpcEventNotification:function(e){var t=!0,i=e.rpcEventName;return"sessioninfo"===i?this.onSessionInfo(e.rpcEventArgs):"sessionchange"===i?this.onSessionChange(e.rpcEventArgs):"vdiScreenTopologyChanged"===i?this.notifyVmEventCallback({event:"vdiScreenTopologyChanged"}):"virtualchannelerror"===i?this.setConnectionState(this.STATE_ENDPOINT_UNSUPPORTED,"virtual channel connection failed: hr="+s(e.hr)):"error"===i?this.setConnectionState(this.STATE_CONNECTION_FAILED,"hr="+s(e.hr)):t=!1,t},sendWebSocketMessage:function(e,t){if(this.socketConnected&&(this.rtcSessionStarted||this.isSessionHandshakeMessage(e))){var i="close"===e;if(!i||!this.socketClosed){D.debug("Sending... "+e);try{this.socket.send(e),this.socketClosed=i}catch(e){D.error("failed to send WebSocket message - "+e.toString()),this.setConnectionState(this.STATE_NOT_CONNECTED)}}}else t?this.pendingMessages.unshift(e):this.pendingMessages.push(e)},isSessionHandshakeMessage:function(e){var t=JSON.parse(e);return"RDWebRTCRedirector"===t.rpcObjectType&&"rtcSession"===t.rpcName},trySendPendingMessages:function(){if(this.socketConnected)for(;;){var e=this.pendingMessages.shift();if(void 0==e)break;if(!this.rtcSessionStarted&&!this.isSessionHandshakeMessage(e)){this.pendingMessages.unshift(e);break}this.sendWebSocketMessage(e)}},getNextRpcObjectId:function(){return this.nextRpcObjectId++},getNextOperationId:function(){return this.nextOperationId++},generateUuid:function(){for(var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},t=null;;)if(t=e()+e()+e()+"4"+e().substring(1)+"b"+e().substring(1)+e()+e()+e(),void 0==this.uniqueIds[t]){this.uniqueIds[t]=!0;break}return t},makeRpcCall:function(e,t,i,n){var r=this.nextRpcCallId++;e.rpcCallId=r;var o=e.rpcArgs,c=!0;for(var a in o)if(void 0!=o[a]){c=!1;break}if(c&&(e.rpcArgs=[]),n){for(var d=[];;){var u=this.pendingMessages.shift();if(void 0==u)break;var l=JSON.parse(u);l.rpcObjectId===e.rpcObjectId&&l.rpcName===e.rpcName?D.debug("Dropping superceded RPC call: "+u):d.push(u)}this.pendingMessages=d}var h=JSON.stringify(e);this.sendWebSocketMessage(h,i);var p;return void 0==t||t?(e.stats={started:performance.now()},p=new Promise(function(t,i){e.onRpcResponse=function(e){0===e.hr?t(e.result):i(new Error("RPC call failed with hr="+s(e.hr)))}}),this.outstandingRpcCalls[r]=e):p=new Promise(function(e,t){e()}),p},disconnectAllCalls:function(){this.notifyVmEventCallback({event:"vdiClientDisconnected",request:"endCalls"})},notifyVmEventCallback:function(e){D.info("notifyVmEventCallback event="+JSON.stringify(e)),void 0!=this.vmEventCallback&&this.vmEventCallback(e)},debugPeriodicCallback:function(){this.rtcObjects.forEach(function(e){void 0!=e.debugPeriodicCallback&&e.debugPeriodicCallback()})}},msRDCRTC=new E,{init:function(){return msRDCRTC.init.apply(msRDCRTC,arguments)},setVMEventCallback:function(){return msRDCRTC.setVMEventCallback.apply(msRDCRTC,arguments)},newAudioElement:function(){return msRDCRTC.newAudioElement.apply(msRDCRTC,arguments)},newVideoElement:function(){return msRDCRTC.newVideoElement.apply(msRDCRTC,arguments)},playNotifyAudio:function(){return msRDCRTC.playNotifyAudio.apply(msRDCRTC,arguments)},pauseNotifyAudio:function(){return msRDCRTC.pauseNotifyAudio.apply(msRDCRTC,arguments)},setLoop:function(){return msRDCRTC.setLoop.apply(msRDCRTC,arguments)},setSinkId:function(){return msRDCRTC.setSinkId.apply(msRDCRTC,arguments)},setDefaultSinkId:function(){return msRDCRTC.setDefaultSinkId.apply(msRDCRTC,arguments)},addClipRect:function(){return msRDCRTC.addClipRect.apply(msRDCRTC,arguments)},removeClipRect:function(){return msRDCRTC.removeClipRect.apply(msRDCRTC,arguments)},createPeerConnection:function(){return msRDCRTC.createPeerConnection.apply(msRDCRTC,arguments)},getUserMediaShim:function(){return msRDCRTC.getUserMedia.apply(msRDCRTC,arguments)},mediaDevicesGetUserMediaShim:function(){return msRDCRTC.getUserMedia.apply(msRDCRTC,arguments)},enumerateDevicesShim:function(){return msRDCRTC.enumerateDevices.apply(msRDCRTC,arguments)},getDisplayMediaShim:function(){return msRDCRTC.getDisplayMedia.apply(msRDCRTC,arguments)},getScreensAsync:function(){return msRDCRTC.getScreensAsync.apply(msRDCRTC,arguments)},setScreenSharePanelId:function(){return msRDCRTC.setScreenSharePanelId.apply(msRDCRTC,arguments)},isFeatureSupported:function(){return msRDCRTC.isFeatureSupported.apply(msRDCRTC,arguments)}}});