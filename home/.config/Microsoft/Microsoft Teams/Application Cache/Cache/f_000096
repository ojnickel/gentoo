(this.webpackJsonp=this.webpackJsonp||[]).push([[93],{sU98:function(e,t,r){"use strict";var i,n;r.d(t,"b",(function(){return i})),r.d(t,"a",(function(){return n})),function(e){e.ActiveUserOperation="AUO",e.PassiveOperation="PO",e.BackgroundOperation="BO"}(i||(i={})),function(e){e.UploadFile="ShareUploadFile",e.RemoveFile="ShareAbort"}(n||(n={}))},u2tj:function(e,t,r){"use strict";r.r(t),r.d(t,"FileUploadService",(function(){return D})),r.d(t,"IFileUploadService",(function(){})),r.d(t,"IFileUploadPreviewService",(function(){})),r.d(t,"FileUploadPreviewService",(function(){return z})),r.d(t,"buildRemoteOperationFailedError",(function(){return A})),r.d(t,"IFileUploadProgress",(function(){return o.IFileUploadProgress})),r.d(t,"UploadStatus",(function(){return o.d})),r.d(t,"UploadStage",(function(){return o.c})),r.d(t,"IFileUploadStatus",(function(){return o.IFileUploadStatus}));var i=r("+7/b"),n=r("3J71"),o=r("voEM"),a=r("Op8s"),l=function(e){return(e=e||"")&&"/"===e.charAt(e.length-1)?e:e+"/"},s=r("vJjW"),c="FileUploadService",u=function(e){var t=e.slice();return new Response(t).arrayBuffer()},d=function(e,t){var r=e.slice(t,f(t,e.size));return r.lastModifiedDate=e.lastModifiedDate,r.name=e.name,r},f=function(e,t){var r=parseFloat(e.toString())+parseFloat(a.d.toString());return r<t||(r=t),r},p=function(e){return encodeURIComponent(e.replace(/'/g,"''"))},g=function(e,t,r){var n=Object(i.a)(Object(i.a)({},e),{completedCalls:e.completedCalls+1,stage:t,offset:r}),l=h(n.completedCalls,n.totalCalls);return Object(i.a)(Object(i.a)({},n),{progress:l,status:l>=a.g?o.d.COMPLETE:o.d.PROGRESS})},h=function(e,t){return Math.ceil(e/t*a.g)},v={alias:"AddStub",url:function(e,t,r){return""+l(e.siteUrl)+function(e){return e?"_api/web/GetFolderByServerRelativePath(decodedUrl=@v)/Files/getByPathOrAddStub(decodedUrl=@fn)":"_api/web/GetFolderByServerRelativeUrl(@v)/Files/addStub(@fn)"}(r)+"?@v='"+p(e.folderRelativeUrl)+"'&@fn='"+p(t)+"'"}},b={alias:"StartUpload",url:function(e,t,r){return l(e.siteUrl)+"_api/web/GetFolderByServerRelativeUrl(@folder)/Files/getByUrlOrAddStub(@file)/StartUpload(uploadId=guid'"+r+"')?@folder='"+p(e.folderRelativeUrl)+"'&@file='"+p(t)+"'"}},U={alias:"ContinueUpload",url:function(e,t,r,i){return l(e.siteUrl)+"_api/web/GetFolderByServerRelativeUrl(@folder)/Files/getByUrlOrAddStub(@file)/ContinueUpload(uploadId=guid'"+r+"',fileOffset="+i+")?@folder='"+p(e.folderRelativeUrl)+"'&@file='"+p(t)+"'"}},O={alias:"FinishUpload",url:function(e,t,r,i){return l(e.siteUrl)+"_api/web/GetFolderByServerRelativeUrl(@folder)/Files/getByUrlOrAddStub(@file)/FinishUpload(uploadId=guid'"+r+"',fileOffset="+i+")?@folder='"+p(e.folderRelativeUrl)+"'&@file='"+p(t)+"'"}},F={alias:"CancelUpload",url:function(e,t,r){return l(e)+"_api/web/GetFileById('"+t+"')/CancelUpload(uploadId=guid'"+r+"')"}},_={alias:"RecycleFile",url:function(e,t){return l(e)+"_api/web/GetFileById('"+t+"')/recycle"}},y={alias:"GetFileById",url:function(e,t){return l(e)+"_api/web/GetFileById('"+t+"')"}},I={alias:"AddFolder",url:function(e,t){return void 0===t&&(t=!1),l(e.siteUrl)+"_api/web/folders/AddUsingPath(DecodedUrl=@a1,overwrite=@a2)?@a1='"+p(""+e.folderRelativeUrl)+"'&@a2="+t}},j=r("2KjA"),S=r("AoXE"),m=r("vM+I"),w=r("QXN4"),C=r("ifNO"),E=function(e){if(e&&e.code===n.d.AlreadyPresent)return n.d.AlreadyPresent},R=function(e){if(e&&e.code===n.d.FileLocked)return n.d.FileLocked},P=function(e){var t,r=((t={})[n.d.AlreadyPresent]=o.d.CONFLICT,t[n.d.FileLocked]=o.d.FAILED,t),i=function(e){var t=null;return[E,R].every((function(r){return!r(e)||(t=e.code,!1)})),t}(e);return i?r[i]:o.d.FAILED},A=function(e,t,r){var i,o,a=r.errorMessage,l=r.correlationId;return Object(C.a)(c,n.d.RemoteOperationFailed,t,((i={})[m.a.logErrorMessage]=a,i[m.a.correlationId]=l,i[m.a.httpCode]=null===(o=null==e?void 0:e.serverResponse)||void 0===o?void 0:o.status,i),null==e?void 0:e.message,null==e?void 0:e.serverResponse)},N=function(e,t){var r=e.uploadId,i=e.status;t({uploadId:r,progress:0,objectUrl:"",stage:e.stage,status:i,siteInfo:e.siteInfo,fileId:e.fileId,baseUrl:""})},M={FetchingPersonalSiteInfo:"fetching_personal_site_info",CreatingFileOnServer:"creating_file_on_server",CreatingFolder:"creating_folder",RetryingFileCreation:"retrying_file_creation",StartingUpload:"starting_upload",ContinuingUpload:"continuing_upload",FinishingUpload:"finishing_upload",CancellingUpload:"cancelling_upload",DeletingFile:"deleting_file",RecyclingFile:"recycling_file",FileDeletedFromOngoingUploadsList:"file_deleted_from_ongoing_uploads_list",SharePointError:"sharepoint_error"},k=function(e){if((null==e?void 0:e.code)===n.d.Aborted)return e},B=function(e,t){try{!function(e){var t=e.siteInfo,r=e.file;if((t.folderRelativeUrl+"/"+r.name).length>260)throw Object(C.a)(c,n.d.FileNameTooLong,"uploadFile",void 0,"File name too long")}(e)}catch(r){throw N(Object(i.a)(Object(i.a)({},e),{stage:"FileUploadValidation",status:o.d.FAILED}),t),r}},L=r("sU98"),D=function(){function e(e,t){var r=this;this._sharepointRestClient=e,this._ongoingUploads=new Set,this.isOngoingUpload=function(e){return!!r._ongoingUploads.has(e)},this.removeOngoingUpload=function(e){r._ongoingUploads.delete(e)},this._getUploadStartNotification=function(e){return{uploadId:e.uploadId,progress:1,objectUrl:"",fileId:"",siteInfo:e.siteInfo,stage:o.c.BeginUpload,baseUrl:e.siteInfo.siteUrl,status:o.d.PROGRESS}},this._createFileInFolder=function(e,t){return Object(i.f)(r,void 0,Promise,(function(){var r;return Object(i.i)(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,6]),[4,this._createFile(e,t)];case 1:return[2,i.sent()];case 2:return r=i.sent(),[4,Object(j.a)(r,this.logger)];case 3:return i.sent()?[4,this._createFolder(t)]:[3,5];case 4:return i.sent(),this.logger.log("Retrying addStub call after folder creation"),t.scenario.mark(M.RetryingFileCreation),[2,this._createFile(e,t)];case 5:throw r;case 6:return[2]}}))}))},this._createFile=function(e,t){return Object(i.f)(r,void 0,Promise,(function(){var r,n,l,c,u;return Object(i.i)(this,(function(d){switch(d.label){case 0:return r=e.file,n=e.overwrite,l=e.siteInfo,c=v.url(l,r.name,n),[4,this._post({url:c,headers:{Scenario:L.a.UploadFile,ScenarioType:L.b.ActiveUserOperation},apiName:v.alias,apiNameDecoration:n?"Overwrite":void 0})];case 1:return u=d.sent(),[2,function(e){var t=e.previousStatus,r=e.createStubResponse,n=e.siteInfo,l=r.UniqueId,c=r.ServerRelativeUrl,u=Math.ceil(t.file.size/a.d)+2;return Object(i.a)(Object(i.a)({},t),{siteInfo:n,serverRelativeUrl:c,fileId:l,objectUrl:""+Object(s.e)(n.siteUrl)+c,totalCalls:u,completedCalls:1,progress:h(1,u),stage:o.c.CreateStub})}({previousStatus:t,createStubResponse:u,siteInfo:l})]}}))}))},this._createFolder=function(e){return Object(i.f)(r,void 0,void 0,(function(){var t,r,n;return Object(i.i)(this,(function(i){switch(i.label){case 0:return t=e.scenario,r=e.siteInfo,this.logger.log("Upload folder not found. Trying to create the folder"),t.mark(M.CreatingFolder),n=I.url(r),[4,this._post({url:n,headers:{Scenario:L.a.UploadFile,ScenarioType:L.b.ActiveUserOperation},apiName:I.alias})];case 1:return i.sent(),[2]}}))}))},this._startUpload=function(e){return Object(i.f)(r,void 0,Promise,(function(){var t,r,n,a,l,s;return Object(i.i)(this,(function(i){switch(i.label){case 0:return t=e.file,r=e.siteInfo,n=e.uploadId,a=b.url(r,t.name,n),l=d(t,0),[4,this._post({url:a,headers:{Scenario:L.a.UploadFile,ScenarioType:L.b.ActiveUserOperation},body:l,apiName:b.alias})];case 1:return s=i.sent(),[2,g(e,o.c.StartUpload,s.value)]}}))}))},this._continueUpload=function(e,t){return Object(i.f)(r,void 0,Promise,(function(){var r,n,a,l,s,c,u,f;return Object(i.i)(this,(function(i){switch(i.label){case 0:return r=e.offset,n=e.uploadId,a=e.siteInfo,l=e.file,r>=l.size?[2,e]:(s=U.url(a,l.name,n,r),c=d(l,r),[4,this._post({url:s,headers:{Scenario:L.a.UploadFile,ScenarioType:L.b.ActiveUserOperation},body:c,apiName:U.alias})]);case 1:return u=i.sent(),f=g(e,o.c.ContinueUpload,u.value),this.logger.log("File: "+e.fileId+" total calls completed: "+f.completedCalls+" / "+f.totalCalls),this._checkCancelElseNotify(f,t),[2,this._continueUpload(f,t)]}}))}))},this._finishUpload=function(e){return Object(i.f)(r,void 0,Promise,(function(){var t,r,n,a;return Object(i.i)(this,(function(i){switch(i.label){case 0:return t=e.siteInfo,r=e.file,n=e.uploadId,a=O.url(t,r.name,n,r.size),[4,this._post({url:a,headers:{Scenario:L.a.UploadFile,ScenarioType:L.b.ActiveUserOperation},apiName:O.alias})];case 1:return i.sent(),[2,g(e,o.c.FinishUpload,r.size)]}}))}))},this._handleSpoErrors=function(e,t,n){return Object(i.f)(r,void 0,void 0,(function(){var r,o,a,l,s,u,d,f;return Object(i.i)(this,(function(p){switch(p.label){case 0:return e.file,e.scenario,r=Object(i.m)(e,["file","scenario"]),o=r.stage,a=r.fileId,l="",Object(j.b)(t)?[4,Object(S.a)(t,c,o,r,this.logger,l)]:[3,2];case 1:return u=p.sent(),[3,3];case 2:u=null,p.label=3;case 3:if(s=u)throw l=(l="Sharepoint throws an error for file ["+a+"] after stage - "+o+". ")+" "+(null===(f=s.reason)||void 0===f?void 0:f[m.a.logErrorMessage]),d=P(s),this.logger.error(l),N(Object(i.a)(Object(i.a)({},e),{status:d}),n),s;return[2]}}))}))},this._recycleFileDuringUploadError=function(e,t){return Object(i.f)(r,void 0,Promise,(function(){var r,n,o,a,l,s;return Object(i.i)(this,(function(i){switch(i.label){case 0:r="success",n="",i.label=1;case 1:return i.trys.push([1,3,,4]),o=e.fileId,e.scenario.mark("recycling_file"),[4,this._recycleFile(o,t)];case 2:return i.sent(),[3,4];case 3:return a=i.sent(),r="failure",n=null!==(s=null===(l=null==a?void 0:a.reason)||void 0===l?void 0:l.logErrorMessage)&&void 0!==s?s:null==a?void 0:a.message,[3,4];case 4:return[2,{status:r,message:n}]}}))}))},this._handleNonSpoErrors=function(e,t,a){return Object(i.f)(r,void 0,void 0,(function(){var r,l,s,c,u;return Object(i.i)(this,(function(d){if(r=e.fileId,l=e.scenario,s=e.stage,c="Error occured while uploading file ["+r+"] after stage - "+s+". ",t&&t.reason&&(t.reason.logErrorMessage=c+" "+t.reason.logErrorMessage),(u=function(e){var t=null;return[k].every((function(r){return!r(e)||(t=e,!1)})),t}(t))&&u.code===n.d.Aborted)throw l.mark(M.CancellingUpload),this.logger.log("File: "+r+" upload interrupted by cancellation"),N(Object(i.a)(Object(i.a)({},Object(i.a)(Object(i.a)({},e),{stage:u.subContext||e.stage})),{status:o.d.CANCELLED}),a),t;return[2]}))}))},this.logger=t.newLogger(c)}return e.prototype.uploadFile=function(e,t){return Object(i.f)(this,void 0,Promise,(function(){var r,n,a,l,s;return Object(i.i)(this,(function(i){switch(i.label){case 0:r=function(e){var t=e.file,r=e.uploadId,i=e.scenario;return{uploadId:r,siteInfo:e.siteInfo,serverRelativeUrl:"",file:t,totalCalls:0,completedCalls:0,fileId:"",objectUrl:"",progress:0,stage:o.c.BeginUpload,status:o.d.PROGRESS,offset:0,scenario:i}}(e),n=e.scenario,a=e.uploadId,l=e.file,B(r,t),i.label=1;case 1:return i.trys.push([1,6,8,9]),this._ongoingUploads.add(a),t(this._getUploadStartNotification(e)),n.mark(M.CreatingFileOnServer),this.logger.log("File: "+a+" creating file stub"),[4,this._createFileInFolder(e,r)];case 2:return r=i.sent(),this._checkCancelElseNotify(r,t),n.mark(M.StartingUpload,{size:l.size}),this.logger.log("File: "+a+" starting chunk upload"),[4,this._startUpload(r)];case 3:return r=i.sent(),this._checkCancelElseNotify(r,t),this.logger.log("File: "+a+" continuing chunk upload"),n.mark(""+M.ContinuingUpload),[4,this._continueUpload(r,t)];case 4:return r=i.sent(),n.mark(M.FinishingUpload),this.logger.log("File: "+a+" finishing upload"),[4,this._finishUpload(r)];case 5:return r=i.sent(),this._checkCancelElseNotify(r,t),this.logger.log("File: "+a+" successfully uploaded"),[2,r];case 6:return s=i.sent(),[4,this._handleUploadError(s,r,t)];case 7:return[2,i.sent()];case 8:return this._cleanup(e),[7];case 9:return[2]}}))}))},e.prototype.cancelOngoingUpload=function(e,t,r,n){return Object(i.f)(this,void 0,Promise,(function(){return Object(i.i)(this,(function(i){switch(i.label){case 0:switch(n){case o.c.CreateStub:case o.c.StartUpload:return[3,1];case o.c.ContinueUpload:return[3,3];case o.c.FinishUpload:return[3,5]}return[3,7];case 1:return[4,this._deleteFile(t,e.siteUrl)];case 2:return i.sent(),[3,7];case 3:return[4,this._cancelUpload(r,t,e.siteUrl)];case 4:return i.sent(),[3,7];case 5:return[4,this._recycleFile(t,e.siteUrl)];case 6:i.sent(),i.label=7;case 7:return[2]}}))}))},e.prototype.removeFile=function(e,t){return Object(i.f)(this,void 0,void 0,(function(){var r;return Object(i.i)(this,(function(i){switch(i.label){case 0:if(!e)throw r="File id is undefined. It is mandatory for file recycle",this.logger.error(r),Object(C.a)(c,n.d.Empty,"removeFile",void 0,r);return this.logger.log("Recycling file from SP server"),[4,this._recycleFile(e,t)];case 1:return i.sent(),[2]}}))}))},e.prototype._checkCancelElseNotify=function(e,t){var r=e.uploadId,l=e.fileId,s=e.objectUrl,u=e.progress,d=e.status,f=e.siteInfo,p=e.stage;if(this._isCancelled(r))throw this.logger.log("File Upload cancelled : ",JSON.stringify({stage:p,fileId:l})),function(e){var t="Cancellation triggered during "+e.stage,r=Object(i.a)(Object(i.a)({},e),{status:o.d.CANCELLED,internalErrorCode:a.j.uploadCancelled,logErrorMessage:t,correlationId:""});return Object(C.a)(c,n.d.Aborted,e.stage,r)}(e);t({uploadId:r,progress:u,objectUrl:s,fileId:l,baseUrl:f.siteUrl,siteInfo:f,stage:p,status:d})},e.prototype._isCancelled=function(e){return!this._ongoingUploads.has(e)},e.prototype._handleUploadError=function(e,t,r){return Object(i.f)(this,void 0,Promise,(function(){var a,l,s,u,d,f,p,g,h,v,b,U,O,F;return Object(i.i)(this,(function(_){switch(_.label){case 0:return a=t.stage,l=t.siteInfo,s=t.fileId,d="Error occured while uploading file ["+s+"] after stage - "+a+". ",this.logger.log(d),[4,this._handleNonSpoErrors(t,e,r)];case 1:return _.sent(),s?[4,this._recycleFileDuringUploadError(t,l.siteUrl)]:[3,3];case 2:u=_.sent(),_.label=3;case 3:f="failure"===(null==u?void 0:u.status)?u.message:"",_.label=4;case 4:return _.trys.push([4,6,,7]),[4,this._handleSpoErrors(t,e,r)];case 5:return _.sent(),[3,7];case 6:throw(p=_.sent())&&p.reason&&(g=p.reason.logErrorMessage,p.reason.logErrorMessage=g+" "+f),p;case 7:throw h=e.context,v=e.code,b=e.subContext,U=e.message,O=e.serverResponse,N(Object(i.a)(Object(i.a)({},t),{status:o.d.FAILED}),r),d=d+" "+U+" "+f+" ",Object(C.j)(e,null!=h?h:c,null!=v?v:n.d.Unknown,null!=b?b:a,((F={})[m.a.httpCode]=null==O?void 0:O.status,F[m.a.logErrorMessage]=d,F),e.message)}}))}))},e.prototype._cancelUpload=function(e,t,r){return Object(i.f)(this,void 0,void 0,(function(){var n,o,a;return Object(i.i)(this,(function(i){switch(i.label){case 0:n=F.url(r,t,e),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this._post({url:n,headers:{Scenario:L.a.RemoveFile,ScenarioType:L.b.PassiveOperation},apiName:F.alias})];case 2:return i.sent(),[3,4];case 3:throw o=i.sent(),a=o&&Object(w.a)(o),A(o,"cancelUpload",{errorMessage:"Error occured while cancelling file upload with uploadId: "+e+" & fileId: "+t+". Correlation Id: "+a,correlationId:a});case 4:return[2]}}))}))},e.prototype._deleteFile=function(e,t){return Object(i.f)(this,void 0,Promise,(function(){var r,n,o,a;return Object(i.i)(this,(function(i){switch(i.label){case 0:r=y.url(t,e),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this._delete({url:r,headers:{Scenario:L.a.RemoveFile,ScenarioType:L.b.PassiveOperation},apiName:y.alias,apiNameDecoration:"DeleteFile"})];case 2:return i.sent(),[3,4];case 3:throw n=i.sent(),o=n&&Object(w.a)(n),a="Error occured while deleting file: "+e+". Correlation Id: "+o,this.logger.error(a),A(n,"delete",{errorMessage:a,correlationId:o});case 4:return[2]}}))}))},e.prototype._recycleFile=function(e,t){return Object(i.f)(this,void 0,Promise,(function(){var r,n,o,a;return Object(i.i)(this,(function(i){switch(i.label){case 0:r=_.url(t,e),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this._delete({url:r,headers:{Scenario:L.a.RemoveFile,ScenarioType:L.b.PassiveOperation},apiName:_.alias})];case 2:return i.sent(),[3,4];case 3:throw n=i.sent(),o=n&&Object(w.a)(n),a="Error occured while recycling file: "+e+" Correlation Id: "+o,this.logger.error(""+a),A(n,"recycle",{errorMessage:a,correlationId:o});case 4:return[2]}}))}))},e.prototype._cleanup=function(e){this._ongoingUploads.delete(e.uploadId)},e.prototype._post=function(e){return Object(i.f)(this,void 0,Promise,(function(){var t;return Object(i.i)(this,(function(r){return t=Object(i.a)(Object(i.a)({},e),{timeout:a.a}),[2,this._sharepointRestClient.post(t)]}))}))},e.prototype._delete=function(e){return Object(i.f)(this,void 0,Promise,(function(){return Object(i.i)(this,(function(t){return[2,this._sharepointRestClient.delete(e)]}))}))},e}(),G=r("IgMk"),T=r("W1yN"),z=function(){function e(e,t){this.asyncMediaService=e,this.logger=t.newLogger("FileUploadPreviewService")}return e.prototype.getFilePreview=function(e,t,r){var n;return Object(i.f)(this,void 0,Promise,(function(){var o,a,l,s,c;return Object(i.i)(this,(function(i){switch(i.label){case 0:return Object(G.a)(t)&&r?[4,u(e)]:[2,Promise.resolve("")];case 1:o=i.sent(),a=this.asyncMediaService.createAmsScenario(T.b.FilesAMSImageUpload),i.label=2;case 2:return i.trys.push([2,4,,5]),[4,this.asyncMediaService.uploadItem(new Uint8Array(o),r,"IMAGE",e.name)];case 3:return l=i.sent(),a.stop(),[2,l.inlineSizeUrl];case 4:return s=i.sent(),c=null===(n=s.serverResponse)||void 0===n?void 0:n.status,a.fail({errors:JSON.stringify([Object(C.d)(s)]),errorCode:""+c}),this.logger.error("error fetching preview url for ",r,Object(C.d)(s)),[2,""];case 5:return[2]}}))}))},e}()}}]);