(this.webpackJsonp=this.webpackJsonp||[]).push([[103],{N4HK:function(e,t,r){"use strict";r.r(t),r.d(t,"IUploadRequest",(function(){})),r.d(t,"IUploadDestination",(function(){})),r.d(t,"IItemUploadService",(function(){})),r.d(t,"IUploadResponse",(function(){})),r.d(t,"IUploadNotification",(function(){})),r.d(t,"IItemUploadStatus",(function(){})),r.d(t,"UploadProgressCallback",(function(){})),r.d(t,"UploadConflictBehaviour",(function(){return s.f})),r.d(t,"UploadRequestStatus",(function(){return s.g})),r.d(t,"ItemUploadStage",(function(){return s.b})),r.d(t,"HttpClientProvider",(function(){})),r.d(t,"IRemoteStore",(function(){})),r.d(t,"IRemoteItem",(function(){})),r.d(t,"RemoteStoreType",(function(){return i.c})),r.d(t,"ItemUploadService",(function(){return b})),r.d(t,"IItemDeleteService",(function(){})),r.d(t,"ItemDeleteService",(function(){return U}));var s=r("2J70"),i=r("EZBI"),o=r("+7/b"),n=r("vtvO"),a=r("3J71"),l=r("ifNO"),u=function(e,t,r,s){return""+e+function(e,t,r){return void 0===t&&(t="/"),void 0===r&&(r="root"),"/"+r+":"+t+"/"+e+":"}(t,r,s)},c=function(e,t){var r=function(e){return(e?"https://graph.microsoft.com":"https://api.onedrive.com")+"/v1.0"}(t);if(e.storageType===i.c.CURRENT_USER_DRIVE)return""+r+function(e){return e?"/me/drive":"/drive"}(t);if(!e.storageId)throw new Error("storageId not supplied for RemoteStore: "+e.storageType);switch(e.storageType){case i.c.OTHER_USER_DRIVE:return r+("/users/"+e.storageId+"/drive");case i.c.DRIVE_BY_ID:return r+("/drives/"+e.storageId);case i.c.GROUP:return r+("/groups/"+e.storageId+"/drive");case i.c.SITE:return r+("/sites/"+e.storageId+"/drive")}},d=function(e){var t=e.id,r=e.name,s=e.webUrl;if(t&&"string"!=typeof t||r&&"string"!=typeof r||s&&"string"!=typeof s)throw new Error("Unexpected data type in response");return{id:t,name:r,webUrl:s}},p=function(e,t,r,s,n,a){var u,c,d=Object(l.f)(e.status),p="Correlation-id: "+e.headers["ms-cv"];(null===(u=t.error)||void 0===u?void 0:u.code)&&(d=i.a.get(t.error.code)||d,p+=", error-code: "+t.error.code);var h=Object(o.a)(Object(o.a)({},a),{httpCode:e.status,logErrorMessage:p});return Object(l.a)(r,n||d,s,h,null===(c=t.error)||void 0===c?void 0:c.message,e)},h=function(e,t,r,s,i,n){return void 0===s&&(s=a.d.Unknown),m(e)?e:Object(l.a)(t,s,r,Object(o.a)(Object(o.a)({},n),{innerError:e}),e.message,i)},m=function(e){return e.hasOwnProperty("context")&&e.hasOwnProperty("code")},f=function(e){return e?"@microsoft.graph.conflictBehavior":"@name.conflictBehavior"},g=function(){function e(e,t){this.preferGraphOverVroom=t,this.unauthenticatedHttpSender=e(),this.authenticatedHttpSender=function(e,t){return e(t?"https://graph.microsoft.com":"service::lw.onedrive.com::MBI_SSL",t?"Bearer":"WLID1.1")}(e,t),this.serviceName=function(e){return e?n.a.Graph:n.a.Vroom}(t)}return e.prototype.createUploadSession=function(e,t,r){return void 0===r&&(r=s.f.RENAME),Object(o.f)(this,void 0,Promise,(function(){var s,n,a,l;return Object(o.i)(this,(function(o){var d,p;return s=c(t,this.preferGraphOverVroom),n=u(s,e,t.path,t.parentId),d=n,p=this.preferGraphOverVroom,a=d+"/"+(p?"":"oneDrive.")+"createUploadSession",[2,this.authenticatedHttpSender({url:a,method:"POST",serviceName:this.serviceName,apiName:i.b.CREATE_UPLOAD_SESSION,headers:{"Content-Type":"application/json"},body:JSON.stringify({item:(l={},l[f(this.preferGraphOverVroom)]=r,l.name=e,l)})})]}))}))},e.prototype.uploadChunk=function(e,t,r,n){return Object(o.f)(this,void 0,Promise,(function(){var a;return Object(o.i)(this,(function(o){return a=t.slice(r,n+1),[2,this.unauthenticatedHttpSender({url:e,method:"PUT",serviceName:this.serviceName,apiName:i.b.UPLOAD_CHUNK,headers:{"Content-Length":(n-r+1).toString(),"Content-Range":"bytes "+r+"-"+n+"/"+t.size},body:a,timeout:s.a})]}))}))},e.prototype.cancelUploadSession=function(e){return Object(o.f)(this,void 0,Promise,(function(){return Object(o.i)(this,(function(t){return[2,this.authenticatedHttpSender({url:e,method:"DELETE",serviceName:this.serviceName,apiName:i.b.CANCEL_UPLOAD_SESSION})]}))}))},e.prototype.deleteItem=function(e,t){return Object(o.f)(this,void 0,Promise,(function(){var r,s;return Object(o.i)(this,(function(o){return r=c(e,this.preferGraphOverVroom),s=function(e,t){return""+e+function(e){return"/items/"+e}(t)}(r,t),[2,this.authenticatedHttpSender({url:s,method:"DELETE",serviceName:this.serviceName,apiName:i.b.DELETE_ITEM})]}))}))},e.prototype.quickUpload=function(e,t,r){return Object(o.f)(this,void 0,Promise,(function(){var n,a,l;return Object(o.i)(this,(function(o){return n=c(t,this.preferGraphOverVroom),a=u(n,e.name,t.path,t.parentId),l=function(e,t,r){return void 0===r&&(r=s.f.RENAME),function(e){return e+"/content"}(e)+"?"+f(t)+"="+r}(a,this.preferGraphOverVroom,r),[2,this.authenticatedHttpSender({url:l,method:"PUT",serviceName:this.serviceName,apiName:i.b.QUICK_UPLOAD,body:e,timeout:s.e})]}))}))},e}(),b=function(){function e(e,t,r){var i=this;this.logger=r,this.requests=new Map,this.uploadFiles=function(e){return Object(o.f)(i,void 0,Promise,(function(){var t,r,i,n,a;return Object(o.i)(this,(function(l){switch(l.label){case 0:t=e.requestId,l.label=1;case 1:return l.trys.push([1,6,7,8]),this.logger.log("File: "+t+" setting initial state for the upload"),this.setInitialState(e),[4,this.processRequest(t)];case 2:return l.sent(),(r=this.requests.get(t)).requestStatus!==s.g.REQUEST_CANCELED?[3,4]:(this.logger.log("File: "+t+" cleaning up items from the server, as the upload is cancelled by the user"),[4,this.cleanUpRemoteItems(t)]);case 3:return l.sent(),r.request,r.itemUploadDetails,r.cancellationCallback,i=Object(o.m)(r,["request","itemUploadDetails","cancellationCallback"]),null===(a=r.cancellationCallback)||void 0===a||a.call(null,i),[3,5];case 4:r.items.filter((function(e){return!!e.error})).length>0?(this.logger.log("File: "+t+" failing request, as one of the items is failed to upload"),r.requestStatus=s.g.REQUEST_FAILED):(this.logger.log("File: "+t+" upload request completed successfully"),r.requestStatus=s.g.REQUEST_COMPLETED),l.label=5;case 5:return[2,this.getUploadResponse(t)];case 6:return n=l.sent(),this.logger.error("File: "+t+" An unexpected error occured"),this.handleUnexpectedUploadError(n,t),[2,this.getUploadResponse(t)];case 7:return this.notifyItemUploadStatus(t),this.requests.delete(t),[7];case 8:return[2]}}))}))},this.apiHelper=new g(e,t)}return e.prototype.cancelUploadRequest=function(e,t){var r=this.requests.get(e);if(!r)throw this.logger.error("File: "+e+" cancellation not allowed, either the upload already finishes or the request id is invalid"),Object(l.a)(a.e.ItemUploadService,a.d.UnknownRequestId,i.b.CANCEL_UPLOAD_SESSION);this.logger.log("File: "+e+" parked for cancellation"),r.requestStatus=s.g.REQUEST_CANCELED,r.cancellationCallback=t},e.prototype.setInitialState=function(e){var t,r,i=0,n=0,a=[],l={totalBytes:0,bytesUploaded:0,itemDetails:{},itemUploadStage:s.b.ITEM_UPLOAD_PENDING};if(this.isFile(e.files))this.logger.log("File: "+e.requestId+" request has only 1 file"),i=e.files.size,n=1,a.push(Object(o.a)(Object(o.a)({},l),{itemDetails:{name:e.files.name},totalBytes:i}));else{n=e.files.length,this.logger.log("File: "+e.requestId+" request contains "+n+" files");for(var u=0;u<n;u++){var c=(null===(t=e.files.item(u))||void 0===t?void 0:t.size)||0;i+=c,a.push(Object(o.a)(Object(o.a)({},l),{itemDetails:{name:null===(r=e.files.item(u))||void 0===r?void 0:r.name},totalBytes:c}))}}var d={requestId:e.requestId,requestStatus:s.g.REQUEST_IN_PROGRESS,fileCount:n,request:e,totalBytes:i,bytesUploaded:0,items:a,itemUploadDetails:[]};this.requests.set(e.requestId,d)},e.prototype.isFile=function(e){return Object.getPrototypeOf(e).constructor.name===File.prototype.constructor.name},e.prototype.processRequest=function(e){return Object(o.f)(this,void 0,Promise,(function(){var t,r,s;return Object(o.i)(this,(function(i){switch(i.label){case 0:for(t=this.requests.get(e),r=[],s=0;s<t.fileCount;s++)r[s]=this.uploadItem(e,s);return[4,Promise.all(r)];case 1:return i.sent(),[2]}}))}))},e.prototype.uploadItem=function(e,t){return Object(o.f)(this,void 0,Promise,(function(){var r,i,n;return Object(o.i)(this,(function(o){switch(o.label){case 0:return r=this.requests.get(e),i=r.request.files,n=this.isFile(i)?i:i.item(t),r.items[t].itemUploadStage=s.b.ITEM_UPLOAD_STARTED,this.notifyItemUploadStatus(e,t),n.size<=s.d?(this.logger.log("File: "+e+" index: "+t+" size: "+n.size+" will follow the path of quick upload"),[4,this.uploadSmallItem(e,t,n)]):[3,2];case 1:return o.sent(),[3,4];case 2:return this.logger.log("File: "+e+" index: "+t+" size "+n.size+" will follow the path of session creation"),[4,this.uploadLargeItem(e,t,n)];case 3:o.sent(),o.label=4;case 4:return r.items[t].error||(r.bytesUploaded+=r.items[t].bytesUploaded),this.notifyItemUploadStatus(e,t),[2]}}))}))},e.prototype.uploadSmallItem=function(e,t,r){return Object(o.f)(this,void 0,Promise,(function(){var n,l,u,c,m,f,g;return Object(o.i)(this,(function(b){switch(b.label){case 0:n=this.requests.get(e),l=n.request,u=l.uploadDestination,c=l.conflictBehaviour,b.label=1;case 1:return b.trys.push([1,4,,5]),[4,this.apiHelper.quickUpload(r,u,c)];case 2:return[4,(m=b.sent()).body.json()];case 3:if(f=b.sent(),m.status!==a.j.CREATED&&m.status!==a.j.OK)throw this.logger.error("File: "+e+" index: "+t+" got invalid http status: "+m.status),p(m,f,a.e.ItemUploadService,i.b.QUICK_UPLOAD);return this.logger.log("File: "+e+" index: "+t+" successfully uploaded with http status: "+m.status),n.items[t]=Object(o.a)(Object(o.a)({},n.items[t]),{itemUploadStage:s.b.ITEM_UPLOAD_COMPLETED,bytesUploaded:r.size,itemDetails:d(f)}),[3,5];case 4:return g=b.sent(),this.logger.error("File: "+e+" index: "+t+" failed to quick upload. Error message: "+g.message),n.items[t]=Object(o.a)(Object(o.a)({},n.items[t]),{itemUploadStage:s.b.ITEM_UPLOAD_FAILED,error:h(g,a.e.ItemUploadService,i.b.QUICK_UPLOAD)}),[3,5];case 5:return[2]}}))}))},e.prototype.uploadLargeItem=function(e,t,r){return Object(o.f)(this,void 0,Promise,(function(){var i,n,a,l,u;return Object(o.i)(this,(function(o){switch(o.label){case 0:return i=this.requests.get(e),[4,this.initiateLargeItemUpload(e,t,r)];case 1:if(o.sent(),i.items[t].itemUploadStage===s.b.ITEM_UPLOAD_FAILED)return[2];n=i.itemUploadDetails[t].uploadUrl||"",o.label=2;case 2:return this.shouldContinueUploadingChunk(i,t)?i.requestStatus===s.g.REQUEST_CANCELED?(i.items[t].itemUploadStage=s.b.ITEM_UPLOAD_CANCELED,[2]):(a=this.getChunkRange(r.size,i.itemUploadDetails[t].nextExpectedRanges),l=a[0],u=a[1],this.logger.log("File: "+e+" index: "+t+" size: "+r.size+", uploading chunk: "+l+" - "+u),[4,this.uploadChunk(r,t,e,l,u,n)]):[3,4];case 3:return o.sent(),this.notifyItemUploadStatus(e,t),[3,2];case 4:return[2]}}))}))},e.prototype.initiateLargeItemUpload=function(e,t,r){return Object(o.f)(this,void 0,Promise,(function(){var n,l,u,c,d,p;return Object(o.i)(this,(function(m){switch(m.label){case 0:n=this.requests.get(e),l=n.request,u=l.uploadDestination,c=l.conflictBehaviour,m.label=1;case 1:return m.trys.push([1,4,,5]),[4,this.apiHelper.createUploadSession(r.name,u,c)];case 2:return d=m.sent(),[4,this.processCreateSessionResponse(d,e,t)];case 3:return m.sent(),[3,5];case 4:return p=m.sent(),this.logger.error("File: "+e+" index: "+t+" failed to create a session. Error message: "+p.message),n.items[t]=Object(o.a)(Object(o.a)({},n.items[t]),{itemUploadStage:s.b.ITEM_UPLOAD_FAILED,error:h(p,a.e.ItemUploadService,i.b.CREATE_UPLOAD_SESSION)}),[3,5];case 5:return[2]}}))}))},e.prototype.processCreateSessionResponse=function(e,t,r){return Object(o.f)(this,void 0,Promise,(function(){var s,n;return Object(o.i)(this,(function(l){switch(l.label){case 0:return[4,e.body.json()];case 1:if(s=l.sent(),n=this.requests.get(t),e.status!==a.j.OK)throw this.logger.error("File: "+t+" index: "+r+" got invalid http status: "+e.status),p(e,s,a.e.ItemUploadService,i.b.CREATE_UPLOAD_SESSION);if(this.logger.log("File: "+t+" index: "+r+" session successfully created with http status: "+e.status),!s.uploadUrl)throw this.logger.error("File: "+t+" index: "+r+" upload url not found"),p(e,s,a.e.ItemUploadService,i.b.CREATE_UPLOAD_SESSION,a.d.InvalidResponse);return n.itemUploadDetails[r]=Object(o.a)({nextExpectedRanges:["0-"]},s),[2]}}))}))},e.prototype.shouldContinueUploadingChunk=function(e,t){var r=e.items,i=e.itemUploadDetails,o=r[t],n=o.bytesUploaded,a=o.totalBytes,l=o.itemUploadStage,u=i[t].uploadUrl;return a-n>0&&u&&l!==s.b.ITEM_UPLOAD_COMPLETED&&l!==s.b.ITEM_UPLOAD_CANCELED&&l!==s.b.ITEM_UPLOAD_FAILED},e.prototype.getChunkRange=function(e,t){void 0===t&&(t=["0-"]);var r=t[0].split("-"),i=parseInt(r[0],10);return[i,Math.min(r[1]?parseInt(r[1],10):1/0,e-1,i+s.c-1)]},e.prototype.uploadChunk=function(e,t,r,n,l,u){return Object(o.f)(this,void 0,Promise,(function(){var c,d,p;return Object(o.i)(this,(function(o){switch(o.label){case 0:c=this.requests.get(r),o.label=1;case 1:return o.trys.push([1,4,,5]),[4,this.apiHelper.uploadChunk(u,e,n,l)];case 2:return d=o.sent(),[4,this.processChunkUploadResponse(d,l,n,r,t)];case 3:return o.sent(),[3,5];case 4:return p=o.sent(),this.logger.error("File: "+r+" index: "+t+" \n          failed to upload large file with size: "+e.size+", Chunk: "+n+" - "+l+" failed. Error message: "+p.message),c.items[t].itemUploadStage=s.b.ITEM_UPLOAD_FAILED,c.items[t].error=h(p,a.e.ItemUploadService,i.b.UPLOAD_CHUNK),[3,5];case 5:return[2]}}))}))},e.prototype.processChunkUploadResponse=function(e,t,r,n,l){return Object(o.f)(this,void 0,void 0,(function(){var u,c,h;return Object(o.i)(this,(function(m){switch(m.label){case 0:return u=this.requests.get(n),[4,e.body.json()];case 1:switch(c=m.sent(),h=t-r+1,e.status){case a.j.CREATED:case a.j.OK:this.logger.log("File: "+n+" index: "+l+" Last chunk: "+r+" - "+t+" successfully uploaded with http status: "+e.status),u.items[l].itemDetails=d(c),u.items[l].itemUploadStage=s.b.ITEM_UPLOAD_COMPLETED,u.items[l].bytesUploaded+=h;break;case a.j.ACCEPTED:this.logger.log("File: "+n+" index: "+l+" Chunk: "+r+" - "+t+" successfully uploaded with http status: "+e.status),u.itemUploadDetails[l]=Object(o.a)(Object(o.a)({},u.itemUploadDetails[l]),c),u.items[l].itemUploadStage=s.b.ITEM_CHUNK_UPLOADED,u.items[l].bytesUploaded+=h;break;default:throw this.logger.error("File: "+n+" index: "+l+" Chunk: "+r+" - "+t+" upload got an invalid http status: "+e.status),p(e,c,a.e.ItemUploadService,i.b.UPLOAD_CHUNK)}return[2]}}))}))},e.prototype.cleanUpRemoteItems=function(e){var t;return Object(o.f)(this,void 0,Promise,(function(){var r,i;return Object(o.i)(this,(function(o){switch(o.label){case 0:r=this.requests.get(e),i=0,o.label=1;case 1:return i<r.fileCount?r.items[i].itemUploadStage!==s.b.ITEM_UPLOAD_COMPLETED?[3,3]:(this.logger.log("File: "+e+" index: "+i+" already uploaded. Hence, deleting the file from the server"),[4,this.deleteUploadedFile(e,i)]):[3,6];case 2:return o.sent(),[3,5];case 3:return(null===(t=r.itemUploadDetails[i])||void 0===t?void 0:t.uploadUrl)?(this.logger.log("File: "+e+" index: "+i+" upload is in progress. Hence, cancelling the session"),[4,this.cancelUploadSession(e,i)]):[3,5];case 4:o.sent(),o.label=5;case 5:return i++,[3,1];case 6:return[2]}}))}))},e.prototype.deleteUploadedFile=function(e,t){return Object(o.f)(this,void 0,Promise,(function(){var r,n,l,u,c,d,m,f,g;return Object(o.i)(this,(function(b){switch(b.label){case 0:if(r=this.requests.get(e),!(n=r.items[t].itemDetails.id))return[3,7];b.label=1;case 1:return b.trys.push([1,6,,7]),l=r.request.uploadDestination,u=l.storageType,c=l.storageId,d={storageType:u,storageId:c},[4,this.apiHelper.deleteItem(d,n)];case 2:return(m=b.sent()).status!==a.j.NO_CONTENT?[3,3]:(this.logger.log("File: "+e+" index: "+t+" successfully deleted from the server"),r.items[t].itemUploadStage=s.b.ITEM_UPLOAD_CANCELED,[3,5]);case 3:return[4,m.body.json()];case 4:throw f=b.sent(),this.logger.error("File: "+e+" index: "+t+" deletion failed, got an invalid http error code: "+m.status),p(m,f,a.e.ItemUploadService,i.b.DELETE_ITEM);case 5:return[3,7];case 6:return g=b.sent(),this.logger.error("File: "+e+" index: "+t+" deletion failed. Error message: "+g.message),r.items[t]=Object(o.a)(Object(o.a)({},r.items[t]),{itemUploadStage:s.b.ITEM_CANCEL_UPLOAD_FAILED,error:h(g,a.e.ItemUploadService,i.b.DELETE_ITEM)}),[3,7];case 7:return[2]}}))}))},e.prototype.cancelUploadSession=function(e,t){var r;return Object(o.f)(this,void 0,Promise,(function(){var n,l,u,c;return Object(o.i)(this,(function(d){switch(d.label){case 0:n=this.requests.get(e),d.label=1;case 1:return d.trys.push([1,6,,7]),[4,this.apiHelper.cancelUploadSession((null===(r=n.itemUploadDetails[t])||void 0===r?void 0:r.uploadUrl)||"")];case 2:return(l=d.sent()).status!==a.j.NO_CONTENT?[3,3]:(this.logger.log("File: "+e+" index: "+t+" successfully able to cancel the session"),n.items[t].itemUploadStage=s.b.ITEM_UPLOAD_CANCELED,[3,5]);case 3:return[4,l.body.json()];case 4:throw u=d.sent(),this.logger.error("File: "+e+" index: "+t+" session cancellation failed, got an invalid http error code: "+l.status),p(l,u,a.e.ItemUploadService,i.b.CANCEL_UPLOAD_SESSION);case 5:return[3,7];case 6:return c=d.sent(),this.logger.error("File: "+e+" index: "+t+" session cancellation failed. Error message: "+c.message),n.items[t]=Object(o.a)(Object(o.a)({},n.items[t]),{itemUploadStage:s.b.ITEM_CANCEL_UPLOAD_FAILED,error:h(c,a.e.ItemUploadService,i.b.CANCEL_UPLOAD_SESSION)}),[3,7];case 7:return[2]}}))}))},e.prototype.notifyItemUploadStatus=function(e,t){var r=this.requests.get(e),s=r.request.uploadProgressCallback;if(s){r.request,r.itemUploadDetails;var i=Object(o.m)(r,["request","itemUploadDetails"]);s.call(null,Object(o.a)(Object(o.a)({},i),{currentItemIndex:t}))}},e.prototype.getUploadResponse=function(e){var t=this.requests.get(e);return{requestStatus:t.requestStatus,requestId:t.requestId,fileCount:t.fileCount,items:t.items}},e.prototype.handleUnexpectedUploadError=function(e,t){var r=this.requests.get(t);r.items=r.items.map((function(t,r){return t.itemUploadStage===s.b.ITEM_UPLOAD_COMPLETED?t:Object(o.a)(Object(o.a)({},t),{itemUploadStage:s.b.ITEM_UPLOAD_FAILED,error:h(e,a.e.ItemUploadService,"Unhandled error",a.d.UndefinedGlobalError,void 0,{logErrorMessage:"Item: "+r+" errored out at stage "+t.itemUploadStage})})})),r.requestStatus=s.g.REQUEST_FAILED},e}(),U=function(){function e(e,t,r){this.logger=r,this.apiHelper=new g(e,t)}return e.prototype.deleteItem=function(e,t){return Object(o.f)(this,void 0,Promise,(function(){var r,s,n;return Object(o.i)(this,(function(o){switch(o.label){case 0:return o.trys.push([0,5,,6]),[4,this.apiHelper.deleteItem(e,t)];case 1:return(r=o.sent()).status!==a.j.NO_CONTENT?[3,2]:(this.logger.log("File: "+t+" successfully deleted from the server"),[2,!0]);case 2:return[4,r.body.json()];case 3:throw s=o.sent(),this.logger.error("File: "+t+" failed to delete, got the https status code as "+r.status),p(r,s,a.e.ItemDeleteService,i.b.DELETE_ITEM);case 4:return[3,6];case 5:throw n=o.sent(),this.logger.error("File: "+t+" failed to delete: Error message: "+n.message),h(n,a.e.ItemDeleteService,i.b.DELETE_ITEM);case 6:return[2]}}))}))},e}()}}]);