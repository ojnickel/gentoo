webpackJsonp([56],{2382:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(2383)},2383:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,i,n,r,a,s,o,c,m,u,g,f,l,v,h,S,p,d,F,y,b,T,I,C){this.$q=e,this.$translate=t,this.resources=i,this.constants=n,this.myUserPreferencesStore=r,this.coachmarksService=a,this.dialogService=s,this.freemiumUtilities=o,this.identityService=c,this.tenantService=m,this.channelService=u,this.retryService=g,this.navigationService=f,this.loggingService=l,this.settingsService=v,this.aggregatedSettingsStore=h,this.eventingService=S,this.analyticsService=p,this.utilityService=d,this.manageTenantService=F,this.engagementSurfaceService=y,this.sxConfig=b,this.deepLinkService=T,this.$rootScope=I,C.registerForMtma(this),this.initializeOnAppLaunchAndReinit()}return e.$inject=["$q","$translate","resources","constants","myUserPreferencesStore","coachmarksService","dialogService","freemiumUtilities","identityService","tenantService","channelService","retryService","navigationService","loggingService","settingsService","aggregatedSettingsStore","eventingService","analyticsService","utilityService","manageTenantService","engagementSurfaceService","sxConfig","deepLinkService","$rootScope","orchestrationService"],e.prototype.initializeOnAppLaunchAndReinit=function(e){this.enableFreNameChangeDialog=this.settingsService.valueAsBoolean(this.constants.settings.names.enableFreNameChangeDialog)&&!this.identityService.isTenantAdmin(),this.enableFreemiumFreV2=this.settingsService.valueAsBoolean(this.constants.settings.names.enableFreemiumFreV2),this.enableFeemiumFreVideo=this.settingsService.valueAsBoolean(this.constants.settings.names.enableFeemiumFreVideo);var t=this.settingsService.valueFor(this.constants.settings.names.freemiumFreInviteOption);this.freemiumFreInviteOption=teamspace.services.FreemiumFreInviteOption[t]||teamspace.services.FreemiumFreInviteOption.OptionalInvite;var i=this.settingsService.valueFor(this.constants.settings.names.freemiumFreVideoOption);this.freemiumFreVideoOption=teamspace.services.FreemiumFreVideoOption[i]||teamspace.services.FreemiumFreVideoOption.CoachmarkVideo,this.enableKickoffBootstrapFirst=this.settingsService.valueAsBoolean(this.constants.settings.names.enableKickoffBootstrapFirst)},e.prototype.mtmaTelemetryIdentifier=function(){return"freemiumFre"},e.prototype.cleanupOnAppTeardown=function(e){this.enableFreNameChangeDialog=void 0,this.enableFreemiumFreV2=void 0,this.enableFeemiumFreVideo=void 0,this.freemiumFreInviteOption=void 0,this.freemiumFreVideoOption=void 0,this.enableKickoffBootstrapFirst=void 0,this.unsubscribeChangeEvent&&(this.unsubscribeChangeEvent(),this.unsubscribeChangeEvent=void 0)},e.prototype.show=function(){var e=this,t=this.settingsService.valueAsBoolean(this.constants.settings.names.enableEngagementSurfaces)&&_.includes(this.settingsService.valueFor(this.constants.settings.names.espMigratedFREs),teamspace.services.FirstRunExperience[teamspace.services.FirstRunExperience.Freemium]);t&&this.engagementSurfaceService.load();var i=t?function(){return e.espMigratedFre()}:function(){return e.inPlaceFre()};return this.delayIfNeeded(i)},e.prototype.delayIfNeeded=function(e){return this.isFreemiumOnboardingDeepLinkSession()?this.delayUntilNavigationToTeamsTab(e):this.$q(function(t){return e().then(t)})},e.prototype.isFreemiumOnboardingDeepLinkSession=function(){return this.deepLinkService.deepLinkSessionType()===this.constants.deepLinkTypes.freemiumOnboarding},e.prototype.delayUntilNavigationToTeamsTab=function(e){var t=this;return this.$q(function(i){t.unsubscribeChangeEvent=t.$rootScope.$on(t.constants.events.ng.$stateChangeSuccess,function(n,r,a){t.isGoingToTeamsTab(r,a)&&(t.unsubscribeChangeEvent(),e().then(i))})})},e.prototype.isGoingToTeamsTab=function(e,t){return e.name===this.constants.states.appConversation&&(!t.ctx||t.ctx!==this.constants.navigation.context.chat)},e.prototype.espMigratedFre=function(){var e,t,i=this,n=void 0,r=[this.$q.resolve().then(function(){return t=i.identityService.isTenantAdmin()}).then(function(){return t&&i.preFetchJoinUrl()}).then(function(){return i.getDefaultTeamThreadId()}).then(function(e){return n=e}).then(function(){return i.navigateToTenantWideTeam(n)}).then(function(){return i.freemiumUtilities.getCanInviteMembers()}).then(function(n){return e=i.enableFreemiumFreV2&&i.freemiumFreInviteOption==teamspace.services.FreemiumFreInviteOption.MandatoryInvite&&t||(!i.enableFreemiumFreV2||i.freemiumFreInviteOption!=teamspace.services.FreemiumFreInviteOption.MandatoryInvite)&&n}).then(function(){return e&&i.sendEligiblePanelView(teamspace.PanelType.eligibleFreemiumInviteFre,!0)}).then(function(){return!i.enableKickoffBootstrapFirst&&i.bootstrapTenantWithRetries()}).then(function(){return i.saveSuggestedContacts()}).then(function(){return i.enableFreNameChangeDialog&&i.sendEligiblePanelView(teamspace.PanelType.eligibleFreemiumUpdateProfileFre,!0)}).then(function(){return i.enableFreNameChangeDialog&&i.showUpdateProfileDialog()}).then(function(){return i.markFreemiumFREComplete()}).then(function(){return e&&i.tryShowInvitationFreDialogBeforeQuickGuide()})];return this.enableKickoffBootstrapFirst&&r.push(this.bootstrapTenantWithRetries()),this.utilityService.whenAllAllowFailures(r).then(function(e){var r=i.loggingService.newScenario(i.constants.scenarios.freemium.freBeforeQuickGuide);if(e[0].wasResolved?r.stop():r.fail({errorMessage:JSON.stringify(e[0].result)}),!t){var a=i.loggingService.newScenario(i.constants.scenarios.freemium.nonAdminGetTwtIdFromSettingStore);return n?a.stop():a.fail(),i.$q.resolve()}if(e.length<=1)return i.$q.resolve();var s=i.loggingService.newScenario(i.constants.scenarios.freemium.adminGetTwtIdFromBootstrap);e[1].wasResolved?(n||(n=e[1].result),n?s.stop():s.fail({errorMessage:"No valid TWT Id"})):s.fail()}).then(function(){return i.navigateToTenantWideTeam(n)}).then(function(){return i.showQuickGuides()}).then(function(){return e&&i.tryShowInvitationFreDialogAfterQuickGuide()}).then(function(){return i.tryShowVideoCoachmark()}).then(function(){return i.eventingService.$emit(i.constants.events.app.isReady)})},e.prototype.preFetchJoinUrl=function(){this.manageTenantService.generateJoinTenantUrl()},e.prototype.showUpdateProfileDialog=function(){return this.enableFreemiumFreV2?this.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumUpdateProfileDialogFreV2,this.loggingService.newScenario(this.constants.scenarios.freemium.freemiumFreUpdateProfileDialogSurfaceV2)):this.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumUpdateProfileDialogFre,this.loggingService.newScenario(this.constants.scenarios.freemium.freemiumFreUpdateProfileDialogSurface))},e.prototype.showQuickGuides=function(){this.enableFreemiumFreV2?this.enableFeemiumFreVideo&&this.freemiumFreInviteOption==teamspace.services.FreemiumFreInviteOption.SemiforcefulInvite&&this.freemiumFreVideoOption==teamspace.services.FreemiumFreVideoOption.SweepCardVideo?this.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumFreSweepCardWithVideoSurface,this.loggingService.newScenario(this.constants.scenarios.freemium.freemiumFreSweepCardWithVideoSurface)):this.freemiumFreInviteOption==teamspace.services.FreemiumFreInviteOption.OriginalSurfaceInvite?this.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumFreSweepCardWithReadyCardSurface,this.loggingService.newScenario(this.constants.scenarios.freemium.freemiumFreSweepCardWithReadyCardSurface)):this.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumFreSweepCardSurface,this.loggingService.newScenario(this.constants.scenarios.freemium.freemiumFreSweepCardSurface)):this.settingsService.valueAsBoolean(this.constants.settings.names.enableFreeMeetingsQuickguide)?this.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumFreQuickGuideSurfaceV2,this.loggingService.newScenario(this.constants.scenarios.freemium.freemiumFreQuickGuideSurfacesV2)):this.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumFreQuickGuideSurface,this.loggingService.newScenario(this.constants.scenarios.freemium.freemiumFreQuickGuideSurfaces))},e.prototype.tryShowInvitationFreDialogBeforeQuickGuide=function(){var e=this;if(this.enableFreemiumFreV2&&this.freemiumFreInviteOption!=teamspace.services.FreemiumFreInviteOption.OriginalSurfaceInvite)return this.$q.resolve();var t=this.loggingService.newScenario(this.constants.scenarios.freemium.freemiumFreInviteByUrlDialogSurface);return this.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumJoinByUrlDialogFre,t).then(function(){if(!e.enableFreemiumFreV2&&e.settingsService.valueAsBoolean(e.constants.settings.names.enableOneClickJoin)&&e.identityService.isTenantAdmin()){var t=e.constants.scenarios.freemium.freemiumFreOneClickJoinCoachmarkSurface,i=e.loggingService.newScenario(t),n=teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumFreOneClickJoinCoachmark;return e.engagementSurfaceService.displaySurface(n,i).catch(function(){})}}).catch(function(){return t=e.loggingService.newScenario(e.constants.scenarios.freemium.freemiumFreInviteMembersDialogSurface),e.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumInviteMembersDialogFre,t)})},e.prototype.tryShowInvitationFreDialogAfterQuickGuide=function(){var e=this;if(!this.enableFreemiumFreV2||this.freemiumFreInviteOption==teamspace.services.FreemiumFreInviteOption.OriginalSurfaceInvite)return this.$q.resolve();var t=this.loggingService.newScenario(this.constants.scenarios.freemium.freemiumFreInviteMembersDialogV2);return this.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumFreInviteMembersDialogV2,t).catch(function(){return t=e.loggingService.newScenario(e.constants.scenarios.freemium.freemiumFreInviteMembersDialogSurface),e.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumInviteMembersDialogFre,t)})},e.prototype.tryShowVideoCoachmark=function(){if(!this.enableFreemiumFreV2||!this.enableFeemiumFreVideo||this.freemiumFreInviteOption!=teamspace.services.FreemiumFreInviteOption.SemiforcefulInvite||this.freemiumFreVideoOption!=teamspace.services.FreemiumFreVideoOption.CoachmarkVideo)return this.$q.resolve();var e=this.loggingService.newScenario(this.constants.scenarios.freemium.freemiumFreVideoCoachmark);return this.engagementSurfaceService.displaySurface(teamspace.services.engagementSurfaces.OnDemandSurface.FreemiumFreVideoCoachmark,e)},e.prototype.inPlaceFre=function(){var e,t=this,i=void 0,n={isFre:!0},r={element:".team-operations-container",content:this.$translate.instant(this.resources.strings.freemium_fre_completion_coachmark),placement:"top"};return this.$q.resolve().then(function(){return t.getDefaultTeamThreadId()}).then(function(e){return i=e}).then(function(){return t.navigateToTenantWideTeam(i)}).then(function(){return t.freemiumUtilities.getCanInviteMembers()}).then(function(t){return e=t}).then(function(){return e&&t.sendEligiblePanelView(teamspace.PanelType.eligibleFreemiumInviteFre,!1)}).then(function(){return t.dialogService.open(t.constants.dialogs.freemiumSetup).closePromise}).then(function(){return t.bootstrapTenantWithRetries()}).then(function(){return t.saveSuggestedContacts()}).then(function(){return t.enableFreNameChangeDialog&&t.sendEligiblePanelView(teamspace.PanelType.eligibleFreemiumUpdateProfileFre,!1)}).then(function(){return t.enableFreNameChangeDialog&&t.dialogService.open(t.constants.dialogs.updateUserProfileFre,n).closePromise}).then(function(){return t.markFreemiumFREComplete()}).then(function(){return e&&t.openMemberInvitationDialog().closePromise}).then(function(){return t.navigateToTenantWideTeam(i)}).then(function(){return e&&t.coachmarksService.showAdHocCoachmark(r)}).then(function(){return t.eventingService.$emit(t.constants.events.app.isReady)})},e.prototype.sendEligiblePanelView=function(e,t){this.analyticsService.sendPanelView({panel:{type:teamspace.PanelType[e],uri:void 0,uriParams:void 0,viewId:this.utilityService.generateUUID(),previousUri:void 0,previousUriParams:void 0,region:teamspace.PanelRegion[teamspace.PanelRegion.main]},dataBag:{isMigratedToEsp:t}})},e.prototype.getDefaultTeamThreadId=function(){var e=this,t=this.$q.resolve();return this.settingsService.valueAsBoolean(this.constants.settings.names.enableSkypeTokenLicenseDetails)&&(t=this.aggregatedSettingsStore.startAndWaitForSettingsToInitialize(SkypeX.Services.AggregatesettingsStorageKey.tenantProperties).toNgPromise(this.$q)),t.then(function(){var t=e.aggregatedSettingsStore.getSettings();return t&&t.tenantProperties&&t.tenantProperties.value&&t.tenantProperties.value.defaultTeamThreadId})},e.prototype.openMemberInvitationDialog=function(){return this.memberTenantInvitationDialog()},e.prototype.memberTenantInvitationDialog=function(){return this.dialogService.open(this.constants.dialogs.memberTenantInvitation,{isFre:!0})},e.prototype.markFreemiumFREComplete=function(){var e=this.myUserPreferencesStore.getUserPreferences(),t=e&&e.firstLoginInformation||{},i=(new Date).toISOString();return t[this.constants.firstLoginDeviceKeys.freemiumFRE]=i,t.espFirstRunCompleted=i,this.myUserPreferencesStore.setUserPreference(SkypeX.Services.MyUserPreferenceStorageKey.FirstLoginInformation,JSON.stringify(t)).toNgPromise(this.$q)},e.prototype.saveSuggestedContacts=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.freemium.freemiumFreSuggestedContacts);this.manageTenantService.getAllTenantUsers().then(function(i){if(i)if(1!==i.length){var n=e.constants.freemium.suggestedContacts.numberOfContactsToShow+1,r=e.sxConfig.getCurrentSkypeMri(),a=i.slice(0,n).map(function(e){if(r!==e.mri)return{email:e.mail||e.email,mri:e.mri,objectId:e.objectId}}).filter(function(e){return null!=e});e.myUserPreferencesStore.setUserPreference(SkypeX.Services.MyUserPreferenceStorageKey.SuggestedContacts,JSON.stringify(a)).toNgPromise(e.$q),t.stop()}else t.stop();else t.fail({message:"Failed to add suggested contacts"})}).catch(function(){t.fail({message:"Failed to add suggested contacts"})})},e.prototype.bootstrapTenantWithRetries=function(){var e=this,t={forever:!1,retryIntervals:this.constants.freemium.bootstrap.retryIntervals};return this.enableKickoffBootstrapFirst?this.retryService.retry(this.constants.freemium.bootstrap.retryName,function(){return e.tenantService.bootstrapTenant()},t).promise:(this.retryService.retry(this.constants.freemium.bootstrap.retryName,function(){return e.tenantService.bootstrapTenant()},t),this.$q.resolve(null))},e.prototype.navigateToTenantWideTeam=function(e){var t,i=this;e?this.channelService.getTeams().then(function(n){var r=n.filter(function(t){return t.objectId==e});r.length>0&&(t=r[0]);var a=i.loggingService.newScenario(i.constants.scenarios.freemium.findTwtByTwtId);t?(a.stop(),i.navigationService.navigateToTeam(e,i.constants.navCtx.freemiumFreCtx).then(function(){if(t.isCollapsed){var e=$('[data-tid="team-channel-list"]').controller("channelList");e&&e.expandCollapseTeam&&e.expandCollapseTeam(t)}})):(a.fail(),i.navigationService.navigateToDefaultTeamState(i.constants.navCtx.freemiumFreCtx))}):this.navigationService.navigateToDefaultTeamState(this.constants.navCtx.freemiumFreCtx)},e}();t.FreemiumFre=n,angular.module("teamspace.freemiumFre",["pascalprecht.translate","teamspace.locales","teamspace.constants","skypeX.myUserPreferencesStore","teamspace.coachmarksService","teamspace.dialogService","teamspace.freemiumUtilities","teamspace.identityService","teamspace.tenantService","teamspace.channelService","teamspace.retryService","teamspace.navigationService","teamspace.loggingService","teamspace.settingsService","skypeX.aggregatedSettingsStore","teamspace.eventingService","teamspace.freemiumSetup","teamspace.analyticsService","teamspace.engagementSurfaceService","teamspace.deepLinkService","teamspace.orchestrationService"]).service("freemiumFre",n)}},[2382]);