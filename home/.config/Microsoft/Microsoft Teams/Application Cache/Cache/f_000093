(this.webpackJsonp=this.webpackJsonp||[]).push([[113],{anpg:function(e,t,r){"use strict";r.r(t),r.d(t,"SubstrateSearchService",(function(){return O})),r.d(t,"SubstrateFilesSearchService",(function(){return I})),r.d(t,"SharepointSearchService",(function(){return R})),r.d(t,"EntityType",(function(){return f.b})),r.d(t,"SubstrateEntityType",(function(){return f.d})),r.d(t,"ProvenanceFields",(function(){return f.a})),r.d(t,"ContentSourceFields",(function(){return f.a})),r.d(t,"Tabs",(function(){return f.m})),r.d(t,"SubstrateSearchActionsEventType",(function(){return f.j})),r.d(t,"SubstrateSearchEntityActionsEventType",(function(){return f.k})),r.d(t,"SearchTriggerOrigin",(function(){return f.c})),r.d(t,"SubstrateResultType",(function(){return f.i})),r.d(t,"SubstratePlacementType",(function(){return f.h})),r.d(t,"SubstrateLayoutType",(function(){return f.g})),r.d(t,"SubstrateEvent",(function(){return f.e})),r.d(t,"DATE_FILTER_OPTIONS",(function(){return l.a})),r.d(t,"MIDDLETIER",(function(){return l.u})),r.d(t,"SUBSTRATE",(function(){return l.L})),r.d(t,"RESULT_SET_KEY",(function(){return l.G})),r.d(t,"OSEARCH",(function(){return l.E})),r.d(t,"SPELLER_SUGGESTION_KEY",(function(){return l.K})),r.d(t,"SnippetOptions",(function(){})),r.d(t,"IUserData",(function(){})),r.d(t,"SubstrateSearchMessageResponse",(function(){})),r.d(t,"SubstrateSearchFilesResponse",(function(){})),r.d(t,"SubstrateSearchPeopleResponse",(function(){})),r.d(t,"ISubstrateSearchEntitySet",(function(){})),r.d(t,"SubstrateSearchMessageResultSet",(function(){})),r.d(t,"SubstrateSearchFilesResultSet",(function(){})),r.d(t,"SubstrateSearchPeopleResultSet",(function(){})),r.d(t,"ISubstrateSearchMessageResult",(function(){})),r.d(t,"ISubstrateSearchOneDriveFileResult",(function(){})),r.d(t,"ISubstrateSearchSharePointFileResult",(function(){})),r.d(t,"ISubstrateSearchPeopleResult",(function(){})),r.d(t,"ISearchResultCount",(function(){})),r.d(t,"OSearchService",(function(){return y})),r.d(t,"IOSearchResponse",(function(){})),r.d(t,"IOSearchResponseWithCacheInfo",(function(){})),r.d(t,"IOSearchResponseMetadata",(function(){})),r.d(t,"IOSearchFileEntity",(function(){})),r.d(t,"handleCancelScenario",(function(){return g.q})),r.d(t,"IOSearchService",(function(){})),r.d(t,"ISearchFilters",(function(){})),r.d(t,"IFilters",(function(){})),r.d(t,"IPeopleFilterData",(function(){})),r.d(t,"ITeamChannelFilterData",(function(){})),r.d(t,"ITeamChannelFilter",(function(){})),r.d(t,"ISubstrateSearchService",(function(){})),r.d(t,"ISubstrateFilesSearchService",(function(){})),r.d(t,"ISubstrateAllSearchResponse",(function(){})),r.d(t,"ISubstrateAllSearchEntitySet",(function(){})),r.d(t,"ISubstrateAllSearchResultSet",(function(){})),r.d(t,"ISubstrateAllMessageSearchResponse",(function(){})),r.d(t,"ISubstrateAllMessageSearchEntitySet",(function(){})),r.d(t,"ISubstrateAllMessageSearchResultSet",(function(){})),r.d(t,"ISearchPeopleQueryParams",(function(){})),r.d(t,"PeopleSearchService",(function(){return T})),r.d(t,"IPeopleSearchService",(function(){})),r.d(t,"ISharepointSearchResponse",(function(){})),r.d(t,"IFileSearchCellResultProperty",(function(){})),r.d(t,"IFileSearchCellResult",(function(){})),r.d(t,"LokiMetaPreviewService",(function(){return j})),r.d(t,"ILokiMetaPreviewService",(function(){})),r.d(t,"IMetaPreviewParams",(function(){})),r.d(t,"searchServiceCache",(function(){return v.a})),r.d(t,"ISearchGetReplyChainParams",(function(){})),r.d(t,"ISearchSetReplyChainParams",(function(){})),r.d(t,"OdcFilePreviewService",(function(){return N})),r.d(t,"IOdcFilePreviewService",(function(){})),r.d(t,"ISubstrateSearchActionsData",(function(){})),r.d(t,"ISubstrateSearchEntityActionsData",(function(){})),r.d(t,"ISearchClientLayoutResultView",(function(){})),r.d(t,"ISubstrateResultsRenderedData",(function(){})),r.d(t,"ISubstrateClientLayoutData",(function(){}));var n,i,s=r("+7/b");!function(e){e.Standard="Standard",e.Private="Private",e.Shared="Shared"}(n||(n={})),function(e){e.Relevance="Relevance",e.DateTime="DateTime"}(i||(i={}));var a=r("W1yN"),o=r("zQSw"),c=r("vtvO"),u=r("svWY"),l=r("580J"),d=r("jN5E"),h=r("g9Js"),S=r("xkH/"),f=r("7nZh"),g=r("s+Ab"),v=r("sok1"),b=r("ifNO"),p={EnableAlteration:!0,EnableSuggestion:!0,SupportedRecourseDisplayTypes:["Suggestion"]},E=function(e){return(null==e?void 0:e.sortOrderSource)===l.J?{}:{topResultsCount:l.L.TOP_RESULTS_COUNT}},O=function(e,t,r,i,O,I){var R=this;this.currentUserProfile=null,this.lcid=l.b,this.substrateInstrumentationTimer=null,this.eventMap={},this.postMessageQuery=function(e,t,r,n,i,c){return Object(s.f)(R,void 0,Promise,(function(){var d,h,S,b,p,E,O,I,R,m,y,T,C,j,F,A,P,D,L,_,w;return Object(s.i)(this,(function(s){switch(s.label){case 0:return d=this.scenarioFactory.findScenario(r),h=v.a.retrieve("messages",t),S=f.e.CachedContentRendered,h?(b=h.logicalId,p=h.results,this.markFetchedFromCacheForMessages(n,d),E=Object(g.h)(b),this.sendSubstrateInstrumentation(S,E),[2,p]):(I=c)?[4,this.buildQueryFilterString(c)]:[3,2];case 1:I=s.sent(),s.label=2;case 2:return O=I,[4,this.generateRequestFor3SMessagesSearch(e,t,i,n,d,{queryString:O,filters:c})];case 3:R=s.sent(),s.label=4;case 4:return s.trys.push([4,7,,8]),m=i.get(o.a.Serp).tokenUrl||l.L.TOKEN_URL,(null==d?void 0:d.eventData.correlationId)===n&&d.mark(a.c.RequestSent3S),y=Date.now(),[4,this.sender(R,m)];case 5:return T=s.sent(),C=T.body,j=T.status,F=T.headers,A=Date.now()-y,(null==d?void 0:d.eventData.correlationId)===n&&d.mark(a.c.ResponseSuccess3S),[4,C.json()];case 6:return P=s.sent(),D=Object(u.get)(P,"EntitySets[0].ResultSets[0].Total"),L=(null==P?void 0:P.Instrumentation.TraceId)||"",this.logResponseRecievedForMessages(D,L,n),(null==d?void 0:d.eventData.correlationId)===n&&d.appendEventData({traceId:L}),this.sendResponseReceivedInstrumentation(L,j,A),_=Object(g.e)(P,F),v.a.store("messages",t,_),v.a.clearDomain(l.E.SEARCH_TYPE.MESSAGE),[2,_];case 7:throw w=s.sent(),d&&Object(g.r)(w,n,d,this.logger),w;case 8:return[2]}}))}))},this.searchAllMessageQuery=function(e,t,r,n,i){return Object(s.f)(R,void 0,Promise,(function(){var a,c,u,d,h,S,f,p,E,O,I,R,m,y,T;return Object(s.i)(this,(function(s){switch(s.label){case 0:return a=v.a.getAllPageMessages(),c=null===(m=this.scenarioFactory)||void 0===m?void 0:m.findScenario(t),a?[2,a.results]:[4,this.generateRequestForAllMessageSearch(e,n,r,i)];case 1:u=s.sent(),s.label=2;case 2:return s.trys.push([2,5,,6]),d=n.get(o.a.Serp).tokenUrl,[4,this.sender(u,d||l.L.TOKEN_URL)];case 3:return h=s.sent(),S=h.body,f=h.headers,[4,S.json()];case 4:return p=s.sent(),E=(null==p?void 0:p.Instrumentation.TraceId)||"",(null==c?void 0:c.eventData.correlationId)===r&&c.appendEventData({traceId:E}),this.logger.log("Returning results for All Message Search. TraceId: "+E+" ClientRequestID: "+r),O=Object(g.e)(p,f),v.a.setAllPageMessages(O),[2,O];case 5:throw I=s.sent(),R="ErrorMessage: "+JSON.stringify(I),(null==c?void 0:c.eventData.correlationId)===r&&(null==c||c.fail({errorCode:(null===(y=I.serverResponse)||void 0===y?void 0:y.status)||(null===(T=I.reason)||void 0===T?void 0:T.httpCode)||Object(b.c)(I),correlationId:u.correlationId,reason:R})),this.logger.warn(R),I;case 6:return[2]}}))}))},this.searchAllData=function(e,t,r,n,i){return Object(s.f)(R,void 0,Promise,(function(){var c,u,d,h,S,b,p,E,O,I,R,m,y,T,C,j,F,A,P,D;return Object(s.i)(this,(function(s){switch(s.label){case 0:return c=v.a.retrieve("all",1),u=null===(D=this.scenarioFactory)||void 0===D?void 0:D.findScenario(a.b.AllSearch),d=f.e.CachedContentRendered,c?(h=c.logicalId,S=c.results,null==u||u.mark(a.c.FetchedFromServiceCache,{message:l.P.FETCHED_FROM_CACHE}),b=Object(g.h)(h),this.sendSubstrateInstrumentation(d,b),[2,S]):[4,this.generateRequestForAllSearch(e,t,r,n,i)];case 1:p=s.sent(),s.label=2;case 2:return s.trys.push([2,5,,6]),null==u||u.mark(a.c.RequestSent3S),E=Date.now(),O=r.get(o.a.Serp).tokenUrl||l.L.TOKEN_URL,[4,this.sender(p,O)];case 3:return I=s.sent(),R=I.body,m=I.status,y=I.headers,T=Date.now()-E,null==u||u.mark(a.c.ResponseSuccess3S),[4,R.json()];case 4:return C=s.sent(),j=null==C?void 0:C.Instrumentation.TraceId,null==u||u.appendEventData({traceId:j}),C&&C.error&&(F=null==C?void 0:C.error,this.logTelemetryForPartialError(F,u)),this.logger.log(this.allPageResultsLogString(C,p.correlationId)),this.sendResponseReceivedInstrumentation(j,m,T),C=Object(g.s)(C),A=Object(g.e)(C,y),v.a.store("all",1,A),[2,A];case 5:throw P=s.sent(),u&&Object(g.r)(P,n,u,this.logger),P;case 6:return[2]}}))}))},this.sendSubstrateInstrumentation=function(e,t){return Object(s.f)(R,void 0,void 0,(function(){var r,n,i;return Object(s.i)(this,(function(s){return this.substrateInstrumentationTimer||(this.substrateInstrumentationTimer=this.windowProvider.setTimeout(this.sendTelemetryToEvents,l.N)),r=Object(g.b)(e,t),n={Name:e,Attributes:[]},Object.keys(t).forEach((function(e){var r=Object(u.get)(t,""+e),i={Key:e,Value:"object"==typeof r?JSON.stringify(r):r};n.Attributes.push(i)})),this.eventMap.hasOwnProperty(r)?this.eventMap[r].push(n):((i=[]).push(n),this.eventMap[r]=i),[2]}))}))},this.logTelemetryForPartialError=function(e,t){null==t||t.appendEventData({reason:Object(b.b)(e,!1),errorCode:Object(u.get)(e,"httpCode",Object(b.c)(e)),isPartialError:!0})},this.sendResponseReceivedInstrumentation=function(e,t,r){var n=f.e.ResponseReceived,i=Object(g.n)(e,t,r);R.sendSubstrateInstrumentation(n,i)},this.sendTelemetryToEvents=function(){R.substrateInstrumentationTimer&&R.windowProvider.clearTimeout(R.substrateInstrumentationTimer),R.substrateInstrumentationTimer=null,R.windowProvider.requestIdleCallback((function(){var e=R.windowProvider.setTimeout((function(){return Object(s.f)(R,void 0,void 0,(function(){var t,r=this;return Object(s.i)(this,(function(n){switch(n.label){case 0:t=[],Object.keys(this.eventMap).forEach((function(e){var n={Key:e,Value:Object(u.get)(r.eventMap,""+e)};t.push(n)})),this.eventMap={},n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.postDataToEventsAPI(t,"powerbar")];case 2:return n.sent(),[3,4];case 3:throw n.sent();case 4:return this.windowProvider.clearTimeout(e),[2]}}))}))}))}))},this.postDataToEventsAPI=function(e,t){return Object(s.f)(R,void 0,Promise,(function(){var r,n,i,a,o;return Object(s.i)(this,(function(s){switch(s.label){case 0:return r=l.L.SUBSTRATE_BASE_URL+"/"+l.L.END_POINT.EVENTS,n=r+"?scenario="+t,i=this.platformService.host.sessionId||Object(d.v4)(),[4,Object(g.k)(this.authService,this.currentUserProfile,Object(d.v4)(),i)];case 1:a=s.sent(),o={url:n,method:"POST",headers:a,body:JSON.stringify(e),serviceName:c.a.Substrate,apiName:"substrateEvents",correlationId:a.clientRequestId},s.label=2;case 2:return s.trys.push([2,4,,5]),[4,this.sender(o,l.L.TOKEN_URL)];case 3:return[2,s.sent()];case 4:throw s.sent();case 5:return[2]}}))}))},this.logResponseRecievedForMessages=function(e,t,r){return R.logger.log("Returning "+e+" results for Message Search. TraceId: "+t+" ClientRequestID: "+r)},this.markFetchedFromCacheForMessages=function(e,t){return(null==t?void 0:t.eventData.correlationId)===e&&t.mark(a.c.FetchedFromServiceCache,{message:l.P.FETCHED_FROM_CACHE})},this.kqlQueryBuilder=function(e,t){var r=t.get(o.a.Serp).substrateMessageSearchInFilterKeyword;if(!r)return e;var n=new RegExp("\\b"+r+":","gi");return e=e.replace(n,l.i+":")},this.buildQueryFilterString=function(e){return Object(s.f)(R,void 0,Promise,(function(){var t,r,n,i,a,o;return Object(s.i)(this,(function(s){switch(s.label){case 0:return this.logger.log("Creating query filter string for Messages"),t=[],e.date&&e.date.length&&(r=Object(g.a)(e.date,l.n),t.push(r)),e.attachment&&t.push(l.l+":yes"),e.mention?(n=this,[4,Object(g.p)(this.authService,this.currentUserProfile)]):[3,2];case 1:n.currentUserProfile=s.sent(),i=Object(u.get)(this.currentUserProfile,"oid"),a=i.replace(/-/g,""),t.push(l.o+":"+a),s.label=2;case 2:return e.people&&t.push(this.createFromFilterValueString(e.people)),(null===(o=e.teamChannel)||void 0===o?void 0:o.isApplied)&&e.teamChannel.teamChannelList[0].channelId&&t.push(l.m+":"+e.teamChannel.teamChannelList[0].channelId),"channel"===e.type&&t.push(l.p),"chat"===e.type&&t.push("NOT "+l.p),[2,t.join(" AND ")]}}))}))},this.createFromFilterValueString=function(e){return e.mri?"("+l.s+":"+e.mri+")":e.email?"("+l.r+":"+e.email+")":"("+l.r+":"+e.displayName+")"},this.generateRequestFor3SMessagesSearch=function(e,t,r,n,i,u){return Object(s.f)(R,void 0,Promise,(function(){var h,S,f,v,b,p,E,O,I;return Object(s.i)(this,(function(s){switch(s.label){case 0:return h=Object(g.f)(r),S=h+"/"+l.L.END_POINT.QUERY,f=Object(g.l)(r),v=r.get(o.a.Serp),b=v.enableInterTenantSharedChannelMessageSearch,p=v.enableTimingHeaderFlightFor3S,E=this.getExtraHeaders(!!b,!!p),(null==i?void 0:i.eventData.correlationId)===n&&i.mark(a.c.RequestHeaderStart),O=this.platformService.host.sessionId||Object(d.v4)(),[4,Object(g.k)(this.authService,this.currentUserProfile,n,O,E)];case 1:return I=s.sent(),this.logger.log("Created request for 3S Message search. ClientRequestId: "+I.clientRequestId),[2,{url:S,method:"POST",headers:I,body:JSON.stringify(this.generateRequestBodyFor3SMessagesSearch(e,t,r,u)),timeout:f,serviceName:c.a.Substrate,apiName:"searchMessages",correlationId:I.clientRequestId}]}}))}))},this.getExtraHeaders=function(e,t){var r=[];if(e&&r.push(l.L.CLIENT_FLIGHTS.INTER_TENANT_SHARED_CHANNEL),t&&r.push(l.L.CLIENT_FLIGHTS.TIMING_HEADER),r.length){var n={};return n[l.L.HEADER_KEYS.X_CLIENT_FLIGHTS]=r.join(","),n}},this.getSharedChannelRefinerStr=function(e,t,r){var n=e.get(o.a.Serp),i=n.enableSharedChannelMessageSearch,s="";if(n.enableInterTenantSharedChannelMessageSearch){var a='GroupId:TenantId:or("',c=t.length-1;t.forEach((function(e,t){a+=e+":"+r+(t!==c?",":'")')})),s=a}else if(i){var u="GroupId:or(",l=t.length-1;t.forEach((function(e,t){u+='"'+e+'"'+(t!==l?",":")")})),s=u}return s},this.generateRequestBodyFor3SMessagesSearch=function(e,t,r,i){var a,o,c=v.a.getInstrumentationData(),d=c.conversationId,h=c.logicalId,S=R.kqlQueryBuilder(e,r),b=(null==i?void 0:i.queryString)?S+" AND "+Object(u.get)(i,"queryString"):S,E=Object(s.a)({entityRequests:[Object(s.a)(Object(s.a)({},l.L.MESSAGE_SEARCH.DEFAULT_REQUEST_BODY),{query:{queryString:b+" AND NOT (isClientSoftDeleted:TRUE)",displayQueryString:e},from:t*l.L.MAX_PAGE_SIZE,size:l.L.MAX_PAGE_SIZE,topResultsCount:l.L.TOP_RESULTS_COUNT})],QueryAlterationOptions:p,cvid:d,logicalId:h,scenario:{name:f.l.powerbar}},(null==i?void 0:i.queryString)?{}:{timezone:Object(g.o)()}),O=R.getRefiningQuery(r,i);O&&(E.entityRequests[0].RefiningQueries=O);var I=null===(o=null===(a=null==i?void 0:i.filters)||void 0===a?void 0:a.teamChannel)||void 0===o?void 0:o.teamChannelList[0];return function(e){return e&&!(null==e?void 0:e.channelOnlyMember)&&(e.groupId||e.substrateGroupId&&(e.channelType===n.Shared||e.isBackedBySubstrateGroup))}(I)&&(E.entityRequests[0].filter={Term:{GroupId:(null==I?void 0:I.substrateGroupId)||(null==I?void 0:I.groupId)}}),i&&"chat"===Object(u.get)(i,"filters.type")&&(E.entityRequests[0].filter={Term:{ConversationType:l.q}}),E},this.getRefiningQuery=function(e,t){var r,n,i,s="";return(null===(n=null===(r=null==t?void 0:t.filters)||void 0===r?void 0:r.teamChannel)||void 0===n?void 0:n.isApplied)&&(null===(i=t.filters.teamChannel.teamChannelList[0].sharedChannelIds)||void 0===i?void 0:i.length)&&t.filters.teamChannel.teamChannelList[0].tenantId&&(s=R.getSharedChannelRefinerStr(e,t.filters.teamChannel.teamChannelList[0].sharedChannelIds,t.filters.teamChannel.teamChannelList[0].tenantId)),s?[{RefinerString:s}]:null},this.generateRequestBodyFor3SAllMessagesSearch=function(e,t,r){var n=v.a.getInstrumentationData(),i=n.conversationId,a=n.logicalId;return{entityRequests:[Object(s.a)(Object(s.a)(Object(s.a)({},l.L.MESSAGE_SEARCH.DEFAULT_REQUEST_BODY),{query:{queryString:R.kqlQueryBuilder(e,t)+" AND NOT (isClientSoftDeleted:TRUE)",displayQueryString:e},size:l.L.TOP_RESULTS_COUNT}),E(r))],QueryAlterationOptions:p,cvid:i,logicalId:a,scenario:{name:f.l.powerbar}}},this.generateRequestBodyFor3SAllSearch=function(e,t,r,n){var i=t.numberOfMessageResults,a=t.numberOfFileResults,c=t.numberOfPeopleResults,u=r.get(o.a.Serp).enableOdbContentSourceInSerpForAll,d=Object(g.d)(e,0,R.lcid,a,!!u,n),h=v.a.getInstrumentationData(),S=h.conversationId,b=h.logicalId;return{entityRequests:[Object(s.a)(Object(s.a)(Object(s.a)({},l.L.MESSAGE_SEARCH.DEFAULT_REQUEST_BODY),{query:{queryString:R.kqlQueryBuilder(e,r)+" AND NOT (isClientSoftDeleted:TRUE)",displayQueryString:e},size:i}),E(n)),d,Object(s.a)(Object(s.a)({},l.O.DEFAULT_REQUEST_BODY),{fields:l.O.ENTITY_REQUESTS_FIELDS,contentSources:[l.O.CONTENT_SOURCES],query:{queryString:e,displayQueryString:e},size:c,HitHighlight:l.O.HITHIGHLIGHT})],QueryAlterationOptions:p,cvid:S,logicalId:b,scenario:{name:f.l.powerbar}}},this.generateRequestForAllSearch=function(e,t,r,n,i){return Object(s.f)(R,void 0,Promise,(function(){var a,o,u,h,S;return Object(s.i)(this,(function(s){switch(s.label){case 0:return a=Object(g.f)(r),o=a+"/"+l.L.END_POINT.QUERY,u=this.platformService.host.sessionId||Object(d.v4)(),[4,Object(g.k)(this.authService,this.currentUserProfile,n,u,l.L.ALL_PAGE_EXTRA_HEADERS)];case 1:return h=s.sent(),S=Object(g.l)(r),this.logger.log("Created request for 3S All Search. ClientRequestId: "+h.clientRequestId),[2,{url:o,method:"POST",headers:h,timeout:S,body:JSON.stringify(this.generateRequestBodyFor3SAllSearch(e,t,r,i)),serviceName:c.a.Substrate,apiName:"searchAll",correlationId:h.clientRequestId}]}}))}))},this.allPageResultsLogString=function(e,t){var r="Fetched ",n=null==e?void 0:e.EntitySets;return null==n||n.forEach((function(e){var t;r+=((null===(t=e.ResultSets)||void 0===t?void 0:t[0].Total)||0)+" "+(e.EntityType||" ")+" results; "})),r=r.trim()+" for All search. TraceId: "+(null==e?void 0:e.Instrumentation.TraceId)+". ClientRequestID: "+t+"."},this.generateRequestForAllMessageSearch=function(e,t,r,n){return Object(s.f)(R,void 0,Promise,(function(){var i,a,o,u;return Object(s.i)(this,(function(s){switch(s.label){case 0:return i=Object(g.f)(t),a=i+"/"+l.L.END_POINT.QUERY,o=this.platformService.host.sessionId||Object(d.v4)(),[4,Object(g.k)(this.authService,this.currentUserProfile,r,o)];case 1:return u=s.sent(),this.logger.log("Created request for 3S All Message Search. ClientRequestId: "+u.clientRequestId),[2,{url:a,method:"POST",headers:u,body:JSON.stringify(this.generateRequestBodyFor3SAllMessagesSearch(e,t,n)),serviceName:c.a.Substrate,apiName:"searchAll",correlationId:u.clientRequestId}]}}))}))};var m=Object(h.a)(e);this.logger=O.newLogger(l.j.SUBSTRATE_SEARCH_SERVICE),this.sender=function(e,r){return t.authorize(m,r)(e)},this.authService=t;var y=Object(S.c)(r,i);this.lcid=Object(S.b)(y),this.scenarioFactory=i,this.windowProvider=I,this.platformService=r},I=function(){function e(e,t,r,n,i){var c=this;this.lcid=l.b,this.currentUserProfile=null,this.getData=function(e,t,r,n,i,d,h){return Object(s.f)(c,void 0,Promise,(function(){var c,S,b,p,E,O,I,R,m,y,T,C,j,F,A,P,D,L,_,w,N;return Object(s.i)(this,(function(s){switch(s.label){case 0:return c=this.scenarioFactory.findScenario(r),S=v.a.retrieve("files",t),b=d.sendSubstrateInstrumentation,p=f.e.CachedContentRendered,E=f.e.ResponseReceived,S?(O=S.logicalId,I=S.results,this.markFetchedFromCache(n,c),_=Object(g.h)(O),b(p,_),[2,I]):[4,this.create3SFilesRequest(e,t,i,n,c,h)];case 1:R=s.sent(),s.label=2;case 2:return s.trys.push([2,5,,6]),m=i.get(o.a.Serp).tokenUrl||l.L.TOKEN_URL,(null==c?void 0:c.eventData.correlationId)===n&&c.mark(a.c.RequestSent3S),y=Date.now(),[4,this.sender(R,m)];case 3:return T=s.sent(),C=T.body,j=T.status,F=T.headers,A=Date.now()-y,(null==c?void 0:c.eventData.correlationId)===n&&c.mark(a.c.ResponseSuccess3S),[4,C.json()];case 4:return P=s.sent(),D=Object(u.get)(P,"Instrumentation.TraceId",""),L=Object(u.get)(P,"EntitySets[0].ResultSets[0].Total",-1),this.logResponseRecieved(L,D,n),(null==c?void 0:c.eventData.correlationId)===n&&c.appendEventData({traceId:D}),_=Object(g.n)(D,j,A),b(E,_),w=Object(g.e)(P,F),v.a.store("files",t,w),[2,w];case 5:throw N=s.sent(),c&&Object(g.r)(N,n,c,this.logger),N;case 6:return[2]}}))}))},this.markFetchedFromCache=function(e,t){return(null==t?void 0:t.eventData.correlationId)===e&&t.mark(a.c.FetchedFromServiceCache,{message:l.P.FETCHED_FROM_CACHE})},this.logResponseRecieved=function(e,t,r){return c.logger.log("Returning "+e+" results for Files search. TraceId: "+t+". ClientRequestId: "+r)};var d=Object(h.a)(e);this.logger=i.newLogger(l.j.SEARCH_SUBSTRAE_FILE_SERVICE),this.sender=function(e,r){return t.authorize(d,r)(e)};var b=Object(S.c)(r,n);this.lcid=Object(S.b)(b),this.authService=t,this.scenarioFactory=n,this.platformService=r}return e.prototype.create3SFilesRequest=function(e,t,r,n,i,o){return Object(s.f)(this,void 0,Promise,(function(){var u,h,S,f,v,b;return Object(s.i)(this,(function(s){switch(s.label){case 0:return u=Object(g.f)(r),h=u+"/"+l.L.END_POINT.QUERY,(null==i?void 0:i.eventData.correlationId)===n&&i.mark(a.c.RequestHeaderStart),S=this.platformService.host.sessionId||Object(d.v4)(),[4,Object(g.k)(this.authService,this.currentUserProfile,n,S)];case 1:return f=s.sent(),v=Object(g.l)(r),b={url:h,method:"POST",headers:f,timeout:v,body:JSON.stringify(this.create3SFilesBody(e,t,this.lcid,r,o)),serviceName:c.a.Substrate,apiName:"searchFiles",correlationId:f[l.L.HEADER_KEYS.CLIENT_ID]},this.logger.log("Created request for 3S Files. ClientRequestId: "+f[l.L.HEADER_KEYS.CLIENT_ID]),[2,b]}}))}))},e.prototype.create3SFilesBody=function(e,t,r,n,i){var s=v.a.getInstrumentationData(),a=s.conversationId,c=s.logicalId,u=n.get(o.a.Serp).enableOdbContentSourceInSerpForFiles,d={Cvid:a,LogicalId:c,EntityRequests:[Object(g.d)(e,t,r,l.L.MAX_PAGE_SIZE,!!u,i)],Scenario:l.M.SCENARIO,TextDecorations:l.M.TEXT_DECORATIONS,QueryAlterationOptions:l.M.QUERY_ALTERATION_OPTIONS};return this.logger.log("Created request body for 3S Files"),d},e}(),R=function(){function e(e,t,r){this.logger=r.newLogger(l.j.SHAREPOINT_SEARCH_SERVICE),this.sender=function(r,n){return t.authorize(e,n)(r)}}return e.prototype.buildQueryFilterString=function(e){var t,r=[];if(e.date){var n=Object(g.a)(e.date,"LastModifiedTime");r.push(n)}if(e.people&&r.push("ModifiedBy:"+e.people.displayName),(null===(t=e.teamChannel)||void 0===t?void 0:t.isApplied)&&e.teamChannel.teamChannelList[0].groupId&&r.push("groupId:"+e.teamChannel.teamChannelList[0].groupId),e.filetype){var i=Object(u.get)(l.h,e.filetype);r.push(i)}return this.logger.log("Creating query filter string for Files"),r.join(" ")},e.prototype.getData=function(e,t,r){return this.logger.log("Fetching File results from Sharepoint"),this.get(e,t,r)},e.prototype.get=function(e,t,r){var n=r&&this.buildQueryFilterString(r);return this.sender(Object(g.c)(e,t,n),l.I.BASE_URL).then((function(e){return e.body.json()})).catch((function(e){return e}))},e}(),m=r("7AWT"),y=function(){function e(e,t,r){var n=this;this.postOSearchMessageAndFileQuery=function(e,t,r,i,a,o,c,u,l){return Object(s.f)(n,void 0,Promise,(function(){var n,d,h,S,b,p,E,O,I;return Object(s.i)(this,(function(s){switch(s.label){case 0:return n=null==u?void 0:u.findScenario(r),d=v.a.retrieve(o,t),h=f.e.CachedContentRendered,S=Object(g.u)(a),d?(b=d.logicalId,p=d.results,this.markFetchedFromCache(i,n),S&&l&&(E=l.sendSubstrateInstrumentation,O=Object(g.h)(b),E(h,O)),I={},[4,p]):[3,2];case 1:return[2,(I.results=s.sent(),I.isFetchedFromCache=!0,I)];case 2:return[2,this.sendRequestForMessageAndFileSearch(e,t,i,a,o,S,c,l)]}}))}))},this.sendRequestForMessageAndFileSearch=function(e,t,r,i,a,o,u,l){return Object(s.f)(n,void 0,Promise,(function(){var n,d,h,S,b,p,E,O,I,R,m,y,T,C,j;return Object(s.i)(this,(function(s){switch(s.label){case 0:return s.trys.push([0,6,,7]),n=f.e.ClientDataSource,d=f.e.ResponseReceived,h=Date.now(),E=this.wrappedSend,[4,this.generateRequestForMessageAndFileSearch(e,t,r,i,a,u)];case 1:return[4,E.apply(this,[s.sent()])];case 2:return S=s.sent(),b=S.body,p=S.status,O=Date.now()-h,[4,b.json()];case 3:return I=s.sent(),o&&l?(R=c.a.OSearch,m=l.sendSubstrateInstrumentation,y=Object(g.n)(r,p,O,R,e.length),m(d,y),[4,this.getClientDataSourceResults(I)]):[3,5];case 4:T=s.sent(),C=Object(g.i)(r,R,T),m(n,C),s.label=5;case 5:return this.logResponseRecieved(I.length,r),v.a.store(a,t,I),[2,{results:I,isFetchedFromCache:!1}];case 6:throw j=s.sent(),this.handleError(j),j;case 7:return[2]}}))}))},this.markFetchedFromCache=function(e,t){return(null==t?void 0:t.eventData.correlationId)===e&&(null==t?void 0:t.mark(a.c.FetchedFromServiceCache,{message:l.P.FETCHED_FROM_CACHE}))},this.logResponseRecieved=function(e,t){return n.logger.log("Returning "+e+" results for Message Search from Osearch. ClientRequestID: "+t)},this.handleError=function(e){var t="ErrorMessage: "+Object(b.b)(e);n.logger.warn(t)},this.getClientDataSourceResults=function(e){return Object(s.f)(n,void 0,void 0,(function(){return Object(s.i)(this,(function(t){switch(t.label){case 0:return[4,e];case 1:return[2,t.sent().map((function(e){return{referenceId:e.ParentReferenceId,type:f.m.Messages,entityId:e.ParentReferenceId}}))]}}))}))},this.generateRequestBodyForMessageAndFileSearch=function(e,t,r,i){return Object(s.f)(n,void 0,Promise,(function(){var n,a,o,c;return Object(s.i)(this,(function(s){switch(s.label){case 0:return n=[],r===l.E.SEARCH_TYPE.MESSAGE?n.push({All:e}):r===l.E.SEARCH_TYPE.FILE&&n.push({Annotation:{TYPE:l.F.annotations.files,VALUE:{fileName:e}}}),a={OPTION:{RESULTBASE:t*l.E.MAX_PAGE_SIZE,RESULTCOUNT:l.E.MAX_PAGE_SIZE+1,ANCHORDATETIME:Object(m.g)(new Date)},QUERYSTRING:{and:n}},i?(c=i)?[4,this.buildQueryFilterString(i,r)]:[3,2]:[3,3];case 1:c=s.sent(),s.label=2;case 2:(o=c).length>0&&(a.QUERYSTRING.and=a.QUERYSTRING.and.concat(o)),s.label=3;case 3:return[2,a]}}))}))},this.buildQueryFilterString=function(e,t){return Object(s.f)(n,void 0,Promise,(function(){var r,n,i,a;return Object(s.i)(this,(function(s){switch(s.label){case 0:return this.logger.log("Creating query filter string"),r=[],this.getTeamsQueryString(e).forEach((function(e){return r.push(e)})),e.people&&r.push({From:e.people.mri}),e.date&&e.date.length&&this.getDateQueryFilter(e.date).forEach((function(e){r.push(e)})),t!==l.E.SEARCH_TYPE.MESSAGE?[3,3]:(e.attachment&&r.push({Annotation:{TYPE:l.F.annotations.files}}),e.mention?[4,this.discover.getUser()]:[3,2]);case 1:n=s.sent(),r.push({Annotation:{TYPE:l.F.annotations.mentions,VALUE:{mri:n&&n.id}}}),s.label=2;case 2:"chat"===e.type&&r.push({ConversationType:l.E.CONVERSATION_TYPE.ONETOONE}),"channel"===e.type&&r.push({ConversationType:l.E.CONVERSATION_TYPE.GROUP}),s.label=3;case 3:return t===l.E.SEARCH_TYPE.FILE&&e.filetype&&(i=this.getFileFilter(e.filetype),a=[],i.forEach((function(e){a.push({Annotation:{TYPE:l.F.annotations.files,VALUE:{fileType:e}}})})),r.push({or:a})),[2,r]}}))}))},this.getTeamsQueryString=function(e){var t,r=[];return(null===(t=e.teamChannel)||void 0===t?void 0:t.isApplied)&&(e.teamChannel.teamChannelList[0].id&&r.push({GroupId:e.teamChannel.teamChannelList[0].id}),e.teamChannel.teamChannelList[0].channelId&&r.push({ThreadId:e.teamChannel.teamChannelList[0].channelId})),r},this.getDateQueryFilter=function(e){var t=[];if(e===l.a.TWO_WEEKS_AGO){var r=Object(g.g)(2,!1),i=Object(g.j)(2,!1);t.push(n.getCreationDateQueryFilterString(l.F.dateGtOperation,r)),t.push(n.getCreationDateQueryFilterString(l.F.dateLtOperation,i))}else t.push(n.getCreationDateQueryFilterString(l.F.dateEqOperation,e.replace(/ /g,"").toLowerCase()));return t},this.getCreationDateQueryFilterString=function(e,t){return{CreationDate:{OP:e,VALUE:t}}},this.getHeader=function(e,t){return Object(s.f)(n,void 0,void 0,(function(){var r;return Object(s.i)(this,(function(n){return(r=Object(s.a)({},l.E.DEFAULT_HEADERS))[l.E.HEADER_KEYS.SKYPETOKEN]=e,r[l.E.HEADER_KEYS.TIMESTAMP]=(new Date).toISOString(),r[l.E.HEADER_KEYS.CLIENT_ID]=t||Object(d.v4)(),[2,r]}))}))},this.getFileFilter=function(e){return Object(u.get)(l.h,e).replace(/filetype:/g,"").split(" ")},this.wrappedSend=Object(h.a)(e),this.discover=t,this.logger=r.newLogger(l.j.OSEARCH_SEARCH_SERVICE)}return e.prototype.generateRequestForMessageAndFileSearch=function(e,t,r,n,i,a){return Object(s.f)(this,void 0,Promise,(function(){var o,u,l,d,h,S;return Object(s.i)(this,(function(s){switch(s.label){case 0:return o=Object(g.m)(n),[4,this.discover.validateSkypeToken()];case 1:return u=s.sent(),[4,this.getHeader(u,r)];case 2:return l=s.sent(),this.logger.log("Created request for OSearch. ClientRequestId: "+l.clientRequestId),S={url:o,method:"POST",headers:l},h=(d=JSON).stringify,[4,this.generateRequestBodyForMessageAndFileSearch(e,t,i,a)];case 3:return[2,(S.body=h.apply(d,[s.sent()]),S.serviceName=c.a.OSearch,S.apiName=i,S.correlationId=l.clientRequestId,S)]}}))}))},e}(),T=function(){function e(e,t,r){var n=this;this.send=e,this.post=function(e,t,r,i,o){return Object(s.f)(n,void 0,Promise,(function(){var n,u,l,d,h,S,p,E,O,I,R,m,y;return Object(s.i)(this,(function(s){switch(s.label){case 0:return[4,this.discover.validateSkypeToken()];case 1:n=s.sent(),u=this.generateRequestForPeopleSearch(e,t,r,n),this.logger.log("Sending request to MT. ClientRequestId: "+t),s.label=2;case 2:return s.trys.push([2,5,,6]),(null==o?void 0:o.eventData.correlationId)===t&&o.mark(a.c.RequestSentMT),l=Date.now(),[4,this.wrappedSend(u)];case 3:return d=s.sent(),h=d.body,S=d.status,p=Date.now()-l,E=Object(g.n)(t,S,p,c.a.MiddleTier,e.length),i.sendSubstrateInstrumentation(f.e.ResponseReceived,E),(null==o?void 0:o.eventData.correlationId)===t&&(null==o||o.mark(a.c.ResponseSuccessMT)),[4,h.json()];case 4:return O=s.sent(),v.a.store("people",1,O.value),[2,O.value];case 5:throw I=s.sent(),R="ErrorMessage: "+JSON.stringify(I),(null==o?void 0:o.eventData.correlationId)===t&&o.fail({errorCode:(null===(m=I.serverResponse)||void 0===m?void 0:m.status)||(null===(y=I.reason)||void 0===y?void 0:y.httpCode)||Object(b.c)(I),correlationId:t,reason:R}),this.logger.warn(R),I;case 6:return[2]}}))}))},this.logger=t.newLogger(l.j.PEOPLE_SEARCH_SERVICE),this.wrappedSend=Object(h.a)(this.send),this.discover=r}return e.prototype.searchUsers=function(e,t,r,n,i,o){return Object(s.f)(this,void 0,Promise,(function(){var u,d,h,S,b,p,E,O;return Object(s.i)(this,(function(s){switch(s.label){case 0:return e.trim()?(u=null==o?void 0:o.findScenario(t),(d=v.a.retrieve("people",1))?(h=d.logicalId,S=d.results,(null==u?void 0:u.eventData.correlationId)===r&&u.mark(a.c.FetchedFromServiceCache,{message:l.P.FETCHED_FROM_CACHE}),b=Object(g.h)(h),i.sendSubstrateInstrumentation(f.e.CachedContentRendered,b),[2,S]):[4,p=this.post(e,r,n,i,u)]):(this.logger.log("Searched for an empty string"),[2,Promise.resolve([])]);case 1:return E=s.sent().map((function(e){return{referenceId:e.objectId,type:f.m.People,entityId:e.mri}})),O=Object(g.i)(r,c.a.MiddleTier,E),i.sendSubstrateInstrumentation(f.e.ClientDataSource,O),[2,p]}}))}))},e.prototype.generateRequestForPeopleSearch=function(e,t,r,n){var i="?includeDLs="+r.includeDLs+"&includeBots="+r.includeBots+"&skypeTeamsInfo="+r.skypeTeamsInfo+"&source="+r.source+"&enableGuest="+r.enableGuest,a=""+l.u.USERS_SEARCH_URL+i;return this.logger.log("Created request body for People search. ClientRequestId: "+t),{url:a,method:"POST",body:e,headers:Object(s.a)(Object(s.a)({},l.u.DEFAULT_HEADERS),{clientRequestId:t,"x-ms-serp-correlation-id":t,"x-skypetoken":n}),correlationId:t,serviceName:c.a.MiddleTier,apiName:"searchPeople"}},e}(),C=function(e){return"https://"+e+"loki.delve.office.com/api/v1/documents/searchpreview"},j=function(e,t,r){var n=this;this.getData=function(e){return Object(s.f)(n,void 0,void 0,(function(){var t,r,n,i,a,o,u,d,h,S,f,g;return Object(s.i)(this,(function(s){switch(s.label){case 0:t=e.spWebUrl,r=e.listId,n=e.webId,i=e.siteId,a=e.uniqueId,o=e.fileType,u=function(e,t){return t(e.toLowerCase()+".")}("Msit",C),d=u+("?spWebUrl="+t+"&listId="+r+"&webId="+n+"&siteId="+i+"&uniqueId="+a+"&documentType="+o),h=l.k,this.logger.log("Getting metapreview data"),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,this.sender({url:d,method:"GET",apiName:"fileMetaPreviewService",serviceName:c.a.LokiWrapper,headers:l.t.DEFAULT_HEADERS},h)];case 2:return S=s.sent().body,[2,F(S.blob())];case 3:throw f=s.sent(),g="Error occurred while fetching data for metapreview, ErrorMessage: "+JSON.stringify(Object(b.d)(f)),this.logger.error(g),f;case 4:return[2]}}))}))};var i=Object(h.a)(e);this.sender=function(e,r){return t.authorize(i,r)(e)},this.logger=r.newLogger(l.j.LOKI_METAPREVIEW_SERVICE)},F=function(e){return e.then((function(e){return URL.createObjectURL(e)}))},A=r("3J71"),P=r("tgiI"),D=r("Pq9x"),L=r("f4tu"),_=r("pybt"),w=r("8FIh"),N=function(e,t,r){var n=this;this.getFilePreviewThumbnail=function(e,t,r){return Object(s.f)(n,void 0,void 0,(function(){var n,i,a,o,c,u,d,h;return Object(s.i)(this,(function(s){switch(s.label){case 0:n=Object(P.a)(t),i=""+l.w+n+l.y,this.logger.log("Getting OneDrive file preview data for fileId: "+e),s.label=1;case 1:return s.trys.push([1,4,,5]),(a=v.a.retrieveFilePreview(e))?(this.logger.log("Returning file preview thumbnail from cache for fileId: "+e),[2,a]):(o=Object(g.t)(r),c=o?this.sendWithRetry:this.authenticatedHttpSender,this.logger.log("Request for file preview thumbnail for fileId: "+e),[4,c(this.buildRequest(i,e,o))]);case 2:return u=s.sent().body,this.logger.log("Returning file thumbnail data for fileId: "+e),[4,Object(D.b)(u.blob())];case 3:return[2,s.sent()];case 4:throw d=s.sent(),h="Error occurred while fetching filepreview data for fileId: "+e+", ErrorMessage: "+JSON.stringify(Object(b.d)(d)),this.logger.error(h),d;case 5:return[2]}}))}))},this.getResourceBasedSender=function(e,t,r){var n,i,s=l.C;return s?null!==(i=null===(n=e.authorizeV2)||void 0===n?void 0:n.call(e,t,s,{scheme:r}))&&void 0!==i?i:e.authorize(t,s):t},this.buildRequest=function(e,t,r){var n={url:e,method:"GET",serviceName:c.a.Vroom,apiName:"OdcFilePreviewService",correlationId:Object(d.v4)()};return r&&(n=Object(s.a)(Object(s.a)({},n),{uniqueId:t,delay:new L.d(l.B,l.x,l.A),retryCounter:0,maxRetryCount:l.z})),n},this.retryLogic=function(e,t){return Object(s.f)(n,void 0,Promise,(function(){var r,n,i,a,o,c;return Object(s.i)(this,(function(s){switch(s.label){case 0:return r=null===(o=null==e?void 0:e.serverResponse)||void 0===o?void 0:o.status,n=null===(c=null==e?void 0:e.serverResponse)||void 0===c?void 0:c.headers,r&&(r===A.j.THROTTLED||r>=A.j.SERVER_ERROR)&&void 0!==t.retryCounter&&t.delay&&t.maxRetryCount&&t.retryCounter++<t.maxRetryCount?(this.logger.log("Retry:"+t.retryCounter+" for fileId:"+t.uniqueId),i=Object(u.toNumber)(n&&n[l.H])||0,a=Math.max(i,t.delay.next()),[4,Object(_.a)(a)]):[3,2];case 1:return s.sent(),[3,3];case 2:throw e;case 3:return[2]}}))}))};var i=Object(h.a)(e),a=l.D;this.authenticatedHttpSender=this.getResourceBasedSender(t,i,a),this.sendWithRetry=Object(w.a)(this.authenticatedHttpSender,(function(e,t){return Object(s.f)(n,void 0,void 0,(function(){return Object(s.i)(this,(function(r){switch(r.label){case 0:return[4,this.retryLogic(e,t)];case 1:return r.sent(),[2]}}))}))})),this.logger=r.newLogger(l.j.ODC_FILEPREVIEW_SERVICE)}},g9Js:function(e,t,r){"use strict";r.d(t,"a",(function(){return a}));var n=r("+7/b"),i=r("3J71"),s=r("ifNO");function a(e){var t=this;return function(r){return Object(n.f)(t,void 0,void 0,(function(){var t;return Object(n.i)(this,(function(n){switch(n.label){case 0:return[4,e(r)];case 1:if((t=n.sent()).status>=i.j.BAD_REQUEST)throw Object(s.a)(i.e.RejectHttpError,i.d.RemoteOperationFailed,"rejectHttpError",void 0,void 0,t);return[2,t]}}))}))}}},tgiI:function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var n=function(e){return e=e.replace(/#/g,"%23")},i=function(e){if(!e)return null;var t,r=(t=e)&&"string"==typeof t?btoa(n(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(parseInt(t,16))})))):null;return r?(r=r.replace(/=+$/g,"").replace(/\//g,"_").replace(/\+/g,"-"),r="u!".concat(r)):null}}}]);