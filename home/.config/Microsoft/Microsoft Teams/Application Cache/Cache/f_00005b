webpackJsonp([57],{2519:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(2520)},2520:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var a="MonetizationService",o=function(e){function t(t,n,i,s,o,r,c,p,l,u,g){var h=e.call(this,c)||this;h.$rootScope=t,h.authenticationService=n,h.constants=i,h.loggingService=o,h.analyticsService=r,h.orchestrationService=c,h.settingsService=p,h.utilityService=l,h.monetizationDatabase=u,h.$q=g,h.logger=o.newLogger(a);var v=new teamspace.services.DataManagerOptions(i.urls.monetizationService.products.type,function(e){return"products"});v.useTeamspaceTokens=!1,v.isTransient=!0,h.productListDataManager=s.registerManager(v);var m=new teamspace.services.DataManagerOptions(i.urls.monetizationService.assets.type,function(e){return"assets"});m.useTeamspaceTokens=!1,m.isTransient=!0,h.assetListDataManager=s.registerManager(m);var d=new teamspace.services.DataManagerOptions(i.urls.monetizationService.saasState.type,function(e){return e.setupUrlWithToken});d.useTeamspaceTokens=!1,d.isTransient=!0,h.saasStateDataManager=s.registerManager(d);var f=new teamspace.services.DataManagerOptions(i.urls.monetizationService.billingRegion.type,function(e){return"billingRegion"});f.useTeamspaceTokens=!1,f.isTransient=!0,h.billingRegionDataManager=s.registerManager(f);var S=new teamspace.services.DataManagerOptions(i.urls.monetizationService.supportedBillingRegions.type,function(e){return"countries"});S.useTeamspaceTokens=!1,S.isTransient=!0,h.supportedBillingRegionsDataManager=s.registerManager(S);var y=new teamspace.services.DataManagerOptions(i.urls.monetizationService.settings.type,function(e){return"settings"});return y.useTeamspaceTokens=!1,y.isTransient=!1,h.settingsDataManager=s.registerManager(y),h.initializeOnAppLaunchAndReinit("launch"),h}return i(t,e),t.$inject=["$rootScope","authenticationService","constants","dataManagerService","loggingService","analyticsService","orchestrationService","settingsService","utilityService","monetizationDatabase","$q"],t.prototype.initializeOnAppLaunchAndReinit=function(e){this.logger.info("initializeOnAppLaunchAndReinit monetizationService: reason = {0}",e)},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("cleanupOnAppTeardown monetizationService: reason = {0}",e)},t.prototype.mtmaTelemetryIdentifier=function(){return a},t.prototype.getSupportedBillingRegions=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.supportBillingRegions);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return t.fail({error2:"monetization feature flag is not enabled"}),this.$q.resolve(null);var n=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.getSupportedBillingRegionsCache(n).then(function(i){return i?(t.appendEventData(s(s({},e.getSupportedBillingRegionsEventData(i)),{source:e.constants.scenarios.extensibility.monetization.cache.supportedBillingRegions})),t.stop(),i):e.getSupportedBillingRegionsFromApi(n).then(function(n){if(!n)throw"empty response from Billing Regions API";return t.appendEventData(s(s({},e.getSupportedBillingRegionsEventData(n)),{source:e.constants.scenarios.extensibility.monetization.apis.supportBillingRegions})),t.stop(),n})}).catch(function(e){var n=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return t.fail({error:n,error2:n}),Promise.resolve(null)})},t.prototype.getBillingRegion=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.billingRegion);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return t.fail({error2:"monetization feature flag is not enabled"}),this.$q.resolve(null);var n=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.getBillingRegionCache().then(function(i){return i?(t.appendEventData(s(s({},e.getBillingRegionEventData(i)),{source:e.constants.scenarios.extensibility.monetization.cache.billingRegion})),t.stop(),i):e.getBillingRegionFromApi(n).then(function(n){return t.appendEventData(s(s({},e.getBillingRegionEventData(n)),{source:e.constants.scenarios.extensibility.monetization.apis.billingRegion})),t.stop(),n})})},t.prototype.setBillingRegion=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.billingRegion);return this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization)?this.putBillingRegionCache(e).then(function(){return n.stop(),t.refreshMonetizationCache()}):(n.fail({error2:"monetization feature flag is not enabled"}),this.$q.resolve(null))},t.prototype.getProducts=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.products);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return t.fail({error2:"monetization feature flag is not enabled"}),this.$q.resolve(null);var n=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.getMonetizationAppsListCache(n).then(function(i){return i?(t.appendEventData(s(s({},e.getMonetizationAppsListEventData(i)),{source:e.constants.scenarios.extensibility.monetization.cache.products})),t.stop(),i):e.getProductsFromAPI(n).then(function(n){if(!n)throw"empty response from Products API";return t.appendEventData(s(s({},e.getMonetizationAppsListEventData(n)),{source:e.constants.scenarios.extensibility.monetization.apis.products})),t.stop(),n})}).catch(function(e){var n=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return t.fail({error:n,error2:n}),Promise.resolve(null)})},t.prototype.getAssets=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.assets);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return t.fail({error2:"monetization feature flag is not enabled"}),this.$q.resolve(null);var n=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.getAssetsListCache(n).then(function(i){return i?(t.appendEventData(s(s({},e.getAssetsListEventData(i)),{source:e.constants.scenarios.extensibility.monetization.cache.assets})),t.stop(),i):e.getAssetsFromAPI(n).then(function(n){if(!n)throw"empty response from Assets API";return t.appendEventData(s(s({},e.getAssetsListEventData(n)),{source:e.constants.scenarios.extensibility.monetization.apis.assets})),t.stop(),n})}).catch(function(e){var n=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return t.fail({error:n,error2:n}),Promise.resolve(null)})},t.prototype.getProductAndAssetDetails=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.productAndAssetDetails);return this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization)?this.getProducts().then(function(i){if(!i||0==i.length)return n.stop(),null;var s=i.find(function(t){return t&&t.associatedSaaSProducts&&t.associatedSaaSProducts.length>0&&t.officeProductId==e});return s?t.getAssets().then(function(e){var t=s.associatedSaaSProducts[0].saasBigCatalogId,i={officeProductName:s.officeProductName,officeProductId:s.officeProductId,associatedSaaSProducts:s.associatedSaaSProducts,activeSubscription:null};if(e&&e.length>0)for(var a=0;a<s.associatedSaaSProducts.length;a++){var o=s.associatedSaaSProducts[a];t=o.saasBigCatalogId;var r=e.find(function(e){return e&&e.isActive&&e.saasBigCatalogId==t});if(r)return i.activeSubscription=r,n.stop(),i}return n.stop(),i}):(n.stop(),null)}):(n.fail({error2:"monetization feature flag is not enabled"}),this.$q.resolve(null))},t.prototype.getSaaSState=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.saaSState);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return n.fail({error2:"monetization feature flag is not enabled"}),this.$q.resolve(null);var i=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.generateDataManagerRequestOptions(i,n).then(function(n){var s={url:""+t.utilityService.combineUriComponents(i.endpointUri,i.assetSaaSStatePath,e),method:"GET",timeout:i.productsHttpTimeoutSeconds*t.constants.timeInMiliseconds.second,skipCommonHeaders:!0};return t.saasStateDataManager.invoke(s,n)}).then(function(e){if(!e)throw"empty response from SaaSState API";return n.appendEventData({configUrl:e.setupUrlWithToken}),n.stop(),e}).catch(function(e){var t=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return n.fail({error:t,error2:t}),Promise.resolve(null)})},t.prototype.refreshMonetizationCache=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.refreshCache);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return t.fail({error2:"monetization feature flag is not enabled"}),this.$q.resolve(null);var n=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.getProductsFromAPI(n).then(function(i){if(!i)throw"empty response from Products API";return e.getAssetsFromAPI(n).then(function(a){if(!a)throw"empty response from Assets API";return e.getSupportedBillingRegionsFromApi(n).then(function(n){if(!n)throw"empty response from Billing Regions API";var o={products:i,assets:a,countries:n};return t.appendEventData(s(s({},o),{source:e.constants.scenarios.extensibility.monetization.cache.refreshCache})),t.stop(),o})})})},t.prototype.sendUserBiTelemetryForMonetizationDialogs=function(e,t){var n={panel:{type:e,uri:void 0,uriParams:void 0,viewId:this.utilityService.generateUUID(),region:teamspace.PanelRegion[teamspace.PanelRegion.main],previousUri:void 0,previousUriParams:void 0},dataBag:t};this.analyticsService.sendPanelView(n)},t.prototype.getBillingRegionFromApi=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.billingRegion);return this.generateDataManagerRequestOptions(e,n).then(function(n){var i={url:""+t.utilityService.combineUriComponents(e.endpointUri,e.billingRegionPath),method:"GET",timeout:1e3*e.productsHttpTimeoutSeconds,skipCommonHeaders:!0};return t.billingRegionDataManager.invoke(i,n)}).then(function(e){if(e){var i=JSON.stringify(e);n.appendEventData({responseData:i})}return n.stop(),t.putBillingRegionCache(e),e}).catch(function(e){var t=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return n.fail({error:t,error2:t}),null})},t.prototype.getSupportedBillingRegionsFromApi=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.supportBillingRegions);return this.generateDataManagerRequestOptions(e,n).then(function(n){var i={url:""+t.utilityService.combineUriComponents(e.endpointUri,e.supportBillingRegionsPath),method:"GET",timeout:1e3*e.productsHttpTimeoutSeconds,skipCommonHeaders:!0};return t.supportedBillingRegionsDataManager.invoke(i,n)}).then(function(e){if(!e)throw"empty response from GetSupportedBillingRegions";var i=JSON.stringify(e);return n.appendEventData({responseData:i}),n.stop(),t.putSupportedBillingRegionsCache(e),e}).catch(function(e){var t=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return n.fail({error:t,error2:t}),null})},t.prototype.getProductsFromAPI=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.products);return this.getBillingRegionCache().then(function(i){return t.generateDataManagerRequestOptions(e,n).then(function(n){var s=t.utilityService.combineUriComponents(e.endpointUri,e.productsPath);i&&(s=t.utilityService.appendQueryStringToUrl(s,e.billingRegionQueryString,i.country));var a={url:""+s,method:"GET",timeout:e.productsHttpTimeoutSeconds*t.constants.timeInMiliseconds.second,skipCommonHeaders:!0};return t.productListDataManager.invoke(a,n)}).then(function(e){if(!e)throw"empty response from Products";return n.stop(),t.putMonetizationAppsListCache(e),e}).catch(function(e){var t=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return n.fail({error:t,error2:t}),Promise.resolve(null)})})},t.prototype.getAssetsFromAPI=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.products);return this.getBillingRegionCache().then(function(i){return t.generateDataManagerRequestOptions(e,n).then(function(n){var s=t.utilityService.combineUriComponents(e.endpointUri,e.assetsPath);i&&(s=t.utilityService.appendQueryStringToUrl(s,e.billingRegionQueryString,i.country));var a={url:""+s,method:"GET",timeout:e.assetsHttpTimeoutSeconds*t.constants.timeInMiliseconds.second,skipCommonHeaders:!0};return t.assetListDataManager.invoke(a,n)}).then(function(e){if(!e)throw"empty response from Assets";return n.stop(),t.putAssetsListCache(e),e}).catch(function(e){var t=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return n.fail({error:t,error2:t}),Promise.resolve(null)})})},t.prototype.getSettings=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.apis.settings);if(!this.settingsService.valueAsBoolean(this.constants.settings.names.enableMonetization))return t.fail({error2:"monetization feature flag is not enabled"}),this.$q.resolve(null);var n=this.settingsService.valueFor(this.constants.settings.names.monetizationConstants);return this.generateDataManagerRequestOptions(n,t).then(function(t){var i={url:""+e.utilityService.combineUriComponents(n.endpointUri,n.settingsPath),method:"GET",timeout:1e3*n.productsHttpTimeoutSeconds,skipCommonHeaders:!0};return e.settingsDataManager.invoke(i,t)}).then(function(e){if(!e)return t.fail({reason:"Empty response from Monet Settings api"}),null;var n=JSON.stringify(e);return t.appendEventData({responseData:n}),t.stop(),e}).catch(function(e){var n=JSON.stringify(teamspace.services.AppsServiceUtils.getSafeError(e));return t.fail({error:n,error2:n}),null})},t.prototype.generateDataManagerRequestOptions=function(e,t){var n=e.resourceUri;return this.authenticationService.getAuthToken(n).then(function(e){var n=new teamspace.services.DataManagerRequestOptions;return n.skipApply=!0,n.scenario=t,n.additionalHeaders={Authorization:"Bearer "+e.token},n})},t.prototype.open=function(){return this.isOpen?SkypeX.Services.SyncTasks.Resolved():this.monetizationDatabase.open()},Object.defineProperty(t.prototype,"isOpen",{get:function(){return this.monetizationDatabase.isOpen},enumerable:!0,configurable:!0}),t.prototype.getHashCode=function(e){if(e)return this.utilityService.djb2_hash(JSON.stringify(e))},t.prototype.validateCacheDataIntegrity=function(e,t){return!(!e||!t)&&t===this.getHashCode(e)},t.prototype.isCacheExpired=function(e,t){return!e||Math.abs((new Date).getTime()-e.getTime())>t*this.constants.timeInMiliseconds.second},t.prototype.getSupportedBillingRegionsCache=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.getSupportedBillingRegionsIndexedDB);return this.open().then(function(){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.supported_billing_regions.name,!1,"monetizationClientCache:getCachedSupportedBillingRegions")}).then(function(e){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction}),e.store.openPrimaryKey().getAll()}).then(function(i){if(i&&i.length>0){var a=i[0];return a?a&&t.validateCacheDataIntegrity(a.countries,a.hash)?t.isCacheExpired(a.insertedDate,e.maxProductsAssetsAgeSeconds)?null:(n.stop(s({},t.getSupportedBillingRegionsEventData(a.countries))),a.countries):(n.fail({error:"Hash check mismatch",error2:"Hash check mismatch"}),null):(n.stop({message:"No Supported Billing Regions found in IndexedDB."}),null)}}).toNgPromise(this.$q).catch(function(e){var i=JSON.stringify(e);return t.logger.error("Failed to get monetization apps list from IndexedDb. Error: {0}",i),n.fail({error:i,error2:i}),null})},t.prototype.putSupportedBillingRegionsCache=function(e){var t=this,n=new Date,i={hash:this.getHashCode(e),insertedDate:n,countries:e},s=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.setSupportedBillingRegionsIndexedDB);return this.open().then(function(){return t.clearSupportedBillingRegionsCache(s)}).then(function(){return s.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.clearSupportedBillingRegions,step:"putSupportedBillingRegionsCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.supported_billing_regions.name,!0,"monetizationClientCache:setCachedSupportedBillingRegions")}).then(function(e){return s.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"putSupportedBillingRegionsCache"}),e.store.put(i)}).then(function(){s.stop({message:"Saved new Supported Billing Regions API response to IndexedDB"})}).catch(function(e){var n=JSON.stringify(e);return t.logger.error("Failed to set Supported Billing Regions list to IndexedDB. Error: "+n),s.fail({error:n,error2:n}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.clearSupportedBillingRegionsCache=function(e){var t=this;return this.open().then(function(){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection,step:"clearSupportedBillingRegionsCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.supported_billing_regions.name,!0,"monetizationClientCache:clearCachedSupportedBillingRegions")}).then(function(n){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"clearSupportedBillingRegionsCache"}),SkypeX.Services.SyncTasks.whenAll([n.store.clearAllData()])}).catch(function(n){var i=JSON.stringify(n);return t.logger.error("Failed to clear cached Supported Billing Regions list from IndexedDB. Error: {0}",i),e.fail({error:i,error2:i}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.getBillingRegionCache=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.getBillingRegionIndexedDB);return this.open().then(function(){return t.appendEventData({event:e.constants.scenarios.extensibility.monetization.cache.openConnection}),e.monetizationDatabase.provider.openTransaction(e.monetizationDatabase.schema.stores.billing_region.name,!1,"monetizationClientCache:getCachedBillingRegion")}).then(function(n){return t.appendEventData({event:e.constants.scenarios.extensibility.monetization.cache.openTransaction}),n.store.openPrimaryKey().getAll()}).then(function(n){if(n&&n.length>0){var i=n[0];return i?i&&e.validateCacheDataIntegrity(i.billingRegion,i.hash)?(t.stop(s({},e.getBillingRegionEventData(i.billingRegion))),i.billingRegion):(t.fail({error:"Hash check mismatch",error2:"Hash check mismatch"}),null):(t.stop({message:"No Billing Region found in IndexedDB."}),null)}}).toNgPromise(this.$q).catch(function(e){var n=JSON.stringify(e);return t.fail({error:n,error2:n}),null})},t.prototype.putBillingRegionCache=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.setBillingRegionIndexedDB);if(e){var i=new Date,s={hash:this.getHashCode(e),insertedDate:i,billingRegion:e},a=this.$q.defer();return this.open().then(function(){return t.clearBillingRegionCache(n)}).then(function(){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.clearBillingRegion,step:"putBillingRegionCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.billing_region.name,!0,"monetizationClientCache:setCachedBillingRegion")}).then(function(e){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"putBillingRegionCache"}),e.store.put(s)}).then(function(){n.stop({message:"Saved Billing Region to IndexedDB"}),a.resolve()}).catch(function(e){var i=JSON.stringify(e);return t.logger.error("Failed to set Billing Region to IndexedDB. Error: "+i),n.fail({error:i,error2:i}),a.reject(),SkypeX.Services.SyncTasks.Rejected(i)}),a.promise}this.clearBillingRegionCache(n)},t.prototype.clearBillingRegionCache=function(e){var t=this;return this.open().then(function(){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection,step:"clearBillingRegionsCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.billing_region.name,!0,"monetizationClientCache:clearCachedBillingRegion")}).then(function(n){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"clearBillingRegionsCache"}),SkypeX.Services.SyncTasks.whenAll([n.store.clearAllData()])}).catch(function(n){var i=JSON.stringify(n);return t.logger.error("Failed to clear cached Billing Region from IndexedDB. Error: {0}",i),e.fail({error:i,error2:i}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.getAssetsListCache=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.getAssetsListIndexedDB);return this.open().then(function(){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_assets_list.name,!1,"monetizationClientCache:getCachedAssets")}).then(function(e){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction}),e.store.openPrimaryKey().getAll()}).then(function(i){if(i&&i.length>0){var a=i[0];return a?a&&t.validateCacheDataIntegrity(a.assets,a.hash)?t.isCacheExpired(a.insertedDate,e.maxProductsAssetsAgeSeconds)?null:(n.stop(s({},t.getAssetsListEventData(a.assets))),a.assets):(n.fail({error:"Hash check mismatch",error2:"Hash check mismatch"}),null):(n.stop({message:"No assets list found in IndexedDB."}),null)}}).toNgPromise(this.$q).catch(function(e){var i=JSON.stringify(e);return t.logger.error("Failed to get assets list from IndexedDb. Error: {0}",i),n.fail({error:i,error2:i}),null})},t.prototype.putAssetsListCache=function(e){var t=this,n=new Date,i={hash:this.getHashCode(e),insertedDate:n,assets:e},s=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.setAssetsListIndexedDB);return this.open().then(function(){return t.clearAssetsListCache(s)}).then(function(){return s.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.clearAssetsList,step:"putAssetsListCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_assets_list.name,!0,"monetizationClientCache:setCachedAssets")}).then(function(e){return s.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"putAssetsListCache"}),e.store.put(i)}).then(function(){s.stop({message:"Saved new assets list API response to IndexedDB"})}).catch(function(e){var n=JSON.stringify(e);return t.logger.error("Failed to set assets list to IndexedDB. Error: "+n),s.fail({error:n,error2:n}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.clearAssetsListCache=function(e){var t=this;return this.open().then(function(){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection,step:"clearAssetsListCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_assets_list.name,!0,"monetizationClientCache:clearCachedAssets")}).then(function(n){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"clearAssetsListCache"}),SkypeX.Services.SyncTasks.whenAll([n.store.clearAllData()])}).catch(function(n){var i=JSON.stringify(n);return t.logger.error("Failed to clear cached assets list from IndexedDB. Error: {0}",i),e.fail({error:i,error2:i}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.getMonetizationAppsListCache=function(e){var t=this,n=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.getMonetizationAppsListIndexedDB);return this.open().then(function(){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_apps_list.name,!1,"monetizationClientCache:getCachedMonetizationApps")}).then(function(e){return n.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction}),e.store.openPrimaryKey().getAll()}).then(function(i){if(i&&i.length>0){var a=i[0];return a?a&&t.validateCacheDataIntegrity(a.products,a.hash)?t.isCacheExpired(a.insertedDate,e.maxProductsAssetsAgeSeconds)?null:(n.stop(s({},t.getMonetizationAppsListEventData(a.products))),a.products):(n.fail({error:"Hash check mismatch",error2:"Hash check mismatch"}),null):(n.stop({message:"No monetization apps list found in IndexedDB."}),null)}}).toNgPromise(this.$q).catch(function(e){var i=JSON.stringify(e);return t.logger.error("Failed to get monetization apps list from IndexedDb. Error: {0}",i),n.fail({error:i,error2:i}),null})},t.prototype.putMonetizationAppsListCache=function(e){var t=this,n=new Date,i={hash:this.getHashCode(e),insertedDate:n,products:e},s=this.loggingService.newScenario(this.constants.scenarios.extensibility.monetization.cache.setMonetizationAppsListIndexedDB);return this.open().then(function(){return t.clearMonetizationAppsListCache(s)}).then(function(){return s.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.clearMonetizationAppsList,step:"putMonetizationAppsListCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_apps_list.name,!0,"monetizationClientCache:setCachedMonetizationApps")}).then(function(e){return s.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"putMonetizationAppsListCache"}),e.store.put(i)}).then(function(){s.stop({message:"Saved new monetization apps list API response to IndexedDB"})}).catch(function(e){var n=JSON.stringify(e);return t.logger.error("Failed to set monetization apps list to IndexedDB. Error: "+n),s.fail({error:n,error2:n}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.clearMonetizationAppsListCache=function(e){var t=this;return this.open().then(function(){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openConnection,step:"clearMonetizationAppsListCache"}),t.monetizationDatabase.provider.openTransaction(t.monetizationDatabase.schema.stores.monetization_apps_list.name,!0,"monetizationClientCache:clearCachedMonetizationApps")}).then(function(n){return e.appendEventData({event:t.constants.scenarios.extensibility.monetization.cache.openTransaction,step:"clearMonetizationAppsListCache"}),SkypeX.Services.SyncTasks.whenAll([n.store.clearAllData()])}).catch(function(n){var i=JSON.stringify(n);return t.logger.error("Failed to clear cached monetization apps list from IndexedDB. Error: {0}",i),e.fail({error:i,error2:i}),SkypeX.Services.SyncTasks.Rejected(n)})},t.prototype.getMonetizationAppsListEventData=function(e){var t=this;if(e){var n=[];return e.forEach(function(e){n.push(t.getMonetizationPlansEventData(e))}),n}},t.prototype.getMonetizationPlansEventData=function(e){if(e)return{productId:e.officeProductId,name:e.officeProductName}},t.prototype.getAssetsListEventData=function(e){var t=this;if(e){var n=[];return e.forEach(function(e){n.push(t.getAssetEventData(e))}),n}},t.prototype.getAssetEventData=function(e){if(e)return{productId:e.saasBigCatalogId,purchaseStartDate:e.purchaseStartDate,licenseCount:e.licenseCount?e.licenseCount:0,isActive:!!e.isActive&&e.isActive}},t.prototype.getSupportedBillingRegionsEventData=function(e){var t=this;if(e){var n=[];return e.forEach(function(e){n.push(t.getSupportedBillingRegionEventData(e))}),n}},t.prototype.getSupportedBillingRegionEventData=function(e){if(e)return{countryCode:e.countryCode,countryName:e.countryName}},t.prototype.getBillingRegionEventData=function(e){if(e)return{country:e.country,countryName:e.countryName,language:e.language,culture:e.culture}},t}(teamspace.services.MTMABase);t.MonetizationService=o,angular.module("teamspace.monetizationService",["skypeX.myUserPreferencesStore","teamspace.appState","teamspace.authenticationService","teamspace.constants","teamspace.dataManagerService","teamspace.localizationService","teamspace.loggingService","teamspace.orchestrationService","teamspace.settingsService","teamspace.utilityService","skypeX.clientDatabase"]).service("monetizationService",o)}},[2519]);