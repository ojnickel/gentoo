(this.webpackJsonp=this.webpackJsonp||[]).push([[117],{lHmM:function(e,t,i){"use strict";i.r(t),i.d(t,"IStoreService",(function(){})),i.d(t,"StoreService",(function(){return J}));var r,n,o=i("+7/b"),s=i("svWY"),c=i("zQSw"),a="all";!function(e){e[e.App=0]="App",e[e.Device=1]="Device",e[e.Media=2]="Media",e[e.Template=3]="Template",e[e.PowerApp=4]="PowerApp",e[e.Workflow=5]="Workflow"}(r||(r={})),function(e){e[e.Provider=0]="Provider",e[e.Collection=1]="Collection",e[e.Item=2]="Item",e[e.HeroItem=3]="HeroItem",e[e.SearchResult=4]="SearchResult",e[e.ContentItem=5]="ContentItem"}(n||(n={}));var l,u={app:r.App,device:r.Device,media:r.Media,template:r.Template,power:r.PowerApp,wf:r.Workflow},d={pr:n.Provider,co:n.Collection,it:n.Item,hi:n.HeroItem,sr:n.SearchResult},p=function(e){return h(e.providerType)+":"+y(e.entityType)+":"+e.entityId},f=function(e){var t={providerType:e,entityType:n.Provider,entityId:"id"};return p(t)},m=function(e){var t=e.indexOf(":"),i=e.indexOf(":",t+1);if(t<0||i<0)throw new Error("invalid store id");return{providerType:u[e.substring(0,t)],entityType:d[e.substring(t+1,i)],entityId:e.substring(i+1)}},h=function(e){for(var t in u)if(void 0!==u[t]&&u[t]===e)return t;return null},y=function(e){for(var t in d)if(void 0!==d[t]&&d[t]===e)return t;return null},v=i("W1yN"),g=function(e){return{id:p(e),collectionId:e.entityId,title:e.title,description:e.description,group:e.group,isHidden:e.isHidden,isInFeed:e.isInFeed,totalItems:e.totalItems}},b=function(e){return{id:p(e),itemId:e.entityId,title:e.title,description:e.description,subtitle:e.subtitle,imageUrl:e.imageUrl,itemGroupId:e.itemGroupId,itemKind:e.itemKind,linkedEntityId:e.linkedEntityId,itemMetadata:e.itemMetadata,features:e.features&&Object(o.o)(e.features),attributes:e.attributes&&Object(o.o)(e.attributes)}},I=function(e,t){var i=t.map((function(e){return g(e)}));return{id:e,timestamp:Date.now(),collections:i}},O=function(e,t){if(!t)return{id:e,timestamp:Date.now(),items:void 0};var i=Object(s.isEmpty)(t.items)?void 0:t.items.map((function(e){return function(e){return{id:p(e),itemId:e.entityId,title:e.title,description:e.description,imageUrl:e.imageUrl,background:e.background,textColor:e.textColor,itemGroupId:e.itemGroupId,itemKind:e.itemKind,linkedEntityId:e.linkedEntityId,itemMetadata:e.itemMetadata}}(e)}));return{id:e,timestamp:Date.now(),title:t.title,description:t.description,imageUrl:t.imageUrl,background:t.background,textColor:t.textColor,items:i}},C=function(e,t){var i,r;return t?{id:p(t),timestamp:Date.now(),cursor:t.cursor,collections:Object(s.isEmpty)(t.collections)||null===(i=t.collections)||void 0===i?void 0:i.map((function(e){return g(e)})),items:Object(s.isEmpty)(t.items)||null===(r=t.items)||void 0===r?void 0:r.map((function(e){return b(e)}))}:{id:e,timestamp:Date.now()}},j=i("CdiN"),w=i("F/li"),S=function(e,t){var i=[],r=t.get(c.a.Extensibility).storeProviderConfigs,n=Object(s.find)(r,(function(t){return t.providerType===e}));return n&&n.collections&&n.collections.forEach((function(t){var r=E(e,t);r&&i.push(r)})),i},T=function(e,t,i){return S(e,i).find((function(e){return e.entityId===t}))},E=function(e,t){if(t&&t.collectionId)return{providerType:e,entityType:n.Collection,entityId:t.collectionId,title:t.title,description:t.description||void 0,group:t.group||void 0,groupOrder:t.groupOrder||void 0,isHidden:t.isHidden||void 0,isInFeed:t.isInFeed||void 0,linkedEntities:t.linkedEntities&&Object(o.o)(t.linkedEntities)||void 0,itemsIdList:t.itemIdList&&Object(o.o)(t.itemIdList)||void 0}},A=i("vtvO"),k=i("ifNO"),P=i("3J71"),D="StoreService",F=function(e,t,i,r,n){return Object(o.f)(void 0,void 0,Promise,(function(){var s;return Object(o.i)(this,(function(o){switch(o.label){case 0:s=n||A.a.MiddleTier,o.label=1;case 1:return o.trys.push([1,4,,5]),[4,e({url:t,method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8"},body:JSON.stringify(i),serviceName:s,apiName:r})];case 2:return[4,o.sent().body.json()];case 3:return[2,o.sent()];case 4:throw o.sent(),Object(k.a)(D,P.d.RemoteOperationFailed,r,void 0,"post request failed");case 5:return[2]}}))}))},x=function(e,t,i,r,n){return Object(o.f)(void 0,void 0,Promise,(function(){var s;return Object(o.i)(this,(function(o){switch(o.label){case 0:s=r||A.a.MiddleTier,o.label=1;case 1:return o.trys.push([1,4,,5]),[4,e({url:t,method:"GET",serviceName:s,apiName:i,skipHeaders:n})];case 2:return[4,o.sent().body.json()];case 3:return[2,o.sent()];case 4:throw o.sent(),Object(k.a)(D,P.d.RemoteOperationFailed,i,void 0,"get request failed");case 5:return[2]}}))}))},z=function(e,t,i,r,n){return Object(o.f)(void 0,void 0,Promise,(function(){var a,l,u,d,p,f,m;return Object(o.i)(this,(function(o){switch(o.label){case 0:if(a=i.get(c.a.Extensibility).storeContentConfigs,!(l=Object(s.find)(a,(function(e){return e.id===n}))))return[2,void 0];u=H(r,l),o.label=1;case 1:return o.trys.push([1,5,,6]),l.contentLink?[4,x(t,l.contentLink,"GetCMSContent",void 0,!0)]:[3,3];case 2:return p=o.sent(),[3,4];case 3:p=void 0,o.label=4;case 4:return(d=p)?[2,U(r,n,d,u)]:[2,u];case 5:return f=o.sent(),e.error("get content "+n+" failed: "+(null===(m=f)||void 0===m?void 0:m.code)),[2,u];case 6:return[2]}}))}))},U=function(e,t,i,r){var o={providerType:e,entityType:n.ContentItem,entityId:t,title:i.title||(null==r?void 0:r.title)||"",description:i.subtitle1||(null==r?void 0:r.description),background:i.backgroundImgSrc};return i.appsList&&!Object(s.isEmpty)(i.appsList)&&(o.items=i.appsList.map((function(t){return{providerType:e,entityType:n.ContentItem,entityId:t.id,title:t.name,imageUrl:t.src}})).filter((function(e){return!!e.entityId}))),o},H=function(e,t){return t.fallbackTitle&&t.fallbackBackground?{providerType:e,entityType:n.ContentItem,entityId:t.id,title:t.fallbackTitle,description:t.fallbackDescription||void 0,background:t.fallbackBackground,imageUrl:t.fallbackImage||void 0,textColor:t.fallbackTextColor||void 0}:void 0},N=function(){function e(e,t,i,r,n){this.providerType=e,this.send=t,this.rawSend=i,this.coreSettings=r,this.logger=n}return e.prototype.getCollection=function(e){return Object(o.f)(this,void 0,Promise,(function(){var t;return Object(o.i)(this,(function(i){switch(i.label){case 0:return[4,this.getCollections()];case 1:return t=i.sent(),[2,Object(s.find)(t,(function(t){return t.entityId===e}))||null]}}))}))},e.prototype.getCollections=function(){return Object(o.f)(this,void 0,Promise,(function(){return Object(o.i)(this,(function(e){var t;return t=this.providerType,[2,[{providerType:t,entityType:n.Collection,entityId:a,title:"_extensibility_apps_gallery_all_apps",isInFeed:!0}]]}))}))},e.prototype.getHeroItemsForFeed=function(){return Object(o.f)(this,void 0,Promise,(function(){var e,t;return Object(o.i)(this,(function(i){switch(i.label){case 0:return e=f(this.providerType),[4,z(this.logger,this.rawSend,this.coreSettings,this.providerType,e)];case 1:return(t=i.sent())?[2,{title:t.title,description:t.description,imageUrl:t.imageUrl,background:t.background,textColor:t.textColor,items:[]}]:[2,null]}}))}))},e.prototype.getHeroItemsForCollection=function(e){return Object(o.f)(this,void 0,Promise,(function(){return Object(o.i)(this,(function(e){return[2,null]}))}))},e.prototype.queryItems=function(e,t,i,r){return Object(o.f)(this,void 0,Promise,(function(){var i,r,c,l,u;return Object(o.i)(this,(function(o){switch(o.label){case 0:return i={providerType:this.providerType,entityType:n.SearchResult,entityId:e+"-"+t},t=t||a,[4,this.getCollection(t)];case 1:return(r=o.sent())?[4,this.getItemsForCollection(t)]:[2,i];case 2:return c=o.sent(),l=c&&c.items||[],u=this.filterItemsByKeyword(l,e),i.collections=Object(s.isEmpty)(u)?[]:[r],i.items=u,[2,i]}}))}))},e.prototype.filterItemsByKeyword=function(e,t){return e.filter((function(e){return!!e.title&&-1!==e.title.toLowerCase().indexOf(t)||!!e.keywords&&!!e.keywords.find((function(e){return-1!==e.indexOf(t)}))}))},e}(),q=function(){function e(){this.cachedCategories={},this.normalizedItems={}}return e.prototype.toNormalizedItems=function(e){var t=this;return!e||Object(s.isEmpty)(e)?[]:e.filter((function(e){return!!e})).map((function(e){var i=e.id+"-"+e.version;return t.normalizedItems[i]?(t.normalizedItems[i].ranking=e.ranking,t.normalizedItems[i]):(t.normalizedItems[i]=Object(o.a)(Object(o.a)({},e),{appKey:i}),t.normalizedItems[i])}))},e.prototype.toNormalizedItemsWithId=function(e){var t=null==e?void 0:e.map((function(e){return{id:e,version:""}}));return this.toNormalizedItems(t)},e.prototype.setAppCategory=function(e,t,i,r){var n=this.getCategoryKey(e,t);return this.cachedCategories[n]={categoryKey:n,category:e,sortType:t,items:this.toNormalizedItems(i.apps),isComplete:r},this.cachedCategories[n]},e.prototype.getAppCategory=function(e,t){var i=this.getCategoryKey(e,t);return this.cachedCategories[i]||null},e.prototype.getAppCategories=function(e,t){var i=this;if(!t||Object(s.isEmpty)(t))return Object(s.values)(this.cachedCategories).filter((function(t){return t.sortType===e}));var r=[];return t.forEach((function(t){var n=i.getAppCategory(t,e);n&&r.push(n)})),r},e.prototype.resetCategories=function(){this.cachedCategories={}},e.prototype.getCategoryKey=function(e,t){return(e+"-"+t).toLowerCase()},e}(),L={all:"all",bots:"bots",connectors:"connectors",inputExtensions:"inputExtensions",popularApps:"popularApps",tabs:"tabs",tenantApps:"tenantApps"};!function(e){e.Alphabetical="Alphabetical",e.Ranked="Ranked"}(l||(l={}));var B=function(e,t,i){return Object(o.f)(void 0,void 0,Promise,(function(){var r,n,c,a;return Object(o.i)(this,(function(o){switch(o.label){case 0:if(r=i.filter((function(e){return!e.isFetched})),Object(s.isEmpty)(r))return[2,i];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,F(t,"beta/users/apps/batchedDefinitions",r.map((function(e){return e.id})),"GetBatchedAppDefinitions")];case 2:return n=o.sent(),r.forEach((function(e){e.isFetched=!0;var t=Object(s.find)(n,(function(t){return t.id===e.id}));t&&(e.name=t.name,e.developerName=t.developerName||void 0,e.imageUrl=t.largeImageUrl||void 0,e.description=t.longDescription||void 0,e.keywords=t.keywords?t.keywords.map((function(e){return e.toLowerCase()})):[],e.keywords.push(e.name.toLowerCase()),e.developerName&&!Object(s.isEmpty)(e.developerName)&&e.keywords.push(e.developerName.toLowerCase()))})),[2,i];case 3:return c=o.sent(),e.error("request to app definitions failed: "+(null===(a=c)||void 0===a?void 0:a.code)),[2,i];case 4:return[2]}}))}))},K=function(e){return{providerType:r.App,entityType:n.Item,entityId:e.id,title:e.name||"",subtitle:e.developerName,imageUrl:e.imageUrl,description:e.description}},M=function(e,t){return e.id+";"+t},R=function(e){var t=e.indexOf(";");if(t>0){var i=e.substring(0,t),r=e.slice(t+1);if(i&&r)return{entityId:i,sortOrder:r}}return{entityId:void 0,sortOrder:void 0}},G=j.StoreItemOrder.Popularity,W=function(e){function t(t,i,n,o){var s=e.call(this,r.App,t,i,n,o)||this;return s.overviewUpdateTimestamp={},s.normalizedStore=new q,s}return Object(o.h)(t,e),t.prototype.getCollection=function(e){return Object(o.f)(this,void 0,Promise,(function(){var t,i;return Object(o.i)(this,(function(n){switch(n.label){case 0:return(t=T(r.App,e,this.coreSettings))?[4,this.getAppItemsForCollection(t.entityId,G,!0)]:[2,null];case 1:return i=n.sent(),[2,!Object(s.isEmpty)(i)&&t?t:null]}}))}))},t.prototype.getCollections=function(){return Object(o.f)(this,void 0,Promise,(function(){var e,t,i,n,c,a,l,u;return Object(o.i)(this,(function(o){switch(o.label){case 0:e=[],t=[],i=S(r.App,this.coreSettings),n=0,c=i,o.label=1;case 1:return n<c.length?(a=c[n],[4,this.getAppItemsForCollection(a.entityId,G,!0)]):[3,4];case 2:if(l=o.sent(),Object(s.isEmpty)(l))return[3,3];t.push.apply(t,l),e.push(a),o.label=3;case 3:return n++,[3,1];case 4:return u=Object(s.uniqBy)(t,(function(e){return e.id})),[4,B(this.logger,this.send,u)];case 5:return o.sent(),[2,e]}}))}))},t.prototype.getItemsForCollection=function(e,t,i,n){return Object(o.f)(this,void 0,Promise,(function(){var c,a,l,u,d,p,f;return Object(o.i)(this,(function(o){switch(o.label){case 0:return c=t||G,i&&R(i).sortOrder!==c&&(i=void 0),[4,this.getAppItemsForCollection(e,c,!i)];case 1:return a=o.sent(),l=Object(s.last)(a),Object(s.isEmpty)(a)||!l?[2,null]:(u=T(r.App,e,this.coreSettings),i===M(l,c)?[2,{title:(null==u?void 0:u.title)||e,description:null==u?void 0:u.description,items:[],cursor:i}]:(i&&(d=R(i).entityId,p=a.findIndex((function(e){return e.id===d})),a=a.slice(p+1)),a=n?a.slice(0,n):a,[4,B(this.logger,this.send,a)]));case 2:return a=o.sent(),l=Object(s.last)(a),f=a.filter((function(e){return!!e.name})).map((function(e){return K(e)})),[2,{title:(null==u?void 0:u.title)||e,description:null==u?void 0:u.description,items:f,cursor:l&&M(l,c)}]}}))}))},t.prototype.getHeroItemsForFeed=function(){return Object(o.f)(this,void 0,Promise,(function(){var e,t,i,c;return Object(o.i)(this,(function(o){switch(o.label){case 0:return[4,z(this.logger,this.rawSend,this.coreSettings,r.App,"featuredapps")];case 1:return(e=o.sent())?(t=[],!e.items||Object(s.isEmpty)(e.items)?[3,3]:(i=e.items.map((function(e){return e.entityId})),[4,B(this.logger,this.send,this.normalizedStore.toNormalizedItemsWithId(i))])):[2,null];case 2:c=o.sent(),t=c.filter((function(e){return!!e.name})).map((function(e){return t=e,{providerType:r.App,entityType:n.HeroItem,entityId:t.id,title:t.name||"",imageUrl:t.imageUrl||"",description:t.description};var t})).slice(0,4),o.label=3;case 3:return[2,{title:e.title,description:e.description,imageUrl:e.imageUrl,background:e.background,textColor:e.textColor,items:t}]}}))}))},t.prototype.getHeroItemsForCollection=function(e){return Object(o.f)(this,void 0,Promise,(function(){var t,i,r,n;return Object(o.i)(this,(function(o){return e!==L.tenantApps.toLowerCase()?[2,null]:(t=this.coreSettings.get(c.a.Extensibility),i=t.storeAppTenantBackground,r=t.storeAppTenantLogo,n=t.storeAppTenantTextColor,i?[2,{background:i,imageUrl:r||void 0,textColor:n||void 0,items:[]}]:[2,null])}))}))},t.prototype.queryItems=function(e,t,i,s){return Object(o.f)(this,void 0,Promise,(function(){var i;return Object(o.i)(this,(function(o){switch(o.label){case 0:return t?[4,this.queryCollectionItems(t,e)]:[3,2];case 1:return i=o.sent(),[3,4];case 2:return[4,this.queryAllItems(e)];case 3:i=o.sent(),o.label=4;case 4:return[2,{providerType:r.App,entityType:n.SearchResult,entityId:e+"-"+t,collections:i.collections,items:i.items}]}}))}))},t.prototype.queryCollectionItems=function(e,t){return Object(o.f)(this,void 0,Promise,(function(){var i,n,c,a,l;return Object(o.i)(this,(function(o){switch(o.label){case 0:return(i=T(r.App,e,this.coreSettings))?[4,this.getAppItemsForCollection(e,j.StoreItemOrder.Popularity)]:[2,{}];case 1:return n=o.sent(),[4,B(this.logger,this.send,n)];case 2:return o.sent(),c=!Object(s.isEmpty)(this.filterCollectionsByKeyword([i],t)),a=[],a=c?n:this.filterAppItemsByKeyword(n,t),l=a.map((function(e){return K(e)})),[2,{collections:Object(s.isEmpty)(l)?void 0:[i],items:l}]}}))}))},t.prototype.queryAllItems=function(e){return Object(o.f)(this,void 0,Promise,(function(){var t,i,n,c,u,d,p,f,m,h,y,v,g,b;return Object(o.i)(this,(function(I){switch(I.label){case 0:return t=S(r.App,this.coreSettings),i=Object(s.flatten)(t.map((function(e){return e.linkedEntities||[]}))),[4,this.fetchAppCategories(l.Ranked,Object(o.o)(i,[L.all]))];case 1:return I.sent(),[4,this.getAppItemsForCollection(a,j.StoreItemOrder.Popularity)];case 2:return n=I.sent(),[4,B(this.logger,this.send,n)];case 3:c=I.sent(),u=this.filterAppItemsByKeyword(c,e),d=[],p=[],f=0,m=t,I.label=4;case 4:return f<m.length?(h=m[f],[4,this.getAppItemsForCollection(h.entityId,j.StoreItemOrder.Popularity)]):[3,7];case 5:y=I.sent(),v=void 0,Object(s.isEmpty)(this.filterCollectionsByKeyword([h],e))?v=Object(s.intersectionBy)(u,y,(function(e){return e.id})):(d.push.apply(d,y),v=y),Object(s.isEmpty)(v)||p.push(h),I.label=6;case 6:return f++,[3,4];case 7:return g=Object(s.uniqBy)(Object(o.o)(u,d),(function(e){return e.id})),b=g.map((function(e){return K(e)})),[2,{collections:p,items:b}]}}))}))},t.prototype.filterCollectionsByKeyword=function(e,t){return e.filter((function(e){return!!e.linkedEntities&&!!e.linkedEntities.find((function(e){return-1!==e.toLowerCase().indexOf(t)}))}))},t.prototype.filterAppItemsByKeyword=function(e,t){return e.filter((function(e){return!!e.keywords&&!!e.keywords.find((function(e){return-1!==e.indexOf(t)}))}))},t.prototype.getAppItemsForCollection=function(e,t,i){return Object(o.f)(this,void 0,Promise,(function(){var n,c,u,d;return Object(o.i)(this,(function(p){switch(p.label){case 0:return c=T(r.App,e,this.coreSettings),Object(s.isEmpty)(null==c?void 0:c.itemsIdList)?(u=(null==c?void 0:c.linkedEntities)||e===a&&[L.all])?[4,this.fetchAppCategories(t===j.StoreItemOrder.Alphabetical?l.Alphabetical:l.Ranked,Object(o.o)(u),i)]:[2,[]]:[3,2];case 1:return d=p.sent(),n=Object(s.uniqBy)(Object(s.flatten)(d.map((function(e){return e.items}))),(function(e){return e.id})),[3,3];case 2:n=this.normalizedStore.toNormalizedItemsWithId(null==c?void 0:c.itemsIdList),p.label=3;case 3:return[2,n]}}))}))},t.prototype.hasCategoriesExpired=function(e){var t=this.coreSettings.get(c.a.Extensibility).storeApiCategoryMaxAgeInMinutes||120;return!!(e&&Date.now()-e>=t*w.f)},t.prototype.fetchAppCategories=function(e,t,i){return Object(o.f)(this,void 0,Promise,(function(){var r,n,a,l,u,d,p,f,m,h=this;return Object(o.i)(this,(function(y){switch(y.label){case 0:return r=i||!t?[]:Object(o.o)(t),n=!Object(s.isEmpty)(r),r=Object(s.uniq)(r),a=this.overviewUpdateTimestamp[e],this.hasCategoriesExpired(a)&&(this.overviewUpdateTimestamp={},this.normalizedStore.resetCategories()),r=r.filter((function(t){var i=h.normalizedStore.getAppCategory(t,e);return!i||!i.isComplete})),l=this.overviewUpdateTimestamp[e],n&&!Object(s.isEmpty)(r)||!n&&!l?[4,this.postStoreRequest(e,r)]:[3,2];case 1:for(f in u=y.sent(),d=this.coreSettings.get(c.a.Extensibility).storeApiMaxOverviewItems,p=d||100,u.appCategoriesDictionary)u.appCategoriesDictionary[f]&&(m=u.appCategoriesDictionary[f],this.normalizedStore.setAppCategory(f,e,m,n||Object(s.size)(m.apps)<p));n||(this.overviewUpdateTimestamp[e]=Date.now()),y.label=2;case 2:return[2,this.normalizedStore.getAppCategories(e,t)]}}))}))},t.prototype.postStoreRequest=function(e,t){var i;return Object(o.f)(this,void 0,Promise,(function(){var r,n;return Object(o.i)(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,F(this.send,"beta/users/apps/store",{appCategories:t||[],defaultAppsSortType:e},"GetAppsStoreResponseModel")];case 1:return r=o.sent(),[3,3];case 2:throw n=o.sent(),this.logger.error("request to apps store api failed: "+(null===(i=n)||void 0===i?void 0:i.code)),n;case 3:return[2,r]}}))}))},t}(N),J=function(){function e(e,t,i,r,n,o){this.scenarioFactory=e,this.logger=t.newLogger("StoreService"),this.dataProviders={};var s={send:i.bind(r,c.b.Gtm.middleTier),rawSend:r,coreSettings:n,logger:this.logger,authenticationService:o};this.registerDataProvider(function(e){var t=e.send,i=e.rawSend,r=e.coreSettings,n=e.logger;return new W(t,i,r,n)}(s))}return e.prototype.getCollections=function(e){return Object(o.f)(this,void 0,Promise,(function(){var t,i,r,c,a,l,u,d,p,f,h;return Object(o.i)(this,(function(o){switch(o.label){case 0:if(t=m(e),i=t.providerType,r=t.entityType,c=t.entityId,a=this.scenarioFactory.newScenario(v.b.StoreServiceGetCollections),r!==n.Provider&&r!==n.Collection)throw h=this.getStoreEventData(i,e),a.fail(h),new Error("getCollections: unsupported entity type: "+r);l=[],o.label=1;case 1:return o.trys.push([1,6,,7]),u=this.getDataProvider(e),r!==n.Collection?[3,3]:[4,u.getCollection(c)];case 2:return d=o.sent(),l=d?[d]:[],[3,5];case 3:return[4,u.getCollections()];case 4:l=o.sent(),o.label=5;case 5:return p=Object(s.size)(l),a.stop(this.getStoreEventData(i,e,p)),this.logger.log("getCollections: "+p+" collections for "+e),[3,7];case 6:return f=o.sent(),h=this.getStoreEventData(i,e),a.fail(h),this.logger.error("failed to get collections: "+(null==f?void 0:f.message)),[3,7];case 7:return[2,I(e,l)]}}))}))},e.prototype.getCollectionItems=function(e,t,i,r){return Object(o.f)(this,void 0,Promise,(function(){var c,a,l,u,d,p,f,h,y;return Object(o.i)(this,(function(o){switch(o.label){case 0:if(c=m(e),a=c.entityId,l=c.entityType,u=c.providerType,d=this.scenarioFactory.newScenario(v.b.StoreServiceGetItems),l!==n.Collection)throw y=this.getStoreEventData(u,e),d.fail(y),new Error("getCollectionItems: unsupported entity type: "+l);p=null,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.getDataProvider(e).getItemsForCollection(a,t,i,r)];case 2:return p=o.sent(),f=Object(s.size)(null==p?void 0:p.items),y=this.getStoreEventData(u,e,void 0,f),d.stop(y),this.logger.log("getCollectionItems: "+f+" items cursor "+i+" for "+e),[3,4];case 3:return h=o.sent(),y=this.getStoreEventData(u,e),d.fail(y),this.logger.error("getCollectionItems failed: "+(null==h?void 0:h.message)),[3,4];case 4:return[2,(g=e,I=p,I?{id:g,timestamp:Date.now(),title:I.title,description:I.description,items:Object(s.isEmpty)(I.items)?void 0:I.items.map((function(e){return b(e)})),cursor:I.cursor}:null)]}var g,I}))}))},e.prototype.getHeroItems=function(e){return Object(o.f)(this,void 0,Promise,(function(){var t,i,r,c,a,l,u,d,p,f;return Object(o.i)(this,(function(o){switch(o.label){case 0:if(t=m(e),i=t.providerType,r=t.entityId,c=t.entityType,a=this.scenarioFactory.newScenario(v.b.StoreServiceGetHeroItems),c!==n.Provider&&c!==n.Collection)throw f=this.getStoreEventData(i,e),a.fail(f),new Error("getHeroItems: unsupported entity type: "+c);l=null,o.label=1;case 1:return o.trys.push([1,6,,7]),u=this.getDataProvider(e),c!==n.Provider?[3,3]:[4,u.getHeroItemsForFeed()];case 2:return l=o.sent(),[3,5];case 3:return[4,u.getHeroItemsForCollection(r)];case 4:l=o.sent(),o.label=5;case 5:return d=Object(s.size)(null==l?void 0:l.items),f=this.getStoreEventData(i,e,void 0,d),a.stop(f),this.logger.log("getHeroItems: "+d+" items for "+e),[3,7];case 6:return p=o.sent(),f=this.getStoreEventData(i,e),a.fail(f),this.logger.error("getHeroItems failed: "+(null==p?void 0:p.code)),[3,7];case 7:return[2,O(e,l)]}}))}))},e.prototype.queryItems=function(e,t,i,r){return Object(o.f)(this,void 0,Promise,(function(){var c,l,u,d,p,f,h,y,g,b,I,O,j;return Object(o.i)(this,(function(o){switch(o.label){case 0:c=m(e),l=c.providerType,u=c.entityId,d=c.entityType,p=this.scenarioFactory.newScenario(v.b.StoreServiceQueryItems),f=t.toLowerCase(),o.label=1;case 1:return o.trys.push([1,3,,4]),y=this.getDataProvider(e),g=d===n.Collection&&u!==a?u:void 0,[4,y.queryItems(f,g,i,r)];case 2:return h=o.sent(),b=Object(s.size)(h.collections),I=Object(s.size)(h.items),j=this.getStoreEventData(l,e,b,I),p.stop(j),this.logger.log("queryItem: "+b+" collections "+I+" items for "+e+", cursor "+i),[3,4];case 3:return O=o.sent(),j=this.getStoreEventData(l,e),p.fail(j),this.logger.error("queryItem failed: "+(null==O?void 0:O.code)),[3,4];case 4:return[2,C(e,h)]}}))}))},e.prototype.registerDataProvider=function(e){var t=f(e.providerType);this.dataProviders[t]?this.logger.log("provider for "+t+" existed, ignore registration"):(this.dataProviders[t]=e,this.logger.log("provider registered: "+t))},e.prototype.getDataProvider=function(e){var t=m(e),i=t.entityType===n.Provider?e:f(t.providerType),r=this.dataProviders[i];if(!r)throw new Error("unsupported provider "+i);return r},e.prototype.getStoreEventData=function(e,t,i,r){var n={providerId:f(e),storeId:t,collectionsCount:i,itemsCount:r};return{storeDataBag:JSON.stringify(n)}},e}()}}]);