/**
 * Inject all the overwrites into the page.
 */
function inject (code) {
    const elem = document.head || document.documentElement
    // Inject into main page
    try {
        const e = document.createElement('script')
        e.textContent = `(() => {
            ${code}
        })();`
        elem.appendChild(e)
        e.remove()
    } catch (e) {
    }
}

function randomString () {
    const num = crypto.getRandomValues(new Uint32Array(1))[0] / 2 ** 32
    return num.toString().replace('0.', '')
}

function init () {
    const randomMethodName = '_d' + randomString()
    const randomPassword = '_p' + randomString()
    const reusableMethodName = '_rm' + randomString()
    const reusableSecret = '_r' + randomString()
    const initialScript = `
      ${decodeURI("var%20protections%20=%20(function%20(exports)%20%7B%0A%09'use%20strict';%0A%0A%09function%20createCommonjsModule(fn)%20%7B%0A%09%20%20var%20module%20=%20%7B%20exports:%20%7B%7D%20%7D;%0A%09%09return%20fn(module,%20module.exports),%20module.exports;%0A%09%7D%0A%0A%09/**%20@fileOverview%20Javascript%20cryptography%20implementation.%0A%09%20*%0A%09%20*%20Crush%20to%20remove%20comments,%20shorten%20variable%20names%20and%0A%09%20*%20generally%20reduce%20transmission%20size.%0A%09%20*%0A%09%20*%20@author%20Emily%20Stark%0A%09%20*%20@author%20Mike%20Hamburg%0A%09%20*%20@author%20Dan%20Boneh%0A%09%20*/%0A%0A%09var%20sjcl_1%20=%20createCommonjsModule(function%20(module)%20%7B%0A%09/*jslint%20indent:%202,%20bitwise:%20false,%20nomen:%20false,%20plusplus:%20false,%20white:%20false,%20regexp:%20false%20*/%0A%09/*global%20document,%20window,%20escape,%20unescape,%20module,%20require,%20Uint32Array%20*/%0A%0A%09/**%0A%09%20*%20The%20Stanford%20Javascript%20Crypto%20Library,%20top-level%20namespace.%0A%09%20*%20@namespace%0A%09%20*/%0A%09var%20sjcl%20=%20%7B%0A%09%20%20/**%0A%09%20%20%20*%20Symmetric%20ciphers.%0A%09%20%20%20*%20@namespace%0A%09%20%20%20*/%0A%09%20%20cipher:%20%7B%7D,%0A%0A%09%20%20/**%0A%09%20%20%20*%20Hash%20functions.%20%20Right%20now%20only%20SHA256%20is%20implemented.%0A%09%20%20%20*%20@namespace%0A%09%20%20%20*/%0A%09%20%20hash:%20%7B%7D,%0A%0A%09%20%20/**%0A%09%20%20%20*%20Key%20exchange%20functions.%20%20Right%20now%20only%20SRP%20is%20implemented.%0A%09%20%20%20*%20@namespace%0A%09%20%20%20*/%0A%09%20%20keyexchange:%20%7B%7D,%0A%09%20%20%0A%09%20%20/**%0A%09%20%20%20*%20Cipher%20modes%20of%20operation.%0A%09%20%20%20*%20@namespace%0A%09%20%20%20*/%0A%09%20%20mode:%20%7B%7D,%0A%0A%09%20%20/**%0A%09%20%20%20*%20Miscellaneous.%20%20HMAC%20and%20PBKDF2.%0A%09%20%20%20*%20@namespace%0A%09%20%20%20*/%0A%09%20%20misc:%20%7B%7D,%0A%09%20%20%0A%09%20%20/**%0A%09%20%20%20*%20Bit%20array%20encoders%20and%20decoders.%0A%09%20%20%20*%20@namespace%0A%09%20%20%20*%0A%09%20%20%20*%20@description%0A%09%20%20%20*%20The%20members%20of%20this%20namespace%20are%20functions%20which%20translate%20between%0A%09%20%20%20*%20SJCL's%20bitArrays%20and%20other%20objects%20(usually%20strings).%20%20Because%20it%0A%09%20%20%20*%20isn't%20always%20clear%20which%20direction%20is%20encoding%20and%20which%20is%20decoding,%0A%09%20%20%20*%20the%20method%20names%20are%20%22fromBits%22%20and%20%22toBits%22.%0A%09%20%20%20*/%0A%09%20%20codec:%20%7B%7D,%0A%09%20%20%0A%09%20%20/**%0A%09%20%20%20*%20Exceptions.%0A%09%20%20%20*%20@namespace%0A%09%20%20%20*/%0A%09%20%20exception:%20%7B%0A%09%20%20%20%20/**%0A%09%20%20%20%20%20*%20Ciphertext%20is%20corrupt.%0A%09%20%20%20%20%20*%20@constructor%0A%09%20%20%20%20%20*/%0A%09%20%20%20%20corrupt:%20function(message)%20%7B%0A%09%20%20%20%20%20%20this.toString%20=%20function()%20%7B%20return%20%22CORRUPT:%20%22+this.message;%20%7D;%0A%09%20%20%20%20%20%20this.message%20=%20message;%0A%09%20%20%20%20%7D,%0A%09%20%20%20%20%0A%09%20%20%20%20/**%0A%09%20%20%20%20%20*%20Invalid%20parameter.%0A%09%20%20%20%20%20*%20@constructor%0A%09%20%20%20%20%20*/%0A%09%20%20%20%20invalid:%20function(message)%20%7B%0A%09%20%20%20%20%20%20this.toString%20=%20function()%20%7B%20return%20%22INVALID:%20%22+this.message;%20%7D;%0A%09%20%20%20%20%20%20this.message%20=%20message;%0A%09%20%20%20%20%7D,%0A%09%20%20%20%20%0A%09%20%20%20%20/**%0A%09%20%20%20%20%20*%20Bug%20or%20missing%20feature%20in%20SJCL.%0A%09%20%20%20%20%20*%20@constructor%0A%09%20%20%20%20%20*/%0A%09%20%20%20%20bug:%20function(message)%20%7B%0A%09%20%20%20%20%20%20this.toString%20=%20function()%20%7B%20return%20%22BUG:%20%22+this.message;%20%7D;%0A%09%20%20%20%20%20%20this.message%20=%20message;%0A%09%20%20%20%20%7D,%0A%0A%09%20%20%20%20/**%0A%09%20%20%20%20%20*%20Something%20isn't%20ready.%0A%09%20%20%20%20%20*%20@constructor%0A%09%20%20%20%20%20*/%0A%09%20%20%20%20notReady:%20function(message)%20%7B%0A%09%20%20%20%20%20%20this.toString%20=%20function()%20%7B%20return%20%22NOT%20READY:%20%22+this.message;%20%7D;%0A%09%20%20%20%20%20%20this.message%20=%20message;%0A%09%20%20%20%20%7D%0A%09%20%20%7D%0A%09%7D;%0A%09/**%20@fileOverview%20Arrays%20of%20bits,%20encoded%20as%20arrays%20of%20Numbers.%0A%09%20*%0A%09%20*%20@author%20Emily%20Stark%0A%09%20*%20@author%20Mike%20Hamburg%0A%09%20*%20@author%20Dan%20Boneh%0A%09%20*/%0A%0A%09/**%0A%09%20*%20Arrays%20of%20bits,%20encoded%20as%20arrays%20of%20Numbers.%0A%09%20*%20@namespace%0A%09%20*%20@description%0A%09%20*%20%3Cp%3E%0A%09%20*%20These%20objects%20are%20the%20currency%20accepted%20by%20SJCL's%20crypto%20functions.%0A%09%20*%20%3C/p%3E%0A%09%20*%0A%09%20*%20%3Cp%3E%0A%09%20*%20Most%20of%20our%20crypto%20primitives%20operate%20on%20arrays%20of%204-byte%20words%20internally,%0A%09%20*%20but%20many%20of%20them%20can%20take%20arguments%20that%20are%20not%20a%20multiple%20of%204%20bytes.%0A%09%20*%20This%20library%20encodes%20arrays%20of%20bits%20(whose%20size%20need%20not%20be%20a%20multiple%20of%208%0A%09%20*%20bits)%20as%20arrays%20of%2032-bit%20words.%20%20The%20bits%20are%20packed,%20big-endian,%20into%20an%0A%09%20*%20array%20of%20words,%2032%20bits%20at%20a%20time.%20%20Since%20the%20words%20are%20double-precision%0A%09%20*%20floating%20point%20numbers,%20they%20fit%20some%20extra%20data.%20%20We%20use%20this%20(in%20a%20private,%0A%09%20*%20possibly-changing%20manner)%20to%20encode%20the%20number%20of%20bits%20actually%20%20present%0A%09%20*%20in%20the%20last%20word%20of%20the%20array.%0A%09%20*%20%3C/p%3E%0A%09%20*%0A%09%20*%20%3Cp%3E%0A%09%20*%20Because%20bitwise%20ops%20clear%20this%20out-of-band%20data,%20these%20arrays%20can%20be%20passed%0A%09%20*%20to%20ciphers%20like%20AES%20which%20want%20arrays%20of%20words.%0A%09%20*%20%3C/p%3E%0A%09%20*/%0A%09sjcl.bitArray%20=%20%7B%0A%09%20%20/**%0A%09%20%20%20*%20Array%20slices%20in%20units%20of%20bits.%0A%09%20%20%20*%20@param%20%7BbitArray%7D%20a%20The%20array%20to%20slice.%0A%09%20%20%20*%20@param%20%7BNumber%7D%20bstart%20The%20offset%20to%20the%20start%20of%20the%20slice,%20in%20bits.%0A%09%20%20%20*%20@param%20%7BNumber%7D%20bend%20The%20offset%20to%20the%20end%20of%20the%20slice,%20in%20bits.%20%20If%20this%20is%20undefined,%0A%09%20%20%20*%20slice%20until%20the%20end%20of%20the%20array.%0A%09%20%20%20*%20@return%20%7BbitArray%7D%20The%20requested%20slice.%0A%09%20%20%20*/%0A%09%20%20bitSlice:%20function%20(a,%20bstart,%20bend)%20%7B%0A%09%20%20%20%20a%20=%20sjcl.bitArray._shiftRight(a.slice(bstart/32),%2032%20-%20(bstart%20&%2031)).slice(1);%0A%09%20%20%20%20return%20(bend%20===%20undefined)%20?%20a%20:%20sjcl.bitArray.clamp(a,%20bend-bstart);%0A%09%20%20%7D,%0A%0A%09%20%20/**%0A%09%20%20%20*%20Extract%20a%20number%20packed%20into%20a%20bit%20array.%0A%09%20%20%20*%20@param%20%7BbitArray%7D%20a%20The%20array%20to%20slice.%0A%09%20%20%20*%20@param%20%7BNumber%7D%20bstart%20The%20offset%20to%20the%20start%20of%20the%20slice,%20in%20bits.%0A%09%20%20%20*%20@param%20%7BNumber%7D%20blength%20The%20length%20of%20the%20number%20to%20extract.%0A%09%20%20%20*%20@return%20%7BNumber%7D%20The%20requested%20slice.%0A%09%20%20%20*/%0A%09%20%20extract:%20function(a,%20bstart,%20blength)%20%7B%0A%09%20%20%20%20//%20FIXME:%20this%20Math.floor%20is%20not%20necessary%20at%20all,%20but%20for%20some%20reason%0A%09%20%20%20%20//%20seems%20to%20suppress%20a%20bug%20in%20the%20Chromium%20JIT.%0A%09%20%20%20%20var%20x,%20sh%20=%20Math.floor((-bstart-blength)%20&%2031);%0A%09%20%20%20%20if%20((bstart%20+%20blength%20-%201%20%5E%20bstart)%20&%20-32)%20%7B%0A%09%20%20%20%20%20%20//%20it%20crosses%20a%20boundary%0A%09%20%20%20%20%20%20x%20=%20(a%5Bbstart/32%7C0%5D%20%3C%3C%20(32%20-%20sh))%20%5E%20(a%5Bbstart/32+1%7C0%5D%20%3E%3E%3E%20sh);%0A%09%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20//%20within%20a%20single%20word%0A%09%20%20%20%20%20%20x%20=%20a%5Bbstart/32%7C0%5D%20%3E%3E%3E%20sh;%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20x%20&%20((1%3C%3Cblength)%20-%201);%0A%09%20%20%7D,%0A%0A%09%20%20/**%0A%09%20%20%20*%20Concatenate%20two%20bit%20arrays.%0A%09%20%20%20*%20@param%20%7BbitArray%7D%20a1%20The%20first%20array.%0A%09%20%20%20*%20@param%20%7BbitArray%7D%20a2%20The%20second%20array.%0A%09%20%20%20*%20@return%20%7BbitArray%7D%20The%20concatenation%20of%20a1%20and%20a2.%0A%09%20%20%20*/%0A%09%20%20concat:%20function%20(a1,%20a2)%20%7B%0A%09%20%20%20%20if%20(a1.length%20===%200%20%7C%7C%20a2.length%20===%200)%20%7B%0A%09%20%20%20%20%20%20return%20a1.concat(a2);%0A%09%20%20%20%20%7D%0A%09%20%20%20%20%0A%09%20%20%20%20var%20last%20=%20a1%5Ba1.length-1%5D,%20shift%20=%20sjcl.bitArray.getPartial(last);%0A%09%20%20%20%20if%20(shift%20===%2032)%20%7B%0A%09%20%20%20%20%20%20return%20a1.concat(a2);%0A%09%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20return%20sjcl.bitArray._shiftRight(a2,%20shift,%20last%7C0,%20a1.slice(0,a1.length-1));%0A%09%20%20%20%20%7D%0A%09%20%20%7D,%0A%0A%09%20%20/**%0A%09%20%20%20*%20Find%20the%20length%20of%20an%20array%20of%20bits.%0A%09%20%20%20*%20@param%20%7BbitArray%7D%20a%20The%20array.%0A%09%20%20%20*%20@return%20%7BNumber%7D%20The%20length%20of%20a,%20in%20bits.%0A%09%20%20%20*/%0A%09%20%20bitLength:%20function%20(a)%20%7B%0A%09%20%20%20%20var%20l%20=%20a.length,%20x;%0A%09%20%20%20%20if%20(l%20===%200)%20%7B%20return%200;%20%7D%0A%09%20%20%20%20x%20=%20a%5Bl%20-%201%5D;%0A%09%20%20%20%20return%20(l-1)%20*%2032%20+%20sjcl.bitArray.getPartial(x);%0A%09%20%20%7D,%0A%0A%09%20%20/**%0A%09%20%20%20*%20Truncate%20an%20array.%0A%09%20%20%20*%20@param%20%7BbitArray%7D%20a%20The%20array.%0A%09%20%20%20*%20@param%20%7BNumber%7D%20len%20The%20length%20to%20truncate%20to,%20in%20bits.%0A%09%20%20%20*%20@return%20%7BbitArray%7D%20A%20new%20array,%20truncated%20to%20len%20bits.%0A%09%20%20%20*/%0A%09%20%20clamp:%20function%20(a,%20len)%20%7B%0A%09%20%20%20%20if%20(a.length%20*%2032%20%3C%20len)%20%7B%20return%20a;%20%7D%0A%09%20%20%20%20a%20=%20a.slice(0,%20Math.ceil(len%20/%2032));%0A%09%20%20%20%20var%20l%20=%20a.length;%0A%09%20%20%20%20len%20=%20len%20&%2031;%0A%09%20%20%20%20if%20(l%20%3E%200%20&&%20len)%20%7B%0A%09%20%20%20%20%20%20a%5Bl-1%5D%20=%20sjcl.bitArray.partial(len,%20a%5Bl-1%5D%20&%200x80000000%20%3E%3E%20(len-1),%201);%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20a;%0A%09%20%20%7D,%0A%0A%09%20%20/**%0A%09%20%20%20*%20Make%20a%20partial%20word%20for%20a%20bit%20array.%0A%09%20%20%20*%20@param%20%7BNumber%7D%20len%20The%20number%20of%20bits%20in%20the%20word.%0A%09%20%20%20*%20@param%20%7BNumber%7D%20x%20The%20bits.%0A%09%20%20%20*%20@param%20%7BNumber%7D%20%5B_end=0%5D%20Pass%201%20if%20x%20has%20already%20been%20shifted%20to%20the%20high%20side.%0A%09%20%20%20*%20@return%20%7BNumber%7D%20The%20partial%20word.%0A%09%20%20%20*/%0A%09%20%20partial:%20function%20(len,%20x,%20_end)%20%7B%0A%09%20%20%20%20if%20(len%20===%2032)%20%7B%20return%20x;%20%7D%0A%09%20%20%20%20return%20(_end%20?%20x%7C0%20:%20x%20%3C%3C%20(32-len))%20+%20len%20*%200x10000000000;%0A%09%20%20%7D,%0A%0A%09%20%20/**%0A%09%20%20%20*%20Get%20the%20number%20of%20bits%20used%20by%20a%20partial%20word.%0A%09%20%20%20*%20@param%20%7BNumber%7D%20x%20The%20partial%20word.%0A%09%20%20%20*%20@return%20%7BNumber%7D%20The%20number%20of%20bits%20used%20by%20the%20partial%20word.%0A%09%20%20%20*/%0A%09%20%20getPartial:%20function%20(x)%20%7B%0A%09%20%20%20%20return%20Math.round(x/0x10000000000)%20%7C%7C%2032;%0A%09%20%20%7D,%0A%0A%09%20%20/**%0A%09%20%20%20*%20Compare%20two%20arrays%20for%20equality%20in%20a%20predictable%20amount%20of%20time.%0A%09%20%20%20*%20@param%20%7BbitArray%7D%20a%20The%20first%20array.%0A%09%20%20%20*%20@param%20%7BbitArray%7D%20b%20The%20second%20array.%0A%09%20%20%20*%20@return%20%7Bboolean%7D%20true%20if%20a%20==%20b;%20false%20otherwise.%0A%09%20%20%20*/%0A%09%20%20equal:%20function%20(a,%20b)%20%7B%0A%09%20%20%20%20if%20(sjcl.bitArray.bitLength(a)%20!==%20sjcl.bitArray.bitLength(b))%20%7B%0A%09%20%20%20%20%20%20return%20false;%0A%09%20%20%20%20%7D%0A%09%20%20%20%20var%20x%20=%200,%20i;%0A%09%20%20%20%20for%20(i=0;%20i%3Ca.length;%20i++)%20%7B%0A%09%20%20%20%20%20%20x%20%7C=%20a%5Bi%5D%5Eb%5Bi%5D;%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20(x%20===%200);%0A%09%20%20%7D,%0A%0A%09%20%20/**%20Shift%20an%20array%20right.%0A%09%20%20%20*%20@param%20%7BbitArray%7D%20a%20The%20array%20to%20shift.%0A%09%20%20%20*%20@param%20%7BNumber%7D%20shift%20The%20number%20of%20bits%20to%20shift.%0A%09%20%20%20*%20@param%20%7BNumber%7D%20%5Bcarry=0%5D%20A%20byte%20to%20carry%20in%0A%09%20%20%20*%20@param%20%7BbitArray%7D%20%5Bout=%5B%5D%5D%20An%20array%20to%20prepend%20to%20the%20output.%0A%09%20%20%20*%20@private%0A%09%20%20%20*/%0A%09%20%20_shiftRight:%20function%20(a,%20shift,%20carry,%20out)%20%7B%0A%09%20%20%20%20var%20i,%20last2=0,%20shift2;%0A%09%20%20%20%20if%20(out%20===%20undefined)%20%7B%20out%20=%20%5B%5D;%20%7D%0A%09%20%20%20%20%0A%09%20%20%20%20for%20(;%20shift%20%3E=%2032;%20shift%20-=%2032)%20%7B%0A%09%20%20%20%20%20%20out.push(carry);%0A%09%20%20%20%20%20%20carry%20=%200;%0A%09%20%20%20%20%7D%0A%09%20%20%20%20if%20(shift%20===%200)%20%7B%0A%09%20%20%20%20%20%20return%20out.concat(a);%0A%09%20%20%20%20%7D%0A%09%20%20%20%20%0A%09%20%20%20%20for%20(i=0;%20i%3Ca.length;%20i++)%20%7B%0A%09%20%20%20%20%20%20out.push(carry%20%7C%20a%5Bi%5D%3E%3E%3Eshift);%0A%09%20%20%20%20%20%20carry%20=%20a%5Bi%5D%20%3C%3C%20(32-shift);%0A%09%20%20%20%20%7D%0A%09%20%20%20%20last2%20=%20a.length%20?%20a%5Ba.length-1%5D%20:%200;%0A%09%20%20%20%20shift2%20=%20sjcl.bitArray.getPartial(last2);%0A%09%20%20%20%20out.push(sjcl.bitArray.partial(shift+shift2%20&%2031,%20(shift%20+%20shift2%20%3E%2032)%20?%20carry%20:%20out.pop(),1));%0A%09%20%20%20%20return%20out;%0A%09%20%20%7D,%0A%09%20%20%0A%09%20%20/**%20xor%20a%20block%20of%204%20words%20together.%0A%09%20%20%20*%20@private%0A%09%20%20%20*/%0A%09%20%20_xor4:%20function(x,y)%20%7B%0A%09%20%20%20%20return%20%5Bx%5B0%5D%5Ey%5B0%5D,x%5B1%5D%5Ey%5B1%5D,x%5B2%5D%5Ey%5B2%5D,x%5B3%5D%5Ey%5B3%5D%5D;%0A%09%20%20%7D,%0A%0A%09%20%20/**%20byteswap%20a%20word%20array%20inplace.%0A%09%20%20%20*%20(does%20not%20handle%20partial%20words)%0A%09%20%20%20*%20@param%20%7Bsjcl.bitArray%7D%20a%20word%20array%0A%09%20%20%20*%20@return%20%7Bsjcl.bitArray%7D%20byteswapped%20array%0A%09%20%20%20*/%0A%09%20%20byteswapM:%20function(a)%20%7B%0A%09%20%20%20%20var%20i,%20v,%20m%20=%200xff00;%0A%09%20%20%20%20for%20(i%20=%200;%20i%20%3C%20a.length;%20++i)%20%7B%0A%09%20%20%20%20%20%20v%20=%20a%5Bi%5D;%0A%09%20%20%20%20%20%20a%5Bi%5D%20=%20(v%20%3E%3E%3E%2024)%20%7C%20((v%20%3E%3E%3E%208)%20&%20m)%20%7C%20((v%20&%20m)%20%3C%3C%208)%20%7C%20(v%20%3C%3C%2024);%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20a;%0A%09%20%20%7D%0A%09%7D;%0A%09/**%20@fileOverview%20Bit%20array%20codec%20implementations.%0A%09%20*%0A%09%20*%20@author%20Emily%20Stark%0A%09%20*%20@author%20Mike%20Hamburg%0A%09%20*%20@author%20Dan%20Boneh%0A%09%20*/%0A%0A%09/**%0A%09%20*%20UTF-8%20strings%0A%09%20*%20@namespace%0A%09%20*/%0A%09sjcl.codec.utf8String%20=%20%7B%0A%09%20%20/**%20Convert%20from%20a%20bitArray%20to%20a%20UTF-8%20string.%20*/%0A%09%20%20fromBits:%20function%20(arr)%20%7B%0A%09%20%20%20%20var%20out%20=%20%22%22,%20bl%20=%20sjcl.bitArray.bitLength(arr),%20i,%20tmp;%0A%09%20%20%20%20for%20(i=0;%20i%3Cbl/8;%20i++)%20%7B%0A%09%20%20%20%20%20%20if%20((i&3)%20===%200)%20%7B%0A%09%20%20%20%20%20%20%20%20tmp%20=%20arr%5Bi/4%5D;%0A%09%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20out%20+=%20String.fromCharCode(tmp%20%3E%3E%3E%208%20%3E%3E%3E%208%20%3E%3E%3E%208);%0A%09%20%20%20%20%20%20tmp%20%3C%3C=%208;%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20decodeURIComponent(escape(out));%0A%09%20%20%7D,%0A%0A%09%20%20/**%20Convert%20from%20a%20UTF-8%20string%20to%20a%20bitArray.%20*/%0A%09%20%20toBits:%20function%20(str)%20%7B%0A%09%20%20%20%20str%20=%20unescape(encodeURIComponent(str));%0A%09%20%20%20%20var%20out%20=%20%5B%5D,%20i,%20tmp=0;%0A%09%20%20%20%20for%20(i=0;%20i%3Cstr.length;%20i++)%20%7B%0A%09%20%20%20%20%20%20tmp%20=%20tmp%20%3C%3C%208%20%7C%20str.charCodeAt(i);%0A%09%20%20%20%20%20%20if%20((i&3)%20===%203)%20%7B%0A%09%20%20%20%20%20%20%20%20out.push(tmp);%0A%09%20%20%20%20%20%20%20%20tmp%20=%200;%0A%09%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D%0A%09%20%20%20%20if%20(i&3)%20%7B%0A%09%20%20%20%20%20%20out.push(sjcl.bitArray.partial(8*(i&3),%20tmp));%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20out;%0A%09%20%20%7D%0A%09%7D;%0A%09/**%20@fileOverview%20Bit%20array%20codec%20implementations.%0A%09%20*%0A%09%20*%20@author%20Emily%20Stark%0A%09%20*%20@author%20Mike%20Hamburg%0A%09%20*%20@author%20Dan%20Boneh%0A%09%20*/%0A%0A%09/**%0A%09%20*%20Hexadecimal%0A%09%20*%20@namespace%0A%09%20*/%0A%09sjcl.codec.hex%20=%20%7B%0A%09%20%20/**%20Convert%20from%20a%20bitArray%20to%20a%20hex%20string.%20*/%0A%09%20%20fromBits:%20function%20(arr)%20%7B%0A%09%20%20%20%20var%20out%20=%20%22%22,%20i;%0A%09%20%20%20%20for%20(i=0;%20i%3Carr.length;%20i++)%20%7B%0A%09%20%20%20%20%20%20out%20+=%20((arr%5Bi%5D%7C0)+0xF00000000000).toString(16).substr(4);%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20out.substr(0,%20sjcl.bitArray.bitLength(arr)/4);//.replace(/(.%7B8%7D)/g,%20%22$1%20%22);%0A%09%20%20%7D,%0A%09%20%20/**%20Convert%20from%20a%20hex%20string%20to%20a%20bitArray.%20*/%0A%09%20%20toBits:%20function%20(str)%20%7B%0A%09%20%20%20%20var%20i,%20out=%5B%5D,%20len;%0A%09%20%20%20%20str%20=%20str.replace(/%5Cs%7C0x/g,%20%22%22);%0A%09%20%20%20%20len%20=%20str.length;%0A%09%20%20%20%20str%20=%20str%20+%20%2200000000%22;%0A%09%20%20%20%20for%20(i=0;%20i%3Cstr.length;%20i+=8)%20%7B%0A%09%20%20%20%20%20%20out.push(parseInt(str.substr(i,8),16)%5E0);%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20sjcl.bitArray.clamp(out,%20len*4);%0A%09%20%20%7D%0A%09%7D;%0A%0A%09/**%20@fileOverview%20Javascript%20SHA-256%20implementation.%0A%09%20*%0A%09%20*%20An%20older%20version%20of%20this%20implementation%20is%20available%20in%20the%20public%0A%09%20*%20domain,%20but%20this%20one%20is%20(c)%20Emily%20Stark,%20Mike%20Hamburg,%20Dan%20Boneh,%0A%09%20*%20Stanford%20University%202008-2010%20and%20BSD-licensed%20for%20liability%0A%09%20*%20reasons.%0A%09%20*%0A%09%20*%20Special%20thanks%20to%20Aldo%20Cortesi%20for%20pointing%20out%20several%20bugs%20in%0A%09%20*%20this%20code.%0A%09%20*%0A%09%20*%20@author%20Emily%20Stark%0A%09%20*%20@author%20Mike%20Hamburg%0A%09%20*%20@author%20Dan%20Boneh%0A%09%20*/%0A%0A%09/**%0A%09%20*%20Context%20for%20a%20SHA-256%20operation%20in%20progress.%0A%09%20*%20@constructor%0A%09%20*/%0A%09sjcl.hash.sha256%20=%20function%20(hash)%20%7B%0A%09%20%20if%20(!this._key%5B0%5D)%20%7B%20this._precompute();%20%7D%0A%09%20%20if%20(hash)%20%7B%0A%09%20%20%20%20this._h%20=%20hash._h.slice(0);%0A%09%20%20%20%20this._buffer%20=%20hash._buffer.slice(0);%0A%09%20%20%20%20this._length%20=%20hash._length;%0A%09%20%20%7D%20else%20%7B%0A%09%20%20%20%20this.reset();%0A%09%20%20%7D%0A%09%7D;%0A%0A%09/**%0A%09%20*%20Hash%20a%20string%20or%20an%20array%20of%20words.%0A%09%20*%20@static%0A%09%20*%20@param%20%7BbitArray%7CString%7D%20data%20the%20data%20to%20hash.%0A%09%20*%20@return%20%7BbitArray%7D%20The%20hash%20value,%20an%20array%20of%2016%20big-endian%20words.%0A%09%20*/%0A%09sjcl.hash.sha256.hash%20=%20function%20(data)%20%7B%0A%09%20%20return%20(new%20sjcl.hash.sha256()).update(data).finalize();%0A%09%7D;%0A%0A%09sjcl.hash.sha256.prototype%20=%20%7B%0A%09%20%20/**%0A%09%20%20%20*%20The%20hash's%20block%20size,%20in%20bits.%0A%09%20%20%20*%20@constant%0A%09%20%20%20*/%0A%09%20%20blockSize:%20512,%0A%09%20%20%20%0A%09%20%20/**%0A%09%20%20%20*%20Reset%20the%20hash%20state.%0A%09%20%20%20*%20@return%20this%0A%09%20%20%20*/%0A%09%20%20reset:function%20()%20%7B%0A%09%20%20%20%20this._h%20=%20this._init.slice(0);%0A%09%20%20%20%20this._buffer%20=%20%5B%5D;%0A%09%20%20%20%20this._length%20=%200;%0A%09%20%20%20%20return%20this;%0A%09%20%20%7D,%0A%09%20%20%0A%09%20%20/**%0A%09%20%20%20*%20Input%20several%20words%20to%20the%20hash.%0A%09%20%20%20*%20@param%20%7BbitArray%7CString%7D%20data%20the%20data%20to%20hash.%0A%09%20%20%20*%20@return%20this%0A%09%20%20%20*/%0A%09%20%20update:%20function%20(data)%20%7B%0A%09%20%20%20%20if%20(typeof%20data%20===%20%22string%22)%20%7B%0A%09%20%20%20%20%20%20data%20=%20sjcl.codec.utf8String.toBits(data);%0A%09%20%20%20%20%7D%0A%09%20%20%20%20var%20i,%20b%20=%20this._buffer%20=%20sjcl.bitArray.concat(this._buffer,%20data),%0A%09%20%20%20%20%20%20%20%20ol%20=%20this._length,%0A%09%20%20%20%20%20%20%20%20nl%20=%20this._length%20=%20ol%20+%20sjcl.bitArray.bitLength(data);%0A%09%20%20%20%20if%20(nl%20%3E%209007199254740991)%7B%0A%09%20%20%20%20%20%20throw%20new%20sjcl.exception.invalid(%22Cannot%20hash%20more%20than%202%5E53%20-%201%20bits%22);%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20if%20(typeof%20Uint32Array%20!==%20'undefined')%20%7B%0A%09%09var%20c%20=%20new%20Uint32Array(b);%0A%09%20%20%20%20%09var%20j%20=%200;%0A%09%20%20%20%20%09for%20(i%20=%20512+ol%20-%20((512+ol)%20&%20511);%20i%20%3C=%20nl;%20i+=%20512)%20%7B%0A%09%20%20%20%20%20%20%09%20%20%20%20this._block(c.subarray(16%20*%20j,%2016%20*%20(j+1)));%0A%09%20%20%20%20%20%20%09%20%20%20%20j%20+=%201;%0A%09%20%20%20%20%09%7D%0A%09%20%20%20%20%09b.splice(0,%2016%20*%20j);%0A%09%20%20%20%20%7D%20else%20%7B%0A%09%09for%20(i%20=%20512+ol%20-%20((512+ol)%20&%20511);%20i%20%3C=%20nl;%20i+=%20512)%20%7B%0A%09%20%20%20%20%20%20%09%20%20%20%20this._block(b.splice(0,16));%0A%09%20%20%20%20%20%20%09%7D%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20this;%0A%09%20%20%7D,%0A%09%20%20%0A%09%20%20/**%0A%09%20%20%20*%20Complete%20hashing%20and%20output%20the%20hash%20value.%0A%09%20%20%20*%20@return%20%7BbitArray%7D%20The%20hash%20value,%20an%20array%20of%208%20big-endian%20words.%0A%09%20%20%20*/%0A%09%20%20finalize:function%20()%20%7B%0A%09%20%20%20%20var%20i,%20b%20=%20this._buffer,%20h%20=%20this._h;%0A%0A%09%20%20%20%20//%20Round%20out%20and%20push%20the%20buffer%0A%09%20%20%20%20b%20=%20sjcl.bitArray.concat(b,%20%5Bsjcl.bitArray.partial(1,1)%5D);%0A%09%20%20%20%20%0A%09%20%20%20%20//%20Round%20out%20the%20buffer%20to%20a%20multiple%20of%2016%20words,%20less%20the%202%20length%20words.%0A%09%20%20%20%20for%20(i%20=%20b.length%20+%202;%20i%20&%2015;%20i++)%20%7B%0A%09%20%20%20%20%20%20b.push(0);%0A%09%20%20%20%20%7D%0A%09%20%20%20%20%0A%09%20%20%20%20//%20append%20the%20length%0A%09%20%20%20%20b.push(Math.floor(this._length%20/%200x100000000));%0A%09%20%20%20%20b.push(this._length%20%7C%200);%0A%0A%09%20%20%20%20while%20(b.length)%20%7B%0A%09%20%20%20%20%20%20this._block(b.splice(0,16));%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20this.reset();%0A%09%20%20%20%20return%20h;%0A%09%20%20%7D,%0A%0A%09%20%20/**%0A%09%20%20%20*%20The%20SHA-256%20initialization%20vector,%20to%20be%20precomputed.%0A%09%20%20%20*%20@private%0A%09%20%20%20*/%0A%09%20%20_init:%5B%5D,%0A%09%20%20/*%0A%09%20%20_init:%5B0x6a09e667,0xbb67ae85,0x3c6ef372,0xa54ff53a,0x510e527f,0x9b05688c,0x1f83d9ab,0x5be0cd19%5D,%0A%09%20%20*/%0A%09%20%20%0A%09%20%20/**%0A%09%20%20%20*%20The%20SHA-256%20hash%20key,%20to%20be%20precomputed.%0A%09%20%20%20*%20@private%0A%09%20%20%20*/%0A%09%20%20_key:%5B%5D,%0A%09%20%20/*%0A%09%20%20_key:%0A%09%20%20%20%20%5B0x428a2f98,%200x71374491,%200xb5c0fbcf,%200xe9b5dba5,%200x3956c25b,%200x59f111f1,%200x923f82a4,%200xab1c5ed5,%0A%09%20%20%20%20%200xd807aa98,%200x12835b01,%200x243185be,%200x550c7dc3,%200x72be5d74,%200x80deb1fe,%200x9bdc06a7,%200xc19bf174,%0A%09%20%20%20%20%200xe49b69c1,%200xefbe4786,%200x0fc19dc6,%200x240ca1cc,%200x2de92c6f,%200x4a7484aa,%200x5cb0a9dc,%200x76f988da,%0A%09%20%20%20%20%200x983e5152,%200xa831c66d,%200xb00327c8,%200xbf597fc7,%200xc6e00bf3,%200xd5a79147,%200x06ca6351,%200x14292967,%0A%09%20%20%20%20%200x27b70a85,%200x2e1b2138,%200x4d2c6dfc,%200x53380d13,%200x650a7354,%200x766a0abb,%200x81c2c92e,%200x92722c85,%0A%09%20%20%20%20%200xa2bfe8a1,%200xa81a664b,%200xc24b8b70,%200xc76c51a3,%200xd192e819,%200xd6990624,%200xf40e3585,%200x106aa070,%0A%09%20%20%20%20%200x19a4c116,%200x1e376c08,%200x2748774c,%200x34b0bcb5,%200x391c0cb3,%200x4ed8aa4a,%200x5b9cca4f,%200x682e6ff3,%0A%09%20%20%20%20%200x748f82ee,%200x78a5636f,%200x84c87814,%200x8cc70208,%200x90befffa,%200xa4506ceb,%200xbef9a3f7,%200xc67178f2%5D,%0A%09%20%20*/%0A%0A%0A%09%20%20/**%0A%09%20%20%20*%20Function%20to%20precompute%20_init%20and%20_key.%0A%09%20%20%20*%20@private%0A%09%20%20%20*/%0A%09%20%20_precompute:%20function%20()%20%7B%0A%09%20%20%20%20var%20i%20=%200,%20prime%20=%202,%20factor,%20isPrime;%0A%0A%09%20%20%20%20function%20frac(x)%20%7B%20return%20(x-Math.floor(x))%20*%200x100000000%20%7C%200;%20%7D%0A%0A%09%20%20%20%20for%20(;%20i%3C64;%20prime++)%20%7B%0A%09%20%20%20%20%20%20isPrime%20=%20true;%0A%09%20%20%20%20%20%20for%20(factor=2;%20factor*factor%20%3C=%20prime;%20factor++)%20%7B%0A%09%20%20%20%20%20%20%20%20if%20(prime%20%25%20factor%20===%200)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20isPrime%20=%20false;%0A%09%20%20%20%20%20%20%20%20%20%20break;%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20if%20(isPrime)%20%7B%0A%09%20%20%20%20%20%20%20%20if%20(i%3C8)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20this._init%5Bi%5D%20=%20frac(Math.pow(prime,%201/2));%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20this._key%5Bi%5D%20=%20frac(Math.pow(prime,%201/3));%0A%09%20%20%20%20%20%20%20%20i++;%0A%09%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D%0A%09%20%20%7D,%0A%09%20%20%0A%09%20%20/**%0A%09%20%20%20*%20Perform%20one%20cycle%20of%20SHA-256.%0A%09%20%20%20*%20@param%20%7BUint32Array%7CbitArray%7D%20w%20one%20block%20of%20words.%0A%09%20%20%20*%20@private%0A%09%20%20%20*/%0A%09%20%20_block:function%20(w)%20%7B%20%20%0A%09%20%20%20%20var%20i,%20tmp,%20a,%20b,%0A%09%20%20%20%20%20%20h%20=%20this._h,%0A%09%20%20%20%20%20%20k%20=%20this._key,%0A%09%20%20%20%20%20%20h0%20=%20h%5B0%5D,%20h1%20=%20h%5B1%5D,%20h2%20=%20h%5B2%5D,%20h3%20=%20h%5B3%5D,%0A%09%20%20%20%20%20%20h4%20=%20h%5B4%5D,%20h5%20=%20h%5B5%5D,%20h6%20=%20h%5B6%5D,%20h7%20=%20h%5B7%5D;%0A%0A%09%20%20%20%20/*%20Rationale%20for%20placement%20of%20%7C0%20:%0A%09%20%20%20%20%20*%20If%20a%20value%20can%20overflow%20is%20original%2032%20bits%20by%20a%20factor%20of%20more%20than%20a%20few%0A%09%20%20%20%20%20*%20million%20(2%5E23%20ish),%20there%20is%20a%20possibility%20that%20it%20might%20overflow%20the%0A%09%20%20%20%20%20*%2053-bit%20mantissa%20and%20lose%20precision.%0A%09%20%20%20%20%20*%0A%09%20%20%20%20%20*%20To%20avoid%20this,%20we%20clamp%20back%20to%2032%20bits%20by%20%7C'ing%20with%200%20on%20any%20value%20that%0A%09%20%20%20%20%20*%20propagates%20around%20the%20loop,%20and%20on%20the%20hash%20state%20h%5B%5D.%20%20I%20don't%20believe%0A%09%20%20%20%20%20*%20that%20the%20clamps%20on%20h4%20and%20on%20h0%20are%20strictly%20necessary,%20but%20it's%20close%0A%09%20%20%20%20%20*%20(for%20h4%20anyway),%20and%20better%20safe%20than%20sorry.%0A%09%20%20%20%20%20*%0A%09%20%20%20%20%20*%20The%20clamps%20on%20h%5B%5D%20are%20necessary%20for%20the%20output%20to%20be%20correct%20even%20in%20the%0A%09%20%20%20%20%20*%20common%20case%20and%20for%20short%20inputs.%0A%09%20%20%20%20%20*/%0A%09%20%20%20%20for%20(i=0;%20i%3C64;%20i++)%20%7B%0A%09%20%20%20%20%20%20//%20load%20up%20the%20input%20word%20for%20this%20round%0A%09%20%20%20%20%20%20if%20(i%3C16)%20%7B%0A%09%20%20%20%20%20%20%20%20tmp%20=%20w%5Bi%5D;%0A%09%20%20%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20a%20%20%20=%20w%5B(i+1%20)%20&%2015%5D;%0A%09%20%20%20%20%20%20%20%20b%20%20%20=%20w%5B(i+14)%20&%2015%5D;%0A%09%20%20%20%20%20%20%20%20tmp%20=%20w%5Bi&15%5D%20=%20((a%3E%3E%3E7%20%20%5E%20a%3E%3E%3E18%20%5E%20a%3E%3E%3E3%20%20%5E%20a%3C%3C25%20%5E%20a%3C%3C14)%20+%20%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(b%3E%3E%3E17%20%5E%20b%3E%3E%3E19%20%5E%20b%3E%3E%3E10%20%5E%20b%3C%3C15%20%5E%20b%3C%3C13)%20+%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20w%5Bi&15%5D%20+%20w%5B(i+9)%20&%2015%5D)%20%7C%200;%0A%09%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%0A%09%20%20%20%20%20%20tmp%20=%20(tmp%20+%20h7%20+%20(h4%3E%3E%3E6%20%5E%20h4%3E%3E%3E11%20%5E%20h4%3E%3E%3E25%20%5E%20h4%3C%3C26%20%5E%20h4%3C%3C21%20%5E%20h4%3C%3C7)%20+%20%20(h6%20%5E%20h4&(h5%5Eh6))%20+%20k%5Bi%5D);%20//%20%7C%200;%0A%09%20%20%20%20%20%20%0A%09%20%20%20%20%20%20//%20shift%20register%0A%09%20%20%20%20%20%20h7%20=%20h6;%20h6%20=%20h5;%20h5%20=%20h4;%0A%09%20%20%20%20%20%20h4%20=%20h3%20+%20tmp%20%7C%200;%0A%09%20%20%20%20%20%20h3%20=%20h2;%20h2%20=%20h1;%20h1%20=%20h0;%0A%0A%09%20%20%20%20%20%20h0%20=%20(tmp%20+%20%20((h1&h2)%20%5E%20(h3&(h1%5Eh2)))%20+%20(h1%3E%3E%3E2%20%5E%20h1%3E%3E%3E13%20%5E%20h1%3E%3E%3E22%20%5E%20h1%3C%3C30%20%5E%20h1%3C%3C19%20%5E%20h1%3C%3C10))%20%7C%200;%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20h%5B0%5D%20=%20h%5B0%5D+h0%20%7C%200;%0A%09%20%20%20%20h%5B1%5D%20=%20h%5B1%5D+h1%20%7C%200;%0A%09%20%20%20%20h%5B2%5D%20=%20h%5B2%5D+h2%20%7C%200;%0A%09%20%20%20%20h%5B3%5D%20=%20h%5B3%5D+h3%20%7C%200;%0A%09%20%20%20%20h%5B4%5D%20=%20h%5B4%5D+h4%20%7C%200;%0A%09%20%20%20%20h%5B5%5D%20=%20h%5B5%5D+h5%20%7C%200;%0A%09%20%20%20%20h%5B6%5D%20=%20h%5B6%5D+h6%20%7C%200;%0A%09%20%20%20%20h%5B7%5D%20=%20h%5B7%5D+h7%20%7C%200;%0A%09%20%20%7D%0A%09%7D;%0A%0A%0A%09/**%20@fileOverview%20HMAC%20implementation.%0A%09%20*%0A%09%20*%20@author%20Emily%20Stark%0A%09%20*%20@author%20Mike%20Hamburg%0A%09%20*%20@author%20Dan%20Boneh%0A%09%20*/%0A%0A%09/**%20HMAC%20with%20the%20specified%20hash%20function.%0A%09%20*%20@constructor%0A%09%20*%20@param%20%7BbitArray%7D%20key%20the%20key%20for%20HMAC.%0A%09%20*%20@param%20%7BObject%7D%20%5BHash=sjcl.hash.sha256%5D%20The%20hash%20function%20to%20use.%0A%09%20*/%0A%09sjcl.misc.hmac%20=%20function%20(key,%20Hash)%20%7B%0A%09%20%20this._hash%20=%20Hash%20=%20Hash%20%7C%7C%20sjcl.hash.sha256;%0A%09%20%20var%20exKey%20=%20%5B%5B%5D,%5B%5D%5D,%20i,%0A%09%20%20%20%20%20%20bs%20=%20Hash.prototype.blockSize%20/%2032;%0A%09%20%20this._baseHash%20=%20%5Bnew%20Hash(),%20new%20Hash()%5D;%0A%0A%09%20%20if%20(key.length%20%3E%20bs)%20%7B%0A%09%20%20%20%20key%20=%20Hash.hash(key);%0A%09%20%20%7D%0A%09%20%20%0A%09%20%20for%20(i=0;%20i%3Cbs;%20i++)%20%7B%0A%09%20%20%20%20exKey%5B0%5D%5Bi%5D%20=%20key%5Bi%5D%5E0x36363636;%0A%09%20%20%20%20exKey%5B1%5D%5Bi%5D%20=%20key%5Bi%5D%5E0x5C5C5C5C;%0A%09%20%20%7D%0A%09%20%20%0A%09%20%20this._baseHash%5B0%5D.update(exKey%5B0%5D);%0A%09%20%20this._baseHash%5B1%5D.update(exKey%5B1%5D);%0A%09%20%20this._resultHash%20=%20new%20Hash(this._baseHash%5B0%5D);%0A%09%7D;%0A%0A%09/**%20HMAC%20with%20the%20specified%20hash%20function.%20%20Also%20called%20encrypt%20since%20it's%20a%20prf.%0A%09%20*%20@param%20%7BbitArray%7CString%7D%20data%20The%20data%20to%20mac.%0A%09%20*/%0A%09sjcl.misc.hmac.prototype.encrypt%20=%20sjcl.misc.hmac.prototype.mac%20=%20function%20(data)%20%7B%0A%09%20%20if%20(!this._updated)%20%7B%0A%09%20%20%20%20this.update(data);%0A%09%20%20%20%20return%20this.digest(data);%0A%09%20%20%7D%20else%20%7B%0A%09%20%20%20%20throw%20new%20sjcl.exception.invalid(%22encrypt%20on%20already%20updated%20hmac%20called!%22);%0A%09%20%20%7D%0A%09%7D;%0A%0A%09sjcl.misc.hmac.prototype.reset%20=%20function%20()%20%7B%0A%09%20%20this._resultHash%20=%20new%20this._hash(this._baseHash%5B0%5D);%0A%09%20%20this._updated%20=%20false;%0A%09%7D;%0A%0A%09sjcl.misc.hmac.prototype.update%20=%20function%20(data)%20%7B%0A%09%20%20this._updated%20=%20true;%0A%09%20%20this._resultHash.update(data);%0A%09%7D;%0A%0A%09sjcl.misc.hmac.prototype.digest%20=%20function%20()%20%7B%0A%09%20%20var%20w%20=%20this._resultHash.finalize(),%20result%20=%20new%20(this._hash)(this._baseHash%5B1%5D).update(w).finalize();%0A%0A%09%20%20this.reset();%0A%0A%09%20%20return%20result;%0A%09%7D;%0A%09if(module.exports)%7B%0A%09%20%20module.exports%20=%20sjcl;%0A%09%7D%0A%09%7D);%0A%0A%09/*%20global%20exportFunction%20*/%0A%0A%09function%20getDataKeySync%20(sessionKey,%20domainKey,%20inputData)%20%7B%0A%09%20%20%20%20//%20eslint-disable-next-line%20new-cap%0A%09%20%20%20%20const%20hmac%20=%20new%20sjcl_1.misc.hmac(sjcl_1.codec.utf8String.toBits(sessionKey%20+%20domainKey),%20sjcl_1.hash.sha256);%0A%09%20%20%20%20return%20sjcl_1.codec.hex.fromBits(hmac.encrypt(inputData))%0A%09%7D%0A%0A%09//%20linear%20feedback%20shift%20register%20to%20find%20a%20random%20approximation%0A%09function%20nextRandom%20(v)%20%7B%0A%09%20%20%20%20return%20Math.abs((v%20%3E%3E%201)%20%7C%20(((v%20%3C%3C%2062)%20%5E%20(v%20%3C%3C%2061))%20&%20(~(~0%20%3C%3C%2063)%20%3C%3C%2062)))%0A%09%7D%0A%0A%09const%20exemptionLists%20=%20%7B%7D;%0A%09function%20shouldExemptUrl%20(type,%20url)%20%7B%0A%09%20%20%20%20for%20(const%20regex%20of%20exemptionLists%5Btype%5D)%20%7B%0A%09%20%20%20%20%20%20%20%20if%20(regex.test(url))%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20return%20true%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20false%0A%09%7D%0A%0A%09function%20initStringExemptionLists%20(args)%20%7B%0A%09%20%20%20%20const%20%7B%20stringExemptionLists%20%7D%20=%20args;%0A%09%20%20%20%20for%20(const%20type%20in%20stringExemptionLists)%20%7B%0A%09%20%20%20%20%20%20%20%20exemptionLists%5Btype%5D%20=%20%5B%5D;%0A%09%20%20%20%20%20%20%20%20for%20(const%20stringExemption%20of%20stringExemptionLists%5Btype%5D)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20exemptionLists%5Btype%5D.push(new%20RegExp(stringExemption));%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09//%20Checks%20the%20stack%20trace%20if%20there%20are%20known%20libraries%20that%20are%20broken.%0A%09function%20shouldExemptMethod%20(type)%20%7B%0A%09%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20const%20errorLines%20=%20new%20Error().stack.split('%5Cn');%0A%09%20%20%20%20%20%20%20%20const%20errorFiles%20=%20new%20Set();%0A%09%20%20%20%20%20%20%20%20//%20Should%20cater%20for%20Chrome%20and%20Firefox%20stacks,%20we%20only%20care%20about%20https?%20resources.%0A%09%20%20%20%20%20%20%20%20const%20lineTest%20=%20/(%5C()?(http%5B%5E)%5D+):%5B0-9%5D+:%5B0-9%5D+(%5C))?/;%0A%09%20%20%20%20%20%20%20%20for%20(const%20line%20of%20errorLines)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20res%20=%20line.match(lineTest);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20if%20(res)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20path%20=%20res%5B2%5D;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20checked%20already%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(errorFiles.has(path))%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20continue%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(shouldExemptUrl(type,%20path))%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20true%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20errorFiles.add(res%5B2%5D);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D%20catch%20(e)%20%7B%0A%09%20%20%20%20%20%20%20%20//%20Fall%20through%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20false%0A%09%7D%0A%0A%09//%20Iterate%20through%20the%20key,%20passing%20an%20item%20index%20and%20a%20byte%20to%20be%20modified%0A%09function%20iterateDataKey%20(key,%20callback)%20%7B%0A%09%20%20%20%20let%20item%20=%20key.charCodeAt(0);%0A%09%20%20%20%20for%20(const%20i%20in%20key)%20%7B%0A%09%20%20%20%20%20%20%20%20let%20byte%20=%20key.charCodeAt(i);%0A%09%20%20%20%20%20%20%20%20for%20(let%20j%20=%208;%20j%20%3E=%200;%20j--)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20callback(item,%20byte);%0A%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20find%20next%20item%20to%20perturb%0A%09%20%20%20%20%20%20%20%20%20%20%20%20item%20=%20nextRandom(item);%0A%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20Right%20shift%20as%20we%20use%20the%20least%20significant%20bit%20of%20it%0A%09%20%20%20%20%20%20%20%20%20%20%20%20byte%20=%20byte%20%3E%3E%201;%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09function%20isFeatureBroken%20(args,%20feature)%20%7B%0A%09%20%20%20%20return%20args.site.brokenFeatures.includes(feature)%0A%09%7D%0A%0A%09/**%0A%09%20*%20For%20each%20property%20defined%20on%20the%20object,%20update%20it%20with%20the%20target%20value.%0A%09%20*/%0A%09function%20overrideProperty%20(name,%20prop)%20%7B%0A%09%20%20%20%20//%20Don't%20update%20if%20existing%20value%20is%20undefined%20or%20null%0A%09%20%20%20%20if%20(!(prop.origValue%20===%20undefined))%20%7B%0A%09%20%20%20%20%20%20%20%20/**%0A%09%20%20%20%20%20%20%20%20%20*%20When%20re-defining%20properties,%20we%20bind%20the%20overwritten%20functions%20to%20null.%20This%20prevents%0A%09%20%20%20%20%20%20%20%20%20*%20sites%20from%20using%20toString%20to%20see%20if%20the%20function%20has%20been%20overwritten%0A%09%20%20%20%20%20%20%20%20%20*%20without%20this%20bind%20call,%20a%20site%20could%20run%20something%20like%0A%09%20%20%20%20%20%20%20%20%20*%20%60Object.getOwnPropertyDescriptor(Screen.prototype,%20%22availTop%22).get.toString()%60%20and%20see%0A%09%20%20%20%20%20%20%20%20%20*%20the%20contents%20of%20the%20function.%20Appending%20.bind(null)%20to%20the%20function%20definition%20will%0A%09%20%20%20%20%20%20%20%20%20*%20have%20the%20same%20toString%20call%20return%20the%20default%20%5Bnative%20code%5D%0A%09%20%20%20%20%20%20%20%20%20*/%0A%09%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20defineProperty(prop.object,%20name,%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20eslint-disable-next-line%20no-extra-bind%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20get:%20(()%20=%3E%20prop.targetValue).bind(null)%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%20%20%20%20%7D%20catch%20(e)%20%7B%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20prop.origValue%0A%09%7D%0A%0A%09//%20TODO%20make%20rollup%20aware%20of%20this%20so%20it%20can%20tree%20shake%0A%09const%20mozProxies%20=%20'wrappedJSObject'%20in%20window;%0A%0A%09function%20defineProperty%20(object,%20propertyName,%20descriptor)%20%7B%0A%09%20%20%20%20if%20(mozProxies)%20%7B%0A%09%20%20%20%20%20%20%20%20const%20usedObj%20=%20object.wrappedJSObject;%0A%09%20%20%20%20%20%20%20%20const%20UsedObjectInterface%20=%20window.wrappedJSObject.Object;%0A%09%20%20%20%20%20%20%20%20const%20definedDescriptor%20=%20new%20UsedObjectInterface();%0A%09%20%20%20%20%20%20%20%20%5B'configurable',%20'enumerable',%20'value',%20'writable'%5D.forEach((propertyName)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20TODO%20check%20if%20value%20is%20complex%20and%20export%20it%20if%20so.%0A%09%20%20%20%20%20%20%20%20%20%20%20%20if%20(propertyName%20in%20descriptor)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20definedDescriptor%5BpropertyName%5D%20=%20descriptor%5BpropertyName%5D;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%20%20%20%20%5B'get',%20'set'%5D.forEach((methodName)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20if%20(methodName%20in%20descriptor)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20exportFunction(descriptor%5BmethodName%5D,%20definedDescriptor,%20%7B%20defineAs:%20methodName%20%7D);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%20%20%20%20UsedObjectInterface.defineProperty(usedObj,%20propertyName,%20definedDescriptor);%0A%09%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20Object.defineProperty(object,%20propertyName,%20descriptor);%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09class%20DDGProxy%20%7B%0A%09%20%20%20%20constructor%20(objectScope,%20property,%20proxyObject)%20%7B%0A%09%20%20%20%20%20%20%20%20this.objectScope%20=%20objectScope;%0A%09%20%20%20%20%20%20%20%20this.property%20=%20property;%0A%09%20%20%20%20%20%20%20%20if%20(mozProxies)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20this._native%20=%20objectScope%5Bproperty%5D;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20handler%20=%20new%20window.wrappedJSObject.Object();%0A%09%20%20%20%20%20%20%20%20%20%20%20%20handler.apply%20=%20exportFunction(proxyObject.apply,%20window);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20this.internal%20=%20new%20window.wrappedJSObject.Proxy(objectScope.wrappedJSObject%5Bproperty%5D,%20handler);%0A%09%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20this._native%20=%20objectScope%5Bproperty%5D;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20handler%20=%20%7B%7D;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20handler.apply%20=%20proxyObject.apply;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20this.internal%20=%20new%20window.Proxy(objectScope%5Bproperty%5D,%20handler);%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20//%20Actually%20apply%20the%20proxy%20to%20the%20native%20property%0A%09%20%20%20%20overload%20()%20%7B%0A%09%20%20%20%20%20%20%20%20if%20(mozProxies)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20exportFunction(this.internal,%20this.objectScope,%20%7B%20defineAs:%20this.property%20%7D);%0A%09%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20this.objectScope%5Bthis.property%5D%20=%20this.internal;%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09let%20DDGReflect;%0A%0A%09if%20(mozProxies)%20%7B%0A%09%20%20%20%20DDGReflect%20=%20window.wrappedJSObject.Reflect;%0A%09%7D%20else%20%7B%0A%09%20%20%20%20DDGReflect%20=%20window.Reflect;%0A%09%7D%0A%0A%09function%20__variableDynamicImportRuntime0__(path)%20%7B%0A%09%20%20%20switch%20(path)%20%7B%0A%09%20%20%20%20%20case%20'./audio-protection.js':%20return%20Promise.resolve().then(function%20()%20%7B%20return%20audioProtection;%20%7D);%0A%09%20%20%20%20%20case%20'./battery-protection.js':%20return%20Promise.resolve().then(function%20()%20%7B%20return%20batteryProtection;%20%7D);%0A%09%20%20%20%20%20case%20'./canvas-protection.js':%20return%20Promise.resolve().then(function%20()%20%7B%20return%20canvasProtection;%20%7D);%0A%09%20%20%20%20%20case%20'./cookie-protection.js':%20return%20Promise.resolve().then(function%20()%20%7B%20return%20cookieProtection;%20%7D);%0A%09%20%20%20%20%20case%20'./do-not-track-protection.js':%20return%20Promise.resolve().then(function%20()%20%7B%20return%20doNotTrackProtection;%20%7D);%0A%09%20%20%20%20%20case%20'./floc-protection.js':%20return%20Promise.resolve().then(function%20()%20%7B%20return%20flocProtection;%20%7D);%0A%09%20%20%20%20%20case%20'./gpc-protection.js':%20return%20Promise.resolve().then(function%20()%20%7B%20return%20gpcProtection;%20%7D);%0A%09%20%20%20%20%20case%20'./hardware-protection.js':%20return%20Promise.resolve().then(function%20()%20%7B%20return%20hardwareProtection;%20%7D);%0A%09%20%20%20%20%20case%20'./referrer-protection.js':%20return%20Promise.resolve().then(function%20()%20%7B%20return%20referrerProtection;%20%7D);%0A%09%20%20%20%20%20case%20'./screen-size-protection.js':%20return%20Promise.resolve().then(function%20()%20%7B%20return%20screenSizeProtection;%20%7D);%0A%09%20%20%20%20%20case%20'./temporary-storage-protection.js':%20return%20Promise.resolve().then(function%20()%20%7B%20return%20temporaryStorageProtection;%20%7D);%0A%09%20%20%20%20%20default:%20return%20Promise.reject(new%20Error(%22Unknown%20variable%20dynamic%20import:%20%22%20+%20path));%0A%09%20%20%20%7D%0A%09%20%7D%0A%0A%09function%20shouldRun%20()%20%7B%0A%09%20%20%20%20//%20don't%20inject%20into%20non-HTML%20documents%20(such%20as%20XML%20documents)%0A%09%20%20%20%20//%20but%20do%20inject%20into%20XHTML%20documents%0A%09%20%20%20%20if%20(document%20instanceof%20HTMLDocument%20===%20false%20&&%20(%0A%09%20%20%20%20%20%20%20%20document%20instanceof%20XMLDocument%20===%20false%20%7C%7C%0A%09%20%20%20%20%20%20%20%20document.createElement('div')%20instanceof%20HTMLDivElement%20===%20false%0A%09%20%20%20%20))%20%7B%0A%09%20%20%20%20%20%20%20%20return%20false%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20true%0A%09%7D%0A%0A%09let%20initArgs%20=%20null;%0A%09const%20updates%20=%20%5B%5D;%0A%09const%20protections%20=%20%5B%5D;%0A%0A%09async%20function%20loadProtections%20()%20%7B%0A%09%20%20%20%20if%20(!shouldRun())%20%7B%0A%09%20%20%20%20%20%20%20%20return%0A%09%20%20%20%20%7D%0A%09%20%20%20%20const%20protectionNames%20=%20%5B%0A%09%20%20%20%20%20%20%20%20'audio',%0A%09%20%20%20%20%20%20%20%20'battery',%0A%09%20%20%20%20%20%20%20%20'canvas',%0A%09%20%20%20%20%20%20%20%20'cookie',%0A%09%20%20%20%20%20%20%20%20'do-not-track',%0A%09%20%20%20%20%20%20%20%20'floc',%0A%09%20%20%20%20%20%20%20%20'gpc',%0A%09%20%20%20%20%20%20%20%20'hardware',%0A%09%20%20%20%20%20%20%20%20'referrer',%0A%09%20%20%20%20%20%20%20%20'screen-size',%0A%09%20%20%20%20%20%20%20%20'temporary-storage'%0A%09%20%20%20%20%5D;%0A%0A%09%20%20%20%20for%20(const%20protectionName%20of%20protectionNames)%20%7B%0A%09%20%20%20%20%20%20%20%20const%20protection%20=%20__variableDynamicImportRuntime0__(%60./$%7BprotectionName%7D-protection.js%60).then((%7B%20init,%20load,%20update%20%7D)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20if%20(load)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20load();%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%20protectionName,%20init,%20update%20%7D%0A%09%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%20%20%20%20protections.push(protection);%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09async%20function%20initProtections%20(args)%20%7B%0A%09%20%20%20%20initArgs%20=%20args;%0A%09%20%20%20%20if%20(!shouldRun())%20%7B%0A%09%20%20%20%20%20%20%20%20return%0A%09%20%20%20%20%7D%0A%09%20%20%20%20initStringExemptionLists(args);%0A%09%20%20%20%20const%20resolvedProtections%20=%20await%20Promise.all(protections);%0A%09%20%20%20%20resolvedProtections.forEach((%7B%20init,%20protectionName%20%7D)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20if%20(!isFeatureBroken(args,%20protectionName))%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20init(args);%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20//%20Fire%20off%20updates%20that%20came%20in%20faster%20than%20the%20init%0A%09%20%20%20%20while%20(updates.length)%20%7B%0A%09%20%20%20%20%20%20%20%20const%20update%20=%20updates.pop();%0A%09%20%20%20%20%20%20%20%20await%20updateProtectionsInner(update);%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09async%20function%20updateProtections%20(args)%20%7B%0A%09%20%20%20%20if%20(!shouldRun())%20%7B%0A%09%20%20%20%20%20%20%20%20return%0A%09%20%20%20%20%7D%0A%09%20%20%20%20if%20(initArgs%20===%20null)%20%7B%0A%09%20%20%20%20%20%20%20%20updates.push(args);%0A%09%20%20%20%20%20%20%20%20return%0A%09%20%20%20%20%7D%0A%09%20%20%20%20updateProtectionsInner(args);%0A%09%7D%0A%0A%09async%20function%20updateProtectionsInner%20(args)%20%7B%0A%09%20%20%20%20const%20resolvedProtections%20=%20await%20Promise.all(protections);%0A%09%20%20%20%20resolvedProtections.forEach((%7B%20update,%20protectionName%20%7D)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20if%20(!isFeatureBroken(initArgs,%20protectionName)%20&&%20update)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20update(args);%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D);%0A%09%7D%0A%0A%09function%20init$a%20(args)%20%7B%0A%09%20%20%20%20const%20%7B%20sessionKey,%20site%20%7D%20=%20args;%0A%09%20%20%20%20const%20domainKey%20=%20site.domain;%0A%0A%09%20%20%20%20//%20In%20place%20modify%20array%20data%20to%20remove%20fingerprinting%0A%09%20%20%20%20function%20transformArrayData%20(channelData,%20domainKey,%20sessionKey,%20thisArg)%20%7B%0A%09%20%20%20%20%20%20%20%20let%20%7B%20audioKey%20%7D%20=%20getCachedResponse(thisArg,%20args);%0A%09%20%20%20%20%20%20%20%20if%20(!audioKey)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20cdSum%20=%20channelData.reduce((sum,%20v)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20sum%20+%20v%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D,%200);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20audioKey%20=%20getDataKeySync(sessionKey,%20domainKey,%20cdSum);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20setCache(thisArg,%20args,%20audioKey);%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20iterateDataKey(audioKey,%20(item,%20byte)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20itemAudioIndex%20=%20item%20%25%20channelData.length;%0A%0A%09%20%20%20%20%20%20%20%20%20%20%20%20let%20factor%20=%20byte%20*%200.0000001;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20if%20(byte%20%5E%200x1)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20factor%20=%200%20-%20factor;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20channelData%5BitemAudioIndex%5D%20=%20channelData%5BitemAudioIndex%5D%20+%20factor;%0A%09%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20const%20copyFromChannelProxy%20=%20new%20DDGProxy(AudioBuffer.prototype,%20'copyFromChannel',%20%7B%0A%09%20%20%20%20%20%20%20%20apply%20(target,%20thisArg,%20args)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20%5Bsource,%20channelNumber,%20startInChannel%5D%20=%20args;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20This%20is%20implemented%20in%20a%20different%20way%20to%20canvas%20purely%20because%20calling%20the%20function%20copied%20the%20original%20value,%20which%20is%20not%20ideal%0A%09%20%20%20%20%20%20%20%20%20%20%20%20if%20(shouldExemptMethod('audio')%20%7C%7C%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20If%20channelNumber%20is%20longer%20than%20arrayBuffer%20number%20of%20channels%20then%20call%20the%20default%20method%20to%20throw%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20channelNumber%20%3E%20thisArg.numberOfChannels%20%7C%7C%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20If%20startInChannel%20is%20longer%20than%20the%20arrayBuffer%20length%20then%20call%20the%20default%20method%20to%20throw%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20startInChannel%20%3E%20thisArg.length)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20The%20normal%20return%20value%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20DDGReflect.apply(target,%20thisArg,%20args)%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20Call%20the%20protected%20getChannelData%20we%20implement,%20slice%20from%20the%20startInChannel%20value%20and%20assign%20to%20the%20source%20array%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20thisArg.getChannelData(channelNumber).slice(startInChannel).forEach((val,%20index)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20source%5Bindex%5D%20=%20val;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%20catch%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20DDGReflect.apply(target,%20thisArg,%20args)%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20copyFromChannelProxy.overload();%0A%0A%09%20%20%20%20const%20cacheExpiry%20=%2060;%0A%09%20%20%20%20const%20cacheData%20=%20new%20WeakMap();%0A%09%20%20%20%20function%20getCachedResponse%20(thisArg,%20args)%20%7B%0A%09%20%20%20%20%20%20%20%20const%20data%20=%20cacheData.get(thisArg);%0A%09%20%20%20%20%20%20%20%20const%20timeNow%20=%20Date.now();%0A%09%20%20%20%20%20%20%20%20if%20(data%20&&%0A%09%20%20%20%20%20%20%20%20%20%20%20%20data.args%20===%20JSON.stringify(args)%20&&%0A%09%20%20%20%20%20%20%20%20%20%20%20%20data.expires%20%3E%20timeNow)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20data.expires%20=%20timeNow%20+%20cacheExpiry;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20cacheData.set(thisArg,%20data);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20return%20data%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20return%20%7B%20audioKey:%20null%20%7D%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20function%20setCache%20(thisArg,%20args,%20audioKey)%20%7B%0A%09%20%20%20%20%20%20%20%20cacheData.set(thisArg,%20%7B%20args:%20JSON.stringify(args),%20expires:%20Date.now()%20+%20cacheExpiry,%20audioKey%20%7D);%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20const%20getChannelDataProxy%20=%20new%20DDGProxy(AudioBuffer.prototype,%20'getChannelData',%20%7B%0A%09%20%20%20%20%20%20%20%20apply%20(target,%20thisArg,%20args)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20The%20normal%20return%20value%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20channelData%20=%20DDGReflect.apply(target,%20thisArg,%20args);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20if%20(shouldExemptMethod('audio'))%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20channelData%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20Anything%20we%20do%20here%20should%20be%20caught%20and%20ignored%20silently%0A%09%20%20%20%20%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20transformArrayData(channelData,%20domainKey,%20sessionKey,%20thisArg,%20args);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%20catch%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20return%20channelData%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20getChannelDataProxy.overload();%0A%0A%09%20%20%20%20const%20audioMethods%20=%20%5B'getByteTimeDomainData',%20'getFloatTimeDomainData',%20'getByteFrequencyData',%20'getFloatFrequencyData'%5D;%0A%09%20%20%20%20for%20(const%20methodName%20of%20audioMethods)%20%7B%0A%09%20%20%20%20%20%20%20%20const%20proxy%20=%20new%20DDGProxy(AnalyserNode.prototype,%20methodName,%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20apply%20(target,%20thisArg,%20args)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20DDGReflect.apply(target,%20thisArg,%20args);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(shouldExemptMethod('audio'))%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20Anything%20we%20do%20here%20should%20be%20caught%20and%20ignored%20silently%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20transformArrayData(args%5B0%5D,%20domainKey,%20sessionKey,%20thisArg,%20args);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20catch%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%20%20%20%20proxy.overload();%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09var%20audioProtection%20=%20/*#__PURE__*/Object.freeze(%7B%0A%09%09__proto__:%20null,%0A%09%09init:%20init$a%0A%09%7D);%0A%0A%09/**%0A%09%20*%20Overwrites%20the%20Battery%20API%20if%20present%20in%20the%20browser.%0A%09%20*%20It%20will%20return%20the%20values%20defined%20in%20the%20getBattery%20function%20to%20the%20client,%0A%09%20*%20as%20well%20as%20prevent%20any%20script%20from%20listening%20to%20events.%0A%09%20*/%0A%09function%20init$9%20(args)%20%7B%0A%09%20%20%20%20if%20(navigator.getBattery)%20%7B%0A%09%20%20%20%20%20%20%20%20const%20spoofedValues%20=%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20charging:%20true,%0A%09%20%20%20%20%20%20%20%20%20%20%20%20chargingTime:%200,%0A%09%20%20%20%20%20%20%20%20%20%20%20%20dischargingTime:%20Infinity,%0A%09%20%20%20%20%20%20%20%20%20%20%20%20level:%201%0A%09%20%20%20%20%20%20%20%20%7D;%0A%09%20%20%20%20%20%20%20%20const%20eventProperties%20=%20%5B'onchargingchange',%20'onchargingtimechange',%20'ondischargingtimechange',%20'onlevelchange'%5D;%0A%0A%09%20%20%20%20%20%20%20%20for%20(const%20%5Bprop,%20val%5D%20of%20Object.entries(spoofedValues))%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20defineProperty(BatteryManager.prototype,%20prop,%20%7B%20get:%20()%20=%3E%20val%20%7D);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%20catch%20(e)%20%7B%20%7D%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20for%20(const%20eventProp%20of%20eventProperties)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20defineProperty(BatteryManager.prototype,%20eventProp,%20%7B%20get:%20()%20=%3E%20null%20%7D);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%20catch%20(e)%20%7B%20%7D%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09var%20batteryProtection%20=%20/*#__PURE__*/Object.freeze(%7B%0A%09%09__proto__:%20null,%0A%09%09init:%20init$9%0A%09%7D);%0A%0A%09function%20init$8%20(args)%20%7B%0A%09%20%20%20%20const%20%7B%20sessionKey,%20site%20%7D%20=%20args;%0A%09%20%20%20%20const%20domainKey%20=%20site.domain;%0A%0A%09%20%20%20%20//%20Using%20proxies%20here%20to%20swallow%20calls%20to%20toString%20etc%0A%09%20%20%20%20const%20getImageDataProxy%20=%20new%20DDGProxy(CanvasRenderingContext2D.prototype,%20'getImageData',%20%7B%0A%09%20%20%20%20%20%20%20%20apply%20(target,%20thisArg,%20args)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20The%20normal%20return%20value%0A%09%20%20%20%20%20%20%20%20%20%20%20%20if%20(shouldExemptMethod('canvas'))%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20DDGReflect.apply(target,%20thisArg,%20args)%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20Anything%20we%20do%20here%20should%20be%20caught%20and%20ignored%20silently%0A%09%20%20%20%20%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20%7B%20offScreenCtx%20%7D%20=%20computeOffScreenCanvas(thisArg.canvas);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20Call%20the%20original%20method%20on%20the%20modified%20off-screen%20canvas%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20DDGReflect.apply(target,%20offScreenCtx,%20args)%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%20catch%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%0A%09%20%20%20%20%20%20%20%20%20%20%20%20return%20DDGReflect.apply(target,%20thisArg,%20args)%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20getImageDataProxy.overload();%0A%0A%09%20%20%20%20function%20computeOffScreenCanvas%20(canvas)%20%7B%0A%09%20%20%20%20%20%20%20%20const%20ctx%20=%20canvas.getContext('2d');%0A%09%20%20%20%20%20%20%20%20//%20We%20*always*%20compute%20the%20random%20pixels%20on%20the%20complete%20pixel%20set,%20then%20pass%20back%20the%20subset%20later%0A%09%20%20%20%20%20%20%20%20let%20imageData%20=%20getImageDataProxy._native.apply(ctx,%20%5B0,%200,%20canvas.width,%20canvas.height%5D);%0A%09%20%20%20%20%20%20%20%20imageData%20=%20modifyPixelData(imageData,%20sessionKey,%20domainKey);%0A%0A%09%20%20%20%20%20%20%20%20//%20Make%20a%20off-screen%20canvas%20and%20put%20the%20data%20there%0A%09%20%20%20%20%20%20%20%20const%20offScreenCanvas%20=%20document.createElement('canvas');%0A%09%20%20%20%20%20%20%20%20offScreenCanvas.width%20=%20canvas.width;%0A%09%20%20%20%20%20%20%20%20offScreenCanvas.height%20=%20canvas.height;%0A%09%20%20%20%20%20%20%20%20const%20offScreenCtx%20=%20offScreenCanvas.getContext('2d');%0A%09%20%20%20%20%20%20%20%20offScreenCtx.putImageData(imageData,%200,%200);%0A%0A%09%20%20%20%20%20%20%20%20return%20%7B%20offScreenCanvas,%20offScreenCtx%20%7D%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20function%20modifyPixelData%20(imageData,%20domainKey,%20sessionKey)%20%7B%0A%09%20%20%20%20%20%20%20%20const%20arr%20=%20%5B%5D;%0A%09%20%20%20%20%20%20%20%20//%20We%20calculate%20a%20checksum%20as%20passing%20imageData%20as%20a%20key%20is%20too%20slow.%0A%09%20%20%20%20%20%20%20%20//%20We%20might%20want%20to%20do%20something%20more%20pseudo%20random%20that%20is%20less%20observable%20through%20timing%20attacks%20and%20collisions%20(but%20this%20will%20come%20at%20a%20performance%20cost)%0A%09%20%20%20%20%20%20%20%20let%20checkSum%20=%200;%0A%09%20%20%20%20%20%20%20%20//%20Create%20an%20array%20of%20only%20pixels%20that%20have%20data%20in%20them%0A%09%20%20%20%20%20%20%20%20const%20d%20=%20imageData.data;%0A%09%20%20%20%20%20%20%20%20for%20(let%20i%20=%200;%20i%20%3C%20d.length;%20i%20+=%204)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20Ignore%20non%20blank%20pixels%20there%20is%20high%20chance%20compression%20ignores%20them%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20sum%20=%20d%5Bi%5D%20+%20d%5Bi%20+%201%5D%20+%20d%5Bi%20+%202%5D%20+%20d%5Bi%20+%203%5D;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20if%20(sum%20!==%200)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20checkSum%20+=%20sum;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20arr.push(i);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%7D%0A%0A%09%20%20%20%20%20%20%20%20const%20canvasKey%20=%20getDataKeySync(sessionKey,%20domainKey,%20checkSum);%0A%09%20%20%20%20%20%20%20%20const%20length%20=%20arr.length;%0A%09%20%20%20%20%20%20%20%20iterateDataKey(canvasKey,%20(item,%20byte)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20channel%20=%20byte%20%25%203;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20lookupId%20=%20item%20%25%20length;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20pixelCanvasIndex%20=%20arr%5BlookupId%5D%20+%20channel;%0A%0A%09%20%20%20%20%20%20%20%20%20%20%20%20imageData.data%5BpixelCanvasIndex%5D%20=%20imageData.data%5BpixelCanvasIndex%5D%20%5E%20(byte%20&%200x1);%0A%09%20%20%20%20%20%20%20%20%7D);%0A%0A%09%20%20%20%20%20%20%20%20return%20imageData%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20const%20canvasMethods%20=%20%5B'toDataURL',%20'toBlob'%5D;%0A%09%20%20%20%20for%20(const%20methodName%20of%20canvasMethods)%20%7B%0A%09%20%20%20%20%20%20%20%20const%20proxy%20=%20new%20DDGProxy(HTMLCanvasElement.prototype,%20methodName,%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20apply%20(target,%20thisArg,%20args)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(shouldExemptMethod('canvas'))%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20DDGReflect.apply(target,%20thisArg,%20args)%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20%7B%20offScreenCanvas%20%7D%20=%20computeOffScreenCanvas(thisArg);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20Call%20the%20original%20method%20on%20the%20modified%20off-screen%20canvas%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20DDGReflect.apply(target,%20offScreenCanvas,%20args)%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20catch%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20Something%20we%20did%20caused%20an%20exception,%20fall%20back%20to%20the%20native%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20DDGReflect.apply(target,%20thisArg,%20args)%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%20%20%20%20proxy.overload();%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09var%20canvasProtection%20=%20/*#__PURE__*/Object.freeze(%7B%0A%09%09__proto__:%20null,%0A%09%09init:%20init$8%0A%09%7D);%0A%0A%09class%20Cookie%20%7B%0A%09%20%20%20%20constructor%20(cookieString)%20%7B%0A%09%20%20%20%20%20%20%20%20this.parts%20=%20cookieString.split(';');%0A%09%20%20%20%20%20%20%20%20this.parse();%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20parse%20()%20%7B%0A%09%20%20%20%20%20%20%20%20const%20EXTRACT_ATTRIBUTES%20=%20new%20Set(%5B'max-age',%20'expires',%20'domain'%5D);%0A%09%20%20%20%20%20%20%20%20this.attrIdx%20=%20%7B%7D;%0A%09%20%20%20%20%20%20%20%20this.parts.forEach((part,%20index)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20kv%20=%20part.split('=',%201);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20attribute%20=%20kv%5B0%5D.trim();%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20value%20=%20part.slice(kv%5B0%5D.length%20+%201);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20if%20(index%20===%200)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.name%20=%20attribute;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.value%20=%20value;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(EXTRACT_ATTRIBUTES.has(attribute.toLowerCase()))%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this%5Battribute.toLowerCase()%5D%20=%20value;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.attrIdx%5Battribute.toLowerCase()%5D%20=%20index;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20getExpiry%20()%20%7B%0A%09%20%20%20%20%20%20%20%20if%20(!this.maxAge%20&&%20!this.expires)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20return%20NaN%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20const%20expiry%20=%20this.maxAge%0A%09%20%20%20%20%20%20%20%20%20%20%20%20?%20parseInt(this.maxAge)%0A%09%20%20%20%20%20%20%20%20%20%20%20%20:%20(new%20Date(this.expires)%20-%20new%20Date())%20/%201000;%0A%09%20%20%20%20%20%20%20%20return%20expiry%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20get%20maxAge%20()%20%7B%0A%09%20%20%20%20%20%20%20%20return%20this%5B'max-age'%5D%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20set%20maxAge%20(value)%20%7B%0A%09%20%20%20%20%20%20%20%20if%20(this.attrIdx%5B'max-age'%5D%20%3E%200)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20this.parts.splice(this.attrIdx%5B'max-age'%5D,%201,%20%60max-age=$%7Bvalue%7D%60);%0A%09%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20this.parts.push(%60max-age=$%7Bvalue%7D%60);%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20this.parse();%0A%09%20%20%20%20%7D%0A%0A%09%20%20%20%20toString%20()%20%7B%0A%09%20%20%20%20%20%20%20%20return%20this.parts.join(';')%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09//%20support%20node-requires%20(for%20test%20import)%0A%09if%20(typeof%20module%20!==%20'undefined'%20&&%20module.exports)%20%7B%0A%09%20%20%20%20module.exports%20=%20Cookie;%0A%09%7D%0A%0A%09function%20blockCookies%20()%20%7B%0A%09%20%20%20%20//%20disable%20setting%20cookies%0A%09%20%20%20%20defineProperty(document,%20'cookie',%20%7B%0A%09%20%20%20%20%20%20%20%20configurable:%20false,%0A%09%20%20%20%20%20%20%20%20set:%20function%20(value)%20%7B%20%7D,%0A%09%20%20%20%20%20%20%20%20get:%20()%20=%3E%20''%0A%09%20%20%20%20%7D);%0A%09%7D%0A%0A%09let%20loadedPolicyResolve;%0A%09//%20Listen%20for%20a%20message%20from%20the%20content%20script%20which%20will%20configure%20the%20policy%20for%20this%20context%0A%09const%20trackerHosts%20=%20new%20Set();%0A%0A%09/**%0A%09%20*%20Apply%20an%20expiry%20policy%20to%20cookies%20set%20via%20document.cookie.%0A%09%20*/%0A%09function%20applyCookieExpiryPolicy%20()%20%7B%0A%09%20%20%20%20const%20debug%20=%20false;%0A%09%20%20%20%20const%20cookieSetter%20=%20Object.getOwnPropertyDescriptor(Document.prototype,%20'cookie').set;%0A%09%20%20%20%20const%20cookieGetter%20=%20Object.getOwnPropertyDescriptor(Document.prototype,%20'cookie').get;%0A%09%20%20%20%20const%20lineTest%20=%20/(%5C()?(http%5B%5E)%5D+):%5B0-9%5D+:%5B0-9%5D+(%5C))?/;%0A%0A%09%20%20%20%20const%20loadPolicy%20=%20new%20Promise((resolve)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20loadedPolicyResolve%20=%20resolve;%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20defineProperty(document,%20'cookie',%20%7B%0A%09%20%20%20%20%20%20%20%20configurable:%20true,%0A%09%20%20%20%20%20%20%20%20set:%20(value)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20call%20the%20native%20document.cookie%20implementation.%20This%20will%20set%20the%20cookie%20immediately%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20if%20the%20value%20is%20valid.%20We%20will%20override%20this%20set%20later%20if%20the%20policy%20dictates%20that%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20the%20expiry%20should%20be%20changed.%0A%09%20%20%20%20%20%20%20%20%20%20%20%20cookieSetter.apply(document,%20%5Bvalue%5D);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20determine%20the%20origins%20of%20the%20scripts%20in%20the%20stack%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20stack%20=%20new%20Error().stack.split('%5Cn');%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20scriptOrigins%20=%20stack.reduce((origins,%20line)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20res%20=%20line.match(lineTest);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(res%20&&%20res%5B2%5D)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20origins.add(new%20URL(res%5B2%5D).hostname);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20origins%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D,%20new%20Set());%0A%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20wait%20for%20config%20before%20doing%20same-site%20tests%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20loadPolicy.then((%7B%20shouldBlock,%20tabRegisteredDomain,%20policy,%20isTrackerFrame%20%7D)%20=%3E%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(!tabRegisteredDomain%20%7C%7C%20!shouldBlock)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20no%20site%20domain%20for%20this%20site%20to%20test%20against,%20abort%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20debug%20&&%20console.log('%5Bddg-cookie-policy%5D%20policy%20disabled%20on%20this%20page');%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20sameSiteScript%20=%20%5B...scriptOrigins%5D.every((host)%20=%3E%20host%20===%20tabRegisteredDomain%20%7C%7C%20host.endsWith(%60.$%7BtabRegisteredDomain%7D%60));%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(sameSiteScript)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20cookies%20set%20by%20scripts%20loaded%20on%20the%20same%20site%20as%20the%20site%20are%20not%20modified%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20debug%20&&%20console.log('%5Bddg-cookie-policy%5D%20ignored%20(sameSite)',%20value,%20%5B...scriptOrigins%5D);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20trackerScript%20=%20%5B...scriptOrigins%5D.some((host)%20=%3E%20trackerHosts.has(host));%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(!trackerScript%20&&%20!isTrackerFrame)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20debug%20&&%20console.log('%5Bddg-cookie-policy%5D%20ignored%20(non-tracker)',%20value,%20%5B...scriptOrigins%5D);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20extract%20cookie%20expiry%20from%20cookie%20string%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20cookie%20=%20new%20Cookie(value);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20apply%20cookie%20policy%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(cookie.getExpiry()%20%3E%20policy.threshold)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20check%20if%20the%20cookie%20still%20exists%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(document.cookie.split(';').findIndex(kv%20=%3E%20kv.trim().startsWith(cookie.parts%5B0%5D.trim()))%20!==%20-1)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cookie.maxAge%20=%20policy.maxAge;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20debug%20&&%20console.log('%5Bddg-cookie-policy%5D%20update',%20cookie.toString(),%20scriptOrigins);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cookieSetter.apply(document,%20%5Bcookie.toString()%5D);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20debug%20&&%20console.log('%5Bddg-cookie-policy%5D%20dissappeared',%20cookie.toString(),%20cookie.parts%5B0%5D,%20scriptOrigins);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20debug%20&&%20console.log('%5Bddg-cookie-policy%5D%20ignored%20(expiry)',%20value,%20scriptOrigins);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%20catch%20(e)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%7D,%0A%09%20%20%20%20%20%20%20%20get:%20cookieGetter%0A%09%20%20%20%20%7D);%0A%09%7D%0A%0A%09//%20Set%20up%203rd%20party%20cookie%20blocker%0A%09function%20load%20(args)%20%7B%0A%09%20%20%20%20//%20The%20cookie%20expiry%20policy%20is%20injected%20into%20every%20frame%20immediately%20so%20that%20no%20cookie%20will%0A%09%20%20%20%20//%20be%20missed.%0A%09%20%20%20%20applyCookieExpiryPolicy();%0A%09%7D%0A%0A%09function%20init$7%20(args)%20%7B%0A%09%20%20%20%20loadedPolicyResolve(args.cookie);%0A%09%20%20%20%20if%20(window.top%20!==%20window%20&&%20args.cookie.isTrackerFrame%20&&%20args.cookie.shouldBlock%20&&%20args.cookie.isThirdParty)%20%7B%0A%09%20%20%20%20%20%20%20%20//%20overrides%20expiry%20policy%20with%20blocking%20-%20only%20in%20subframes%0A%09%20%20%20%20%20%20%20%20blockCookies();%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09function%20update%20(args)%20%7B%0A%09%20%20%20%20if%20(args.trackerDefinition)%20%7B%0A%09%20%20%20%20%20%20%20%20trackerHosts.add(args.hostname);%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09var%20cookieProtection%20=%20/*#__PURE__*/Object.freeze(%7B%0A%09%09__proto__:%20null,%0A%09%09load:%20load,%0A%09%09init:%20init$7,%0A%09%09update:%20update%0A%09%7D);%0A%0A%09function%20init$6%20(args)%20%7B%0A%09%20%20%20%20overrideProperty('doNotTrack',%20%7B%0A%09%20%20%20%20%20%20%20%20object:%20Navigator.prototype,%0A%09%20%20%20%20%20%20%20%20origValue:%20navigator.doNotTrack,%0A%09%20%20%20%20%20%20%20%20targetValue:%20/Firefox/i.test(navigator.userAgent)%20?%20'unspecified'%20:%20null%0A%09%20%20%20%20%7D);%0A%09%7D%0A%0A%09var%20doNotTrackProtection%20=%20/*#__PURE__*/Object.freeze(%7B%0A%09%09__proto__:%20null,%0A%09%09init:%20init$6%0A%09%7D);%0A%0A%09function%20init$5%20()%20%7B%0A%09%20%20%20%20if%20('interestCohort'%20in%20Document.prototype)%20%7B%0A%09%20%20%20%20%20%20%20%20delete%20Document.prototype.interestCohort;%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09var%20flocProtection%20=%20/*#__PURE__*/Object.freeze(%7B%0A%09%09__proto__:%20null,%0A%09%09init:%20init$5%0A%09%7D);%0A%0A%09//%20Set%20Global%20Privacy%20Control%20property%20on%20DOM%0A%09function%20init$4%20(args)%20%7B%0A%09%20%20%20%20//%20If%20GPC%20on,%20set%20DOM%20property%20to%20true%20if%20not%20already%20true%0A%09%20%20%20%20if%20(args.globalPrivacyControlValue)%20%7B%0A%09%20%20%20%20%20%20%20%20if%20(navigator.globalPrivacyControl)%20return%0A%09%20%20%20%20%20%20%20%20defineProperty(navigator,%20'globalPrivacyControl',%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20value:%20true,%0A%09%20%20%20%20%20%20%20%20%20%20%20%20enumerable:%20true%0A%09%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20//%20If%20GPC%20off,%20set%20DOM%20property%20prototype%20to%20false%20so%20it%20may%20be%20overwritten%0A%09%20%20%20%20%20%20%20%20//%20with%20a%20true%20value%20by%20user%20agent%20or%20other%20extensions%0A%09%20%20%20%20%20%20%20%20if%20(typeof%20navigator.globalPrivacyControl%20!==%20'undefined')%20return%0A%09%20%20%20%20%20%20%20%20defineProperty(Object.getPrototypeOf(navigator),%20'globalPrivacyControl',%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20value:%20false,%0A%09%20%20%20%20%20%20%20%20%20%20%20%20enumerable:%20true%0A%09%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09var%20gpcProtection%20=%20/*#__PURE__*/Object.freeze(%7B%0A%09%09__proto__:%20null,%0A%09%09init:%20init$4%0A%09%7D);%0A%0A%09function%20init$3%20(args)%20%7B%0A%09%20%20%20%20overrideProperty('keyboard',%20%7B%0A%09%20%20%20%20%20%20%20%20object:%20Navigator.prototype,%0A%09%20%20%20%20%20%20%20%20origValue:%20navigator.keyboard,%0A%09%20%20%20%20%20%20%20%20targetValue:%20undefined%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20overrideProperty('hardwareConcurrency',%20%7B%0A%09%20%20%20%20%20%20%20%20object:%20Navigator.prototype,%0A%09%20%20%20%20%20%20%20%20origValue:%20navigator.hardwareConcurrency,%0A%09%20%20%20%20%20%20%20%20targetValue:%208%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20overrideProperty('deviceMemory',%20%7B%0A%09%20%20%20%20%20%20%20%20object:%20Navigator.prototype,%0A%09%20%20%20%20%20%20%20%20origValue:%20navigator.deviceMemory,%0A%09%20%20%20%20%20%20%20%20targetValue:%208%0A%09%20%20%20%20%7D);%0A%09%7D%0A%0A%09var%20hardwareProtection%20=%20/*#__PURE__*/Object.freeze(%7B%0A%09%09__proto__:%20null,%0A%09%09init:%20init$3%0A%09%7D);%0A%0A%09function%20init$2%20(args)%20%7B%0A%09%20%20%20%20//%20Unfortunately,%20we%20only%20have%20limited%20information%20about%20the%20referrer%20and%20current%20frame.%20A%20single%0A%09%20%20%20%20//%20page%20may%20load%20many%20requests%20and%20sub%20frames,%20all%20with%20different%20referrers.%20Since%20we%0A%09%20%20%20%20if%20(args.referrer%20&&%20//%20make%20sure%20the%20referrer%20was%20set%20correctly%0A%09%20%20%20%20%20%20%20%20args.referrer.referrer%20!==%20undefined%20&&%20//%20referrer%20value%20will%20be%20undefined%20when%20it%20should%20be%20unchanged.%0A%09%20%20%20%20%20%20%20%20document.referrer%20&&%20//%20don't%20change%20the%20value%20if%20it%20isn't%20set%0A%09%20%20%20%20%20%20%20%20document.referrer%20!==%20''%20&&%20//%20don't%20add%20referrer%20information%0A%09%20%20%20%20%20%20%20%20new%20URL(document.URL).hostname%20!==%20new%20URL(document.referrer).hostname)%20%7B%20//%20don't%20replace%20the%20referrer%20for%20the%20current%20host.%0A%09%20%20%20%20%20%20%20%20let%20trimmedReferer%20=%20document.referrer;%0A%09%20%20%20%20%20%20%20%20if%20(new%20URL(document.referrer).hostname%20===%20args.referrer.referrerHost)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20make%20sure%20the%20real%20referrer%20&%20replacement%20referrer%20match%20if%20we're%20going%20to%20replace%20it%0A%09%20%20%20%20%20%20%20%20%20%20%20%20trimmedReferer%20=%20args.referrer.referrer;%0A%09%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20//%20if%20we%20don't%20have%20a%20matching%20referrer,%20just%20trim%20it%20to%20origin.%0A%09%20%20%20%20%20%20%20%20%20%20%20%20trimmedReferer%20=%20new%20URL(document.referrer).origin%20+%20'/';%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20overrideProperty('referrer',%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20object:%20Document.prototype,%0A%09%20%20%20%20%20%20%20%20%20%20%20%20origValue:%20document.referrer,%0A%09%20%20%20%20%20%20%20%20%20%20%20%20targetValue:%20trimmedReferer%0A%09%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09var%20referrerProtection%20=%20/*#__PURE__*/Object.freeze(%7B%0A%09%09__proto__:%20null,%0A%09%09init:%20init$2%0A%09%7D);%0A%0A%09/**%0A%09%20*%20normalize%20window%20dimensions,%20if%20more%20than%20one%20monitor%20is%20in%20play.%0A%09%20*%20%20X/Y%20values%20are%20set%20in%20the%20browser%20based%20on%20distance%20to%20the%20main%20monitor%20top%20or%20left,%20which%0A%09%20*%20can%20mean%20second%20or%20more%20monitors%20have%20very%20large%20or%20negative%20values.%20This%20function%20maps%20a%20given%0A%09%20*%20given%20coordinate%20value%20to%20the%20proper%20place%20on%20the%20main%20screen.%0A%09%20*/%0A%09function%20normalizeWindowDimension%20(value,%20targetDimension)%20%7B%0A%09%20%20%20%20if%20(value%20%3E%20targetDimension)%20%7B%0A%09%20%20%20%20%20%20%20%20return%20value%20%25%20targetDimension%0A%09%20%20%20%20%7D%0A%09%20%20%20%20if%20(value%20%3C%200)%20%7B%0A%09%20%20%20%20%20%20%20%20return%20targetDimension%20+%20value%0A%09%20%20%20%20%7D%0A%09%20%20%20%20return%20value%0A%09%7D%0A%0A%09function%20setWindowPropertyValue%20(property,%20value)%20%7B%0A%09%20%20%20%20//%20Here%20we%20don't%20update%20the%20prototype%20getter%20because%20the%20values%20are%20updated%20dynamically%0A%09%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20defineProperty(window,%20property,%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20get:%20()%20=%3E%20value,%0A%09%20%20%20%20%20%20%20%20%20%20%20%20set:%20()%20=%3E%20%7B%7D,%0A%09%20%20%20%20%20%20%20%20%20%20%20%20configurable:%20true%0A%09%20%20%20%20%20%20%20%20%7D);%0A%09%20%20%20%20%7D%20catch%20(e)%20%7B%7D%0A%09%7D%0A%0A%09const%20origPropertyValues%20=%20%7B%7D;%0A%0A%09/**%0A%09%20*%20Fix%20window%20dimensions.%20The%20extension%20runs%20in%20a%20different%20JS%20context%20than%20the%0A%09%20*%20page,%20so%20we%20can%20inject%20the%20correct%20screen%20values%20as%20the%20window%20is%20resized,%0A%09%20*%20ensuring%20that%20no%20information%20is%20leaked%20as%20the%20dimensions%20change,%20but%20also%20that%20the%0A%09%20*%20values%20change%20correctly%20for%20valid%20use%20cases.%0A%09%20*/%0A%09function%20setWindowDimensions%20()%20%7B%0A%09%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20const%20normalizedY%20=%20normalizeWindowDimension(window.screenY,%20window.screen.height);%0A%09%20%20%20%20%20%20%20%20const%20normalizedX%20=%20normalizeWindowDimension(window.screenX,%20window.screen.width);%0A%09%20%20%20%20%20%20%20%20if%20(normalizedY%20%3C=%20origPropertyValues.availTop)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('screenY',%200);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('screenTop',%200);%0A%09%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('screenY',%20normalizedY);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('screenTop',%20normalizedY);%0A%09%20%20%20%20%20%20%20%20%7D%0A%0A%09%20%20%20%20%20%20%20%20if%20(top.window.outerHeight%20%3E=%20origPropertyValues.availHeight%20-%201)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('outerHeight',%20top.window.screen.height);%0A%09%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('outerHeight',%20top.window.outerHeight);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%20catch%20(e)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20top%20not%20accessible%20to%20certain%20iFrames,%20so%20ignore.%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%7D%0A%0A%09%20%20%20%20%20%20%20%20if%20(normalizedX%20%3C=%20origPropertyValues.availLeft)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('screenX',%200);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('screenLeft',%200);%0A%09%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('screenX',%20normalizedX);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('screenLeft',%20normalizedX);%0A%09%20%20%20%20%20%20%20%20%7D%0A%0A%09%20%20%20%20%20%20%20%20if%20(top.window.outerWidth%20%3E=%20origPropertyValues.availWidth%20-%201)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('outerWidth',%20top.window.screen.width);%0A%09%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20setWindowPropertyValue('outerWidth',%20top.window.outerWidth);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%20catch%20(e)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20//%20top%20not%20accessible%20to%20certain%20iFrames,%20so%20ignore.%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%20%20%20%20%7D%0A%09%20%20%20%20%7D%20catch%20(e)%20%7B%0A%09%20%20%20%20%20%20%20%20//%20in%20a%20cross%20domain%20iFrame,%20top.window%20is%20not%20accessible.%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09function%20init$1%20(args)%20%7B%0A%09%20%20%20%20origPropertyValues.availTop%20=%20overrideProperty('availTop',%20%7B%0A%09%20%20%20%20%20%20%20%20object:%20Screen.prototype,%0A%09%20%20%20%20%20%20%20%20origValue:%20screen.availTop,%0A%09%20%20%20%20%20%20%20%20targetValue:%200%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20origPropertyValues.availLeft%20=%20overrideProperty('availLeft',%20%7B%0A%09%20%20%20%20%20%20%20%20object:%20Screen.prototype,%0A%09%20%20%20%20%20%20%20%20origValue:%20screen.availLeft,%0A%09%20%20%20%20%20%20%20%20targetValue:%200%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20origPropertyValues.availWidth%20=%20overrideProperty('availWidth',%20%7B%0A%09%20%20%20%20%20%20%20%20object:%20Screen.prototype,%0A%09%20%20%20%20%20%20%20%20origValue:%20screen.availWidth,%0A%09%20%20%20%20%20%20%20%20targetValue:%20screen.width%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20origPropertyValues.availHeight%20=%20overrideProperty('availHeight',%20%7B%0A%09%20%20%20%20%20%20%20%20object:%20Screen.prototype,%0A%09%20%20%20%20%20%20%20%20origValue:%20screen.availHeight,%0A%09%20%20%20%20%20%20%20%20targetValue:%20screen.height%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20overrideProperty('colorDepth',%20%7B%0A%09%20%20%20%20%20%20%20%20object:%20Screen.prototype,%0A%09%20%20%20%20%20%20%20%20origValue:%20screen.colorDepth,%0A%09%20%20%20%20%20%20%20%20targetValue:%2024%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20overrideProperty('pixelDepth',%20%7B%0A%09%20%20%20%20%20%20%20%20object:%20Screen.prototype,%0A%09%20%20%20%20%20%20%20%20origValue:%20screen.pixelDepth,%0A%09%20%20%20%20%20%20%20%20targetValue:%2024%0A%09%20%20%20%20%7D);%0A%0A%09%20%20%20%20window.addEventListener('resize',%20function%20()%20%7B%0A%09%20%20%20%20%20%20%20%20setWindowDimensions();%0A%09%20%20%20%20%7D);%0A%09%20%20%20%20setWindowDimensions();%0A%09%7D%0A%0A%09var%20screenSizeProtection%20=%20/*#__PURE__*/Object.freeze(%7B%0A%09%09__proto__:%20null,%0A%09%09init:%20init$1%0A%09%7D);%0A%0A%09function%20init%20()%20%7B%0A%09%20%20%20%20/**%0A%09%20%20%20%20%20*%20Temporary%20storage%20can%20be%20used%20to%20determine%20hard%20disk%20usage%20and%20size.%0A%09%20%20%20%20%20*%20This%20will%20limit%20the%20max%20storage%20to%204GB%20without%20completely%20disabling%20the%0A%09%20%20%20%20%20*%20feature.%0A%09%20%20%20%20%20*/%0A%09%20%20%20%20if%20(navigator.webkitTemporaryStorage)%20%7B%0A%09%20%20%20%20%20%20%20%20try%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20org%20=%20navigator.webkitTemporaryStorage.queryUsageAndQuota;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20const%20tStorage%20=%20navigator.webkitTemporaryStorage;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20tStorage.queryUsageAndQuota%20=%20function%20queryUsageAndQuota%20(callback,%20err)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20modifiedCallback%20=%20function%20(usedBytes,%20grantedBytes)%20%7B%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20maxBytesGranted%20=%204%20*%201024%20*%201024%20*%201024;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20spoofedGrantedBytes%20=%20Math.min(grantedBytes,%20maxBytesGranted);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20callback(usedBytes,%20spoofedGrantedBytes);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20org.call(navigator.webkitTemporaryStorage,%20modifiedCallback,%20err);%0A%09%20%20%20%20%20%20%20%20%20%20%20%20%7D;%0A%09%20%20%20%20%20%20%20%20%20%20%20%20defineProperty(Navigator.prototype,%20'webkitTemporaryStorage',%20%7B%20get:%20()%20=%3E%20tStorage%20%7D);%0A%09%20%20%20%20%20%20%20%20%7D%20catch%20(e)%20%7B%7D%0A%09%20%20%20%20%7D%0A%09%7D%0A%0A%09var%20temporaryStorageProtection%20=%20/*#__PURE__*/Object.freeze(%7B%0A%09%09__proto__:%20null,%0A%09%09init:%20init%0A%09%7D);%0A%0A%09exports.initProtections%20=%20initProtections;%0A%09exports.loadProtections%20=%20loadProtections;%0A%09exports.updateProtections%20=%20updateProtections;%0A%0A%09Object.defineProperty(exports,%20'__esModule',%20%7B%20value:%20true%20%7D);%0A%0A%09return%20exports;%0A%0A%7D(%7B%7D));%0A")}
      protections.loadProtections()
      // Define a random function we call later.
      // Use define property so isn't enumerable
      Object.defineProperty(window, '${randomMethodName}', {
          enumerable: false,
          // configurable, To allow for deletion later
          configurable: true,
          writable: false,
          // Use proxy to ensure stringification isn't possible
          value: new Proxy(function () {}, {
              apply(target, thisArg, args) {
                  if ('${randomPassword}' === args[0]) {
                      protections.initProtections(args[1])
                  } else {
                      // TODO force enable all protections if password is wrong
                      console.error("Password for hidden function wasn't correct! The page is likely attempting to attack the protections by DuckDuckGo");
                  }
                  // This method is single use, clean up
                  delete window.${randomMethodName};
              }
          })
      });

      // Define a random update function we call later.
      // Use define property so isn't enumerable
      Object.defineProperty(window, '${reusableMethodName}', {
          enumerable: false,
          // configurable, To allow for deletion later
          configurable: true,
          writable: false,
          // Use proxy to ensure stringification isn't possible
          value: new Proxy(function () {}, {
              apply(target, thisArg, args) {
                  if ('${reusableSecret}' === args[0]) {
                      protections.updateProtections(args[1])
                  }
              }
          })
      });
    `
    inject(initialScript)

    chrome.runtime.sendMessage({
        registeredContentScript: true,
        documentUrl: window.location.href
    },
    (message) => {
        if (!message) {
            // Remove injected function only as background has disabled protections
            inject(`delete window.${randomMethodName}`)
            return
        }
        const stringifiedArgs = JSON.stringify(message)
        const callRandomFunction = `
                window.${randomMethodName}('${randomPassword}', ${stringifiedArgs});
            `
        inject(callRandomFunction)
    }
    )

    chrome.runtime.onMessage.addListener((message) => {
        // forward update messages to the embedded script
        if (message && message.type === 'update') {
            const stringifiedArgs = JSON.stringify(message)
            const callRandomUpdateFunction = `
                window.${reusableMethodName}('${reusableSecret}', ${stringifiedArgs});
            `
            inject(callRandomUpdateFunction)
        }
    })
}

init()

